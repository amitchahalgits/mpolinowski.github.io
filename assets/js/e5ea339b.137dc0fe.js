"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[6084],{263366:(e,r,t)=>{t.r(r),t.d(r,{assets:()=>o,contentTitle:()=>a,default:()=>g,frontMatter:()=>n,metadata:()=>l,toc:()=>c});var i=t(474848),s=t(28453);const n={sidebar_position:9960,slug:"2020-08-03",title:"Gitlab as Docker Registry",authors:"mpolinowski",tags:["LINUX","Gitlab"]},a=void 0,l={id:"DevOps/GitOps/2020-08-03--gitlab-as-docker-registry/index",title:"Gitlab as Docker Registry",description:"Guangzhou, China",source:"@site/docs/DevOps/GitOps/2020-08-03--gitlab-as-docker-registry/index.md",sourceDirName:"DevOps/GitOps/2020-08-03--gitlab-as-docker-registry",slug:"/DevOps/GitOps/2020-08-03--gitlab-as-docker-registry/2020-08-03",permalink:"/docs/DevOps/GitOps/2020-08-03--gitlab-as-docker-registry/2020-08-03",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/GitOps/2020-08-03--gitlab-as-docker-registry/index.md",tags:[{label:"LINUX",permalink:"/docs/tags/linux"},{label:"Gitlab",permalink:"/docs/tags/gitlab"}],version:"current",sidebarPosition:9960,frontMatter:{sidebar_position:9960,slug:"2020-08-03",title:"Gitlab as Docker Registry",authors:"mpolinowski",tags:["LINUX","Gitlab"]},sidebar:"tutorialSidebar",previous:{title:"Working with Gitlab",permalink:"/docs/DevOps/GitOps/2020-08-04--working-with-gitlab/2020-08-04"},next:{title:"Setting up Gitlab",permalink:"/docs/DevOps/GitOps/2020-08-02--gitlab-setup/2020-08-02"}},o={},c=[{value:"Setting Up GitLab\u2019s Docker Registry",id:"setting-up-gitlabs-docker-registry",level:2},{value:"Building a Docker Image",id:"building-a-docker-image",level:2},{value:"Test your Docker Registry",id:"test-your-docker-registry",level:2},{value:"Clean Up",id:"clean-up",level:2}];function d(e){const r={a:"a",code:"code",h2:"h2",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.p,{children:(0,i.jsx)(r.img,{alt:"Guangzhou, China",src:t(505972).A+"",width:"1500",height:"625"})}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"#setting-up-gitlabs-docker-registry",children:"Setting Up GitLab\u2019s Docker Registry"})}),"\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"#building-a-docker-image",children:"Building a Docker Image"})}),"\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"#test-your-docker-registry",children:"Test your Docker Registry"})}),"\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"#clean-up",children:"Clean Up"})}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"setting-up-gitlabs-docker-registry",children:"Setting Up GitLab\u2019s Docker Registry"}),"\n",(0,i.jsx)(r.p,{children:"GitLab will set up a private Docker registry with just a few configuration updates. First we\u2019ll set up the URL where the registry will reside. SSH into your GitLab server, then open up the GitLab configuration file:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:"sudo nano /etc/gitlab/gitlab.rb\n"})}),"\n",(0,i.jsxs)(r.p,{children:["Scroll down to the ",(0,i.jsx)(r.strong,{children:"Container Registry"})," settings section. We\u2019re going to uncomment the ",(0,i.jsx)(r.code,{children:"registry_external_url"})," line and set it to our GitLab hostname with a port number:"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:"registry_external_url 'https://gitlab.example.com:34578'\n"})}),"\n",(0,i.jsx)(r.p,{children:"Save and close the file, then reconfigure GitLab:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:"sudo gitlab-ctl reconfigure\n"})}),"\n",(0,i.jsx)(r.p,{children:"Now switch to another machine with Docker installed, and log in to the private Docker registry:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:"docker login gitlab.example.com:34578\n"})}),"\n",(0,i.jsx)(r.p,{children:"You will be prompted for your username and password. Use your GitLab credentials to log in."}),"\n",(0,i.jsx)(r.h2,{id:"building-a-docker-image",children:"Building a Docker Image"}),"\n",(0,i.jsxs)(r.p,{children:["To get our app building in Docker, we need to update the ",(0,i.jsx)(r.code,{children:".gitlab-ci.yml"})," file:"]}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.img,{alt:"Gitlab Privat Docker Registry",src:t(593356).A+"",width:"1049",height:"576"})}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-yml",children:'image: docker:19.03.0-dind\r\n\r\nvariables:\r\n  DOCKER_HOST: tcp://docker:2375\r\n  DOCKER_TLS_CERTDIR: ""\r\n\r\nservices:\r\n  - name: docker:19.03.12-dind\r\n    entrypoint: ["env", "-u", "DOCKER_HOST"]\r\n    command: ["dockerd-entrypoint.sh"]\r\n\r\n\r\nstages:\r\n- build\r\n# - test\r\n- release\r\n\r\nvariables:\r\n  TEST_IMAGE: gitlab.example.com:34578/wiki/wiki-instar-en-docker:$CI_COMMIT_REF_NAME\r\n  RELEASE_IMAGE: gitlab.example.com:34578/wiki/wiki-instar-en-docker:latest\r\n\r\nbefore_script:\r\n  - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN gitlab.example.com:34578\r\n\r\nbuild:\r\n  stage: build\r\n  script:\r\n    - docker build --pull -t $TEST_IMAGE .\r\n    - docker push $TEST_IMAGE\r\n\r\n# test:\r\n#   stage: test\r\n#     - docker pull $TEST_IMAGE\r\n#     - docker run $TEST_IMAGE npm test\r\n\r\nrelease:\r\n  stage: release\r\n  script:\r\n    - docker pull $TEST_IMAGE\r\n    - docker tag $TEST_IMAGE $RELEASE_IMAGE\r\n    - docker push $RELEASE_IMAGE\r\n  only:\r\n    - master\n'})}),"\n",(0,i.jsx)(r.p,{children:"Once you commit your CI script the job will be started:"}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.img,{alt:"Gitlab Privat Docker Registry",src:t(668254).A+"",width:"1046",height:"253"})}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.img,{alt:"Gitlab Privat Docker Registry",src:t(504981).A+"",width:"1029",height:"292"})}),"\n",(0,i.jsx)(r.h2,{id:"test-your-docker-registry",children:"Test your Docker Registry"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:"docker pull gitlab.example.com:34578/wiki/wiki-instar-en-docker:latest\r\ndocker run -p 80:7777 gitlab.example.com:34578/wiki/wiki-instar-en-docker:latest\n"})}),"\n",(0,i.jsx)(r.h2,{id:"clean-up",children:"Clean Up"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:"gitlab-ctl registry-garbage-collect -m\n"})}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.a,{href:"https://forums.docker.com/t/some-way-to-clean-up-identify-contents-of-var-lib-docker-overlay/30604/29",children:"https://forums.docker.com/t/some-way-to-clean-up-identify-contents-of-var-lib-docker-overlay/30604/29"})}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.a,{href:"https://gitlab.com/gitlab-org/gitlab-foss/-/issues/21690",children:"https://gitlab.com/gitlab-org/gitlab-foss/-/issues/21690"})}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.a,{href:"https://gitlab.com/gitlab-org/docker-distribution-pruner",children:"https://gitlab.com/gitlab-org/docker-distribution-pruner"})})]})}function g(e={}){const{wrapper:r}={...(0,s.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},668254:(e,r,t)=>{t.d(r,{A:()=>i});const i=t.p+"assets/images/Gitlab_Docker_Registry_01-5bb962504226c81f718329e69f218173.png"},504981:(e,r,t)=>{t.d(r,{A:()=>i});const i=t.p+"assets/images/Gitlab_Docker_Registry_02-ea523e9b85f1b713a57edaec301b55ed.png"},593356:(e,r,t)=>{t.d(r,{A:()=>i});const i=t.p+"assets/images/Gitlab_Docker_Registry_03-d472891a8b04155b81d06c17f8802868.png"},505972:(e,r,t)=>{t.d(r,{A:()=>i});const i=t.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-3c682f7dbaf3c13bccb0cad63672e020.jpg"},28453:(e,r,t)=>{t.d(r,{R:()=>a,x:()=>l});var i=t(296540);const s={},n=i.createContext(s);function a(e){const r=i.useContext(n);return i.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function l(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(n.Provider,{value:r},e.children)}}}]);