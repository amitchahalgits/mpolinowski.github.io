"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[62956],{869279:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>l});var a=r(785893),t=r(603905);const o={sidebar_position:8050,slug:"2021-08-06",title:"Hashicorp Consul Refresher - Loadbalancing with Fabio",authors:"mpolinowski",tags:["Consul","Nomad","Linux"]},i=void 0,s={id:"DevOps/Hashicorp/2021-08-06--hashicorp-consul-fabio-loadbalancing/index",title:"Hashicorp Consul Refresher - Loadbalancing with Fabio",description:"Tsim Sha Tsui, Hongkong",source:"@site/docs/DevOps/Hashicorp/2021-08-06--hashicorp-consul-fabio-loadbalancing/index.md",sourceDirName:"DevOps/Hashicorp/2021-08-06--hashicorp-consul-fabio-loadbalancing",slug:"/DevOps/Hashicorp/2021-08-06--hashicorp-consul-fabio-loadbalancing/2021-08-06",permalink:"/docs/DevOps/Hashicorp/2021-08-06--hashicorp-consul-fabio-loadbalancing/2021-08-06",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Hashicorp/2021-08-06--hashicorp-consul-fabio-loadbalancing/index.md",tags:[{label:"Consul",permalink:"/docs/tags/consul"},{label:"Nomad",permalink:"/docs/tags/nomad"},{label:"Linux",permalink:"/docs/tags/linux"}],version:"current",sidebarPosition:8050,frontMatter:{sidebar_position:8050,slug:"2021-08-06",title:"Hashicorp Consul Refresher - Loadbalancing with Fabio",authors:"mpolinowski",tags:["Consul","Nomad","Linux"]},sidebar:"tutorialSidebar",previous:{title:"Hashicorp Consul Refresher - Loadbalancing with Traefik",permalink:"/docs/DevOps/Hashicorp/2021-08-06--hashicorp-consul-traefik-loadbalancing/2021-08-06"},next:{title:"Hashicorp Consul Refresher - Service Discovery",permalink:"/docs/DevOps/Hashicorp/2021-08-05--hashicorp-consul-service-discovery/2021-08-05"}},c={},l=[{value:"Load Balancing with Fabio",id:"load-balancing-with-fabio",level:2},{value:"Create the Web Service",id:"create-the-web-service",level:3},{value:"Create and run a Fabio job",id:"create-and-run-a-fabio-job",level:3}];function h(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.ah)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Tsim Sha Tsui, Hongkong",src:r(863896).Z+"",width:"1500",height:"461"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.a,{href:"#load-balancing-with-fabio",children:"Load Balancing with Fabio"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"#create-the-web-service",children:"Create the Web Service"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"#create-and-run-a-fabio-job",children:"Create and run a Fabio job"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"load-balancing-with-fabio",children:"Load Balancing with Fabio"}),"\n",(0,a.jsxs)(n.p,{children:["The main use case for ",(0,a.jsx)(n.a,{href:"https://fabiolb.net/",children:"Fabio"})," in this scenario is to distribute incoming HTTP(S) and TCP requests from the Internet to front-end services that can handle these requests. ",(0,a.jsx)(n.a,{href:"https://learn.hashicorp.com/tutorials/nomad/load-balancing-fabio",children:"Fabio can natively integrate with Consul"})," using the ",(0,a.jsx)(n.a,{href:"https://docs.traefik.io/providers/consul-catalog/",children:"Consul Catalog Provider"})," and can use tags to route traffic."]}),"\n",(0,a.jsx)(n.h3,{id:"create-the-web-service",children:"Create the Web Service"}),"\n",(0,a.jsxs)(n.p,{children:["I am going to modify the ",(0,a.jsx)(n.a,{href:"/docs/DevOps/Hashicorp/2021-08-05--hashicorp-consul-service-discovery/2021-08-05",children:"HTTP Echo service I created earlier"})," to be load balanced by Fabio:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'job "http-echo-gui" {\r\n  datacenters = ["instaryun"]\r\n\r\n  group "echo" {\r\n  \r\n    network {\r\n        port "heartbeat" {\r\n            static = 8080\r\n            }\r\n    }\r\n\r\n    count = 1\r\n    task "server" {\r\n      driver = "docker"  \r\n      config {\r\n        image = "hashicorp/http-echo:latest"\r\n        ports = ["heartbeat"]\r\n        args  = [\r\n          "-listen", ":${NOMAD_PORT_heartbeat}",\r\n          "-text", "${attr.os.name}: server running on ${NOMAD_IP_heartbeat} with port ${NOMAD_PORT_heartbeat}",\r\n        ]\r\n      }\r\n      service {\r\n        name = "http-echo"\r\n        port = "heartbeat"\r\n        \r\n        tags = [\r\n          "heartbeat",\r\n          "urlprefix-/http-echo",\r\n        ]\r\n\r\n        check {\r\n          type     = "http"\r\n          path     = "/health"\r\n          interval = "2s"\r\n          timeout  = "2s"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:'Note that this job only deploys 1 instance of the Echo web application which I will "load balance" with Fabio in the next few steps. Obviously, you should increase this count to have this make sense... but I only have two LINUX PCs running at the moment and so my "Datacenter" consists of a single minion server.'}),"\n",(0,a.jsx)(n.h3,{id:"create-and-run-a-fabio-job",children:"Create and run a Fabio job"}),"\n",(0,a.jsx)(n.p,{children:"Create a job named:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"nano ~/nomad_jobs/fabio.nomad\n"})}),"\n",(0,a.jsx)(n.p,{children:"This job starts an instance of Fabio and configures it to discover its configuration from Consul. This Fabio instance provides routing and load balancing to the sample web application."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'job "fabio" {\r\n  datacenters = ["instaryun"]\r\n  type = "system"\r\n\r\n  group "fabio" {\r\n    network {\r\n      port "lb" {\r\n        static = 9999\r\n      }\r\n      port "ui" {\r\n        static = 9998\r\n      }\r\n    }\r\n    task "fabio" {\r\n      driver = "docker"\r\n      config {\r\n        image = "fabiolb/fabio"\r\n        network_mode = "host"\r\n        ports = ["lb","ui"]\r\n        args    = ["-proxy.strategy=rr"]\r\n      }\r\n\r\n      resources {\r\n        cpu    = 200\r\n        memory = 128\r\n      }\r\n    }\r\n  }\r\n}\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Fabio can be run without any additional parameters and will use a pseudo-random strategy for load balancing between multiple instances of the same application. In our job file, an additional argument of ",(0,a.jsx)(n.code,{children:"-proxy.strategy=rr"})," is passed to the Fabio command to use a ",(0,a.jsx)(n.a,{href:"https://fabiolb.net/ref/proxy.strategy/",children:"round-robin strategy"})," instead."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'nomad plan ~/nomad_jobs/fabio.nomad\r\n+ Job: "fabio"\r\n+ Task Group: "fabio" (1 create)\r\n  + Task: "fabio" (forces create)\r\n\r\nScheduler dry-run:\r\n- All tasks successfully allocated.\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Run Fabio and it will automatically use the ",(0,a.jsx)(n.a,{href:"https://fabiolb.net/quickstart/",children:"tags"})," that were provided to Consul when the job was registered, to automatically configure itself with the instances running on the various dynamic ports."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'nomad job run -check-index 0 ~/nomad_jobs/fabio.nomad\r\n\r\n==> 2021-09-04T17:48:20+08:00: Evaluation "4ccd671f" finished with status "complete"\n'})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Hashicorp Consul Fabio",src:r(497317).Z+"",width:"1277",height:"590"})}),"\n",(0,a.jsxs)(n.p,{children:["The tag urlprefix-/http-echo tells Fabio to add the instance to the route /http-echo. The instances of the application are then available by visiting ",(0,a.jsx)(n.code,{children:"/http-echo"})," on port ",(0,a.jsx)(n.code,{children:"9999"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"curl 192.168.2.111:9999/http-echo\r\n\r\ndebian: server running on 192.168.2.111 with port 8080\n"})}),"\n",(0,a.jsxs)(n.p,{children:["The response shows that the service is still running on port 8080 but is now proxied through Fabio and - ",(0,a.jsx)(n.strong,{children:"in theory"})," - it would be loadbalanced. Refreshing the page would show you that you will reach all your instances of ",(0,a.jsx)(n.code,{children:"http-echo"}),". You can visit the ",(0,a.jsx)(n.strong,{children:"Fabio UI"})," on port ",(0,a.jsx)(n.code,{children:"9998"})," to verify that all your nodes were picked up successfully:"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Hashicorp Consul Fabio",src:r(725948).Z+"",width:"981",height:"385"})})]})}function d(e={}){const{wrapper:n}={...(0,t.ah)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}},603905:(e,n,r)=>{r.d(n,{ah:()=>l});var a=r(667294);function t(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function o(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,a)}return r}function i(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?o(Object(r),!0).forEach((function(n){t(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function s(e,n){if(null==e)return{};var r,a,t=function(e,n){if(null==e)return{};var r,a,t={},o=Object.keys(e);for(a=0;a<o.length;a++)r=o[a],n.indexOf(r)>=0||(t[r]=e[r]);return t}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)r=o[a],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(t[r]=e[r])}return t}var c=a.createContext({}),l=function(e){var n=a.useContext(c),r=n;return e&&(r="function"==typeof e?e(n):i(i({},n),e)),r},h={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},d=a.forwardRef((function(e,n){var r=e.components,t=e.mdxType,o=e.originalType,c=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),p=l(r),u=t,b=p["".concat(c,".").concat(u)]||p[u]||h[u]||o;return r?a.createElement(b,i(i({ref:n},d),{},{components:r})):a.createElement(b,i({ref:n},d))}));d.displayName="MDXCreateElement"},497317:(e,n,r)=>{r.d(n,{Z:()=>a});const a=r.p+"assets/images/Hashicorp_Consul_Fabio_01-7ff80874cd28e444d5a04ea68434458d.png"},725948:(e,n,r)=>{r.d(n,{Z:()=>a});const a=r.p+"assets/images/Hashicorp_Consul_Fabio_02-69915edc19eaa6efa7b3300ef3163ec7.png"},863896:(e,n,r)=>{r.d(n,{Z:()=>a});const a=r.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-11f46a2aa16d04d5dd9b5dc1c7c256c1.jpg"}}]);