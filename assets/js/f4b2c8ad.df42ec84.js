"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[76395],{626429:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>d,frontMatter:()=>i,metadata:()=>s,toc:()=>l});var a=r(785893),t=r(603905);const i={sidebar_position:8040,slug:"2021-08-06",title:"Hashicorp Consul Refresher - Loadbalancing with Traefik",authors:"mpolinowski",tags:["Consul","Nomad","Linux","Traefik"]},o=void 0,s={id:"DevOps/Hashicorp/2021-08-06--hashicorp-consul-traefik-loadbalancing/index",title:"Hashicorp Consul Refresher - Loadbalancing with Traefik",description:"Tsim Sha Tsui, Hongkong",source:"@site/docs/DevOps/Hashicorp/2021-08-06--hashicorp-consul-traefik-loadbalancing/index.md",sourceDirName:"DevOps/Hashicorp/2021-08-06--hashicorp-consul-traefik-loadbalancing",slug:"/DevOps/Hashicorp/2021-08-06--hashicorp-consul-traefik-loadbalancing/2021-08-06",permalink:"/docs/DevOps/Hashicorp/2021-08-06--hashicorp-consul-traefik-loadbalancing/2021-08-06",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Hashicorp/2021-08-06--hashicorp-consul-traefik-loadbalancing/index.md",tags:[{label:"Consul",permalink:"/docs/tags/consul"},{label:"Nomad",permalink:"/docs/tags/nomad"},{label:"Linux",permalink:"/docs/tags/linux"},{label:"Traefik",permalink:"/docs/tags/traefik"}],version:"current",sidebarPosition:8040,frontMatter:{sidebar_position:8040,slug:"2021-08-06",title:"Hashicorp Consul Refresher - Loadbalancing with Traefik",authors:"mpolinowski",tags:["Consul","Nomad","Linux","Traefik"]},sidebar:"tutorialSidebar",previous:{title:"Nomad Job Configuration",permalink:"/docs/DevOps/Hashicorp/2021-08-07--hashicorp-nomad-job-configuration/2021-08-07"},next:{title:"Hashicorp Consul Refresher - Loadbalancing with Fabio",permalink:"/docs/DevOps/Hashicorp/2021-08-06--hashicorp-consul-fabio-loadbalancing/2021-08-06"}},c={},l=[{value:"Load Balancing with Traefik",id:"load-balancing-with-traefik",level:2},{value:"Create the Web Service",id:"create-the-web-service",level:3},{value:"Create and run a Traefik job",id:"create-and-run-a-traefik-job",level:3}];function h(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.ah)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Tsim Sha Tsui, Hongkong",src:r(5747).Z+"",width:"1500",height:"461"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.a,{href:"#load-balancing-with-traefik",children:"Load Balancing with Traefik"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"#create-the-web-service",children:"Create the Web Service"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"#create-and-run-a-traefik-job",children:"Create and run a Traefik job"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"load-balancing-with-traefik",children:"Load Balancing with Traefik"}),"\n",(0,a.jsxs)(n.p,{children:["The main use case for ",(0,a.jsx)(n.a,{href:"https://traefik.io/",children:"Traefik"})," in this scenario is to distribute incoming HTTP(S) and TCP requests from the Internet to front-end services that can handle these requests. ",(0,a.jsx)(n.a,{href:"https://learn.hashicorp.com/tutorials/nomad/load-balancing-traefik?in=nomad/load-balancing",children:"Traefik can natively integrate with Consul"})," using the ",(0,a.jsx)(n.a,{href:"https://docs.traefik.io/providers/consul-catalog/",children:"Consul Catalog Provider"})," and can use tags to route traffic."]}),"\n",(0,a.jsx)(n.h3,{id:"create-the-web-service",children:"Create the Web Service"}),"\n",(0,a.jsxs)(n.p,{children:["I am going to modify the ",(0,a.jsx)(n.a,{href:"/docs/DevOps/Hashicorp/2021-08-05--hashicorp-consul-service-discovery/2021-08-05",children:"HTTP Echo service I created earlier"})," to be load balanced by Traefik:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'job "http-echo-gui" {\r\n  datacenters = ["instaryun"]\r\n\r\n  group "echo" {\r\n\r\n    count = 1\r\n\r\n    network {\r\n      port  "http"{\r\n        to = -1\r\n      }\r\n    }\r\n\r\n    service {\r\n      name = "echo-webapp"\r\n      port = "http"\r\n\r\n      tags = [\r\n        "traefik.enable=true",\r\n        "traefik.http.routers.http.rule=Path(`/echo`)",\r\n      ]\r\n\r\n      check {\r\n        type     = "http"\r\n        path     = "/"\r\n        interval = "2s"\r\n        timeout  = "2s"\r\n      }\r\n    }\r\n\r\n    task "server" {\r\n      driver = "docker"\r\n      config {\r\n        image = "hashicorp/http-echo:latest"\r\n        ports = ["http"]\r\n        args  = [\r\n          "-listen", ":${NOMAD_PORT_http}",\r\n          "-text", "${attr.os.name}: server running on ${NOMAD_IP_http} with port ${NOMAD_PORT_http}",\r\n        ]\r\n      }\r\n    }\r\n  }\r\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:'Note that this job only deploys 1 instance of the Echo web application which I will "load balance" with Traefik in the next few steps. Obviously, you should increase this count to have this make sense... but I only have two LINUX PCs running at the moment and so my "Datacenter" consists of a single minion server.'}),"\n",(0,a.jsxs)(n.p,{children:["The job uses tags to configure routing to the web app. Even though the application listens on ",(0,a.jsx)(n.code,{children:"/"}),", it is possible to define ",(0,a.jsx)(n.code,{children:"/echo"})," as the route because of the Path option."]}),"\n",(0,a.jsx)(n.p,{children:"I will deploy the web application using the Nomad UI:"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Hashicorp Consul Traefik Loadbalancer",src:r(27508).Z+"",width:"1245",height:"679"})}),"\n",(0,a.jsxs)(n.p,{children:["Unlike before - when I set a static port for the web app - now it received a dynamic port from Nomad ",(0,a.jsx)(n.code,{children:"26137"})," that is bound to the local IP of my server:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"docker ps\r\n\r\nCONTAINER ID   IMAGE                        PORTS\r\n367c94939c8e   hashicorp/http-echo:latest   5678/tcp, 192.168.2.111:26137->26137/tcp, 192.168.2.111:26137->26137/udp\n"})}),"\n",(0,a.jsx)(n.p,{children:"You can verify in Consul that the service is up and running:"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Hashicorp Consul Traefik Loadbalancer",src:r(64457).Z+"",width:"1303",height:"821"})}),"\n",(0,a.jsx)(n.h3,{id:"create-and-run-a-traefik-job",children:"Create and run a Traefik job"}),"\n",(0,a.jsx)(n.p,{children:"Create a job named:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"nano ~/nomad_jobs/traefik.nomad\n"})}),"\n",(0,a.jsx)(n.p,{children:"This job starts an instance of Traefik and configures it to discover its configuration from Consul. This Traefik instance provides routing and load balancing to the sample web application."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'job "traefik" {\r\n  region      = "global"\r\n  datacenters = ["instaryun"]\r\n  type        = "service"\r\n\r\n  group "traefik" {\r\n    count = 1\r\n\r\n    network {\r\n      port "http" {\r\n        static = 8080\r\n      }\r\n\r\n      port "api" {\r\n        static = 8081\r\n      }\r\n    }\r\n\r\n    service {\r\n      name = "traefik"\r\n\r\n      check {\r\n        name     = "alive"\r\n        type     = "tcp"\r\n        port     = "http"\r\n        interval = "10s"\r\n        timeout  = "2s"\r\n      }\r\n    }\r\n\r\n    task "traefik" {\r\n      driver = "docker"\r\n\r\n      config {\r\n        image        = "traefik:v2.2"\r\n        network_mode = "host"\r\n\r\n        volumes = [\r\n          "local/traefik.toml:/etc/traefik/traefik.toml",\r\n        ]\r\n      }\r\n\r\n      template {\r\n        data = <<EOF\r\n[entryPoints]\r\n    [entryPoints.http]\r\n    address = ":8080"\r\n    [entryPoints.traefik]\r\n    address = ":8081"\r\n\r\n[api]\r\n    dashboard = true\r\n    insecure  = true\r\n\r\n# Enable Consul Catalog configuration backend.\r\n[providers.consulCatalog]\r\n    prefix           = "traefik"\r\n    exposedByDefault = false\r\n\r\n    [providers.consulCatalog.endpoint]\r\n      address = "127.0.0.1:8500"\r\n      scheme  = "http"\r\nEOF\r\n\r\n        destination = "local/traefik.toml"\r\n      }\r\n\r\n      resources {\r\n        cpu    = 100\r\n        memory = 128\r\n      }\r\n    }\r\n  }\r\n}\n'})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'nomad plan nomad_jobs/traefik.nomad\r\n+ Job: "traefik"\r\n+ Task Group: "traefik" (1 create)\r\n  + Task: "traefik" (forces create)\r\n\r\nScheduler dry-run:\r\n- All tasks successfully allocated.\r\n\r\nTo submit the job with version verification run:\r\n\r\nnomad job run -check-index 0 nomad_jobs/traefik.nomad\n'})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"nomad job run -check-index 0 nomad_jobs/traefik.nomad\r\n\r\n\r\nDeployed\r\nTask Group  Desired  Placed  Healthy  Unhealthy  Progress Deadline\r\ntraefik     1        1       1        0          2021-09-03T13:12:15+08:00\n"})}),"\n",(0,a.jsxs)(n.p,{children:["This configuration uses a static port for the load balancer to ",(0,a.jsx)(n.code,{children:"8080"}),". This allow you to query the service under the configured path ",(0,a.jsx)(n.code,{children:"/echo"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"curl http://192.168.2.111:8080/echo\r\n\r\ndebian: server running on 192.168.2.111 with port 26137\n"})}),"\n",(0,a.jsxs)(n.p,{children:["You can see that the service is still running on port ",(0,a.jsx)(n.code,{children:"26137"})," but is now proxied through Traefik on port ",(0,a.jsx)(n.code,{children:"8080"})," and - in theory - would also be loadbalanced, once you start more than 1 instance of the web service."]}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.strong,{children:"Traefik Dashboard"})," is now running on port ",(0,a.jsx)(n.code,{children:"8081"})," on my minion - Make sure that ",(0,a.jsx)(n.strong,{children:"both ports are opened in your minions firewall"}),":"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Hashicorp Consul Traefik Loadbalancer",src:r(682481).Z+"",width:"1255",height:"661"})})]})}function d(e={}){const{wrapper:n}={...(0,t.ah)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}},603905:(e,n,r)=>{r.d(n,{ah:()=>l});var a=r(667294);function t(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function i(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,a)}return r}function o(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?i(Object(r),!0).forEach((function(n){t(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function s(e,n){if(null==e)return{};var r,a,t=function(e,n){if(null==e)return{};var r,a,t={},i=Object.keys(e);for(a=0;a<i.length;a++)r=i[a],n.indexOf(r)>=0||(t[r]=e[r]);return t}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)r=i[a],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(t[r]=e[r])}return t}var c=a.createContext({}),l=function(e){var n=a.useContext(c),r=n;return e&&(r="function"==typeof e?e(n):o(o({},n),e)),r},h={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},d=a.forwardRef((function(e,n){var r=e.components,t=e.mdxType,i=e.originalType,c=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),p=l(r),u=t,f=p["".concat(c,".").concat(u)]||p[u]||h[u]||i;return r?a.createElement(f,o(o({ref:n},d),{},{components:r})):a.createElement(f,o({ref:n},d))}));d.displayName="MDXCreateElement"},27508:(e,n,r)=>{r.d(n,{Z:()=>a});const a=r.p+"assets/images/Hashicorp_Consul_Traefik_01-e8d7b535e0266b14a8de077b98acf0ac.png"},64457:(e,n,r)=>{r.d(n,{Z:()=>a});const a=r.p+"assets/images/Hashicorp_Consul_Traefik_02-782d8e337302c950d1ba75fe3694028a.png"},682481:(e,n,r)=>{r.d(n,{Z:()=>a});const a=r.p+"assets/images/Hashicorp_Consul_Traefik_03-ae9d4aa4ae2d1a9c7aa0c65e44d635a1.png"},5747:(e,n,r)=>{r.d(n,{Z:()=>a});const a=r.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-11f46a2aa16d04d5dd9b5dc1c7c256c1.jpg"}}]);