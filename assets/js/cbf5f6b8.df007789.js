"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[7549],{656627:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>o,default:()=>h,frontMatter:()=>i,metadata:()=>c,toc:()=>l});var r=s(474848),t=s(28453);const i={sidebar_position:8050,slug:"2022-12-08",title:"NGINX Websocket Proxy",authors:"mpolinowski",tags:["NGINX","Linux"],description:"Using the NGINX as a Proxy for Websocket APIs"},o=void 0,c={id:"DevOps/NGINX/2022-12-08-nginx-websocket-proxy/index",title:"NGINX Websocket Proxy",description:"Using the NGINX as a Proxy for Websocket APIs",source:"@site/docs/DevOps/NGINX/2022-12-08-nginx-websocket-proxy/index.md",sourceDirName:"DevOps/NGINX/2022-12-08-nginx-websocket-proxy",slug:"/DevOps/NGINX/2022-12-08-nginx-websocket-proxy/2022-12-08",permalink:"/docs/DevOps/NGINX/2022-12-08-nginx-websocket-proxy/2022-12-08",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/NGINX/2022-12-08-nginx-websocket-proxy/index.md",tags:[{label:"NGINX",permalink:"/docs/tags/nginx"},{label:"Linux",permalink:"/docs/tags/linux"}],version:"current",sidebarPosition:8050,frontMatter:{sidebar_position:8050,slug:"2022-12-08",title:"NGINX Websocket Proxy",authors:"mpolinowski",tags:["NGINX","Linux"],description:"Using the NGINX as a Proxy for Websocket APIs"},sidebar:"tutorialSidebar",previous:{title:"NGINX HTTP/2 Docker Ingress",permalink:"/docs/DevOps/NGINX/2023-06-13-nginx-docker-ingress/2023-06-13"},next:{title:"NGINX TCP/UDP Load Balancing",permalink:"/docs/DevOps/NGINX/2022-11-17-nginx-udp-tcp-load-balancing/2022-11-17"}},a={},l=[{value:"Basic Setup",id:"basic-setup",level:2},{value:"Minimal WS Server (Node.js)",id:"minimal-ws-server-nodejs",level:3},{value:"NGINX WS Proxy",id:"nginx-ws-proxy",level:3},{value:"Testing the Service",id:"testing-the-service",level:2},{value:"Secure Websocket Proxy",id:"secure-websocket-proxy",level:2},{value:"Secure Websocket Proxy with Path Re-Writing",id:"secure-websocket-proxy-with-path-re-writing",level:2},{value:"Secure Websocket Proxy with Load-Balancing",id:"secure-websocket-proxy-with-load-balancing",level:2}];function d(e){const n={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Shen Zhen, China",src:s(267865).A+"",width:"1500",height:"598"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"#basic-setup",children:"Basic Setup"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#minimal-ws-server-nodejs",children:"Minimal WS Server (Node.js)"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#nginx-ws-proxy",children:"NGINX WS Proxy"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#testing-the-service",children:"Testing the Service"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#secure-websocket-proxy",children:"Secure Websocket Proxy"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#secure-websocket-proxy-with-path-re-writing",children:"Secure Websocket Proxy with Path Re-Writing"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#secure-websocket-proxy-with-load-balancing",children:"Secure Websocket Proxy with Load-Balancing"})}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.em,{children:"See also:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://www.nginx.com/blog/websocket-nginx/",children:"NGINX as a WebSocket Proxy"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/nicokaiser/nginx-websocket-proxy",children:"nginx WebSocket Proxy"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/mpolinowski/nginx_docker_ingress",children:"NGINX Docker Ingress"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/mpolinowski/ws-api-proxy",children:"Github Repository"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"basic-setup",children:"Basic Setup"}),"\n",(0,r.jsxs)(n.p,{children:["This example uses ",(0,r.jsx)(n.code,{children:"ws"}),", a WebSocket implementation built on Node.js. NGINX acts as a reverse proxy for this simple WebSocket application."]}),"\n",(0,r.jsx)(n.h3,{id:"minimal-ws-server-nodejs",children:"Minimal WS Server (Node.js)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"npm init\nnpm install ws\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.em,{children:"server1.js"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"// import the ws library\nvar WebSocketServer = require('ws').Server;\n\n// start websocket service on port 8010\nwss = new WebSocketServer({port: 8010});\n\n// tell me when you are ready\nconsole.log(\"Server started\");\n\n// handle connection, send msg to console and\n// confirm reception to client\nwss.on('connection', function(ws) {\n        ws.on('message', function(message) {\n        console.log('Received from client: %s', message);\n        ws.send('Server received from client: ' + message);\n    });\n});\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"node server1.js\nServer started\n"})}),"\n",(0,r.jsx)(n.h3,{id:"nginx-ws-proxy",children:"NGINX WS Proxy"}),"\n",(0,r.jsxs)(n.p,{children:["To have NGINX proxy these requests, create the following configuration using a map block so that the ",(0,r.jsx)(n.strong,{children:"Connection header"})," is correctly set to close when the ",(0,r.jsx)(n.strong,{children:"Upgrade header"})," in the request is set to ",(0,r.jsx)(n.code,{children:"''"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"http {\n    map $http_upgrade $connection_upgrade {\n        default upgrade;\n        '' close;\n    }\n \n    upstream websocket {\n        server 127.0.0.1:8010;\n    }\n \n    server {\n        listen 8020;\n        location / {\n            proxy_pass http://websocket;\n            proxy_http_version 1.1;\n            proxy_set_header Upgrade $http_upgrade;\n            proxy_set_header Connection $connection_upgrade;\n            proxy_set_header Host $host;\n        }\n    }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"Start the container with:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"docker run --rm --network host -v /path/to/docker_ws_proxy:/etc/nginx --name proxy nginx:alpine\n"})}),"\n",(0,r.jsx)(n.h2,{id:"testing-the-service",children:"Testing the Service"}),"\n",(0,r.jsxs)(n.p,{children:["To test the service we can use ",(0,r.jsx)(n.a,{href:"https://www.npmjs.com/package/wscat",children:"wscat"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"npm install -g wscat\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Run the WS client to listen on port ",(0,r.jsx)(n.code,{children:"8020"})," - the NGINX proxy port - and send a text message:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"wscat --connect ws://127.0.0.1:8020\nConnected (press CTRL+C to quit)\n> Echo\n< Server received from client: Echo\n"})}),"\n",(0,r.jsx)(n.p,{children:"Check your console running the WS server and you should see your message there as well:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"node server1.js\nServer started\nReceived from client: Echo\n"})}),"\n",(0,r.jsx)(n.h2,{id:"secure-websocket-proxy",children:"Secure Websocket Proxy"}),"\n",(0,r.jsx)(n.p,{children:"Now we have a websocket server and a proxy that can be used as an ingress to forward traffic to our ws server. The next step is to use the proxy to terminate incoming encrypted traffic and direct the unencrypted backend service:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-conf",children:'# WebSocketSecure SSL Endpoint\n\nupstream websocket {\n    server 127.0.0.1:8010;\n}\n\nserver {\n    listen 8020 ssl;\n\n    # host name to respond to\n    server_name 127.0.0.1;\n\n    # your SSL configuration\n    # ssl_certificate /etc/letsencrypt/live/my.domain.com/fullchain.pem;\n    # ssl_certificate_key /etc/letsencrypt/live/my.domain.com/privkey.pem;\n    ssl_certificate /etc/nginx/certs/nginx-selfsigned.crt; # Replace with the 2 lines above when using CA Cert\n    ssl_certificate_key /etc/nginx/certs/nginx-selfsigned.key;\n\n    location / {\n        # switch off logging\n        access_log off;\n\n        # redirect all HTTP traffic to 127.0.0.1:8010\n        proxy_pass http://websocket;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header Host $host;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\n        # WebSocket support (nginx 1.4)\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection "upgrade";\n    }\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"Here I am including a self-signed TLS certificate and key that still needs to be created:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cd docker_ws_proxy/certs\nopenssl req -new -newkey rsa:4096 -x509 -sha256 -days 365 -nodes -out nginx-selfsigned.crt -keyout nginx-selfsigned.key\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Here you should set the ",(0,r.jsx)(n.strong,{children:"Common Name"})," to your server address or domain. I will use ",(0,r.jsx)(n.code,{children:"localhost"})," for this test-run:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"Country Name (2 letter code) [AU]:\nState or Province Name (full name) [Some-State]:\nLocality Name (eg, city) []:\nOrganization Name (eg, company) [Internet Widgits Pty Ltd]:\nOrganizational Unit Name (eg, section) []:\nCommon Name (e.g. server FQDN or YOUR name) []:127.0.0.1\nEmail Address []:\n"})}),"\n",(0,r.jsxs)(n.p,{children:["When trying to connect with a self-signed certificate using ",(0,r.jsx)(n.strong,{children:"wscat"})," you run into ",(0,r.jsx)(n.code,{children:"error: self-signed certificate"}),". You can get around it with ",(0,r.jsx)(n.code,{children:"-n"})," (",(0,r.jsx)(n.code,{children:"--no-check"}),") flag:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"wscat --connect wss://127.0.0.1:8020 -n\n"})}),"\n",(0,r.jsx)(n.h2,{id:"secure-websocket-proxy-with-path-re-writing",children:"Secure Websocket Proxy with Path Re-Writing"}),"\n",(0,r.jsxs)(n.p,{children:["To be able to add our WSS backend into a frontend service we usually have to add routes different from what the backend provides - e.g. the backend provides the service on ",(0,r.jsx)(n.code,{children:"/"})," but our frontend sends API calls to ",(0,r.jsx)(n.code,{children:"/api/ws"}),". NGINX allows us to re-write these calls according to our backend requirements:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-conf",children:'upstream websocket {\n    server 127.0.0.1:8010;\n}\n\nserver {\n    listen 8020 ssl;\n\n    # host name to respond to\n    server_name 127.0.0.1;\n\n    # your SSL configuration\n    # ssl_certificate /etc/letsencrypt/live/my.domain.com/fullchain.pem;\n    # ssl_certificate_key /etc/letsencrypt/live/my.domain.com/privkey.pem;\n    ssl_certificate /etc/nginx/certs/nginx-selfsigned.crt; # Replace with the 2 lines above when using CA Cert\n    ssl_certificate_key /etc/nginx/certs/nginx-selfsigned.key;\n\n    location /api/ws {\n        # switch off logging\n        access_log off;\n\n        # redirect all HTTP traffic to localhost:8010\n        proxy_pass http://websocket;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header Host $host;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\n        # WebSocket support (nginx 1.4)\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection "upgrade";\n\n        # Path rewriting\n        rewrite /api/ws/(.*) /$1 break;\n        proxy_redirect off;\n    }\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"The service can be tested with:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"wscat --connect wss://127.0.0.1:8020/api/ws -n \n"})}),"\n",(0,r.jsx)(n.h2,{id:"secure-websocket-proxy-with-load-balancing",children:"Secure Websocket Proxy with Load-Balancing"}),"\n",(0,r.jsxs)(n.p,{children:["When traffic increases we might need to expand our backend and load-balance the incoming request. From the NGINX side we only need to ensure that every incoming request sticks to the backend server it initially negotiated the TLS connection with - this can be done with ",(0,r.jsx)(n.a,{href:"https://nginx.org/en/docs/http/load_balancing.html",children:"Session persistence"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-conf",children:'# WebSocket Proxy with Load Balancing\n\nupstream websocket {\n    # Clients with the same IP are redirected to the same backend\n    ip_hash;\n\n    # Available backend servers\n    server 127.0.0.1:8010;\n    server 127.0.0.1:8030;\n    server 127.0.0.1:8040;\n}\n\n\nserver {\n    listen 8020 ssl;\n\n    # host name to respond to\n    server_name 127.0.0.1;\n\n    # your SSL configuration\n    # ssl_certificate /etc/letsencrypt/live/my.domain.com/fullchain.pem;\n    # ssl_certificate_key /etc/letsencrypt/live/my.domain.com/privkey.pem;\n    ssl_certificate /etc/nginx/certs/nginx-selfsigned.crt; # Replace with the 2 lines above when using CA Cert\n    ssl_certificate_key /etc/nginx/certs/nginx-selfsigned.key;\n\n    location /api/ws {\n        # switch off logging\n        access_log off;\n\n        # redirect all HTTP traffic to websocket backend\n        proxy_pass http://websocket;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header Host $host;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\n        # WebSocket support (nginx 1.4)\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection "upgrade";\n\n        # Path rewriting\n        rewrite /api/ws/(.*) /$1 break;\n        proxy_redirect off;\n    }\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["From the client side we can just make copies of the the initial ",(0,r.jsx)(n.code,{children:"server1.js"})," and replace the port where they are providing their service. Start all of them and re-run the test:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"wscat --connect wss://127.0.0.1:8020/api/ws -n\n"})})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},267865:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-0829cb95dd693c790a8ca59f3f351274.jpg"},28453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>c});var r=s(296540);const t={},i=r.createContext(t);function o(e){const n=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);