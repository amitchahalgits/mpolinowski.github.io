"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[11842],{387944:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>h,frontMatter:()=>i,metadata:()=>o,toc:()=>c});var t=r(785893),a=r(603905);const i={sidebar_position:7050,slug:"2021-04-13",title:"Setting up KVM on RedHat Enterprise Linux",authors:"mpolinowski",tags:["LINUX"]},s=void 0,o={id:"DevOps/Linux/2021-04-13-installing-kvm-on-red-hat-enterprise-linux/index",title:"Setting up KVM on RedHat Enterprise Linux",description:"Shenzhen, China",source:"@site/docs/DevOps/Linux/2021-04-13-installing-kvm-on-red-hat-enterprise-linux/index.md",sourceDirName:"DevOps/Linux/2021-04-13-installing-kvm-on-red-hat-enterprise-linux",slug:"/DevOps/Linux/2021-04-13-installing-kvm-on-red-hat-enterprise-linux/2021-04-13",permalink:"/docs/DevOps/Linux/2021-04-13-installing-kvm-on-red-hat-enterprise-linux/2021-04-13",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Linux/2021-04-13-installing-kvm-on-red-hat-enterprise-linux/index.md",tags:[{label:"LINUX",permalink:"/docs/tags/linux"}],version:"current",sidebarPosition:7050,frontMatter:{sidebar_position:7050,slug:"2021-04-13",title:"Setting up KVM on RedHat Enterprise Linux",authors:"mpolinowski",tags:["LINUX"]},sidebar:"tutorialSidebar",previous:{title:"Installing Deb Packages on RHEL8",permalink:"/docs/DevOps/Linux/2021-04-14-using-deb-files-on-rhel8/2021-04-14"},next:{title:"Gnome3 Cheat Sheet",permalink:"/docs/DevOps/Linux/2021-04-12-gnome3-cheat-sheet/2021-04-12"}},l={},c=[{value:"Preparing RHEL",id:"preparing-rhel",level:2},{value:"Install and Enable KVM",id:"install-and-enable-kvm",level:3},{value:"Create a VM instance on KVM",id:"create-a-vm-instance-on-kvm",level:3},{value:"Create a Linux Bridge",id:"create-a-linux-bridge",level:4},{value:"Start your VM",id:"start-your-vm",level:4},{value:"Install Virtual machine Manager GUI",id:"install-virtual-machine-manager-gui",level:3}];function d(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.ah)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Shenzhen, China",src:r(26483).Z+"",width:"1500",height:"675"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"#preparing-rhel",children:"Preparing RHEL"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#install-and-enable-kvm",children:"Install and Enable KVM"})}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"#create-a-vm-instance-on-kvm",children:"Create a VM instance on KVM"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#create-a-linux-bridge",children:"Create a Linux Bridge"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#start-your-vm",children:"Start your VM"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#install-virtual-machine-manager-gui",children:"Install Virtual machine Manager GUI"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"preparing-rhel",children:"Preparing RHEL"}),"\n",(0,t.jsx)(n.p,{children:"Check if your CPU supports virtualization:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"lscpu | grep Virtualization\r\n\r\n> Virtualization: VT-x\n"})}),"\n",(0,t.jsx)(n.h3,{id:"install-and-enable-kvm",children:"Install and Enable KVM"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo yum update\r\nsudo yum install @virt\n"})}),"\n",(0,t.jsx)(n.p,{children:"Verify that Kernel modules are loaded:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"$ lsmod | grep kvm\r\n\r\n> kvm_intel 315392 0\r\n> kvm 847872 1 kvm_intel\r\n> irgqbypass 16384 1 kvm\n"})}),"\n",(0,t.jsx)(n.p,{children:"Now we can install a few tools for virtual machine management:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo dnf -y install libvirt-devel virt-top libguestfs-tools\n"})}),"\n",(0,t.jsx)(n.p,{children:"By default, KVM daemon libvirtd is not started, start the service using the command:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo systemctl enable --now libvirtd\r\nservice libvirtd status\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Open TCP port ",(0,t.jsx)(n.code,{children:"5901"})," if your server has a firewall set up:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"firewall-cmd --permanent --add-port=5901/tcp\r\nfirewall-cmd --reload\n"})}),"\n",(0,t.jsx)(n.h3,{id:"create-a-vm-instance-on-kvm",children:"Create a VM instance on KVM"}),"\n",(0,t.jsx)(n.p,{children:"First, start by creating a network bridge to be attached to your instances. In Linux networking, a bridge is used to connect two or more network segments. It is commonly used in Virtualization to pass Virtual Machines traffic through a hypervisor network card. All guest machines connected to a network bridge will treat it transparently as a physical network interface."}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Linux Bridges"})," behave like a virtual network switch and any physical or virtual device can be connected to the bridge."]}),"\n",(0,t.jsx)(n.h4,{id:"create-a-linux-bridge",children:"Create a Linux Bridge"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo nmcli connection show\r\n\r\nNAME     UUID                                  TYPE      DEVICE\r\nenp3s0   27ff1bfd-3ec2-4300-bc71-06e9e9a7457c  ethernet  enp3s0\r\ndocker0  dc5707f4-ae30-481e-8866-d08dfe7e6400  bridge    docker0\r\nvirbr0   91177751-4bcf-45a5-bba9-b1ec99f44887  bridge    virbr0\n"})}),"\n",(0,t.jsxs)(n.p,{children:["I only have one Ethernet interface ",(0,t.jsx)(n.code,{children:"enp3s0"}),". I will copy the configuration file and change the device type to ",(0,t.jsx)(n.strong,{children:"Bridge"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo cp /etc/sysconfig/network-scripts/ifcfg-enp3s0 /etc/sysconfig/network-scripts/ifcfg-br1\r\n\r\ncat /etc/sysconfig/network-scripts/ifcfg-br1\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-cfg",children:"TYPE=Bridge\r\nDEVICE=br1\r\nDELAY=0\r\nSTP=off\r\nIPV4_FAILURE_FATAL=no\r\nIPV6INIT=no\r\nNAME=br1\r\nONBOOT=yes\r\nIPADDR=192.168.2.110\r\nPREFIX=24\r\nGATEWAY=192.168.2.5\r\nDNS1=192.168.2.5\r\nDNS2=8.8.8.8\r\nIPV6_PRIVACY=no\n"})}),"\n",(0,t.jsx)(n.p,{children:"Interface configuration file."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo nano /etc/sysconfig/network-scripts/ifcfg-enp3s0\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-cfg",children:"DEVICE=enp3s0\r\nTYPE=Ethernet\r\nONBOOT=yes\r\nBRIDGE=br1\n"})}),"\n",(0,t.jsx)(n.p,{children:"Now reboot your system and check if the bridge was created:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo nmcli connection show\r\n\r\nNAME           UUID                                  TYPE      DEVICE\r\nbr1            2ee981ca-5ff4-4f9b-03fe-32879aa3dc85  bridge    br1\r\ndocker0        d25f4cc0-d675-4338-b758-455df4c8f30d  bridge    docker0\r\nvirbr0         c2e570e7-415b-4c86-af86-aaf9c5a1e0fc  bridge    virbr0\r\nSystem enp3s0  63aa2036-8665-f54d-9a92-c3035bad03f7  ethernet  enp3s0\n"})}),"\n",(0,t.jsx)(n.h4,{id:"start-your-vm",children:"Start your VM"}),"\n",(0,t.jsx)(n.p,{children:"You an check all available operating systems with:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"osinfo-query os\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The list was outdated for me - I first checked if the latest version of ",(0,t.jsx)(n.code,{children:"osinfo-db-tools"})," was installed, downloaded the latest list and imported it:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'sudo yum install osinfo-db-tools\r\nwget -O "/tmp/osinfo-db.tar.xz" "https://releases.pagure.org/libosinfo/osinfo-db-20210621.tar.xz"\r\nsudo osinfo-db-import --local "/tmp/osinfo-db.tar.xz"\n'})}),"\n",(0,t.jsx)(n.p,{children:"After the update the list included the latest version of Operating System and I was able to create a Fedora 34 VM with the following command:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo virt-install \\\r\n--name fed34 \\\r\n--ram 2048 \\\r\n--vcpus 2 \\\r\n--disk path=/var/lib/libvirt/images/fed34.img,size=20 \\\r\n--os-variant fedora34 \\\r\n--os-type linux \\\r\n--network bridge=br1 \\\r\n--graphics none \\\r\n--console pty,target_type=serial \\\r\n--location 'https://mirror.arizona.edu/fedora/linux/releases/34/Server/x86_64/os/' \\\r\n--extra-args 'console=ttyS0,115200n8 serial'\n"})}),"\n",(0,t.jsx)(n.p,{children:"ERROR:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'[FAILED] Failed to start Switch Root.\r\nWarning: /dev/root does not exist\r\n\r\nGenerating "/run/initramfs/rdsosreport.txt"\r\n\r\n\r\nEntering emergency mode. Exit the shell to continue.\r\nType "journalctl" to view system logs.\r\nYou might want to save "/run/initramfs/rdsosreport.txt" to a USB stick or /boot\r\nafter mounting them and attach it to a bug report.\r\n\r\n\r\nPress Enter for maintenance\r\n(or press Control-D to continue):\n'})}),"\n",(0,t.jsxs)(n.p,{children:["After running into the Error message above I tried downloading the image myself and switched to CentOS 8 - ",(0,t.jsx)(n.a,{href:"http://isoredirect.centos.org/centos/8-stream/isos/x86_64/",children:"Download Page"}),". Make sure to move the image to a public directory like ",(0,t.jsx)(n.code,{children:"/opt"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo virt-install \\\r\n--name CentOS \\\r\n--location=/opt/CentOS-Stream-8-x86_64-20210706-dvd1.iso \\\r\n--ram 2048 \\\r\n--vcpus 2 \\\r\n--disk path=/var/lib/libvirt/images/centos.img,size=20 \\\r\n--os-variant rhel6.0 \\\r\n--os-type linux \\\r\n--network bridge=br1 \\\r\n--graphics none \\\r\n--console pty,target_type=serial \\\r\n--extra-args 'console=ttyS0,115200n8 serial' \\\r\n--check path_in_use=off\n"})}),"\n",(0,t.jsx)(n.p,{children:"And this time it worked:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'Performing post-installation setup tasks\r\n.\r\nConfiguring installed system\r\n...................\r\nWriting network configuration\r\n.\r\nCreating users\r\nConfiguring addons\r\nExecuting org_fedora_oscap addon\r\nExecuting com_redhat_kdump addon\r\n..\r\nGenerating initramfs\r\n...\r\nRunning post-installation scripts\r\n.\r\nStoring configuration files and kickstarts\r\n.\r\nInstallation complete\r\n\r\nUse of this product is subject to the license agreement found at:\r\n/usr/share/redhat-release/EULA\r\n\r\nInstallation complete. Press ENTER to quit:\r\n\r\n\r\n...\r\n\r\n\r\nCentOS Stream 8\r\nKernel 4.18.0-315.el8.x86_64 on an x86_64\r\n\r\nActivate the web console with: systemctl enable --now cockpit.socket\r\n\r\ncentos login: myuser\r\nPassword: mypassword\r\n\r\ncat /etc/os-release\r\n\r\nNAME="CentOS Stream"\r\nVERSION="8"\r\nID="centos"\r\nID_LIKE="rhel fedora"\r\nVERSION_ID="8"\r\nPLATFORM_ID="platform:el8"\r\nPRETTY_NAME="CentOS Stream 8"\r\nANSI_COLOR="0;31"\r\nCPE_NAME="cpe:/o:centos:centos:8"\r\nHOME_URL="https://centos.org/"\r\nBUG_REPORT_URL="https://bugzilla.redhat.com/"\r\nREDHAT_SUPPORT_PRODUCT="Red Hat Enterprise Linux 8"\r\nREDHAT_SUPPORT_PRODUCT_VERSION="CentOS Stream"\n'})}),"\n",(0,t.jsx)(n.h3,{id:"install-virtual-machine-manager-gui",children:"Install Virtual machine Manager GUI"}),"\n",(0,t.jsx)(n.p,{children:"If you have a Desktop Environment on your RHEL 8, you can install the virt-manager tool which allows you to manage Virtual Machines from a GUI."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo yum -y install virt-manager\n"})}),"\n",(0,t.jsx)(n.p,{children:"We can now use the Virtual Machine Manager to take control of our virtual environment."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"KVM and RHEL",src:r(937709).Z+"",width:"1084",height:"565"})}),"\n",(0,t.jsx)(n.p,{children:"At this point I hit another problem - somehow my virtual machine was not connected to a network. It was not assigned an IP address after boot. I will have to dive a bit deeper into this at a later point."})]})}function h(e={}){const{wrapper:n}={...(0,a.ah)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},603905:(e,n,r)=>{r.d(n,{ah:()=>c});var t=r(667294);function a(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function i(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,t)}return r}function s(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?i(Object(r),!0).forEach((function(n){a(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function o(e,n){if(null==e)return{};var r,t,a=function(e,n){if(null==e)return{};var r,t,a={},i=Object.keys(e);for(t=0;t<i.length;t++)r=i[t],n.indexOf(r)>=0||(a[r]=e[r]);return a}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(t=0;t<i.length;t++)r=i[t],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var l=t.createContext({}),c=function(e){var n=t.useContext(l),r=n;return e&&(r="function"==typeof e?e(n):s(s({},n),e)),r},d={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},h=t.forwardRef((function(e,n){var r=e.components,a=e.mdxType,i=e.originalType,l=e.parentName,h=o(e,["components","mdxType","originalType","parentName"]),u=c(r),p=a,g=u["".concat(l,".").concat(p)]||u[p]||d[p]||i;return r?t.createElement(g,s(s({ref:n},h),{},{components:r})):t.createElement(g,s({ref:n},h))}));h.displayName="MDXCreateElement"},937709:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/KVM_and_RHEL_01-133556e43f3f0c37b187b94b857ac493.png"},26483:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/photo-456tdsfggd_67gfh6dgdf4_d-def3899d6748c796fd9f6350dab6e523.jpg"}}]);