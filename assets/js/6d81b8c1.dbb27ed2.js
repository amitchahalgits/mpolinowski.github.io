"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[68022],{241642:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>a,metadata:()=>o,toc:()=>d});var i=n(474848),t=n(28453);const a={sidebar_position:7090,slug:"2022-01-15",title:"Zabbix v6 SMART HDD Check",authors:"mpolinowski",tags:["LINUX","Zabbix"]},r=void 0,o={id:"DevOps/Zabbix/2022-01-15--zabbix-v6-smart-hdd-check/index",title:"Zabbix v6 SMART HDD Check",description:"TST, Hong Kong",source:"@site/docs/DevOps/Zabbix/2022-01-15--zabbix-v6-smart-hdd-check/index.md",sourceDirName:"DevOps/Zabbix/2022-01-15--zabbix-v6-smart-hdd-check",slug:"/DevOps/Zabbix/2022-01-15--zabbix-v6-smart-hdd-check/2022-01-15",permalink:"/docs/DevOps/Zabbix/2022-01-15--zabbix-v6-smart-hdd-check/2022-01-15",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Zabbix/2022-01-15--zabbix-v6-smart-hdd-check/index.md",tags:[{label:"LINUX",permalink:"/docs/tags/linux"},{label:"Zabbix",permalink:"/docs/tags/zabbix"}],version:"current",sidebarPosition:7090,frontMatter:{sidebar_position:7090,slug:"2022-01-15",title:"Zabbix v6 SMART HDD Check",authors:"mpolinowski",tags:["LINUX","Zabbix"]},sidebar:"tutorialSidebar",previous:{title:"Zabbix v6 Creating triggers for Baseline monitoring and Anomaly detection",permalink:"/docs/DevOps/Zabbix/2022-01-16--zabbix-v6-baseline-monitoring/2022-01-16"},next:{title:"Zabbix v6 Slack Notifications",permalink:"/docs/DevOps/Zabbix/2022-01-15--zabbix-v6-slack-notifications/2022-01-15"}},l={},d=[{value:"Install Smartmontools",id:"install-smartmontools",level:2},{value:"Using Smartctl",id:"using-smartctl",level:3},{value:"Add SMART Zabbix Plugin",id:"add-smart-zabbix-plugin",level:2},{value:"Bugfixing",id:"bugfixing",level:3}];function c(e){const s={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{alt:"TST, Hong Kong",src:n(807880).A+"",width:"1500",height:"622"})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.a,{href:"#install-smartmontools",children:"Install Smartmontools"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"#using-smartctl",children:"Using Smartctl"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.a,{href:"#add-smart-zabbix-plugin",children:"Add SMART Zabbix Plugin"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"#bugfixing",children:"Bugfixing"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.p,{children:"S.M.A.R.T. (Self-Monitoring, Analysis and Reporting Technology; often written as SMART) is a monitoring system included in computer hard disk drives (HDDs), solid-state drives (SSDs), and eMMC drives"}),"\n",(0,i.jsx)(s.h2,{id:"install-smartmontools",children:"Install Smartmontools"}),"\n",(0,i.jsx)(s.p,{children:"The smartmontools package comes with two utilities, smartctl which you can use to check your hard drives on the command line, and smartd, a daemon that checks your hard disks at a specified interval and logs warnings/errors to the syslog and can also send warnings and errors to a specified email address (usually the admin of the system)."}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"apt install smartmontools\n"})}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"smartctl -v\r\n\r\nsmartctl 7.2 2020-12-30 r5155 [x86_64-linux-5.10.0-11-amd64] (local build)\r\nCopyright (C) 2002-20, Bruce Allen, Christian Franke, www.smartmontools.org\n"})}),"\n",(0,i.jsx)(s.h3,{id:"using-smartctl",children:"Using Smartctl"}),"\n",(0,i.jsx)(s.p,{children:"Find partition:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"df -h\r\n\r\nFilesystem      Size  Used Avail Use% Mounted on\r\nudev            3.8G     0  3.8G   0% /dev\r\ntmpfs           777M  996K  776M   1% /run\r\n/dev/sda1        75G   43G   30G  59% /\r\ntmpfs           3.8G     0  3.8G   0% /dev/shm\r\ntmpfs           5.0M     0  5.0M   0% /run/lock\r\n/dev/sda15      121M  130K  120M   1% /boot/efi\n"})}),"\n",(0,i.jsxs)(s.p,{children:["In the case of my test server below we have a virtual machine - that, obviously, does not have access to the underlying HDD hardware ",(0,i.jsx)(s.code,{children:"/dev/sda1"}),":"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"smartctl -a /dev/sda1\r\n\r\n=== START OF INFORMATION SECTION ===\r\nVendor:               QEMU\r\nProduct:              QEMU HARDDISK\r\nRevision:             2.5+\r\nCompliance:           SPC-3\r\nUser Capacity:        81,923,145,728 bytes [81.9 GB]\r\nLogical block size:   512 bytes\r\nLU is thin provisioned, LBPRZ=0\r\nDevice type:          disk\r\nLocal Time is:        Sun Jan 30 05:14:03 2022 CET\r\nSMART support is:     Unavailable - device lacks SMART capability.\r\n\r\n=== START OF READ SMART DATA SECTION ===\r\nCurrent Drive Temperature:     0 C\r\nDrive Trip Temperature:        0 C\n"})}),"\n",(0,i.jsxs)(s.p,{children:["When you see that the ",(0,i.jsx)(s.code,{children:"SMART support is:"})," ",(0,i.jsx)(s.strong,{children:"disabled"})," run the following command to enable it:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"smartctl -s on -a /dev/sda1\n"})}),"\n",(0,i.jsx)(s.h2,{id:"add-smart-zabbix-plugin",children:"Add SMART Zabbix Plugin"}),"\n",(0,i.jsxs)(s.p,{children:["The ",(0,i.jsx)(s.a,{href:"https://www.zabbix.com/integrations/smart",children:"template for monitoring S.M.A.R.T. attributes"})," of physical disk that works without any external scripts. It collects metrics by Zabbix agent 2 version 5.0 and later with Smartmontools version 7.1 and later. Disk discovery LLD rule finds all HDD, SSD, NVMe disks with S.M.A.R.T. enabled. Attribute discovery LLD rule finds all Vendor Specific Attributes for each disk."]}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{alt:"SMART Zabbix Plugin",src:n(744163).A+"",width:"834",height:"372"})}),"\n",(0,i.jsx)(s.h3,{id:"bugfixing",children:"Bugfixing"}),"\n",(0,i.jsxs)(s.p,{children:["Searching for ",(0,i.jsx)(s.code,{children:"smart"})," in ",(0,i.jsx)(s.strong,{children:"Latest Data"})," only showed the running SMART Tools service:"]}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{alt:"SMART Zabbix Plugin",src:n(798100).A+"",width:"893",height:"440"})}),"\n",(0,i.jsxs)(s.p,{children:["Checking the agent status showed me that the Agent was unable to execute the SMART Tools command because it lacked ",(0,i.jsx)(s.code,{children:"sudo"})," rights:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"service zabbix-agent2 status\r\n...\r\nMar 07 10:59:16 my-server sudo[260607]: pam_unix(sudo:auth): conversation failed\r\nMar 07 10:59:16 my-server sudo[260607]: pam_unix(sudo:auth): auth could not identify password for [zabbix]\n"})}),"\n",(0,i.jsxs)(s.p,{children:["Add the ",(0,i.jsx)(s.code,{children:"zabbix"})," agent to ",(0,i.jsx)(s.strong,{children:"Sudoers"}),":"]}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.em,{children:"/etc/sudoers"})}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"# Zabbix user SMART control\r\nzabbix ALL=(ALL) NOPASSWD:/usr/sbin/smartctl\n"})}),"\n",(0,i.jsx)(s.p,{children:"But I still did not see anything... until the next morning:"}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{alt:"SMART Zabbix Plugin",src:n(708153).A+"",width:"1034",height:"910"})}),"\n",(0,i.jsx)(s.p,{children:"It seems that the discovery service only returns values sporadically - even though it is set to run once every hour:"}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{alt:"SMART Zabbix Plugin",src:n(105734).A+"",width:"936",height:"283"})}),"\n",(0,i.jsx)(s.p,{children:"I am not yet sure why this is the case. But I lowered the interval to 20min for now - let's see..."})]})}function h(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},744163:(e,s,n)=>{n.d(s,{A:()=>i});const i=n.p+"assets/images/Zabbix_SMART_Monitor_01-b4fcc9c4374182630743a1b3f14a8f6a.jpg"},798100:(e,s,n)=>{n.d(s,{A:()=>i});const i=n.p+"assets/images/Zabbix_SMART_Monitor_02-493d45df941c9b99e7880c40769a2587.jpg"},708153:(e,s,n)=>{n.d(s,{A:()=>i});const i=n.p+"assets/images/Zabbix_SMART_Monitor_03-ba737b8df4ae689fbee4ae86febfb06a.png"},105734:(e,s,n)=>{n.d(s,{A:()=>i});const i=n.p+"assets/images/Zabbix_SMART_Monitor_04-5284bcfc67558603d17b3c628891854c.png"},807880:(e,s,n)=>{n.d(s,{A:()=>i});const i=n.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-d8b333d1f9ddf34ac7392aef86b14c83.jpg"},28453:(e,s,n)=>{n.d(s,{R:()=>r,x:()=>o});var i=n(296540);const t={},a=i.createContext(t);function r(e){const s=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function o(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),i.createElement(a.Provider,{value:s},e.children)}}}]);