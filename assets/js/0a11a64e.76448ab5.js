"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[93620],{96115:(n,e,r)=>{r.r(e),r.d(e,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>s,metadata:()=>i,toc:()=>l});var a=r(474848),t=r(28453);const s={sidebar_position:9060,slug:"2020-06-18",title:"Salt Execution Order",authors:"mpolinowski",tags:["LINUX","Salt"]},o=void 0,i={id:"DevOps/Salt/2020-06-18--salt-execution-order/index",title:"Salt Execution Order",description:"Guangzhou, China",source:"@site/docs/DevOps/Salt/2020-06-18--salt-execution-order/index.md",sourceDirName:"DevOps/Salt/2020-06-18--salt-execution-order",slug:"/DevOps/Salt/2020-06-18--salt-execution-order/2020-06-18",permalink:"/docs/DevOps/Salt/2020-06-18--salt-execution-order/2020-06-18",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Salt/2020-06-18--salt-execution-order/index.md",tags:[{label:"LINUX",permalink:"/docs/tags/linux"},{label:"Salt",permalink:"/docs/tags/salt"}],version:"current",sidebarPosition:9060,frontMatter:{sidebar_position:9060,slug:"2020-06-18",title:"Salt Execution Order",authors:"mpolinowski",tags:["LINUX","Salt"]},sidebar:"tutorialSidebar",previous:{title:"Salt Mine & Orchestrate",permalink:"/docs/DevOps/Salt/2020-06-19--salt-mine-orchestrate/2020-06-19"},next:{title:"Salt Pillars & Formulas",permalink:"/docs/DevOps/Salt/2020-06-17--salt-pillars-formulas/2020-06-17"}},c={},l=[{value:"Complex State Trees",id:"complex-state-trees",level:2},{value:"Execution Order",id:"execution-order",level:3},{value:"Requisites",id:"requisites",level:3},{value:"Watch",id:"watch",level:3},{value:"Conditionals and Branching",id:"conditionals-and-branching",level:2},{value:"onChanges",id:"onchanges",level:3},{value:"onFail",id:"onfail",level:3},{value:"prereq",id:"prereq",level:3}];function d(n){const e={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...n.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(e.p,{children:(0,a.jsx)(e.img,{alt:"Guangzhou, China",src:r(927177).A+"",width:"1500",height:"669"})}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.a,{href:"#complex-state-trees",children:"Complex State Trees"}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#execution-order",children:"Execution Order"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#requisites",children:"Requisites"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#watch",children:"Watch"})}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.a,{href:"#conditionals-and-branching",children:"Conditionals and Branching"}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#onchanges",children:"onChanges"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#onfail",children:"onFail"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#prereq",children:"prereq"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(e.h2,{id:"complex-state-trees",children:"Complex State Trees"}),"\n",(0,a.jsxs)(e.p,{children:["You can combine ",(0,a.jsx)(e.code,{children:"*.sls"})," files by using import statements or by the use of ",(0,a.jsx)(e.strong,{children:"Top Files"}),". We can use this data for example in our Apache landing page (see previous tutorial):"]}),"\n",(0,a.jsx)(e.p,{children:(0,a.jsx)(e.strong,{children:"welcome.sls"})}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:"# Adding a blank front page\r\n\r\ninclude:\r\n  - apache\r\n\r\n{% set name = salt.pillar.get('name') %}\r\n\r\ncheck_pillar_values:\r\n  test.check_pillar:\r\n    - present:\r\n      - name\r\n    - failhard: True\r\n\r\nwelcome_page:\r\n  file.managed:\r\n    - name: /var/www/html/index.html\r\n    - contents: |\r\n        <!doctype html>\r\n        <body>\r\n            <h1>{{ name }}.</h1>\r\n        </body>\n"})}),"\n",(0,a.jsxs)(e.p,{children:["The include statement on top will add the Apache installation - we can now execute the ",(0,a.jsx)(e.code,{children:"welcome.sls"})," directly and get the complete Apache setup:"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-bash",children:"sudo salt ubuntuAsus state.sls apache.welcome\n"})}),"\n",(0,a.jsxs)(e.p,{children:["You can accomplish the same by creating a ",(0,a.jsx)(e.code,{children:"/srv/salt/top.sls"})," file:"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:"base:\r\n  '*':\r\n    - apache\r\n    - apache.welcome\n"})}),"\n",(0,a.jsx)(e.p,{children:"The Apache setup can now be executed by running:"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-bash",children:"sudo salt '*' state.highstate\n"})}),"\n",(0,a.jsxs)(e.p,{children:["The ",(0,a.jsx)(e.code,{children:"state.highstate"})," command will setup the whole infrastructure as defined inside your top file. If you create multiple top files for different setup use the ",(0,a.jsx)(e.a,{href:"https://docs.saltstack.com/en/master/ref/modules/all/salt.modules.state.html",children:"state.top"})," command and specify the file you want to execute:"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-bash",children:"sudo salt '*' state.top prod_top.sls\n"})}),"\n",(0,a.jsx)(e.h3,{id:"execution-order",children:"Execution Order"}),"\n",(0,a.jsxs)(e.p,{children:["Salt's YAML render picks up every instruction inside an ",(0,a.jsx)(e.code,{children:"*.sls"})," file and assigns an order key to them. This makes sure that they are executed in the same order they are written down inside your file. If you need to make sure that one of the instruction is ",(0,a.jsx)(e.strong,{children:"ALWAYS"})," either executed ",(0,a.jsx)(e.strong,{children:"FIRST"})," or ",(0,a.jsx)(e.strong,{children:"LAST"}),", you can specify this inside your file:"]}),"\n",(0,a.jsx)(e.p,{children:(0,a.jsx)(e.strong,{children:"init.sls"})}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:"# Install vanilla Apache on Debian/RedHat\r\n\r\n{% from 'apache/map.sls' import apache with context %}\r\n\r\ninstall_apache:\r\n  pkg.installed:\r\n   - name: {{ apache.pkg }}\r\n   - order: last\r\n\r\nenable_apache:\r\n  service.running:\r\n    - name: {{ apache.srv }}\r\n\r\n    # Will be enabled automatically on Debian but has to be enabled manually on RedHat\r\n    - enable: True\r\n    - order: first\n"})}),"\n",(0,a.jsx)(e.p,{children:"This order stops working reliably once you have include or require statements inside your file."}),"\n",(0,a.jsx)(e.h3,{id:"requisites",children:"Requisites"}),"\n",(0,a.jsx)(e.p,{children:"Requisites bring explicit ordering to your file execution:"}),"\n",(0,a.jsx)(e.p,{children:(0,a.jsx)(e.strong,{children:"init.sls"})}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:"# Install vanilla Apache on Debian/RedHat\r\n\r\n{% from 'apache/map.sls' import apache with context %}\r\n\r\ninstall_apache:\r\n  pkg.installed:\r\n   - name: {{ apache.pkg }}\r\n\r\nenable_apache:\r\n  service.running:\r\n    - name: {{ apache.srv }}\r\n\r\n    # Will be enabled automatically on Debian but has to be enabled manually on RedHat\r\n    - enable: True\r\n    - require:\r\n      - pkg: install_apache\n"})}),"\n",(0,a.jsxs)(e.p,{children:["The ",(0,a.jsx)(e.code,{children:"require"})," statement makes sure that Apache is installed before it will attempt to enable the Apache service."]}),"\n",(0,a.jsx)(e.h3,{id:"watch",children:"Watch"}),"\n",(0,a.jsx)(e.p,{children:"The watch module reacts to a specified instruction being executed and then triggers another function. A practical use case is to restart the Apache service once the Apache configuration was modified:"}),"\n",(0,a.jsx)(e.p,{children:(0,a.jsx)(e.strong,{children:"init.sls"})}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:"# Install vanilla Apache on Debian/RedHat\r\n\r\n{% from 'apache/map.sls' import apache with context %}\r\n\r\ninstall_apache:\r\n  pkg.installed:\r\n   - name: {{ apache.pkg }}\r\n\r\nenable_apache:\r\n  service.running:\r\n    - name: {{ apache.srv }}\r\n\r\n    # Will be enabled automatically on Debian but has to be enabled manually on RedHat\r\n    - enable: True\r\n    - watch:\r\n      - file: danger_config\r\n    \r\ndanger_config:\r\n  file.managed:\r\n    - name /bar/foo\r\n    - contents: foo\r\n    \n"})}),"\n",(0,a.jsx)(e.p,{children:"We can also extend the watch service to another SLS file:"}),"\n",(0,a.jsx)(e.p,{children:(0,a.jsx)(e.strong,{children:"mods.sls"})}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:"include:\r\n  - apache\r\n\r\nextend:\r\n  start_apache:\r\n    service:\r\n      - watch:\r\n        - file: danger_config\r\n\r\n{% for conf in ['status', 'info'] %}\r\n\r\nmod_{{ conf }}:\r\n  file.managed:\r\n    - name: /etc/apache2/conf-available/mod_{{ conf }}.conf\r\n    - contents: |\r\n        <Location '/{{ conf }}'>\r\n            SetHandler server-{{ conf }}\r\n        </Location>\r\n\r\n  {% if salt.grains.get('os_family') == 'Debian' %}\r\n  cmd.run:\r\n    - name: a2enmod {{ conf }} && a2enconf mod_{{ conf }}\r\n    - creates: /etc/apache2/conf-enabled/mod_{{ conf }}.conf\r\n  {% endif %}\r\n\r\n{% endfor %}\n"})}),"\n",(0,a.jsxs)(e.p,{children:["The ",(0,a.jsx)(e.code,{children:"mods.sls"})," configures Apache - by including the ",(0,a.jsx)(e.code,{children:"init.sls"})," file we can now execute mods and be certain that Apache will be installed first before the configuration is attempted. We can now define the watch task here instead of the init file."]}),"\n",(0,a.jsxs)(e.p,{children:["We can also use the  ",(0,a.jsx)(e.code,{children:"watch_in"})," statement:"]}),"\n",(0,a.jsx)(e.p,{children:(0,a.jsx)(e.strong,{children:"mods.sls"})}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:"include:\r\n  - apache\r\n\r\n{% for conf in ['status', 'info'] %}\r\n\r\nmod_{{ conf }}:\r\n  file.managed:\r\n    - name: /etc/apache2/conf-available/mod_{{ conf }}.conf\r\n    - contents: |\r\n        <Location '/{{ conf }}'>\r\n            SetHandler server-{{ conf }}\r\n        </Location>\r\n    - watch_in:\r\n      - service: enable_apache\r\n\r\n  {% if salt.grains.get('os_family') == 'Debian' %}\r\n  cmd.run:\r\n    - name: a2enmod {{ conf }} && a2enconf mod_{{ conf }}\r\n    - creates: /etc/apache2/conf-enabled/mod_{{ conf }}.conf\r\n    - watch_in:\r\n      - service: enable_apache\r\n  {% endif %}\r\n\r\n{% endfor %}\n"})}),"\n",(0,a.jsxs)(e.p,{children:["If ",(0,a.jsx)(e.code,{children:"mod_status"})," or ",(0,a.jsx)(e.code,{children:"mod_info"})," should always be changed ",(0,a.jsx)(e.strong,{children:"BEFORE"})," Apache is restarted with ",(0,a.jsx)(e.code,{children:"enable_apache"}),"."]}),"\n",(0,a.jsx)(e.p,{children:"You can test the execution order by doing a dry-run:"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-bash",children:"salt '*' state.sls apache.mods test=true\r\n\r\nubuntuAsus:\r\n----------\r\n          ID: install_apache\r\n    Function: pkg.installed\r\n        Name: apache2\r\n      Result: True\r\n     Comment: All specified packages are already installed\r\n     Started: 18:26:02.852277\r\n    Duration: 38.55 ms\r\n     Changes:   \r\n----------\r\n          ID: mod_status\r\n    Function: file.managed\r\n        Name: /etc/apache2/conf-available/mod_status.conf\r\n      Result: None\r\n     Comment: The file /etc/apache2/conf-available/mod_status.conf is set to be changed\r\n              Note: No changes made, actual changes may\r\n              be different due to other states.\r\n     Started: 18:26:02.899635\r\n    Duration: 1.456 ms\r\n     Changes:   \r\n              ----------\r\n              newfile:\r\n                  /etc/apache2/conf-available/mod_status.conf\r\n----------\r\n          ID: mod_info\r\n    Function: file.managed\r\n        Name: /etc/apache2/conf-available/mod_info.conf\r\n      Result: None\r\n     Comment: The file /etc/apache2/conf-available/mod_info.conf is set to be changed\r\n              Note: No changes made, actual changes may\r\n              be different due to other states.\r\n     Started: 18:26:02.901184\r\n    Duration: 1.077 ms\r\n     Changes:   \r\n              ----------\r\n              newfile:\r\n                  /etc/apache2/conf-available/mod_info.conf\r\n----------\r\n          ID: enable_apache\r\n    Function: service.running\r\n        Name: apache2\r\n      Result: None\r\n     Comment: Service is set to be restarted\r\n     Started: 18:26:02.940131\r\n    Duration: 19.022 ms\r\n     Changes:   \r\n----------\r\n          ID: mod_status\r\n    Function: cmd.run\r\n        Name: a2enmod status && a2enconf mod_status\r\n      Result: None\r\n     Comment: Command 'a2enmod status && a2enconf mod_status' would have been executed\r\n     Started: 18:26:02.961747\r\n    Duration: 378.228 ms\r\n     Changes:   \r\n----------\r\n          ID: mod_info\r\n    Function: cmd.run\r\n        Name: a2enmod info && a2enconf mod_info\r\n      Result: None\r\n     Comment: Command 'a2enmod info && a2enconf mod_info' would have been executed\r\n     Started: 18:26:03.340098\r\n    Duration: 4.92 ms\r\n     Changes:   \r\n\r\nSummary for ubuntuAsus\r\n------------\r\nSucceeded: 6 (unchanged=5, changed=2)\r\nFailed:    0\r\n------------\r\nTotal states run:     6\r\nTotal run time: 443.253 ms\n"})}),"\n",(0,a.jsx)(e.h2,{id:"conditionals-and-branching",children:"Conditionals and Branching"}),"\n",(0,a.jsx)(e.h3,{id:"onchanges",children:"onChanges"}),"\n",(0,a.jsxs)(e.p,{children:["We can use ",(0,a.jsx)(e.code,{children:"onChanges"})," to watch a state and trigger actions when required. For example the Apache modules only need to be (re) enabled if their content changed."]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yml",children:"include:\r\n  - apache\r\n\r\n{% for conf in ['status', 'info'] %}\r\n\r\nmod_{{ conf }}:\r\n  file.managed:\r\n    - name: /etc/apache2/conf-available/mod_{{ conf }}.conf\r\n    - contents: |\r\n        <Location \"/{{ conf }}\">\r\n            SetHandler server-{{ conf }}\r\n        </Location>\r\n    - watch_in:\r\n      - service: enable_apache\r\n\r\n  {% if salt.grains.get('os_family') == 'Debian' %}\r\n  cmd.run:\r\n    - name: a2enmod {{ conf }} && a2enconf mod_{{ conf }}\r\n    - onchanges:\r\n      - file: mod_{{ conf }}\r\n    - watch_in:\r\n      - service: enable_apache\r\n  {% endif %}\r\n\r\n{% endfor %}\n"})}),"\n",(0,a.jsx)(e.p,{children:"You can now re-run the command and the see that the execution was suppressed:"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-bash",children:"salt ubuntuAsus state.sls apache.mods\n"})}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:"----------\r\n          ID: mod_status\r\n    Function: cmd.run\r\n        Name: a2enmod status && a2enconf mod_status\r\n      Result: True\r\n     Comment: State was not run because none of the onchanges reqs changed\r\n     Started: 10:54:17.354494\r\n    Duration: 0.004 ms\r\n     Changes:   \r\n----------\r\n          ID: mod_info\r\n    Function: cmd.run\r\n        Name: a2enmod info && a2enconf mod_info\r\n      Result: True\r\n     Comment: State was not run because none of the onchanges reqs changed\r\n     Started: 10:54:17.354603\r\n    Duration: 0.002 ms\r\n     Changes:\n"})}),"\n",(0,a.jsx)(e.p,{children:"You can now change the configuration file (by adding some meaningless white space) and re-run the command:"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-js",children:'...\r\n\r\n<Location "/{{ conf }}">\r\n    SetHandler server-{{ conf }}\r\n\r\n</Location>\r\n\r\n...\n'})}),"\n",(0,a.jsx)(e.p,{children:"The change will be picked up and the modules will be executed once again:"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-bash",children:'salt ubuntuAsus state.sls apache.mods\r\n\r\n                                                                    \r\nubuntuAsus:\r\n----------\r\n          ID: mod_status\r\n    Function: file.managed\r\n        Name: /etc/apache2/conf-available/mod_status.conf\r\n      Result: True\r\n     Comment: File /etc/apache2/conf-available/mod_status.conf updated\r\n     Started: 11:00:09.916316\r\n    Duration: 31.164 ms\r\n     Changes:   \r\n              ----------\r\n              diff:\r\n                  --- \r\n                  +++ \r\n                  @@ -1,3 +1,4 @@\r\n                   <Location "/status">\r\n                       SetHandler server-status\r\n                  +\r\n                   </Location>\r\n----------\r\n          ID: enable_apache\r\n    Function: service.running\r\n        Name: apache2\r\n      Result: True\r\n     Comment: Service restarted\r\n     Started: 11:00:10.005666\r\n    Duration: 133.762 ms\r\n     Changes:   \r\n              ----------\r\n              apache2:\r\n                  True\r\n----------\r\n          ID: mod_info\r\n    Function: file.managed\r\n        Name: /etc/apache2/conf-available/mod_info.conf\r\n      Result: True\r\n     Comment: File /etc/apache2/conf-available/mod_info.conf updated\r\n     Started: 11:00:09.947841\r\n    Duration: 11.464 ms\r\n     Changes:   \r\n              ----------\r\n              diff:\r\n                  --- \r\n                  +++ \r\n                  @@ -1,3 +1,4 @@\r\n                   <Location "/info">\r\n                       SetHandler server-info\r\n                  +\r\n                   </Location>\r\n----------\r\n          ID: mod_status\r\n    Function: cmd.run\r\n        Name: a2enmod status && a2enconf mod_status\r\n      Result: True\r\n     Comment: Command "a2enmod status && a2enconf mod_status" run\r\n     Started: 11:00:10.142729\r\n    Duration: 59.029 ms\r\n     Changes:   \r\n              ----------\r\n              pid:\r\n                  83853\r\n              retcode:\r\n                  0\r\n              stderr:\r\n              stdout:\r\n                  Module status already enabled\r\n                  Conf mod_status already enabled\r\n----------\r\n          ID: mod_info\r\n    Function: cmd.run\r\n        Name: a2enmod info && a2enconf mod_info\r\n      Result: True\r\n     Comment: Command "a2enmod info && a2enconf mod_info" run\r\n     Started: 11:00:10.202081\r\n    Duration: 52.738 ms\r\n     Changes:   \r\n              ----------\r\n              pid:\r\n                  83864\r\n              retcode:\r\n                  0\r\n              stderr:\r\n              stdout:\r\n                  Module info already enabled\r\n                  Conf mod_info already enabled\n'})}),"\n",(0,a.jsx)(e.h3,{id:"onfail",children:"onFail"}),"\n",(0,a.jsxs)(e.p,{children:["With ",(0,a.jsx)(e.code,{children:"onFail"})," we can run a state if another state does not complete successfully. Create a file ",(0,a.jsx)(e.code,{children:"nano /srv/salt/apptest.sls"})," and let it ",(0,a.jsx)(e.a,{href:"https://docs.saltstack.com/en/master/ref/states/all/salt.states.git.html#salt.states.git.latest",children:"download a git repository"})," for us:"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:"apptest:\r\n  git.latest:\r\n    - name: https://github.com/mpolinowski/docker-elk.git\r\n    - rev: master\r\n    - target: /opt/apptest\r\n\r\nnotify_of_fail:\r\n  event.send:\r\n    - name: apptest/failed\r\n    - onfail:\r\n      - git: apptest\n"})}),"\n",(0,a.jsx)(e.p,{children:"Then run the state:"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-bash",children:"salt ubuntuAsus state.sls apptest\n"})}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-bash",children:"ubuntuAsus:\r\n----------\r\n          ID: apptest\r\n    Function: git.latest\r\n        Name: https://github.com/mpolinowski/docker-elk.git\r\n      Result: True\r\n     Comment: https://github.com/mpolinowski/docker-elk.git cloned to /opt/apptest\r\n     Started: 11:24:51.598681\r\n    Duration: 13472.643 ms\r\n     Changes:   \r\n              ----------\r\n              new:\r\n                  https://github.com/mpolinowski/docker-elk.git => /opt/apptest\r\n              revision:\r\n                  ----------\r\n                  new:\r\n                      2358839589c36223984b6a0528289d9efefd5189\r\n                  old:\r\n                      None\r\n----------\r\n          ID: notify_of_fail\r\n    Function: event.send\r\n        Name: apptest/failed\r\n      Result: True\r\n     Comment: State was not run because onfail req did not change\r\n     Started: 11:25:05.080430\r\n    Duration: 0.013 ms\r\n     Changes:   \r\n\r\nSummary for ubuntuAsus\r\n------------\r\nSucceeded: 2 (changed=1)\r\nFailed:    0\r\n------------\r\nTotal states run:     2\r\nTotal run time:  13.473 s\n"})}),"\n",(0,a.jsxs)(e.p,{children:["The repository cloning was successful and the notification was ",(0,a.jsx)(e.strong,{children:"NOT"})," triggered."]}),"\n",(0,a.jsx)(e.h3,{id:"prereq",children:"prereq"}),"\n",(0,a.jsx)(e.p,{children:"Only run a state when another state will change the system. E.g. reload your webserver only if a new app version was downloaded by git:"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:'{% from "apache/map.sls" import apache with context %}\r\n\r\ninclude:\r\n  - apache\r\n\r\napptest:\r\n  git.latest:\r\n    - name: https://github.com/mpolinowski/docker-elk.git\r\n    - rev: master\r\n    - target: /opt/apptest\r\n    - watch_in:\r\n      - service: enable_apache\r\n\r\nreload_apache:\r\n  module.run:\r\n    - name: service.stop\r\n    - m_name: {{ apache.srv }}\r\n    - prereq:\r\n      - git: apptest\r\n\r\nnotify_of_fail:\r\n  event.send:\r\n    - name: apptest/failed\r\n    - onfail:\r\n      - git: apptest\n'})}),"\n",(0,a.jsxs)(e.p,{children:["The prerequisite will run ",(0,a.jsx)(e.code,{children:"apptest"})," in ",(0,a.jsx)(e.em,{children:"Dry-Run"}),". If the code changed, ",(0,a.jsx)(e.code,{children:"reload_apache"})," will be triggered once the new source code was cloned by git."]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-bash",children:"salt ubuntuAsus state.sls apptest                                                                             \r\nubuntuAsus:\r\n----------\r\n          ID: install_apache\r\n    Function: pkg.installed\r\n        Name: apache2\r\n      Result: True\r\n     Comment: All specified packages are already installed\r\n     Started: 11:44:57.106219\r\n    Duration: 40.43 ms\r\n     Changes:   \r\n----------\r\n          ID: reload_apache\r\n    Function: module.run\r\n        Name: service.stop\r\n      Result: True\r\n     Comment: Module function service.stop executed\r\n     Started: 11:44:58.331330\r\n    Duration: 97.635 ms\r\n     Changes:   \r\n              ----------\r\n              ret:\r\n                  True\r\n----------\r\n          ID: apptest\r\n    Function: git.latest\r\n        Name: https://github.com/mpolinowski/docker-elk.git\r\n      Result: True\r\n     Comment: https://github.com/mpolinowski/docker-elk.git cloned to /opt/apptest\r\n     Started: 11:44:58.429290\r\n    Duration: 4591.687 ms\r\n     Changes:   \r\n              ----------\r\n              new:\r\n                  https://github.com/mpolinowski/docker-elk.git => /opt/apptest\r\n              revision:\r\n                  ----------\r\n                  new:\r\n                      2358839589c36223984b6a0528289d9efefd5189\r\n                  old:\r\n                      None\r\n----------\r\n          ID: enable_apache\r\n    Function: service.running\r\n        Name: apache2\r\n      Result: True\r\n     Comment: Service apache2 is already enabled, and is running\r\n     Started: 11:45:03.021324\r\n    Duration: 118.316 ms\r\n     Changes:   \r\n              ----------\r\n              apache2:\r\n                  True\r\n----------\r\n          ID: notify_of_fail\r\n    Function: event.send\r\n        Name: apptest/failed\r\n      Result: True\r\n     Comment: State was not run because onfail req did not change\r\n     Started: 11:45:03.141194\r\n    Duration: 0.004 ms\r\n     Changes:   \r\n\r\nSummary for ubuntuAsus\r\n------------\r\nSucceeded: 5 (changed=3)\r\nFailed:    0\r\n------------\r\nTotal states run:     5\r\nTotal run time:   4.848 s\n"})}),"\n",(0,a.jsxs)(e.p,{children:[(0,a.jsx)(e.code,{children:"reload_apache"})," detected that ",(0,a.jsx)(e.code,{children:"apptest"})," will add new source code and stopped the webserver. Once the code was cloned the watch task reloaded the webserver."]})]})}function h(n={}){const{wrapper:e}={...(0,t.R)(),...n.components};return e?(0,a.jsx)(e,{...n,children:(0,a.jsx)(d,{...n})}):d(n)}},927177:(n,e,r)=>{r.d(e,{A:()=>a});const a=r.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-bf63cad7c3e1864ad8175e21a1e31033.jpg"},28453:(n,e,r)=>{r.d(e,{R:()=>o,x:()=>i});var a=r(296540);const t={},s=a.createContext(t);function o(n){const e=a.useContext(s);return a.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function i(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(t):n.components||t:o(n.components),a.createElement(s.Provider,{value:e},n.children)}}}]);