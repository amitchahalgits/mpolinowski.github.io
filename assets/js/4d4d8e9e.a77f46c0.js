"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[46804],{3905:(t,e,n)=>{n.d(e,{Zo:()=>p,kt:()=>d});var o=n(67294);function a(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function i(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,o)}return n}function r(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?i(Object(n),!0).forEach((function(e){a(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function s(t,e){if(null==t)return{};var n,o,a=function(t,e){if(null==t)return{};var n,o,a={},i=Object.keys(t);for(o=0;o<i.length;o++)n=i[o],e.indexOf(n)>=0||(a[n]=t[n]);return a}(t,e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);for(o=0;o<i.length;o++)n=i[o],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(a[n]=t[n])}return a}var l=o.createContext({}),c=function(t){var e=o.useContext(l),n=e;return t&&(n="function"==typeof t?t(e):r(r({},e),t)),n},p=function(t){var e=c(t.components);return o.createElement(l.Provider,{value:e},t.children)},m={inlineCode:"code",wrapper:function(t){var e=t.children;return o.createElement(o.Fragment,{},e)}},u=o.forwardRef((function(t,e){var n=t.components,a=t.mdxType,i=t.originalType,l=t.parentName,p=s(t,["components","mdxType","originalType","parentName"]),u=c(n),d=a,h=u["".concat(l,".").concat(d)]||u[d]||m[d]||i;return n?o.createElement(h,r(r({ref:e},p),{},{components:n})):o.createElement(h,r({ref:e},p))}));function d(t,e){var n=arguments,a=e&&e.mdxType;if("string"==typeof t||a){var i=n.length,r=new Array(i);r[0]=u;var s={};for(var l in e)hasOwnProperty.call(e,l)&&(s[l]=e[l]);s.originalType=t,s.mdxType="string"==typeof t?t:a,r[1]=s;for(var c=2;c<i;c++)r[c]=n[c];return o.createElement.apply(null,r)}return o.createElement.apply(null,n)}u.displayName="MDXCreateElement"},34190:(t,e,n)=>{n.r(e),n.d(e,{assets:()=>l,contentTitle:()=>r,default:()=>m,frontMatter:()=>i,metadata:()=>s,toc:()=>c});var o=n(87462),a=(n(67294),n(3905));const i={sidebar_position:6970,slug:"2023-04-17",title:"(Re) Introduction to Home Assistant Auto-discovery",authors:"mpolinowski",tags:["IoT"],image:"https://mpolinowski.github.io/img/search/mqtt.png",description:"Using the INSTAR IP Cameras MQTT Interface to add your Camera to Home Assistant."},r=void 0,s={unversionedId:"IoT-and-Machine-Learning/Home_Automation/2023-04-17-home-assistant-mqtt-autodiscovery-part-iii/index",id:"IoT-and-Machine-Learning/Home_Automation/2023-04-17-home-assistant-mqtt-autodiscovery-part-iii/index",title:"(Re) Introduction to Home Assistant Auto-discovery",description:"Using the INSTAR IP Cameras MQTT Interface to add your Camera to Home Assistant.",source:"@site/docs/IoT-and-Machine-Learning/Home_Automation/2023-04-17-home-assistant-mqtt-autodiscovery-part-iii/index.md",sourceDirName:"IoT-and-Machine-Learning/Home_Automation/2023-04-17-home-assistant-mqtt-autodiscovery-part-iii",slug:"/IoT-and-Machine-Learning/Home_Automation/2023-04-17-home-assistant-mqtt-autodiscovery-part-iii/2023-04-17",permalink:"/docs/IoT-and-Machine-Learning/Home_Automation/2023-04-17-home-assistant-mqtt-autodiscovery-part-iii/2023-04-17",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/IoT-and-Machine-Learning/Home_Automation/2023-04-17-home-assistant-mqtt-autodiscovery-part-iii/index.md",tags:[{label:"IoT",permalink:"/docs/tags/io-t"}],version:"current",sidebarPosition:6970,frontMatter:{sidebar_position:6970,slug:"2023-04-17",title:"(Re) Introduction to Home Assistant Auto-discovery",authors:"mpolinowski",tags:["IoT"],image:"https://mpolinowski.github.io/img/search/mqtt.png",description:"Using the INSTAR IP Cameras MQTT Interface to add your Camera to Home Assistant."},sidebar:"tutorialSidebar",previous:{title:"Camera Surveillance System with OpenCV",permalink:"/docs/IoT-and-Machine-Learning/Home_Automation/2023-02-07-python-home-security/2023-02-07"},next:{title:"OpenThread Border Router with Docker with Docker",permalink:"/docs/IoT-and-Machine-Learning/Home_Automation/2023-01-23-thread-edge-router-docker/2023-01-23"}},l={},c=[{value:"Docker",id:"docker",level:2},{value:"MQTT Autodiscovery",id:"mqtt-autodiscovery",level:2},{value:"Last-Will Trigger",id:"last-will-trigger",level:3},{value:"Shell Script",id:"shell-script",level:3},{value:"Automation",id:"automation",level:3},{value:"Python Script",id:"python-script",level:3},{value:"Broker Configuration",id:"broker-configuration",level:4}],p={toc:c};function m(t){let{components:e,...i}=t;return(0,a.kt)("wrapper",(0,o.Z)({},p,i,{components:e,mdxType:"MDXLayout"}),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Guangzhou, China",src:n(25894).Z,width:"1500",height:"526"})),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#re-introduction-to-home-assistant-auto-discovery"},"(Re) Introduction to Home Assistant Auto-discovery"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#docker"},"Docker")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#mqtt-autodiscovery"},"MQTT Autodiscovery"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#last-will-trigger"},"Last-Will Trigger")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#shell-script"},"Shell Script")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#automation"},"Automation")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#python-script"},"Python Script"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#broker-configuration"},"Broker Configuration"))))))))),(0,a.kt)("p",null,"The abstracted version to:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://mpolinowski.github.io/docs/IoT-and-Machine-Learning/Home_Automation/2022-07-10-home-assistant-mqtt-autodiscovery-part-i/2022-07-10"},"Home Assistant - MQTT Auto-Discovery :: Configuration")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://mpolinowski.github.io/docs/IoT-and-Machine-Learning/Home_Automation/2022-07-11-home-assistant-mqtt-autodiscovery-part-ii/2022-07-11"},"Home Assistant - MQTT Auto-Discovery :: Automation")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://mpolinowski.github.io/docs/IoT-and-Machine-Learning/Home_Automation/2022-07-12-home-assistant-mqtt-python/2022-07-12"},"Home Assistant - Python Scripts as Service"))),(0,a.kt)("h1",{id:"re-introduction-to-home-assistant-auto-discovery"},"(Re) Introduction to Home Assistant Auto-discovery"),(0,a.kt)("h2",{id:"docker"},"Docker"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"docker pull homeassistant/home-assistant:stable\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir -p /opt/homeassistant/{config}\nchmod -R 775 /opt/homeassistant\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"docker run -d --rm --privileged --net=host --name='home-assistant' -e 'TZ=Europe/Berlin' -v /opt/homeassistant/config:/config homeassistant/home-assistant:stable\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},(0,a.kt)("inlineCode",{parentName:"p"},"http://localhost:8123"))),(0,a.kt)("h2",{id:"mqtt-autodiscovery"},"MQTT Autodiscovery"),(0,a.kt)("h3",{id:"last-will-trigger"},"Last-Will Trigger"),(0,a.kt)("p",null,"Add the Last-Will Topic as an ",(0,a.kt)("strong",{parentName:"p"},"MQTT Sensor")," to your HA configuration file, e.g. ",(0,a.kt)("inlineCode",{parentName:"p"},"/opt/homeassistant/config/configuration.yaml"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yml"},'mqtt:\n  sensor:\n    - device:\n        identifiers: in8401_office\n        manufacturer: INSTAR Deutschland GmbH\n        model: INSTAR 2k+ IN-8401 WLAN\n        name: IN-8401 2k+ Garden\n        configuration_url: "http://192.168.2.120:80"\n      availability:\n        topic: "cameras/120/status/connection"\n        payload_available: \'{"val":"online"}\'\n        payload_not_available: \'{"val":"offline"}\'\n      object_id: in8401_office_testament\n      unique_id: in8401_office_testament\n      name: "LWT Office Camera"\n      state_topic: "cameras/120/status/connection"\n      value_template: "{{ value_json.val }}"\n      icon: mdi:coffin\n      qos: 1\n')),(0,a.kt)("p",null,"The entity will show up once you reload the configuration:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"(Re) Introduction to Home Assistant Auto-discovery",src:n(50228).Z,width:"1101",height:"343"})),(0,a.kt)("p",null,"This entity will change it's value from ",(0,a.kt)("inlineCode",{parentName:"p"},"offline")," to ",(0,a.kt)("inlineCode",{parentName:"p"},"online")," when the camera connects. This event can be used in an ",(0,a.kt)("strong",{parentName:"p"},"Automation")," to trigger a script that automatically adds your camera as an ",(0,a.kt)("strong",{parentName:"p"},"Home Assistant Entity"),"."),(0,a.kt)("h3",{id:"shell-script"},"Shell Script"),(0,a.kt)("p",null,"To be able to use the before mentioned Python script we need to create a tiny shell script that can be used in the ",(0,a.kt)("strong",{parentName:"p"},"Home Assistant Automation"),". Enter your Home Assistant ",(0,a.kt)("inlineCode",{parentName:"p"},"config")," directory, e.g. ",(0,a.kt)("inlineCode",{parentName:"p"},"/opt/homeassistant/config")," and create a sub-directory ",(0,a.kt)("inlineCode",{parentName:"p"},"shell"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir shell\nnano ./shell/mqtt_autodiscover_8401_office.sh\n")),(0,a.kt)("p",null,"The shell script only needs to direct the Python binary to the location you used for the Python Script (that we will create in the last step):"),(0,a.kt)("p",null,(0,a.kt)("em",{parentName:"p"},"mqtt","_","autodiscover","_","8401","_","office.sh")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\npython /config/python_scripts/mqtt5_client.py -f config_topics_8401.json\n")),(0,a.kt)("p",null,"To activate the Shell Extension and expose our script to HA we need to add the following lines to the ",(0,a.kt)("inlineCode",{parentName:"p"},"config/configuration.yml"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"# Auto configure 8401 office with mqtt\nshell_command:\n  mqtt_autodiscover_8401_office: /bin/ash /config/shell/mqtt_autodiscover_8401_office.sh\n")),(0,a.kt)("p",null,"Reload the configuration or restart Home Assistant:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"(Re) Introduction to Home Assistant Auto-discovery",src:n(16227).Z,width:"1318",height:"506"})),(0,a.kt)("h3",{id:"automation"},"Automation"),(0,a.kt)("p",null,"We can now add a new ",(0,a.kt)("strong",{parentName:"p"},"Automation"),":"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"(Re) Introduction to Home Assistant Auto-discovery",src:n(65432).Z,width:"1323",height:"584"})),(0,a.kt)("p",null,"The ",(0,a.kt)("strong",{parentName:"p"},"Automation")," should be triggered every time the ",(0,a.kt)("strong",{parentName:"p"},"Last-Will Entity")," created in the first step changes it's value from ",(0,a.kt)("inlineCode",{parentName:"p"},"offline")," to ",(0,a.kt)("inlineCode",{parentName:"p"},"online")," (",(0,a.kt)("strong",{parentName:"p"},"Note")," these values can be configured in your camera's webUI - see below right): "),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"(Re) Introduction to Home Assistant Auto-discovery",src:n(26388).Z,width:"1762",height:"700"})),(0,a.kt)("p",null,"As ",(0,a.kt)("strong",{parentName:"p"},"Action")," select ",(0,a.kt)("strong",{parentName:"p"},"Call Service")," and to execute the Python script with the ",(0,a.kt)("strong",{parentName:"p"},"Shell Script")," option:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"(Re) Introduction to Home Assistant Auto-discovery",src:n(35423).Z,width:"1463",height:"313"})),(0,a.kt)("p",null,"If the option does not show up in drop down menu verify that you added the shell script and restarted Home Assistant as described in the previous step."),(0,a.kt)("h3",{id:"python-script"},"Python Script"),(0,a.kt)("p",null,"The Python Script provides an MQTT5 Client that will help us auto-registering our camera. All necessary files can be cloned from ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/mpolinowski/ha-mqtt-python/"},"this repository"),". Those are the ",(0,a.kt)("strong",{parentName:"p"},"MQTT Client Script"),", a ",(0,a.kt)("strong",{parentName:"p"},"Configuration File")," that contains your MQTT Broker configuration and a ",(0,a.kt)("strong",{parentName:"p"},"JSON File")," that contains all the MQTT Entities you want to add to Home Assistant that allow you to control your camera:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/mpolinowski/ha-mqtt-python/blob/master/mqtt5_client.py"},"mqtt5_client.py")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/mpolinowski/ha-mqtt-python/blob/master/config.py"},"config.py")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/mpolinowski/ha-mqtt-python/blob/master/config_topics_8401.json"},"config_topics_8401.json")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/mpolinowski/ha-mqtt-python/blob/master/config_topics_9408.json"},"config_topics_9408.json"))),(0,a.kt)("p",null,"Take those files and place them inside a folder called ",(0,a.kt)("inlineCode",{parentName:"p"},"python_scripts")," inside the Home Assistant configuration directory, e.g. ",(0,a.kt)("inlineCode",{parentName:"p"},"/opt/homeassistant/config"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir python_scripts\n")),(0,a.kt)("p",null,"Your configuration directory should now contain the following sub dirs and files:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"/opt/homeassistant/config\n\u251c\u2500\u2500 automations.yaml\n\u251c\u2500\u2500 blueprints\n\u2502\xa0\xa0 \u251c\u2500\u2500 automation\n\u2502\xa0\xa0 \u2514\u2500\u2500 script\n\u251c\u2500\u2500 configuration.yaml\n\u251c\u2500\u2500 deps\n\u251c\u2500\u2500 home-assistant.log\n\u251c\u2500\u2500 home-assistant_v2.db\n\u251c\u2500\u2500 python_scripts\n\u2502\xa0\xa0 \u251c\u2500\u2500 config.py\n\u2502\xa0\xa0 \u251c\u2500\u2500 config_topics_8401.json\n\u2502\xa0\xa0 \u2514\u2500\u2500 mqtt5_client.py\n\u251c\u2500\u2500 scenes.yaml\n\u251c\u2500\u2500 scripts.yaml\n\u251c\u2500\u2500 secrets.yaml\n\u251c\u2500\u2500 shell\n\u2502\xa0\xa0 \u2514\u2500\u2500 mqtt_autodiscover_8401_office.sh\n\u2514\u2500\u2500 tts\n")),(0,a.kt)("h4",{id:"broker-configuration"},"Broker Configuration"),(0,a.kt)("p",null,"Now add your broker configuration to ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/mpolinowski/ha-mqtt-python/blob/master/config.py"},"config.py"),", e.g. :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'mqtt_server_host = "192.168.2.112"\nmqtt_server_port = 1883\nmqtt_bind_address = ""\nmqtt_bind_port = 0\nmqtt_username = "admin"\nmqtt_password = "instar"\nmqtt_transport = "tcp"\nmqtt_keepalive = 60\nmqtt_client_id = "mqtt5_client"\n')),(0,a.kt)("p",null,"This is the configuration that the Python MQTT Client is going to use to connect to your broker when it is triggered by our ",(0,a.kt)("strong",{parentName:"p"},"Home Assistant Automation"),"."))}m.isMDXComponent=!0},50228:(t,e,n)=>{n.d(e,{Z:()=>o});const o=n.p+"assets/images/Home_Assistant_MQTT_Auto-Discovery_01-bd4659f612705452a274d7254e4c1f52.png"},16227:(t,e,n)=>{n.d(e,{Z:()=>o});const o=n.p+"assets/images/Home_Assistant_MQTT_Auto-Discovery_02-218081f6c3deaddf0f539392132cf6cc.png"},65432:(t,e,n)=>{n.d(e,{Z:()=>o});const o=n.p+"assets/images/Home_Assistant_MQTT_Auto-Discovery_03-fdbf767da90761ca48a89aac082af73f.png"},26388:(t,e,n)=>{n.d(e,{Z:()=>o});const o=n.p+"assets/images/Home_Assistant_MQTT_Auto-Discovery_04-00a19823da480fd24de0dae184917eec.png"},35423:(t,e,n)=>{n.d(e,{Z:()=>o});const o=n.p+"assets/images/Home_Assistant_MQTT_Auto-Discovery_05-a791d5a74b606cb3c7799e4068805fdf.png"},25894:(t,e,n)=>{n.d(e,{Z:()=>o});const o=n.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-98d71e33f881256303c68773a2ed92ba.jpg"}}]);