"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[87161],{208568:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>u,frontMatter:()=>s,metadata:()=>i,toc:()=>c});var t=r(785893),a=r(603905);const s={sidebar_position:7050,slug:"2021-08-20",title:"Hashicorp Vault - Setup",authors:"mpolinowski",tags:["Vault","Linux"]},l=void 0,i={id:"DevOps/Hashicorp/2021-08-20--hashicorp-vault-setup/index",title:"Hashicorp Vault - Setup",description:"Victoria Harbour, Hong Kong",source:"@site/docs/DevOps/Hashicorp/2021-08-20--hashicorp-vault-setup/index.md",sourceDirName:"DevOps/Hashicorp/2021-08-20--hashicorp-vault-setup",slug:"/DevOps/Hashicorp/2021-08-20--hashicorp-vault-setup/2021-08-20",permalink:"/docs/DevOps/Hashicorp/2021-08-20--hashicorp-vault-setup/2021-08-20",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Hashicorp/2021-08-20--hashicorp-vault-setup/index.md",tags:[{label:"Vault",permalink:"/docs/tags/vault"},{label:"Linux",permalink:"/docs/tags/linux"}],version:"current",sidebarPosition:7050,frontMatter:{sidebar_position:7050,slug:"2021-08-20",title:"Hashicorp Vault - Setup",authors:"mpolinowski",tags:["Vault","Linux"]},sidebar:"tutorialSidebar",previous:{title:"Hashicorp Vault - Secrets & Tokens",permalink:"/docs/DevOps/Hashicorp/2021-08-21--hashicorp-vault-secrets-tokens/2021-08-21"},next:{title:"Hashicorp Consul Refresher - Gossip TLS Encryption",permalink:"/docs/DevOps/Hashicorp/2021-08-14--hashicorp-consul-tls-encryption/2021-08-14"}},o={},c=[{value:"Installation",id:"installation",level:2},{value:"Download",id:"download",level:3},{value:"Configure Vault",id:"configure-vault",level:3},{value:"Firewall",id:"firewall",level:4},{value:"Prepare System.d Service",id:"prepare-systemd-service",level:3},{value:"Initialize Vault",id:"initialize-vault",level:3},{value:"Accessing the UI",id:"accessing-the-ui",level:2}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.ah)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Victoria Harbour, Hong Kong",src:r(924891).Z+"",width:"1500",height:"463"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"#installation",children:"Installation"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#download",children:"Download"})}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"#configure-vault",children:"Configure Vault"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#firewall",children:"Firewall"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#prepare-systemd-service",children:"Prepare System.d Service"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#initialize-vault",children:"Initialize Vault"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#accessing-the-ui",children:"Accessing the UI"})}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,t.jsxs)(n.p,{children:["Before I was using the package managers to install nomad and consul - and ran into a few issues with it. So now I want to follow the ",(0,t.jsx)(n.a,{href:"https://www.vaultproject.io/downloads",children:"manual installation guide"})," (",(0,t.jsx)(n.em,{children:"see manual binary download"}),") instead."]}),"\n",(0,t.jsx)(n.h3,{id:"download",children:"Download"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"wget https://releases.hashicorp.com/vault/1.8.2/vault_1.8.2_linux_amd64.zip\r\nunzip vault_1.8.2_linux_amd64.zip\r\nsudo mv vault /usr/bin\r\nrm vault_1.8.2_linux_amd64.zip\n"})}),"\n",(0,t.jsx)(n.p,{children:"And verify that it was installed successfully:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"vault -v\r\nVault v1.8.2 (aca76f63357041a43b49f3e8c11d67358496959f)\n"})}),"\n",(0,t.jsx)(n.p,{children:"We can also add the autocomplete function:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"vault -autocomplete-install\r\ncomplete -C /usr/bin/vault vault\n"})}),"\n",(0,t.jsx)(n.h3,{id:"configure-vault",children:"Configure Vault"}),"\n",(0,t.jsx)(n.p,{children:"Create the configuration directory:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo mkdir /etc/vault.d\n"})}),"\n",(0,t.jsx)(n.p,{children:"And create the basic configuration file:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo nano /etc/vault.d/config.hcl\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'storage "consul" {\r\n    address = "192.168.2.110:8500"\r\n    path = "vault/"\r\n}\r\nlistener "tcp" {\r\n    address = "192.168.2.110:8200"\r\n    tls_disable = 1\r\n}\r\napi_addr = "http://192.168.2.110:8200"\r\ncluster_addr = "https://192.168.2.110:8201"\r\nui = true\n'})}),"\n",(0,t.jsxs)(n.p,{children:["As ",(0,t.jsx)(n.strong,{children:"Storage"})," I have chosen the Consul k/v store with a prefix of ",(0,t.jsx)(n.code,{children:"vault/"}),". Alternatively, you can also store the Vault data to file:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'storage "file" {\r\n  path = "/opt/vault/data"\r\n}\n'})}),"\n",(0,t.jsx)(n.h4,{id:"firewall",children:"Firewall"}),"\n",(0,t.jsxs)(n.p,{children:["I used the port ",(0,t.jsx)(n.code,{children:"80"})," here for the Vault service - make sure that your firewall allows traffic in on the port you choose there:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"firewall-cmd --permanent --zone=public --add-port=8200/tcp\r\nfirewall-cmd --permanent --zone=public --add-port=8201/tcp\r\nfirewall-cmd --reload\r\nfirewall-cmd --zone=public --list-ports\n"})}),"\n",(0,t.jsx)(n.h3,{id:"prepare-systemd-service",children:"Prepare System.d Service"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo nano /etc/systemd/system/vault.service\n"})}),"\n",(0,t.jsx)(n.p,{children:"Create the service file:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yml",children:'[Unit]\r\nDescription="HashiCorp Vault - A tool for managing secrets"\r\nDocumentation=https://www.vaultproject.io/docs/\r\nRequires=network-online.target\r\nAfter=network-online.target\r\nConditionFileNotEmpty=/etc/vault.d/config.hcl\r\nStartLimitIntervalSec=60\r\nStartLimitBurst=3\r\n\r\n[Service]\r\nProtectSystem=full\r\nProtectHome=read-only\r\nPrivateTmp=yes\r\nPrivateDevices=yes\r\nSecureBits=keep-caps\r\nAmbientCapabilities=CAP_IPC_LOCK\r\nCapabilities=CAP_IPC_LOCK+ep\r\nCapabilityBoundingSet=CAP_SYSLOG CAP_IPC_LOCK\r\nNoNewPrivileges=yes\r\nExecStart=/usr/bin/vault server -config=/etc/vault.d/config.hcl\r\nExecReload=/bin/kill --signal HUP $MAINPID\r\nKillMode=process\r\nKillSignal=SIGINT\r\nRestart=on-failure\r\nRestartSec=5\r\nTimeoutStopSec=30\r\nStartLimitInterval=60\r\nStartLimitIntervalSec=60\r\nStartLimitBurst=3\r\nLimitNOFILE=65536\r\nLimitMEMLOCK=infinity\r\nLogRateLimitIntervalSec=0\r\nLogRateLimitBurst=0\r\n\r\n[Install]\r\nWantedBy=multi-user.target\n'})}),"\n",(0,t.jsx)(n.p,{children:"Reload SystemD:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo systemctl daemon-reload\r\nservice vault status\n"})}),"\n",(0,t.jsxs)(n.p,{children:["And add the following exports to your shell config (e.g. ",(0,t.jsx)(n.code,{children:"~/bashrc"}),", ",(0,t.jsx)(n.code,{children:"./zshrc"}),"):"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-cfg",children:'echo "export VAULT_ADDR=http://192.168.2.110:8200" >> ~/.zshrc\r\nsource ~/.zshrc\n'})}),"\n",(0,t.jsx)(n.p,{children:"Now we can start the service:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo service vault start\r\nsudo service vault status\r\nsudo systemctl enable vault\n"})}),"\n",(0,t.jsx)(n.h3,{id:"initialize-vault",children:"Initialize Vault"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yml",children:'vault operator init\r\n\r\nUnseal Key 1: vanBssslvadjyp9jptzsAPO4uWGK1ZsT8FYW/qpS36iJ\r\nUnseal Key 2: g6OsArgXl0+K0AUaSZJb8eNXAX1nfdKMdrRJfu8zIug1\r\nUnseal Key 3: MHj+gJhnIgXI6mKxt3lHmtvJEgypaEczGeZF5Ep4uKgX\r\nUnseal Key 4: i8HXZ90nHzo3aku+S37JDzeXGUxZX+H5WE4632gO2cjY\r\nUnseal Key 5: 4ixQc9p7whDWkSr8lW8r5b1w0LodNGOxGIZP5kFdwZ29\r\n\r\nInitial Root Token: s.TFCSNUDRJbuBGjOkgaqSfEQR\r\n\r\nVault initialized with 5 key shares and a key threshold of 3. Please securely\r\ndistribute the key shares printed above. When the Vault is re-sealed,\r\nrestarted, or stopped, you must supply at least 3 of these keys to unseal it\r\nbefore it can start servicing requests.\r\n\r\nVault does not store the generated master key. Without at least 3 keys to\r\nreconstruct the master key, Vault will remain permanently sealed!\r\n\r\nIt is possible to generate new unseal keys, provided you have a quorum of\r\nexisting unseal keys shares. See "vault operator rekey" for more information.\n'})}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"RECOVERY:"})," All the information are stored in the Consul k/v store under the path you defined inside your Vault config ",(0,t.jsx)(n.code,{children:"consul kv get -recurse"}),". To reset all of this first delete all Vault keys from the Consul k/v store ",(0,t.jsx)(n.code,{children:"consul kv delete -recurse vault/"}),", restart Vault ",(0,t.jsx)(n.code,{children:"sudo service vault restart"})," and reinitialize ",(0,t.jsx)(n.code,{children:"vault operator init"})]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["To unseal Vault we now can use ",(0,t.jsx)(n.strong,{children:"three"})," of the ",(0,t.jsx)(n.strong,{children:"Unseal Keys"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yml",children:"vault operator unseal vanBssslvadjyp9jptzsAPO4uWGK1ZsT8FYW/qpS36iJ\r\nKey                Value\r\n---\r\n-----\r\nSeal Type          shamir\r\nInitialized        true\r\nSealed             true\r\nTotal Shares       5\r\nThreshold          3\r\nUnseal Progress    1/3\r\nUnseal Nonce       10ab3b57-8dba-f89b-0ad5-d941d1a8e8dd\r\nVersion            1.8.2\r\nStorage Type       consul\r\nHA Enabled         true\r\n\r\nvault operator unseal g6OsArgXl0+K0AUaSZJb8eNXAX1nfdKMdrRJfu8zIug1\r\n\r\nKey                Value\r\n---\r\n-----\r\nSeal Type          shamir\r\nInitialized        true\r\nSealed             true\r\nTotal Shares       5\r\nThreshold          3\r\nUnseal Progress    2/3\r\nUnseal Nonce       10ab3b57-8dba-f89b-0ad5-d941d1a8e8dd\r\nVersion            1.8.2\r\nStorage Type       consul\r\nHA Enabled         true\r\n\r\nvault operator unseal MHj+gJhnIgXI6mKxt3lHmtvJEgypaEczGeZF5Ep4uKgX\r\n\r\nKey                    Value\r\n---\r\n-----\r\nSeal Type              shamir\r\nInitialized            true\r\nSealed                 false\r\nTotal Shares           5\r\nThreshold              3\r\nVersion                1.8.2\r\nStorage Type           consul\r\nCluster Name           vault-cluster-825513f4\r\nCluster ID             95834c86-b5a6-e3fa-a5d3-a05c977dac8a\r\nHA Enabled             true\r\nHA Cluster             n/a\r\nHA Mode                standby\r\nActive Node Address    <none>\n"})}),"\n",(0,t.jsx)(n.h2,{id:"accessing-the-ui",children:"Accessing the UI"}),"\n",(0,t.jsxs)(n.p,{children:["I have configured Vault to start the user interface on ",(0,t.jsx)(n.code,{children:"http://192.168.2.110:8200"})," - there you can use the root token to unlock the UI:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yml",children:"Initial Root Token: s.TFCSNUDRJbuBGjOkgaqSfEQR\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"HashiCorp Vault",src:r(471240).Z+"",width:"1014",height:"467"})}),"\n",(0,t.jsxs)(n.p,{children:["This token is the ",(0,t.jsx)(n.strong,{children:"Root Token"})," and should not be used by default - I am just going to use it for the set up process and later create a set of different tokens for different tasks. But for now:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-cfg",children:'echo "export VAULT_TOKEN=s.TFCSNUDRJbuBGjOkgaqSfEQR" >> ~/.zshrc\r\nsource ~/.zshrc\n'})}),"\n",(0,t.jsx)(n.p,{children:"This way I am now able to use both the UI and the CLI to interact with the Vault API:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"vault secrets list\r\n\r\nPath          Type         Accessor              Description\r\n----          ----         --------              -----------\r\ncubbyhole/    cubbyhole    cubbyhole_afe308c4    per-token private secret storage\r\nidentity/     identity     identity_76793f2d     identity store\r\nsys/          system       system_88682e7c       system endpoints used for control, policy and debugging\n"})})]})}function u(e={}){const{wrapper:n}={...(0,a.ah)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},603905:(e,n,r)=>{r.d(n,{ah:()=>c});var t=r(667294);function a(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function s(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,t)}return r}function l(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?s(Object(r),!0).forEach((function(n){a(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):s(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function i(e,n){if(null==e)return{};var r,t,a=function(e,n){if(null==e)return{};var r,t,a={},s=Object.keys(e);for(t=0;t<s.length;t++)r=s[t],n.indexOf(r)>=0||(a[r]=e[r]);return a}(e,n);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(t=0;t<s.length;t++)r=s[t],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var o=t.createContext({}),c=function(e){var n=t.useContext(o),r=n;return e&&(r="function"==typeof e?e(n):l(l({},n),e)),r},d={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},u=t.forwardRef((function(e,n){var r=e.components,a=e.mdxType,s=e.originalType,o=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),h=c(r),p=a,g=h["".concat(o,".").concat(p)]||h[p]||d[p]||s;return r?t.createElement(g,l(l({ref:n},u),{},{components:r})):t.createElement(g,l({ref:n},u))}));u.displayName="MDXCreateElement"},471240:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/HashiCorp_Vault_01-13fc225a8dd8970d852b10dfda3192c1.png"},924891:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-4dde297a1a12027e4adf9e84677dc5af.jpg"}}]);