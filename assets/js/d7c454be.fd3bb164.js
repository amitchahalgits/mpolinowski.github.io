"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[95112],{146224:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>i,metadata:()=>a,toc:()=>d});var t=r(785893),s=r(603905);const i={sidebar_position:8080,slug:"2021-02-23",title:"NGINX Redirect based on User Agent",authors:"mpolinowski",tags:["NGINX","Gatsby","Docker"]},o=void 0,a={id:"DevOps/NGINX/2021-02-23-nginx-agent-redirect/index",title:"NGINX Redirect based on User Agent",description:"Tsim Sha Tsui, Hongkong",source:"@site/docs/DevOps/NGINX/2021-02-23-nginx-agent-redirect/index.md",sourceDirName:"DevOps/NGINX/2021-02-23-nginx-agent-redirect",slug:"/DevOps/NGINX/2021-02-23-nginx-agent-redirect/2021-02-23",permalink:"/docs/DevOps/NGINX/2021-02-23-nginx-agent-redirect/2021-02-23",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/NGINX/2021-02-23-nginx-agent-redirect/index.md",tags:[{label:"NGINX",permalink:"/docs/tags/nginx"},{label:"Gatsby",permalink:"/docs/tags/gatsby"},{label:"Docker",permalink:"/docs/tags/docker"}],version:"current",sidebarPosition:8080,frontMatter:{sidebar_position:8080,slug:"2021-02-23",title:"NGINX Redirect based on User Agent",authors:"mpolinowski",tags:["NGINX","Gatsby","Docker"]},sidebar:"tutorialSidebar",previous:{title:"NGINX TCP/UDP Load Balancing",permalink:"/docs/DevOps/NGINX/2022-11-17-nginx-udp-tcp-load-balancing/2022-11-17"},next:{title:"Setting up Certbot Auto-renewal for NGINX (Maintenance Mode)",permalink:"/docs/DevOps/NGINX/2021-07-29--certbot-nginx-autorenewal/2021-07-29"}},c={},d=[{value:"NGINX",id:"nginx",level:2},{value:"Apache2",id:"apache2",level:2},{value:"Getting Started",id:"getting-started",level:3},{value:"Adding the Redirects",id:"adding-the-redirects",level:3}];function l(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.ah)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Tsim Sha Tsui, Hongkong",src:r(778589).Z+"",width:"1500",height:"567"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#nginx",children:"NGINX"})}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"#apache2",children:"Apache2"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#getting-started",children:"Getting Started"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#adding-the-redirects",children:"Adding the Redirects"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["Continuation from ",(0,t.jsx)(n.a,{href:"/docs/DevOps/NGINX/2021-02-22-nginx-docker-ingress/2021-02-22",children:"NGINX Docker Ingress"})]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"https://github.com/mpolinowski/nginx_docker_ingress",children:"Github Repository"})}),"\n",(0,t.jsx)(n.h2,{id:"nginx",children:"NGINX"}),"\n",(0,t.jsxs)(n.p,{children:["I need to offer a URL that redirects user based on the user agent their browser reports. This can be done using a simple ",(0,t.jsx)(n.strong,{children:"IF Statement"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:"server {\r\n    listen 80;\r\n    listen [::]:80;\r\n\r\n    server_name  192.168.2.111;\r\n\r\n    # force all traffic to use https\r\n    return 301 https://$server_name$request_uri;\r\n}\r\n\r\n\r\nserver {\r\n\r\n    listen 443 ssl;\r\n    listen [::]:443 ssl;\r\n\r\n    include /etc/nginx/conf.d/self-signed.conf;\r\n    include /etc/nginx/conf.d/ssl-params.conf;\r\n\r\n    server_name 192.168.2.111;\r\n\r\n    if ( $http_user_agent ~* 'android|blackberry' ) {\r\n       return 301 https://192.168.2.117$request_uri;\r\n     }\r\n\r\n    if ( $http_user_agent ~* 'ipad|iphone|ipod' ) {\r\n       return 301 https://192.168.2.77$request_uri;\r\n     }\r\n\r\n    if ( $http_user_agent ~* 'windows' ) {\r\n       return 301 https://192.168.2.249$request_uri;\r\n     }\r\n\r\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"Now start the ingress with this new configuration file:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"docker run -d -p 443:443 -p 80:80 -v /opt/redirection:/etc/nginx/conf.d --name ingress nginx:1.21.1-alpine\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Accessing the ingress on IP ",(0,t.jsx)(n.code,{children:"192.168.2.111"})," will now upgrade you to ",(0,t.jsx)(n.strong,{children:"HTTPS"})," and then redirect you to another local IP address based on your browser reported user agent:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Android Phones"})," -> ",(0,t.jsx)(n.code,{children:"https://192.168.2.117"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"iPhones Phones"})," -> ",(0,t.jsx)(n.code,{children:"https://192.168.2.77"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Windows Phones"})," -> ",(0,t.jsx)(n.code,{children:"https://192.168.2.249"})]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"apache2",children:"Apache2"}),"\n",(0,t.jsx)(n.h3,{id:"getting-started",children:"Getting Started"}),"\n",(0,t.jsx)(n.p,{children:"Just to see how it works on the other side - here is how to do the same thing in Apache:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"mkdir -p /var/www/html/my.page.com/\r\nchown -R $USER:$USER /var/www/html/my.page.com/\r\nsudo chmod -R 755 /var/www/html/my.page.com\r\nnano /var/www/html/my.page.com/index.html\n"})}),"\n",(0,t.jsx)(n.p,{children:"And add some page content here:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-html",children:"<html>\r\n    <head>\r\n        <title>My App</title>\r\n    </head>\r\n    <body>\r\n        <h1>Hi there!</h1>\r\n    </body>\r\n</html>\n"})}),"\n",(0,t.jsx)(n.p,{children:"Now, create a virtual host file for the domain using the command shown below."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"nano /etc/apache2/sites-available/my.page.com.conf\n"})}),"\n",(0,t.jsx)(n.p,{children:"Now copy and paste the content below and replace the domain my.page.com with your own domain:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-xml",children:"<VirtualHost *:80>\r\n    ServerAdmin admin@my.page.com\r\n    ServerName my.page.com\r\n    ServerAlias www.my.page.com\r\n    DocumentRoot /var/www/html/my.page.com/\r\n    ErrorLog ${APACHE_LOG_DIR}/error.log\r\n    CustomLog ${APACHE_LOG_DIR}/access.log combined\r\n</VirtualHost>\n"})}),"\n",(0,t.jsx)(n.p,{children:"At this point, first test then enable the virtual host file as shown:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"apachectl configtest\r\na2ensite my.page.com.conf\r\nsystemctl restart apache2\n"})}),"\n",(0,t.jsx)(n.h3,{id:"adding-the-redirects",children:"Adding the Redirects"}),"\n",(0,t.jsx)(n.p,{children:"Now add the following lines to your virtual host config:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:"<VirtualHost *:80>\r\n    ServerAdmin admin@my.page.com\r\n    ServerName my.page.com\r\n    ServerAlias www.my.page.com\r\n    RewriteEngine On\r\n    RewriteCond %{HTTP_HOST} my.page.com$ [NC]\r\n    RewriteCond %{HTTP_USER_AGENT} iPhone [OR]\r\n    RewriteCond %{HTTP_USER_AGENT} iPod\r\n    RewriteRule ^(.*)$ https://apps.apple.com/us/app/instarvision/id413109553 [L,R=301]\r\n    RewriteCond %{HTTP_USER_AGENT} iPad [OR]\r\n    RewriteCond %{HTTP_USER_AGENT} Mac\\ OS\\ X\r\n    RewriteRule ^(.*)$ https://apps.apple.com/us/app/instarvision-for-ipad/id767539403 [L,R=301]\r\n    RewriteCond %{HTTP_USER_AGENT} Android\r\n    RewriteRule ^(.*)$ https://play.google.com/store/apps/details?id=de.instar.vision [L,R=301]\r\n    RewriteCond %{HTTP_USER_AGENT} Windows\r\n    RewriteRule ^(.*)$ https://www.microsoft.com/de-de/store/p/instarvision/9nblggh10wtp [L,R=301]\r\n    RewriteCond %{HTTP_USER_AGENT} ^(.*)\r\n    RewriteRule ^(.*)$ https://www.instar.com/support/downloads [L,R=301]\r\n    ErrorLog ${APACHE_LOG_DIR}/error.log\r\n    CustomLog ${APACHE_LOG_DIR}/access.log combined\r\n</VirtualHost>\n"})}),"\n",(0,t.jsx)(n.p,{children:"And test and reload Apache:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"apachectl configtest\r\nsystemctl reload apache2\n"})}),"\n",(0,t.jsx)(n.p,{children:"Verify that the redirects are working and run Certbot to create the SSL certificate and add the Apache configuration for you"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"certbot -d my.page.com\n"})})]})}function h(e={}){const{wrapper:n}={...(0,s.ah)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},603905:(e,n,r)=>{r.d(n,{ah:()=>d});var t=r(667294);function s(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function i(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,t)}return r}function o(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?i(Object(r),!0).forEach((function(n){s(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function a(e,n){if(null==e)return{};var r,t,s=function(e,n){if(null==e)return{};var r,t,s={},i=Object.keys(e);for(t=0;t<i.length;t++)r=i[t],n.indexOf(r)>=0||(s[r]=e[r]);return s}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(t=0;t<i.length;t++)r=i[t],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(s[r]=e[r])}return s}var c=t.createContext({}),d=function(e){var n=t.useContext(c),r=n;return e&&(r="function"==typeof e?e(n):o(o({},n),e)),r},l={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},h=t.forwardRef((function(e,n){var r=e.components,s=e.mdxType,i=e.originalType,c=e.parentName,h=a(e,["components","mdxType","originalType","parentName"]),p=d(r),g=s,u=p["".concat(c,".").concat(g)]||p[g]||l[g]||i;return r?t.createElement(u,o(o({ref:n},h),{},{components:r})):t.createElement(u,o({ref:n},h))}));h.displayName="MDXCreateElement"},778589:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/photo-456tdsfggd_67gfh6dgdf4_d-923afcfaf6c8c7812c07b878b927a8c4.jpg"}}]);