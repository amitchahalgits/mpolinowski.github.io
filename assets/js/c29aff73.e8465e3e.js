"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[14312],{721437:(e,o,t)=>{t.r(o),t.d(o,{assets:()=>l,contentTitle:()=>r,default:()=>u,frontMatter:()=>i,metadata:()=>a,toc:()=>c});var s=t(785893),n=t(603905);const i={sidebar_position:6070,slug:"2022-07-23",title:"Mosquitto Broker from Source",authors:"mpolinowski",tags:["IoT"],image:"https://mpolinowski.github.io/img/search/mqtt.png",description:"Building the Mosquitto MQTT broker from source on an Arch Linux System with Websocket support."},r=void 0,a={id:"Automation_and_Robotics/MQTT/2022-07-23-mosquitto-broker-compilation/index",title:"Mosquitto Broker from Source",description:"Building the Mosquitto MQTT broker from source on an Arch Linux System with Websocket support.",source:"@site/docs/Automation_and_Robotics/MQTT/2022-07-23-mosquitto-broker-compilation/index.md",sourceDirName:"Automation_and_Robotics/MQTT/2022-07-23-mosquitto-broker-compilation",slug:"/Automation_and_Robotics/MQTT/2022-07-23-mosquitto-broker-compilation/2022-07-23",permalink:"/docs/Automation_and_Robotics/MQTT/2022-07-23-mosquitto-broker-compilation/2022-07-23",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Automation_and_Robotics/MQTT/2022-07-23-mosquitto-broker-compilation/index.md",tags:[{label:"IoT",permalink:"/docs/tags/io-t"}],version:"current",sidebarPosition:6070,frontMatter:{sidebar_position:6070,slug:"2022-07-23",title:"Mosquitto Broker from Source",authors:"mpolinowski",tags:["IoT"],image:"https://mpolinowski.github.io/img/search/mqtt.png",description:"Building the Mosquitto MQTT broker from source on an Arch Linux System with Websocket support."},sidebar:"tutorialSidebar",previous:{title:"Mosquitto Broker Docker Cross-Compile",permalink:"/docs/Automation_and_Robotics/MQTT/2022-07-24-mosquitto-broker-cross-compilation/2022-07-24"},next:{title:"Go - MQTT Hello World",permalink:"/docs/Automation_and_Robotics/MQTT/2022-07-22-go-hello-world/2022-07-22"}},l={},c=[{value:"Build on Linux Desktop",id:"build-on-linux-desktop",level:2},{value:"Test Run",id:"test-run",level:3}];function d(e){const o={a:"a",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,n.ah)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(o.p,{children:(0,s.jsx)(o.img,{alt:"Guangzhou, China",src:t(824641).Z+"",width:"2385",height:"962"})}),"\n",(0,s.jsxs)(o.ul,{children:["\n",(0,s.jsxs)(o.li,{children:[(0,s.jsx)(o.a,{href:"#build-on-linux-desktop",children:"Build on Linux Desktop"}),"\n",(0,s.jsxs)(o.ul,{children:["\n",(0,s.jsx)(o.li,{children:(0,s.jsx)(o.a,{href:"#test-run",children:"Test Run"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(o.h2,{id:"build-on-linux-desktop",children:"Build on Linux Desktop"}),"\n",(0,s.jsxs)(o.p,{children:["Start by ",(0,s.jsx)(o.a,{href:"https://mosquitto.org/download/",children:"downloading the source code"}),":"]}),"\n",(0,s.jsx)(o.pre,{children:(0,s.jsx)(o.code,{className:"language-bash",children:"wget https://mosquitto.org/files/source/mosquitto-2.0.15.tar.gz\ntar -xvf mosquitto-2.0.15.tar.gz\nrm -rf mosquitto-2.0.15.tar.gz\ncd ./mosquitto-2.0.15\n"})}),"\n",(0,s.jsxs)(o.p,{children:["Run ",(0,s.jsx)(o.code,{children:"make"})," to build the binary and use the following flags as required:"]}),"\n",(0,s.jsxs)(o.ul,{children:["\n",(0,s.jsxs)(o.li,{children:[(0,s.jsx)(o.strong,{children:"c-ares"})," (libc-ares-dev on Debian based systems) - only when compiled with make WITH_SRV=yes"]}),"\n",(0,s.jsxs)(o.li,{children:[(0,s.jsx)(o.strong,{children:"cJSON"})," - for client JSON output support. Disable with ",(0,s.jsx)(o.code,{children:"make WITH_CJSON=no"})," Auto detected with CMake."]}),"\n",(0,s.jsxs)(o.li,{children:[(0,s.jsx)(o.strong,{children:"libwebsockets"})," (libwebsockets-dev) - enable with ",(0,s.jsx)(o.code,{children:"make WITH_WEBSOCKETS=yes"})]}),"\n",(0,s.jsxs)(o.li,{children:[(0,s.jsx)(o.strong,{children:"openssl"})," (libssl-dev on Debian based systems) - disable with ",(0,s.jsx)(o.code,{children:"make WITH_TLS=no"})]}),"\n",(0,s.jsxs)(o.li,{children:[(0,s.jsx)(o.strong,{children:"pthreads"})," - for client library thread support. This is required to support the mosquitto_loop_start() and mosquitto_loop_stop() functions. If compiled without pthread support, the library isn't guaranteed to be thread safe."]}),"\n",(0,s.jsxs)(o.li,{children:[(0,s.jsx)(o.strong,{children:"uthash / utlist"})," - bundled versions of these headers are provided, disable their use with make ",(0,s.jsx)(o.code,{children:"WITH_BUNDLED_DEPS=no"})]}),"\n",(0,s.jsxs)(o.li,{children:[(0,s.jsx)(o.strong,{children:"xsltproc"})," (xsltproc and docbook-xsl on Debian based systems) - only needed when building from git sources - disable with make ",(0,s.jsx)(o.code,{children:"WITH_DOCS=no"})]}),"\n"]}),"\n",(0,s.jsx)(o.pre,{children:(0,s.jsx)(o.code,{className:"language-bash",children:"make WITH_WEBSOCKETS=yes WITH_CJSON=yes WITH_TLS=yes WITH_BUNDLED_DEPS=yes WITH_DOCS=no\n"})}),"\n",(0,s.jsxs)(o.p,{children:["This will build the binary ",(0,s.jsx)(o.code,{children:"./mosquitto-2.0.15/src/mosquitto"}),"."]}),"\n",(0,s.jsx)(o.h3,{id:"test-run",children:"Test Run"}),"\n",(0,s.jsx)(o.p,{children:"As preparation I will copy the binary to:"}),"\n",(0,s.jsx)(o.pre,{children:(0,s.jsx)(o.code,{className:"language-bash",children:"sudo mkdir /opt/mosquitto\nsudo cp src/mosquitto /opt/mosquitto/\n"})}),"\n",(0,s.jsx)(o.p,{children:"I will also use the password generator that comes with Mosquitto:"}),"\n",(0,s.jsx)(o.pre,{children:(0,s.jsx)(o.code,{className:"language-bash",children:"sudo cp apps/mosquitto_passwd/mosquitto_passwd /opt/mosquitto/\n"})}),"\n",(0,s.jsxs)(o.p,{children:["To run the broker we first have to create a configuration file ",(0,s.jsx)(o.code,{children:"mosquitto.conf"})," - I am going to activate persistance and logging just to see if it working (make sure to use a ",(0,s.jsx)(o.code,{children:"user mosquitto"})," that is available on your system - you can replace mosquitto with your own user):"]}),"\n",(0,s.jsx)(o.pre,{children:(0,s.jsx)(o.code,{className:"language-conf",children:"auto_id_prefix zeroid-\npersistent_client_expiration 1d\nqueue_qos0_messages true\nuser mosquitto\nlistener 1883\nprotocol mqtt\nlistener 1885\nprotocol websockets\nsocket_domain ipv4\nautosave_interval 7200\npersistence true\npersistence_file mosquitto.db\npersistence_location /opt/mosquitto\nlog_dest file /opt/mosquitto/mosquitto.log\nlog_type error\nlog_type warning\nlog_type notice\nlog_type information\nconnection_messages true\nlog_timestamp true\nlog_timestamp_format %Y-%m-%dT%H:%M:%S\nallow_anonymous false\npassword_file /opt/mosquitto/passwordfile\n"})}),"\n",(0,s.jsxs)(o.p,{children:["Now we need to create the ",(0,s.jsx)(o.code,{children:"passwordfile"})," that will hold the broker login. ",(0,s.jsx)(o.code,{children:"mosquitto_passwd"})," is a tool for managing password files for mosquitto."]}),"\n",(0,s.jsxs)(o.p,{children:[(0,s.jsx)(o.strong,{children:"Usage"}),": \tmosquitto_passwd [-H sha512 | -H sha512-pbkdf2] [-c | -D] passwordfile username\nmosquitto_passwd [-H sha512 | -H sha512-pbkdf2] [-c] -b passwordfile username password\nmosquitto_passwd -U passwordfile"]}),"\n",(0,s.jsxs)(o.ul,{children:["\n",(0,s.jsxs)(o.li,{children:[(0,s.jsx)(o.code,{children:"-b"})," : run in batch mode to allow passing passwords on the command line."]}),"\n",(0,s.jsxs)(o.li,{children:[(0,s.jsx)(o.code,{children:"-c"})," : create a new password file. This will overwrite existing files."]}),"\n",(0,s.jsxs)(o.li,{children:[(0,s.jsx)(o.code,{children:"-D"})," : delete the username rather than adding/updating its password."]}),"\n",(0,s.jsxs)(o.li,{children:[(0,s.jsx)(o.code,{children:"-H"})," : specify the hashing algorithm. Defaults to sha512-pbkdf2, which is recommended."]}),"\n",(0,s.jsxs)(o.li,{children:[(0,s.jsx)(o.code,{children:"-U"})," : update a plain text password file to use hashed passwords."]}),"\n"]}),"\n",(0,s.jsx)(o.pre,{children:(0,s.jsx)(o.code,{className:"language-bash",children:"mosquitto_passwd -H sha512-pbkdf2 -b -c passwordfile admin instar\n"})}),"\n",(0,s.jsx)(o.p,{children:"This creates the passwordfile required by our configuration file:"}),"\n",(0,s.jsx)(o.pre,{children:(0,s.jsx)(o.code,{className:"language-bash",children:"cat /opt/mosquitto/passwordfile\nadmin:$7$101$LSO6p87vcuGTol/U$t0jRLUn2iEnpLAiO4FGR7kPZsqgGvEjEabsbwJ4wqbLungrBtwM3D7BKqnNgczKX0XPezzvbgURB0LYvveX2zA==\n"})}),"\n",(0,s.jsxs)(o.p,{children:["Since I am running the broker with the ",(0,s.jsx)(o.code,{children:"mosquitto"})," user I have to make sure that the user is allowed to access all those files inside the directories:"]}),"\n",(0,s.jsx)(o.pre,{children:(0,s.jsx)(o.code,{className:"language-bash",children:"sudo chown mosquitto:mosquitto /opt/mosquitto/*\n"})}),"\n",(0,s.jsx)(o.pre,{children:(0,s.jsx)(o.code,{className:"language-bash",children:"ls -la\ndrwxr-xr-x  2 mosquitto mosquitto    4096 Sep 11 15:36 .\ndrwxr-xr-x 19 root      root         4096 Sep 11 15:13 ..\n-rwxr-xr-x  1 mosquitto mosquitto 1770008 Sep 11 15:14 mosquitto\n-rw-r--r--  1 mosquitto mosquitto     533 Sep 11 15:41 mosquitto.conf\n-rwxr-xr-x  1 mosquitto mosquitto   80232 Sep 11 15:20 mosquitto_passwd\n-rw-r--r--  1 mosquitto mosquitto     119 Sep 11 15:29 passwordfile\n"})}),"\n",(0,s.jsx)(o.p,{children:"Now I can finally start Mosquitto with the following command:"}),"\n",(0,s.jsx)(o.pre,{children:(0,s.jsx)(o.code,{className:"language-bash",children:"./mosquitto -c /opt/mosquitto/mosquitto.conf\n"})}),"\n",(0,s.jsx)(o.p,{children:"I am getting an error message here that the log file could not be written:"}),"\n",(0,s.jsx)(o.pre,{children:(0,s.jsx)(o.code,{className:"language-bash",children:"2022-09-11T16:01:23: Error: Unable to open log file /opt/mosquitto/mosquitto.log for writing.\n"})}),"\n",(0,s.jsx)(o.p,{children:"This will probably also affect the persistance... let's add the files with correct permissions and restart:"}),"\n",(0,s.jsx)(o.pre,{children:(0,s.jsx)(o.code,{className:"language-bash",children:"sudo touch /opt/mosquitto/mosquitto.log\nsudo touch /opt/mosquitto/mosquitto.db\nsudo chown mosquitto:mosquitto /opt/mosquitto/*\n"})}),"\n",(0,s.jsx)(o.p,{children:"Strange, I am still getting write permission errors - let's open this up completely:"}),"\n",(0,s.jsx)(o.pre,{children:(0,s.jsx)(o.code,{className:"language-bash",children:"sudo chmod 777 /opt/mosquitto/*\n"})}),"\n",(0,s.jsxs)(o.p,{children:["Not sure what the issue is here with the ",(0,s.jsx)(o.code,{children:"mosquitto"})," user on my system. But it is working correctly:"]}),"\n",(0,s.jsx)(o.pre,{children:(0,s.jsx)(o.code,{className:"language-bash",children:"cat mosquitto.log\n\n2022-09-11T16:15:04: mosquitto version 2.0.15 starting\n2022-09-11T16:15:04: Config loaded from /opt/mosquitto/mosquitto.conf.\n2022-09-11T16:15:04: Opening ipv4 listen socket on port 1883.\n2022-09-11T16:15:04: Opening ipv6 listen socket on port 1883.\n2022-09-11T16:15:04: Opening websockets listen socket on port 1885.\n2022-09-11T16:15:04: mosquitto version 2.0.15 running\n"})}),"\n",(0,s.jsx)(o.pre,{children:(0,s.jsx)(o.code,{className:"language-bash",children:"netstat -tlnp\n\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    \ntcp        0      0 0.0.0.0:1885            0.0.0.0:*               LISTEN      26215/./mosquitto   \ntcp        0      0 0.0.0.0:1883            0.0.0.0:*               LISTEN      26215/./mosquitto   \ntcp6       0      0 :::1883                 :::*                    LISTEN      26215/./mosquitto\n"})}),"\n",(0,s.jsx)(o.p,{children:"I can test the broker using the MQTT Explorer:"}),"\n",(0,s.jsx)(o.p,{children:(0,s.jsx)(o.img,{alt:"Mosquitto Broker from Source",src:t(454694).Z+"",width:"1016",height:"622"})}),"\n",(0,s.jsxs)(o.p,{children:["The Explorer is going to connect using the Websocket interface on port ",(0,s.jsx)(o.code,{children:"1885"})," and I can add another client - my INSTAR MQTT camera - using classic MQTT on port ",(0,s.jsx)(o.code,{children:"1883"}),". A few seconds later I can see my cameras LWT telling me the connection worked:"]}),"\n",(0,s.jsx)(o.p,{children:(0,s.jsx)(o.img,{alt:"Mosquitto Broker from Source",src:t(342414).Z+"",width:"1190",height:"669"})})]})}function u(e={}){const{wrapper:o}={...(0,n.ah)(),...e.components};return o?(0,s.jsx)(o,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},603905:(e,o,t)=>{t.d(o,{ah:()=>c});var s=t(667294);function n(e,o,t){return o in e?Object.defineProperty(e,o,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[o]=t,e}function i(e,o){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);o&&(s=s.filter((function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable}))),t.push.apply(t,s)}return t}function r(e){for(var o=1;o<arguments.length;o++){var t=null!=arguments[o]?arguments[o]:{};o%2?i(Object(t),!0).forEach((function(o){n(e,o,t[o])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(o){Object.defineProperty(e,o,Object.getOwnPropertyDescriptor(t,o))}))}return e}function a(e,o){if(null==e)return{};var t,s,n=function(e,o){if(null==e)return{};var t,s,n={},i=Object.keys(e);for(s=0;s<i.length;s++)t=i[s],o.indexOf(t)>=0||(n[t]=e[t]);return n}(e,o);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(s=0;s<i.length;s++)t=i[s],o.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(n[t]=e[t])}return n}var l=s.createContext({}),c=function(e){var o=s.useContext(l),t=o;return e&&(t="function"==typeof e?e(o):r(r({},o),e)),t},d={inlineCode:"code",wrapper:function(e){var o=e.children;return s.createElement(s.Fragment,{},o)}},u=s.forwardRef((function(e,o){var t=e.components,n=e.mdxType,i=e.originalType,l=e.parentName,u=a(e,["components","mdxType","originalType","parentName"]),h=c(t),p=n,m=h["".concat(l,".").concat(p)]||h[p]||d[p]||i;return t?s.createElement(m,r(r({ref:o},u),{},{components:t})):s.createElement(m,r({ref:o},u))}));u.displayName="MDXCreateElement"},454694:(e,o,t)=>{t.d(o,{Z:()=>s});const s=t.p+"assets/images/Mosquitto_Compile_from_Source_01-dd049775b00204aca0e6396b4d0e2ffa.png"},342414:(e,o,t)=>{t.d(o,{Z:()=>s});const s=t.p+"assets/images/Mosquitto_Compile_from_Source_02-c16921842a1564b7e518633f5383b06f.png"},824641:(e,o,t)=>{t.d(o,{Z:()=>s});const s=t.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-4dda98a4eb3b498839926e0b6a5039aa.jpg"}}]);