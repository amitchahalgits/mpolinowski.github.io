"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[49822],{444701:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>i,metadata:()=>a,toc:()=>t});var r=s(474848),c=s(28453);const i={sidebar_position:7070,slug:"2021-08-13",title:"Hashicorp Consul Refresher - Access Control Lists",authors:"mpolinowski",tags:["Consul","Linux"]},l=void 0,a={id:"DevOps/Hashicorp/2021-08-13--hashicorp-consul-access-control-lists/index",title:"Hashicorp Consul Refresher - Access Control Lists",description:"Phnom Penh, Cambodia",source:"@site/docs/DevOps/Hashicorp/2021-08-13--hashicorp-consul-access-control-lists/index.md",sourceDirName:"DevOps/Hashicorp/2021-08-13--hashicorp-consul-access-control-lists",slug:"/DevOps/Hashicorp/2021-08-13--hashicorp-consul-access-control-lists/2021-08-13",permalink:"/docs/DevOps/Hashicorp/2021-08-13--hashicorp-consul-access-control-lists/2021-08-13",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Hashicorp/2021-08-13--hashicorp-consul-access-control-lists/index.md",tags:[{label:"Consul",permalink:"/docs/tags/consul"},{label:"Linux",permalink:"/docs/tags/linux"}],version:"current",sidebarPosition:7070,frontMatter:{sidebar_position:7070,slug:"2021-08-13",title:"Hashicorp Consul Refresher - Access Control Lists",authors:"mpolinowski",tags:["Consul","Linux"]},sidebar:"tutorialSidebar",previous:{title:"Hashicorp Consul Refresher - Gossip TLS Encryption",permalink:"/docs/DevOps/Hashicorp/2021-08-14--hashicorp-consul-tls-encryption/2021-08-14"},next:{title:"Hashicorp Consul Refresher - Service Mesh",permalink:"/docs/DevOps/Hashicorp/2021-08-12--hashicorp-consul-service-mesh/2021-08-12"}},o={},t=[{value:"Configuration",id:"configuration",level:2},{value:"Create the initial bootstrap token",id:"create-the-initial-bootstrap-token",level:2},{value:"Adding the Secret Token to your Environment",id:"adding-the-secret-token-to-your-environment",level:3},{value:"Policies",id:"policies",level:2},{value:"Example",id:"example",level:3},{value:"ACL Policies CLI and REST API",id:"acl-policies-cli-and-rest-api",level:3},{value:"Creating ACL Tokens",id:"creating-acl-tokens",level:2}];function d(e){const n={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,c.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Phnom Penh, Cambodia",src:s(862139).A+"",width:"1500",height:"453"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#configuration",children:"Configuration"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"#create-the-initial-bootstrap-token",children:"Create the initial bootstrap token"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#adding-the-secret-token-to-your-environment",children:"Adding the Secret Token to your Environment"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"#policies",children:"Policies"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#example",children:"Example"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#acl-policies-cli-and-rest-api",children:"ACL Policies CLI and REST API"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#creating-acl-tokens",children:"Creating ACL Tokens"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,r.jsxs)(n.p,{children:["To enable ACLs, add the following ",(0,r.jsx)(n.a,{href:"https://www.consul.io/docs/agent/options.html#configuration-key-reference",children:"ACL parameters"})," to the agent's configuration file and then restart the Consul service. In order for ACL configuration to be applied correctly you will need to apply the same parameters to every server and every client in your datacenter."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"nano /etc/consul.d/consul.hcl\n"})}),"\n",(0,r.jsxs)(n.p,{children:["I am going to set the ",(0,r.jsx)(n.strong,{children:"default policy"})," to ",(0,r.jsx)(n.code,{children:"allow"})," for now - so I am not going to have to use ACL tokens before I had a chance to set them up:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'acl = {\r\n  enabled = true\r\n  default_policy = "allow"\r\n  enable_token_persistence = true\r\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"Add those lines to all agents configs and restart the agents:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"service consul restart\n"})}),"\n",(0,r.jsx)(n.h2,{id:"create-the-initial-bootstrap-token",children:"Create the initial bootstrap token"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"consul acl bootstrap\r\n\r\nAccessorID:       26ec3264-b39b-116f-c215-14fed44c6abc\r\nSecretID:         c7fe7af1-ac0c-e8a8-f527-ba5cf75a3865\r\nDescription:      Bootstrap Token (Global Management)\r\nLocal:            false\r\nCreate Time:      2021-09-08 15:00:23.015534911 +0800 HKT\r\nPolicies:         00000000-0000-0000-0000-000000000001 - global-management\n"})}),"\n",(0,r.jsx)(n.p,{children:"The output gives you important information about the token, including the associated policy global-management and SecretID. And trying to use the Consul CLI will now fail - if you don't provide the SecretID token:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"consul acl token list\r\nFailed to retrieve the token list: Unexpected response code: 403 (Permission denied)\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"consul acl token list -token c7fe7af1-ac0c-e8a8-f527-ba5cf75a3865\r\n\r\nAccessorID:       00000000-0000-0000-0000-000000000002\r\nSecretID:         anonymous\r\nDescription:      Anonymous Token\r\nLocal:            false\r\nCreate Time:      2021-09-08 14:59:29.508323787 +0800 HKT\r\nLegacy:           false\r\n\r\nAccessorID:       26ec3264-b39b-116f-c215-14fed44c6abc\r\nSecretID:         c7fe7af1-ac0c-e8a8-f527-ba5cf75a3865\r\nDescription:      Bootstrap Token (Global Management)\r\nLocal:            false\r\nCreate Time:      2021-09-08 15:00:23.015534911 +0800 HKT\r\nLegacy:           false\r\nPolicies:\r\n   00000000-0000-0000-0000-000000000001 - global-management\n"})}),"\n",(0,r.jsx)(n.h3,{id:"adding-the-secret-token-to-your-environment",children:"Adding the Secret Token to your Environment"}),"\n",(0,r.jsx)(n.p,{children:"This might be a security risk - but it is very convenient during development. Adding the SecretID as an environment variable saves you a lot of typing."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"HTTP Token"})}),"\n",(0,r.jsxs)(n.p,{children:["While you are setting up the ACL system, set the ",(0,r.jsx)(n.strong,{children:"CONSUL_HTTP_TOKEN"})," environment variable (",(0,r.jsx)(n.code,{children:"SecretID"}),") to the bootstrap token on one server - you can add this to your shell config, e.g. ",(0,r.jsx)(n.code,{children:".bashrc"}),", ",(0,r.jsx)(n.code,{children:".zshrc"}),", etc.:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"nano ~/.zshrc\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"export CONSUL_HTTP_TOKEN=c7fe7af1-ac0c-e8a8-f527-ba5cf75a3865\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"source ~/.zshrc\n"})}),"\n",(0,r.jsx)(n.p,{children:"Or write the token into a file:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:".zshrc"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"export CONSUL_HTTP_TOKEN_FILE=/opt/consul_certs/token\n"})}),"\n",(0,r.jsx)(n.p,{children:"Or just use the file inside your Consul command like:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"consul acl token list -token-file /opt/token\n"})}),"\n",(0,r.jsxs)(n.p,{children:["And login to the Consul UI with the ",(0,r.jsx)(n.strong,{children:"SecretID"}),":"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Hashicorp Consul ACL Token",src:s(313488).A+"",width:"994",height:"516"})}),"\n",(0,r.jsx)(n.h2,{id:"policies",children:"Policies"}),"\n",(0,r.jsx)(n.p,{children:"Policies are reusable sets of rules that token are bound by. They include:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"ID"})," - Auto-generated public identifier"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Name"})," - A unique, human-readable name"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Description"})," - Optional description"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Rules"})," - Set of rules that grant or deny permissions in Consul"]}),"\n",(0,r.jsx)(n.li,{children:"__Datacenters - The datacenters this policy is valid for"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.strong,{children:"Policy Control Levels"})," are:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"READ"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"WRITE"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"LIST"})," (lists all keys in the Consul k/v store)"]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"DENY"})}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"example",children:"Example"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'key "kv/elasticsearch/elkversion"{\r\n  policy = "write"\r\n}\r\n\r\nservice "elasticsearch"{\r\n  policy = "read"\r\n}\r\n\r\nnode "elasticsearch_01"{\r\n  policy = "write"\r\n}\n'})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["You have permission to read/write to the key ",(0,r.jsx)(n.code,{children:"kv/elasticsearch/elkversion"})," in the Consul K/V Store."]}),"\n",(0,r.jsxs)(n.li,{children:["You only have permission to read all resources related to the service ",(0,r.jsx)(n.code,{children:"elasticsearch"})]}),"\n",(0,r.jsxs)(n.li,{children:["And read/write permission to everything related to the node server ",(0,r.jsx)(n.code,{children:"elasticsearch_01"})]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["You can also use ",(0,r.jsx)(n.em,{children:"Wildcards"})," with ",(0,r.jsx)(n.code,{children:"resource_prefix"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'key_prefix "kv/"{\r\n  policy = "read"\r\n}\r\n\r\nservice_prefix ""{\r\n  policy = "read"\r\n}\n'})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Read all keys and all service resources."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"acl-policies-cli-and-rest-api",children:"ACL Policies CLI and REST API"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"consul acl policy"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"create"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"delete"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"list"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"read"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"update"})}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["We can now create a policy file ",(0,r.jsx)(n.code,{children:"nano elasticsearch_policy.hcl"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'node "consul-minion" {\r\n  policy = "write"\r\n}\r\n\r\nkey_prefix "frontend/elasticsearch"{\r\n  policy = "write"\r\n}\r\n\r\nsessions ""{\r\n  policy = "write"\r\n}\r\n\r\nservice "elasticsearch"{\r\n  policy = "write"\r\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"And use the CLI to register the policy:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'consul acl policy create -name "elasticsearch" -description "Elastic Stack Service" -rules @elasticsearch_policy.hcl -token c7fe7af1-ac0c-e8a8-f527-ba5cf75a3865\r\n\r\nID:           fd5a4edd-c1d0-4307-f078-72c4fd1605df\r\nName:         elasticsearch\r\nDescription:  Elastic Stack Service\r\nDatacenters:\r\nRules:\r\nnode "consul-minion" {\r\n  policy = "write"\r\n}\r\n\r\nkey_prefix "frontend/elasticsearch"{\r\n  policy = "write"\r\n}\r\n\r\nsessions ""{\r\n  policy = "write"\r\n}\r\n\r\nservice "elasticsearch"{\r\n  policy = "write"\r\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"Or you can use the REST API:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'curl -X PUT \\\r\n  --header "X-Consul-Token: c7fe7af1-ac0c-e8a8-f527-ba5cf75a3865" \\\r\n  --data @elasticsearch_policy.hcl \\\r\n  http://192.168.2.110:8500/v1/acl/policy\n'})}),"\n",(0,r.jsx)(n.p,{children:"Alternatively, you can also add/edit policies from the Consul UI:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Hashicorp Consul ACL Token",src:s(227307).A+"",width:"1287",height:"845"})}),"\n",(0,r.jsx)(n.h2,{id:"creating-acl-tokens",children:"Creating ACL Tokens"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"consul acl token"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"clone"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"create"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"delete"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"list"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"read"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"update"})}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["To create a token for the policy ",(0,r.jsx)(n.code,{children:"fd5a4edd-c1d0-4307-f078-72c4fd1605df"})," created earlier:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"consul acl policy list -token c7fe7af1-ac0c-e8a8-f527-ba5cf75a3865\r\n\r\nelasticsearch:\r\n   ID:           fd5a4edd-c1d0-4307-f078-72c4fd1605df\r\n   Description:  Elastic Stack Service\r\n   Datacenters:\r\nglobal-management:\r\n   ID:           00000000-0000-0000-0000-000000000001\r\n   Description:  Builtin Policy that grants unlimited access\r\n   Datacenters:\n"})}),"\n",(0,r.jsx)(n.p,{children:"Run the following command:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"consul acl token create -description 'Elastic Stack Service Token' -policy-id fd5a4edd-c1d0-4307-f078-72c4fd1605df  -token c7fe7af1-ac0c-e8a8-f527-ba5cf75a3865\r\n\r\nAccessorID:       af3bbd81-5917-5628-5f07-3a40413edaa9\r\nSecretID:         40c6f5ef-c9c7-b098-6046-7fed34772834\r\nDescription:      Elastic Stack Service Token\r\nLocal:            false\r\nCreate Time:      2021-09-11 17:44:38.82495481 +0800 HKT\r\nPolicies:\r\n   fd5a4edd-c1d0-4307-f078-72c4fd1605df - elasticsearch\n"})}),"\n",(0,r.jsx)(n.p,{children:"Or you can use the REST API:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'curl -X PUT \\\r\n  --header "X-Consul-Token: c7fe7af1-ac0c-e8a8-f527-ba5cf75a3865" \\\r\n  --data @payload.json \\\r\n  http://192.168.2.110:8500/v1/acl/token\n'})}),"\n",(0,r.jsxs)(n.p,{children:["With ",(0,r.jsx)(n.code,{children:"payload.json"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\r\n  "Description": "Elastic Stack Service Token",\r\n  "Policies": [\r\n    { "ID": "fd5a4edd-c1d0-4307-f078-72c4fd1605df" }\r\n  ]\r\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"And the token will have been added:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"consul acl token list -token c7fe7af1-ac0c-e8a8-f527-ba5cf75a3865\r\n\r\nAccessorID:       af3bbd81-5917-5628-5f07-3a40413edaa9\r\nSecretID:         40c6f5ef-c9c7-b098-6046-7fed34772834\r\nDescription:      Elastic Stack Service Token\r\nLocal:            false\r\nCreate Time:      2021-09-11 17:44:38.82495481 +0800 HKT\r\nLegacy:           false\r\nPolicies:\r\n   fd5a4edd-c1d0-4307-f078-72c4fd1605df - elasticsearch\r\n\r\nAccessorID:       00000000-0000-0000-0000-000000000002\r\nSecretID:         anonymous\r\nDescription:      Anonymous Token\r\nLocal:            false\r\nCreate Time:      2021-09-08 14:59:29.508323787 +0800 HKT\r\nLegacy:           false\r\n\r\nAccessorID:       26ec3264-b39b-116f-c215-14fed44c6abc\r\nSecretID:         c7fe7af1-ac0c-e8a8-f527-ba5cf75a3865\r\nDescription:      Bootstrap Token (Global Management)\r\nLocal:            false\r\nCreate Time:      2021-09-08 15:00:23.015534911 +0800 HKT\r\nLegacy:           false\r\nPolicies:\r\n   00000000-0000-0000-0000-000000000001 - global-management\n"})})]})}function h(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},313488:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Hashicorp_Consul_ACL_Token_01-8392aacb554031f640aa6a8a15899cce.png"},227307:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Hashicorp_Consul_ACL_Token_02-18e4b90b1cdb588236492717606c22e8.png"},862139:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-791f4988598f20c843135210699ae7a5.jpg"},28453:(e,n,s)=>{s.d(n,{R:()=>l,x:()=>a});var r=s(296540);const c={},i=r.createContext(c);function l(e){const n=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:l(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);