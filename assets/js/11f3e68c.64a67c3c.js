"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[81558],{383116:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>t,metadata:()=>i,toc:()=>c});var r=s(785893),a=s(603905);const t={sidebar_position:9070,slug:"2020-06-17",title:"Salt Pillars & Formulas",authors:"mpolinowski",tags:["LINUX","Salt"]},l=void 0,i={id:"DevOps/Salt/2020-06-17--salt-pillars-formulas/index",title:"Salt Pillars & Formulas",description:"Guangzhou, China",source:"@site/docs/DevOps/Salt/2020-06-17--salt-pillars-formulas/index.mdx",sourceDirName:"DevOps/Salt/2020-06-17--salt-pillars-formulas",slug:"/DevOps/Salt/2020-06-17--salt-pillars-formulas/2020-06-17",permalink:"/docs/DevOps/Salt/2020-06-17--salt-pillars-formulas/2020-06-17",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Salt/2020-06-17--salt-pillars-formulas/index.mdx",tags:[{label:"LINUX",permalink:"/docs/tags/linux"},{label:"Salt",permalink:"/docs/tags/salt"}],version:"current",sidebarPosition:9070,frontMatter:{sidebar_position:9070,slug:"2020-06-17",title:"Salt Pillars & Formulas",authors:"mpolinowski",tags:["LINUX","Salt"]},sidebar:"tutorialSidebar",previous:{title:"Salt Execution Order",permalink:"/docs/DevOps/Salt/2020-06-18--salt-execution-order/2020-06-18"},next:{title:"Salt State",permalink:"/docs/DevOps/Salt/2020-06-16--salt-state/2020-06-16"}},o={},c=[{value:"Working with Pillars",id:"working-with-pillars",level:2},{value:"Working with Formulas",id:"working-with-formulas",level:2}];function d(e){const n={a:"a",code:"code",h2:"h2",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.ah)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Guangzhou, China",src:s(56019).Z+"",width:"1500",height:"623"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#working-with-secure-data",children:"Working with Secure Data"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#working-with-formulas",children:"Working with Formulas"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"working-with-pillars",children:"Working with Pillars"}),"\n",(0,r.jsxs)(n.p,{children:["Pillars in Salt is arbitrary, minion-specific data. There is a large volume of ",(0,r.jsx)(n.a,{href:"https://docs.saltstack.com/en/master/ref/pillar/all/index.html",children:"Pillar Modules"})," available to pull this data into Salt from external sources."]}),"\n",(0,r.jsxs)(n.p,{children:["Instructions on how to pull this data in is stored in ",(0,r.jsx)(n.code,{children:"*.sls"})," files. Start by creating the directory ",(0,r.jsx)(n.code,{children:"/srv/pillar"})," and add the following files:"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"top.sls"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"base:\r\n  '*':\r\n    - name\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"Top File"})," sets the permission - what minions have access to a specific file. In this case all minions will have access to the file ",(0,r.jsx)(n.code,{children:"name.sls"}),":"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"name.sls"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"{% if grains.os == 'Ubuntu' %}\r\nname: Ubuntu Rocks\r\n{% elif grains.os == 'Centos' %}\r\nname: CentOS Rocks\r\n{% endif %}\n"})}),"\n",(0,r.jsx)(n.p,{children:"We can clean this up by using a dictionary:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"{% set lookup = {\r\n  'Ubuntu': 'Ubuntu Rocks',\r\n  'Centos': 'Centos Rocks'\r\n} %}\r\n\r\n{% set name = lookup[grains.os] %}\r\n\r\nname: {{ name | json() }}\n"})}),"\n",(0,r.jsx)(n.p,{children:"Or:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"{% set os = salt.grains.filter_by({\r\n    'Ubuntu': {\r\n        'name': 'Ubuntu Rocks'\r\n    },\r\n    'Centos': {\r\n        'name': 'Centos Rocks'\r\n    }\r\n}) %}\r\n\r\nname: {{ os.name }}\n"})}),"\n",(0,r.jsx)(n.p,{children:"Run the following command to update all minions:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo salt '*' saltutil.refresh_pillar\r\n\r\nubuntuAsus:\r\n    True\n"})}),"\n",(0,r.jsx)(n.p,{children:"We can use this data for example in our Apache landing page (see previous tutorial):"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"welcome.sls"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"# Adding a blank front page\r\n{% set name = salt.pillar.get('name') %}\r\n\r\ncheck_pillar_values:\r\n  test.check_pillar:\r\n    - present:\r\n      - name\r\n    - failhard: True\r\n\r\nwelcome_page:\r\n  file.managed:\r\n    - name: /var/www/html/index.html\r\n    - contents: |\r\n        <!doctype html>\r\n        <body>\r\n            <h1>{{ name }}.</h1>\r\n        </body>\n"})}),"\n",(0,r.jsx)(n.p,{children:"You should be able to see that you Minions have access to your pillars:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo salt '*' pillar.items\n"})}),"\n",(0,r.jsx)(n.p,{children:"And check that your front page was updated:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo salt '*' state.sls apache.welcome\n"})}),"\n",(0,r.jsxs)(n.p,{children:["You can also manually set the value of ",(0,r.jsx)(n.code,{children:"name"})," - but this data will be send to all minions and is NOT PRIVATE:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo salt '*' state.sls apache.welcome pillar='{name: Override}'\n"})}),"\n",(0,r.jsx)(n.h2,{id:"working-with-formulas",children:"Working with Formulas"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://docs.saltstack.com/en/latest/topics/development/conventions/formulas.html",children:"Formulas are pre-written Salt States"}),". They are as open-ended as Salt States themselves and can be used for tasks such as installing a package, configuring, and starting a service, setting up users or permissions, and many other common tasks."]}),"\n",(0,r.jsxs)(n.p,{children:["All official Salt Formulas are found as separate Git repositories in the ",(0,r.jsx)(n.a,{href:"https://github.com/saltstack-formulas",children:"'saltstack-formulas' organization on GitHub"}),". They can be downloaded using the ",(0,r.jsx)(n.a,{href:"https://docs.saltstack.com/en/master/ref/file_server/all/salt.fileserver.gitfs.html#module-salt.fileserver.gitfs",children:"GIT Fileserver Backend"}),". To be able to use Git you first have to uncomment it in your ",(0,r.jsx)(n.code,{children:"/etc/salt/master"})," config. Or use a ",(0,r.jsx)(n.code,{children:"local.conf"})," in ",(0,r.jsx)(n.code,{children:"/etc/salt/master.d/local.conf"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"fileserver_backend:\r\n  - git\r\n  - roots\r\n\r\ngitfs_remotes:\r\n  - https://github.com/saltstack-formulas/memcached-formula\n"})}),"\n",(0,r.jsxs)(n.p,{children:["After adding your ",(0,r.jsx)(n.a,{href:"https://github.com/saltstack-formulas",children:"desired Formulas"})," restart the Salt master and use the ",(0,r.jsx)(n.code,{children:"cp.list_master"})," or ",(0,r.jsx)(n.code,{children:"cp.list_states"})," command to get a list of all available configuration files to make sure that ",(0,r.jsx)(n.code,{children:"memcached"})," was successfully cloned from Github:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo systemctl restart salt-master\r\n\r\nsudo salt ubuntuAsus cp.list_states\r\nubuntuAsus:\r\n    - apache\r\n    - apache.map\r\n    - apache.mods\r\n    - apache.welcome\r\n    - memcached\r\n    - memcached.config\r\n    - memcached.libmemcached\r\n    - memcached.macros\r\n    - memcached.python_memcached\r\n    - memcached.uninstall\n"})}),"\n",(0,r.jsx)(n.p,{children:"Continue installing the following package:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"on CentOS"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"yum install https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm\r\nyum install GitPython\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"on Ubuntu"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"sudo apt install python-git-doc\n"})})]})}function h(e={}){const{wrapper:n}={...(0,a.ah)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},603905:(e,n,s)=>{s.d(n,{ah:()=>c});var r=s(667294);function a(e,n,s){return n in e?Object.defineProperty(e,n,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[n]=s,e}function t(e,n){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),s.push.apply(s,r)}return s}function l(e){for(var n=1;n<arguments.length;n++){var s=null!=arguments[n]?arguments[n]:{};n%2?t(Object(s),!0).forEach((function(n){a(e,n,s[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):t(Object(s)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(s,n))}))}return e}function i(e,n){if(null==e)return{};var s,r,a=function(e,n){if(null==e)return{};var s,r,a={},t=Object.keys(e);for(r=0;r<t.length;r++)s=t[r],n.indexOf(s)>=0||(a[s]=e[s]);return a}(e,n);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);for(r=0;r<t.length;r++)s=t[r],n.indexOf(s)>=0||Object.prototype.propertyIsEnumerable.call(e,s)&&(a[s]=e[s])}return a}var o=r.createContext({}),c=function(e){var n=r.useContext(o),s=n;return e&&(s="function"==typeof e?e(n):l(l({},n),e)),s},d={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},h=r.forwardRef((function(e,n){var s=e.components,a=e.mdxType,t=e.originalType,o=e.parentName,h=i(e,["components","mdxType","originalType","parentName"]),u=c(s),m=a,p=u["".concat(o,".").concat(m)]||u[m]||d[m]||t;return s?r.createElement(p,l(l({ref:n},h),{},{components:s})):r.createElement(p,l({ref:n},h))}));h.displayName="MDXCreateElement"},56019:(e,n,s)=>{s.d(n,{Z:()=>r});const r=s.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-a9b30aa80e5cdc115144c7d8a07f3c41.jpg"}}]);