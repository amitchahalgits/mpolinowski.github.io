"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[19852],{259427:(e,s,r)=>{r.r(s),r.d(s,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>o,metadata:()=>i,toc:()=>c});var n=r(785893),t=r(603905);const o={sidebar_position:8060,slug:"2021-03-26",title:"Elasticsearch 7 to log Linux System Events",authors:"mpolinowski",tags:["LINUX","Elasticsearch"]},a=void 0,i={id:"DevOps/Elasticsearch/2021-03-26-elasticsearch7-for-syslog-messages/index",title:"Elasticsearch 7 to log Linux System Events",description:"Harbin, China",source:"@site/docs/DevOps/Elasticsearch/2021-03-26-elasticsearch7-for-syslog-messages/index.md",sourceDirName:"DevOps/Elasticsearch/2021-03-26-elasticsearch7-for-syslog-messages",slug:"/DevOps/Elasticsearch/2021-03-26-elasticsearch7-for-syslog-messages/2021-03-26",permalink:"/docs/DevOps/Elasticsearch/2021-03-26-elasticsearch7-for-syslog-messages/2021-03-26",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Elasticsearch/2021-03-26-elasticsearch7-for-syslog-messages/index.md",tags:[{label:"LINUX",permalink:"/docs/tags/linux"},{label:"Elasticsearch",permalink:"/docs/tags/elasticsearch"}],version:"current",sidebarPosition:8060,frontMatter:{sidebar_position:8060,slug:"2021-03-26",title:"Elasticsearch 7 to log Linux System Events",authors:"mpolinowski",tags:["LINUX","Elasticsearch"]},sidebar:"tutorialSidebar",previous:{title:"Elasticsearch 7 Aggregations",permalink:"/docs/DevOps/Elasticsearch/2021-03-27-elasticsearch7-aggregations/2021-03-27"},next:{title:"Log all the searches going through Elasticsearch",permalink:"/docs/DevOps/Elasticsearch/2021-03-25-elasticsearch7-activate-logging-of-search-queries/2021-03-25"}},l={},c=[{value:"Configuring Logstash",id:"configuring-logstash",level:2},{value:"Running Logstash",id:"running-logstash",level:2},{value:"Kibana",id:"kibana",level:2}];function g(e){const s={a:"a",blockquote:"blockquote",code:"code",em:"em",h2:"h2",img:"img",p:"p",pre:"pre",...(0,t.ah)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(s.p,{children:(0,n.jsx)(s.img,{alt:"Harbin, China",src:r(824147).Z+"",width:"1500",height:"376"})}),"\n",(0,n.jsxs)(s.p,{children:["Logstash together with Remote Syslog (",(0,n.jsx)(s.em,{children:"rsyslog"}),") can monitor remote host systems via an UDP or TCP connection. But I personally prefer to use ",(0,n.jsx)(s.a,{href:"/docs/DevOps/Zabbix/2020-07-15--zabbix-docker-installation/2020-07-15",children:"Zabbix to monitor remote servers"}),". But it might be interesting to spin up an ELK cluster on your server to debug a problem. For this I am going to use Logstash to monitor the local ",(0,n.jsx)(s.code,{children:"/var/log/syslog"}),":"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"head -10 /var/log/syslog \n"})}),"\n",(0,n.jsx)(s.h2,{id:"configuring-logstash",children:"Configuring Logstash"}),"\n",(0,n.jsxs)(s.p,{children:["And I am going to use the ",(0,n.jsx)(s.a,{href:"https://github.com/coralogix-resources/logstash-syslog/blob/master/logstash-monitoring-syslog.conf",children:"Coralogix Logstash configuration file"})," to run Logstash:"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-json",children:'input {\r\n  file {\r\n     path => ["/usr/share/logstash/syslog"]\r\n     type => "syslog"\r\n     start_position => "beginning"\r\n   }\r\n}\r\nfilter {\r\n       if [type] == "syslog" {\r\n    grok {\r\n      match => { "message" => "%{SYSLOGTIMESTAMP:syslog_timestamp} %{SYSLOGHOST:syslog_hostname} %{DATA:syslog_program}(?:\\[%{POSINT:syslog_pid}\\])?: %{GREEDYDATA:syslog_message}" }\r\n      add_field => [ "received_at", "%{@timestamp}" ]\r\n      add_field => [ "received_from", "%{host}" ]\r\n    }\r\n    date {\r\n      match => [ "syslog_timestamp", "MMM  d HH:mm:ss", "MMM dd HH:mm:ss" ]\r\n      target => "syslog_timestamp"\r\n    }\r\n  }\r\n}\r\noutput{\r\n  elasticsearch{\r\n    hosts => ["localhost:9200"] \r\n    index => "syslog-monitor" \r\n  }\r\n}\n'})}),"\n",(0,n.jsx)(s.h2,{id:"running-logstash",children:"Running Logstash"}),"\n",(0,n.jsx)(s.p,{children:"I will now try to ingest the entire log into Elasticsearch using my Logstash container:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:'docker run \\\r\n   --name logstash \\\r\n   --net=host \\\r\n   --rm -it \\\r\n   -v /opt/logstash/pipeline/logstash.conf:/usr/share/logstash/pipeline/logstash.conf \\\r\n   -v /var/log/syslog:/usr/share/logstash/syslog:Z \\\r\n   -e "ELASTIC_HOST=localhost:9200" \\\r\n   -e "XPACK_SECURITY_ENABLED=false" \\\r\n   -e "XPACK_REPORTING_ENABLED=false" \\\r\n   -e "XPACK_MONITORING_ENABLED=false" \\\r\n   -e "XPACK_MONITORING_ELASTICSEARCH_USERNAME=elastic" \\\r\n   -e "XPACK_MONITORING_ELASTICSEARCH_PASSWORD=changeme" \\\r\n   logstash:7.13.4\n'})}),"\n",(0,n.jsxs)(s.blockquote,{children:["\n",(0,n.jsxs)(s.p,{children:["I ran into permission issues here: ",(0,n.jsx)(s.code,{children:'failed to open file {:path=>"/usr/share/logstash/syslog", :exception=>Errno::EACCES, :message=>"Permission denied - /usr/share/logstash/syslog"}'}),". Had to chmod the syslog file to give Docker access."]}),"\n"]}),"\n",(0,n.jsx)(s.p,{children:"Logstash is running quietly in the background. To check if there is content data being indexed run the following command and you should see last 2 documents that were generated:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"curl -XGET \"http://localhost:9200/syslog-monitor/_search?pretty\"  -H 'Content-Type: application/json' -d ' { \"size\": 2 }'\n"})}),"\n",(0,n.jsx)(s.p,{children:"And it looks like it is working:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-json",children:'{\r\n  "took" : 0,\r\n  "timed_out" : false,\r\n  "_shards" : {\r\n    "total" : 1,\r\n    "successful" : 1,\r\n    "skipped" : 0,\r\n    "failed" : 0\r\n  },\r\n  "hits" : {\r\n    "total" : {\r\n      "value" : 8307,\r\n      "relation" : "eq"\r\n    },\r\n    "max_score" : 1.0,\r\n    "hits" : [\r\n      {\r\n        "_index" : "syslog-monitor",\r\n        "_type" : "_doc",\r\n        "_id" : "CBVIDHsBhWUvimFeD-Tj",\r\n        "_score" : 1.0,\r\n        "_source" : {\r\n          "syslog_message" : "var-lib-docker-overlay2-eb8de377cf683367ca97a620a723c4c6ddd7ccd68090fb050c9ab427ea5c2d47-merged.mount: Succeeded.",\r\n          "type" : "syslog",\r\n          "syslog_program" : "systemd",\r\n          "syslog_hostname" : "debian11",\r\n          "received_at" : "2021-08-03T13:50:54.304Z",\r\n          "syslog_timestamp" : "2021-08-03T21:46:24.000Z",\r\n          "host" : "debian11",\r\n          "@timestamp" : "2021-08-03T13:50:54.304Z",\r\n          "path" : "/usr/share/logstash/syslog",\r\n          "syslog_pid" : "1",\r\n          "received_from" : "debian11",\r\n          "message" : "Aug  3 21:46:24 debian11 systemd[1]: var-lib-docker-overlay2-eb8de377cf683367ca97a620a723c4c6ddd7ccd68090fb050c9ab427ea5c2d47-merged.mount: Succeeded.",\r\n          "@version" : "1"\r\n        }\r\n      },\r\n      {\r\n        "_index" : "syslog-monitor",\r\n        "_type" : "_doc",\r\n        "_id" : "CRVLDHsBhWUvimFeuuQO",\r\n        "_score" : 1.0,\r\n        "_source" : {\r\n          "@timestamp" : "2021-08-03T13:54:53.923Z",\r\n          "syslog_message" : "Finished Rotate log files.",\r\n          "type" : "syslog",\r\n          "host" : "debian11",\r\n          "syslog_hostname" : "debian11",\r\n          "received_at" : "2021-08-03T13:54:53.923Z",\r\n          "received_from" : "debian11",\r\n          "syslog_program" : "systemd",\r\n          "@version" : "1",\r\n          "path" : "/usr/share/logstash/syslog",\r\n          "syslog_timestamp" : "2021-08-01T17:55:44.000Z",\r\n          "syslog_pid" : "1",\r\n          "message" : "Aug  1 17:55:44 debian11 systemd[1]: Finished Rotate log files."\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\n'})}),"\n",(0,n.jsx)(s.h2,{id:"kibana",children:"Kibana"}),"\n",(0,n.jsxs)(s.p,{children:["I can now create an Index Pattern in Kibana with ",(0,n.jsx)(s.code,{children:"received_at"})," as the primary time field:"]}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.img,{alt:"Logstash for Syslogs",src:r(541558).Z+"",width:"1497",height:"479"})}),"\n",(0,n.jsx)(s.p,{children:"And drill down the log entries on a time line:"}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.img,{alt:"Logstash for Syslogs",src:r(20861).Z+"",width:"1489",height:"703"})})]})}function d(e={}){const{wrapper:s}={...(0,t.ah)(),...e.components};return s?(0,n.jsx)(s,{...e,children:(0,n.jsx)(g,{...e})}):g(e)}},603905:(e,s,r)=>{r.d(s,{ah:()=>c});var n=r(667294);function t(e,s,r){return s in e?Object.defineProperty(e,s,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[s]=r,e}function o(e,s){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);s&&(n=n.filter((function(s){return Object.getOwnPropertyDescriptor(e,s).enumerable}))),r.push.apply(r,n)}return r}function a(e){for(var s=1;s<arguments.length;s++){var r=null!=arguments[s]?arguments[s]:{};s%2?o(Object(r),!0).forEach((function(s){t(e,s,r[s])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(s){Object.defineProperty(e,s,Object.getOwnPropertyDescriptor(r,s))}))}return e}function i(e,s){if(null==e)return{};var r,n,t=function(e,s){if(null==e)return{};var r,n,t={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],s.indexOf(r)>=0||(t[r]=e[r]);return t}(e,s);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],s.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(t[r]=e[r])}return t}var l=n.createContext({}),c=function(e){var s=n.useContext(l),r=s;return e&&(r="function"==typeof e?e(s):a(a({},s),e)),r},g={inlineCode:"code",wrapper:function(e){var s=e.children;return n.createElement(n.Fragment,{},s)}},d=n.forwardRef((function(e,s){var r=e.components,t=e.mdxType,o=e.originalType,l=e.parentName,d=i(e,["components","mdxType","originalType","parentName"]),h=c(r),m=t,p=h["".concat(l,".").concat(m)]||h[m]||g[m]||o;return r?n.createElement(p,a(a({ref:s},d),{},{components:r})):n.createElement(p,a({ref:s},d))}));d.displayName="MDXCreateElement"},541558:(e,s,r)=>{r.d(s,{Z:()=>n});const n=r.p+"assets/images/Logstash_for_Syslogs_01-7da163880bb8b9131d6d293125f63755.png"},20861:(e,s,r)=>{r.d(s,{Z:()=>n});const n=r.p+"assets/images/Logstash_for_Syslogs_02-49dc0db2229731bdfa8dd7d2d016ca25.png"},824147:(e,s,r)=>{r.d(s,{Z:()=>n});const n=r.p+"assets/images/photo-456tdsfggd_67gfh6dgdf4_d-ead0c98a32466e0f9eb24be25c9fe588.jpg"}}]);