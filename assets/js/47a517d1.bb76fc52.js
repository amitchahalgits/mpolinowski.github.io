"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[62671],{158109:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>h,frontMatter:()=>r,metadata:()=>a,toc:()=>c});var s=t(474848),o=t(28453);const r={sidebar_position:9070,slug:"2020-08-19",title:"Joining Consul Clients",authors:"mpolinowski",tags:["LINUX","Consul"]},i=void 0,a={id:"DevOps/Hashicorp/2020-08-18--consul-mock-datacenter/index",title:"Joining Consul Clients",description:"TST, Hong Kong",source:"@site/docs/DevOps/Hashicorp/2020-08-18--consul-mock-datacenter/index.md",sourceDirName:"DevOps/Hashicorp/2020-08-18--consul-mock-datacenter",slug:"/DevOps/Hashicorp/2020-08-18--consul-mock-datacenter/2020-08-19",permalink:"/docs/DevOps/Hashicorp/2020-08-18--consul-mock-datacenter/2020-08-19",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Hashicorp/2020-08-18--consul-mock-datacenter/index.md",tags:[{label:"LINUX",permalink:"/docs/tags/linux"},{label:"Consul",permalink:"/docs/tags/consul"}],version:"current",sidebarPosition:9070,frontMatter:{sidebar_position:9070,slug:"2020-08-19",title:"Joining Consul Clients",authors:"mpolinowski",tags:["LINUX","Consul"]},sidebar:"tutorialSidebar",previous:{title:"Consul Service Mesh",permalink:"/docs/DevOps/Hashicorp/2020-08-18--consul-service-mesh/2020-08-18"},next:{title:"Installing HashiCorp Consul on Ubuntu Server 20.04",permalink:"/docs/DevOps/Hashicorp/2020-08-17--installing-consul-ubuntu/2020-08-17"}},l={},c=[{value:"Start the Agents",id:"start-the-agents",level:2},{value:"Join the Agents",id:"join-the-agents",level:2}];function d(e){const n={a:"a",code:"code",em:"em",h2:"h2",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"TST, Hong Kong",src:t(659931).A+"",width:"1500",height:"562"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#start-the-agents",children:"Start the Agents"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#join-the-agents",children:"Join the Agents"})}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"When a new Consul agent starts, it doesn't know about other agents; it is essentially a datacenter with one member. Agents learn about each other in two ways. To add a new agent to an existing datacenter you give it the IP address of any other agent in the datacenter (either a client or a server), which causes the new agent to join the datacenter. Once the agent is a member of the new datacenter, it automatically learns about the other agents via gossip."}),"\n",(0,s.jsx)(n.p,{children:"In this tutorial, we will configure the Consul agent to run in server mode instead of the dev mode we used earlier. This is done via the following command line flags:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.em,{children:"(In production you would provide these settings to consul in a configuration file.)"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"server"})," - Providing this flag specifies that you want the agent to start in server mode."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"-bootstrap-expect"})," - This tells the Consul server how many servers the datacenter should have in total. All the servers will wait for this number to join before bootstrapping the replicated log, which keeps data consistent across all the servers. Because you are setting up a one-server datacenter, you'll set this value to ",(0,s.jsx)(n.code,{children:"1"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"-node"})," - Each node in a datacenter must have a unique name. By default, Consul uses the hostname of the machine, but you'll manually override it, and set it to ",(0,s.jsx)(n.code,{children:"consul-server"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"-bind"})," - This is the address that this agent will listen on for communication from other Consul members. It must be accessible by all other nodes in the datacenter. If you don't set a bind address Consul will try to listen on all IPv4 interfaces and will fail to start if it finds multiple private IPs. Since production servers often have multiple interfaces, you should always provide a bind address. In my case this is ",(0,s.jsx)(n.code,{children:"192.168.2.110"})," for the server and ",(0,s.jsx)(n.code,{children:"192.168.2.111"})," for the client."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"data-dir"})," - This flag tells Consul agents where they should store their state, which can include sensitive data like ACL tokens for both servers and clients. In production deployments you should be careful about the permissions for this directory. I will create a directory ",(0,s.jsx)(n.code,{children:"/tmp/consul-test"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"config-dir"})," - This flag tells consul where to look for its configuration. You will set it to a standard location: ",(0,s.jsx)(n.code,{children:"/etc/consul.d"}),"."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"start-the-agents",children:"Start the Agents"}),"\n",(0,s.jsx)(n.p,{children:"Start your first Consul agent by running the following command. Consul will start up in the foreground of your terminal window:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Server"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"consul agent \\\r\n  -server \\\r\n  -bootstrap-expect=1 \\\r\n  -node=consul-server \\\r\n  -bind=192.168.2.110 \\\r\n  -data-dir=/tmp/consul-test \\\r\n  -config-dir=/etc/consul.d\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Client"})}),"\n",(0,s.jsxs)(n.p,{children:["And on your client server - in my case IP ",(0,s.jsx)(n.code,{children:"192.168.2.111"})," - execute the Consul service with:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"consul agent \\\r\n  -node=consul-client1 \\\r\n  -bind=192.168.2.111 \\\r\n  -enable-script-checks=true \\\r\n  -data-dir=/tmp/consul-test \\\r\n  -config-dir=/etc/consul.d\n"})}),"\n",(0,s.jsx)(n.p,{children:"Now you have two Consul agents running: one server and one client. The two agents still don't know about each other and each comprise their own single-node datacenters:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"consul members\r\n\r\nNode           Address             Status  Type    Build  Protocol  DC   Segment\r\nconsul-server  192.168.2.110:8301  alive   server  1.8.3  2         dc1  <all>\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"consul members\r\n              \r\nNode       Address             Status  Type    Build  Protocol  DC   Segment\r\nagent-two  192.168.2.111:8301  alive   client  1.8.3  2         dc1  <default>\n"})}),"\n",(0,s.jsx)(n.h2,{id:"join-the-agents",children:"Join the Agents"}),"\n",(0,s.jsx)(n.p,{children:"Run the consul join command on the Consul server, giving it the bind address of the Consul client:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"consul join 192.168.2.111\r\n\r\nSuccessfully joined cluster by contacting 1 nodes.\n"})}),"\n",(0,s.jsx)(n.p,{children:"You can verify that the client was added by typing:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Server"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"consul members\r\n\r\nNode           Address             Status  Type    Build  Protocol  DC   Segment\r\nconsul-server  192.168.2.110:8301  alive   server  1.8.3  2         dc1  <all>\r\nagent-two      192.168.2.111:8301  alive   client  1.8.3  2         dc1  <default>\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Client"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"consul members\r\n              \r\nNode           Address             Status  Type    Build  Protocol  DC   Segment\r\nconsul-server  192.168.2.110:8301  alive   server  1.8.3  2         dc1  <all>\r\nagent-two      192.168.2.111:8301  alive   client  1.8.3  2         dc1  <default>\n"})}),"\n",(0,s.jsxs)(n.p,{children:["In production, new Consul agents should automatically join the datacenter without human intervention. You can provide hard-coded addresses of known Consul agents to new agents using the ",(0,s.jsx)(n.code,{children:"-join"})," flag or ",(0,s.jsx)(n.code,{children:"start_join"})," setting."]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},659931:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-57269f97e6ae2616c9623b1eb52b5373.jpg"},28453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>a});var s=t(296540);const o={},r=s.createContext(o);function i(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);