"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[31919],{821107:(n,e,r)=>{r.r(e),r.d(e,{assets:()=>i,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>c,toc:()=>l});var t=r(474848),s=r(28453);const a={sidebar_position:9080,slug:"2020-12-24",title:"Tomcat 9 Cluster & Loadbalancing",authors:"mpolinowski",tags:["LINUX","Tomcat"]},o=void 0,c={id:"DevOps/Tomcat/2020-12-24-tomcat9-cluster-and-load-balancing/index",title:"Tomcat 9 Cluster & Loadbalancing",description:"Siem Reap, Cambodia",source:"@site/docs/DevOps/Tomcat/2020-12-24-tomcat9-cluster-and-load-balancing/index.md",sourceDirName:"DevOps/Tomcat/2020-12-24-tomcat9-cluster-and-load-balancing",slug:"/DevOps/Tomcat/2020-12-24-tomcat9-cluster-and-load-balancing/2020-12-24",permalink:"/docs/DevOps/Tomcat/2020-12-24-tomcat9-cluster-and-load-balancing/2020-12-24",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Tomcat/2020-12-24-tomcat9-cluster-and-load-balancing/index.md",tags:[{label:"LINUX",permalink:"/docs/tags/linux"},{label:"Tomcat",permalink:"/docs/tags/tomcat"}],version:"current",sidebarPosition:9080,frontMatter:{sidebar_position:9080,slug:"2020-12-24",title:"Tomcat 9 Cluster & Loadbalancing",authors:"mpolinowski",tags:["LINUX","Tomcat"]},sidebar:"tutorialSidebar",previous:{title:"Tomcat 10 Docker Cluster",permalink:"/docs/DevOps/Tomcat/2020-12-25-tomcat10-docker-cluster/2020-12-25"},next:{title:"Tomcat 9 Configuration",permalink:"/docs/DevOps/Tomcat/2020-12-23-tomcat9-configuration/2020-12-23"}},i={},l=[{value:"Creating Multiple Server Instances",id:"creating-multiple-server-instances",level:2},{value:"Duplicating our Server Code",id:"duplicating-our-server-code",level:3},{value:"Assigning Server Ports",id:"assigning-server-ports",level:3},{value:"Creating Startup Scripts",id:"creating-startup-scripts",level:3},{value:"Loadbalancing - Vertical Cluster",id:"loadbalancing---vertical-cluster",level:2},{value:"Setting Up NGINX",id:"setting-up-nginx",level:3}];function d(n){const e={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...n.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.p,{children:(0,t.jsx)(e.img,{alt:"Siem Reap, Cambodia",src:r(354473).A+"",width:"1500",height:"706"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"#creating-multiple-server-instances",children:"Creating Multiple Server Instances"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"#duplicating-our-server-code",children:"Duplicating our Server Code"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"#assigning-server-ports",children:"Assigning Server Ports"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"#creating-startup-scripts",children:"Creating Startup Scripts"})}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"#loadbalancing---vertical-cluster",children:"Loadbalancing - Vertical Cluster"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"#setting-up-nginx",children:"Setting Up NGINX"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:"I now want to create several instances of the Tomcat server on a single LINUX server. This is the kind of setup you would use for an microservice driven web app. For this case I will create 1:1 copies of the original server and latter add NGINX in front of it to balance out the load."}),"\n",(0,t.jsx)(e.h2,{id:"creating-multiple-server-instances",children:"Creating Multiple Server Instances"}),"\n",(0,t.jsx)(e.h3,{id:"duplicating-our-server-code",children:"Duplicating our Server Code"}),"\n",(0,t.jsxs)(e.p,{children:["Start by copying ",(0,t.jsx)(e.strong,{children:"everything but"})," the ",(0,t.jsx)(e.code,{children:"/lib"})," and ",(0,t.jsx)(e.code,{children:"/bin"})," directory from your Tomcat installation dir into 3 new folder next to the installation dir - ",(0,t.jsx)(e.code,{children:"instance1"}),", ",(0,t.jsx)(e.code,{children:"instance2"})," and ",(0,t.jsx)(e.code,{children:"instance3"}),":"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"Directories\r\n\u251c\u2500\u2500 apache-tomcat-9.0.41\r\n\u2502  \u251c\u2500\u2500 bin\r\n\u2502  \u251c\u2500\u2500 conf\r\n\u2502  \u251c\u2500\u2500 lib\r\n\u2502  \u251c\u2500\u2500 logs\r\n\u2502  \u251c\u2500\u2500 temp\r\n\u2502  \u251c\u2500\u2500 virtual-hosts\r\n\u2502  \u2502  \u251c\u2500\u2500 host1\r\n\u2502  \u2502  \u251c\u2500\u2500 host2\r\n\u2502  \u2502  \u2514\u2500\u2500 host3\r\n\u2502  \u251c\u2500\u2500 webapps\r\n\u2502  \u2502  \u251c\u2500\u2500 boilerplate\r\n\u2502  \u2502  \u251c\u2500\u2500 docs\r\n\u2502  \u2502  \u251c\u2500\u2500 examples\r\n\u2502  \u2502  \u251c\u2500\u2500 host-manager\r\n\u2502  \u2502  \u251c\u2500\u2500 manager\r\n\u2502  \u2502  \u2514\u2500\u2500 ROOT\r\n\u2502  \u2514\u2500\u2500 work\r\n\u251c\u2500\u2500 instance1\r\n\u2502  \u251c\u2500\u2500 conf\r\n\u2502  \u251c\u2500\u2500 logs\r\n\u2502  \u251c\u2500\u2500 temp\r\n\u2502  \u251c\u2500\u2500 virtual-hosts\r\n\u2502  \u2502  \u251c\u2500\u2500 host1\r\n\u2502  \u2502  \u251c\u2500\u2500 host2\r\n\u2502  \u2502  \u2514\u2500\u2500 host3\r\n\u2502  \u251c\u2500\u2500 webapps\r\n\u2502  \u2502  \u251c\u2500\u2500 boilerplate\r\n\u2502  \u2502  \u251c\u2500\u2500 docs\r\n\u2502  \u2502  \u251c\u2500\u2500 examples\r\n\u2502  \u2502  \u251c\u2500\u2500 host-manager\r\n\u2502  \u2502  \u251c\u2500\u2500 manager\r\n\u2502  \u2502  \u2514\u2500\u2500 ROOT\r\n\u2502  \u2514\u2500\u2500 work\r\n\u251c\u2500\u2500 instance2\r\n\u2502  \u251c\u2500\u2500 conf\r\n\u2502  \u251c\u2500\u2500 logs\r\n\u2502  \u251c\u2500\u2500 temp\r\n\u2502  \u251c\u2500\u2500 virtual-hosts\r\n\u2502  \u2502  \u251c\u2500\u2500 host1\r\n\u2502  \u2502  \u251c\u2500\u2500 host2\r\n\u2502  \u2502  \u2514\u2500\u2500 host3\r\n\u2502  \u251c\u2500\u2500 webapps\r\n\u2502  \u2502  \u251c\u2500\u2500 boilerplate\r\n\u2502  \u2502  \u251c\u2500\u2500 docs\r\n\u2502  \u2502  \u251c\u2500\u2500 examples\r\n\u2502  \u2502  \u251c\u2500\u2500 host-manager\r\n\u2502  \u2502  \u251c\u2500\u2500 manager\r\n\u2502  \u2502  \u2514\u2500\u2500 ROOT\r\n\u2502  \u2514\u2500\u2500 work\r\n\u251c\u2500\u2500 instance3\r\n\u2502  \u251c\u2500\u2500 conf\r\n\u2502  \u251c\u2500\u2500 logs\r\n\u2502  \u251c\u2500\u2500 temp\r\n\u2502  \u251c\u2500\u2500 virtual-hosts\r\n\u2502  \u2502  \u251c\u2500\u2500 host1\r\n\u2502  \u2502  \u251c\u2500\u2500 host2\r\n\u2502  \u2502  \u2514\u2500\u2500 host3\r\n\u2502  \u251c\u2500\u2500 webapps\r\n\u2502  \u2502  \u251c\u2500\u2500 boilerplate\r\n\u2502  \u2502  \u251c\u2500\u2500 docs\r\n\u2502  \u2502  \u251c\u2500\u2500 examples\r\n\u2502  \u2502  \u251c\u2500\u2500 host-manager\r\n\u2502  \u2502  \u251c\u2500\u2500 manager\r\n\u2502  \u2502  \u2514\u2500\u2500 ROOT\r\n\u2502  \u2514\u2500\u2500 work\n"})}),"\n",(0,t.jsx)(e.h3,{id:"assigning-server-ports",children:"Assigning Server Ports"}),"\n",(0,t.jsxs)(e.p,{children:["Now we need to give each instance a unique set of ports to operate on. This can be set inside the ",(0,t.jsx)(e.code,{children:"./conf/server.xml"})," of each instance, e.g. ",(0,t.jsx)(e.code,{children:"nano /opt/tomcat/instance1/conf/server.xml"}),":"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-xml",children:'<Server port="8105" shutdown="SHUTDOWN">\r\n\r\n...\r\n\r\n<Connector port="8180" protocol="HTTP/1.1" connectionTimeout="20000" />\r\n\r\n...\r\n\r\n\x3c!-- <Connector protocol="org.apache.coyote.http11.Http11NioProtocol"\r\n               port="8443" maxThreads="200"\r\n               scheme="https" secure="true" SSLEnabled="true"\r\n               keystoreFile="/opt/tomcat/ssl/sslKey.jks" keystorePass="instar"\r\n               clientAuth="false" sslProtocol="TLS"/> --\x3e\r\n\r\n...\r\n\r\n<Connector protocol="AJP/1.3" port="8109" />\n'})}),"\n",(0,t.jsxs)(e.blockquote,{children:["\n",(0,t.jsx)(e.p,{children:"I am removing the self-signed certificate as I am going to use NGINX later to handle my CA certificate."}),"\n"]}),"\n",(0,t.jsxs)(e.table,{children:[(0,t.jsx)(e.thead,{children:(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.th,{children:"Instance"}),(0,t.jsx)(e.th,{children:"Shutdown Port"}),(0,t.jsx)(e.th,{children:"HTTP Port"}),(0,t.jsx)(e.th,{children:"AJP Port"})]})}),(0,t.jsxs)(e.tbody,{children:[(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"Base"}),(0,t.jsx)(e.td,{children:"8005"}),(0,t.jsx)(e.td,{children:"8080"}),(0,t.jsx)(e.td,{children:"8009"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"Instance1"}),(0,t.jsx)(e.td,{children:"8105"}),(0,t.jsx)(e.td,{children:"8180"}),(0,t.jsx)(e.td,{children:"8109"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"Instance2"}),(0,t.jsx)(e.td,{children:"8205"}),(0,t.jsx)(e.td,{children:"8280"}),(0,t.jsx)(e.td,{children:"8209"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"Instance3"}),(0,t.jsx)(e.td,{children:"8305"}),(0,t.jsx)(e.td,{children:"8380"}),(0,t.jsx)(e.td,{children:"8309"})]})]})]}),"\n",(0,t.jsx)(e.h3,{id:"creating-startup-scripts",children:"Creating Startup Scripts"}),"\n",(0,t.jsxs)(e.p,{children:["Now we need a new ",(0,t.jsx)(e.code,{children:"scripts"})," folder inside the tomcat directory to create startup and stop scripts for our new instances - ",(0,t.jsx)(e.code,{children:"mkdir /opt/tomcat/scripts"}),":"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"nano /opt/tomcat/scripts/start-instance1.sh\n"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:'#!/bin/bash\r\n\r\nexport CATALINA_HOME="/opt/tomcat/latest"\r\nexport CATALINA_BASE="/opt/tomcat/instance1"\r\n\r\ncd $CATALINA_HOME/bin\r\n./startup.sh\n'})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"nano /opt/tomcat/scripts/stop-instance1.sh\n"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:'#!/bin/bash\r\n\r\nexport CATALINA_HOME="/opt/tomcat/latest"\r\nexport CATALINA_BASE="/opt/tomcat/instance1"\r\n\r\ncd $CATALINA_HOME/bin\r\n./shutdown.sh\n'})}),"\n",(0,t.jsx)(e.p,{children:"Create both scripts for all your instances:"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"scripts\r\n\u251c\u2500\u2500 start-instance1.sh\r\n\u251c\u2500\u2500 start-instance2.sh\r\n\u251c\u2500\u2500 start-instance3.sh\r\n\u251c\u2500\u2500 stop-instance1.sh\r\n\u251c\u2500\u2500 stop-instance2.sh\r\n\u2514\u2500\u2500 stop-instance3.sh\n"})}),"\n",(0,t.jsxs)(e.p,{children:["And make those scripts executable with ",(0,t.jsx)(e.code,{children:"chmod -R 755 /opt/tomcat/scripts"}),". You can now start all instances by running each startup script like:"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"/opt/tomcat/scripts/start-instance1.sh\r\n\r\nUsing CATALINA_BASE:   /opt/tomcat/instance1\r\nUsing CATALINA_HOME:   /opt/tomcat/latest\r\nUsing CATALINA_TMPDIR: /opt/tomcat/instance1/temp\r\nUsing JRE_HOME:        /usr\r\nUsing CLASSPATH:       /opt/tomcat/latest/bin/bootstrap.jar:/opt/tomcat/latest/bin/tomcat-juli.jar\r\nUsing CATALINA_OPTS:\r\nTomcat started.\n"})}),"\n",(0,t.jsxs)(e.p,{children:["After making sure that the ports you specified for those 3 instances: ",(0,t.jsx)(e.code,{children:"ufw allow 8180/tcp"}),", ",(0,t.jsx)(e.code,{children:"ufw allow 8280/tcp"}),", ",(0,t.jsx)(e.code,{children:"ufw allow 8380/tcp"})," - try accessing the 4 different versions of the virtual host we created earlier with your browser:"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"http://virtual-host1.com:8180/\r\nhttp://virtual-host1.com:8280/\r\nhttp://virtual-host1.com:8380/\n"})}),"\n",(0,t.jsx)(e.h2,{id:"loadbalancing---vertical-cluster",children:"Loadbalancing - Vertical Cluster"}),"\n",(0,t.jsx)(e.p,{children:"I now have 3 virtual hosts (instances) that I can target by a unique port:"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"Port 8180 -> Instance 1"}),"\n",(0,t.jsx)(e.li,{children:"Port 8280 -> Instance 2"}),"\n",(0,t.jsx)(e.li,{children:"Port 8380 -> Instance 3"}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:"Each of them hosts 3 web applications that will respond to one of the following addresses:"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"virtual-host1.com"}),"\n",(0,t.jsx)(e.li,{children:"virtual-host2.com"}),"\n",(0,t.jsx)(e.li,{children:"virtual-host3.com"}),"\n"]}),"\n",(0,t.jsxs)(e.blockquote,{children:["\n",(0,t.jsxs)(e.p,{children:["Before I only added these addresses to the PC I am working on. I now also have to add them to ",(0,t.jsx)(e.code,{children:"/etc/hosts"})," on my LINUX server and resolve them to ",(0,t.jsx)(e.code,{children:"127.0.0.1"}),". Verify that you can reach your virtual host before proceeding:"]}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:'curl virtual-host1.com:8180\r\n\r\n<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">\r\n<html>\r\n<head>\r\n<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">\r\n<title>Tomcat Boilerplate</title>\r\n</head>\r\n<body>\r\n\r\n<h1>Hello from Virtual Host 1</h1>\r\n<h3>Virtual Host Address: http://virtual-host1.com:8180/</h3>\r\n</body>\r\n</html>#\n'})}),"\n",(0,t.jsx)(e.h3,{id:"setting-up-nginx",children:"Setting Up NGINX"}),"\n",(0,t.jsxs)(e.p,{children:["I am going to use the ",(0,t.jsx)(e.a,{href:"http://nginx.org/en/docs/http/ngx_http_upstream_module.html",children:"NGINX Upstream Module"})," to set up a Round-Robin traffic balancing for the 3 virtual hosts that we just created:"]}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.img,{alt:"NGINX Loadbalancer",src:r(387156).A+"",width:"751",height:"768"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-cfg",children:"server {\r\n    listen 80;\r\n    listen [::]:80;\r\n\r\n    server_name virtual-host1.com virtual-host2.com virtual-host3.com;\r\n\r\n    return 301 https://$server_name$request_uri;\r\n}\r\n\r\n\r\nupstream tc1_servlets {\r\n    server virtual-host1.com:8180;\r\n    server virtual-host1.com:8280;\r\n    server virtual-host1.com:8380;\r\n}\r\n\r\nserver {\r\n    listen      443 ssl http2;\r\n    listen      [::]:443 ssl http2;\r\n    include     conf.d/self-signed.conf;\r\n    include     conf.d/ssl-params.conf;\r\n    include     conf.d/header.conf;\r\n\r\n    server_name virtual-host1.com;\r\n\r\n    location = / {\r\n        proxy_pass http://tc1_servlets;\r\n    }\r\n\r\n    error_page  404              /404.html;\r\n    error_page  500 502 503 504  /50x.html;\r\n    location = /50x.html {\r\n        root   /usr/share/nginx/html;\r\n    }\r\n}\r\n\r\n\r\nupstream tc2_servlets {\r\n    server virtual-host2.com:8180;\r\n    server virtual-host2.com:8280;\r\n    server virtual-host2.com:8380;\r\n}\r\n\r\nserver {\r\n    listen      443 ssl http2;\r\n    listen      [::]:443 ssl http2;\r\n    include     conf.d/self-signed.conf;\r\n    include     conf.d/ssl-params.conf;\r\n    include     conf.d/header.conf;\r\n\r\n    server_name virtual-host2.com;\r\n\r\n    location = / {\r\n        proxy_pass http://tc2_servlets;\r\n    }\r\n\r\n    error_page  404              /404.html;\r\n    error_page  500 502 503 504  /50x.html;\r\n    location = /50x.html {\r\n        root   /usr/share/nginx/html;\r\n    }\r\n}\r\n\r\n\r\nupstream tc3_servlets {\r\n    server virtual-host3.com:8180;\r\n    server virtual-host3.com:8280;\r\n    server virtual-host3.com:8380;\r\n}\r\n\r\nserver {\r\n    listen      443 ssl http2;\r\n    listen      [::]:443 ssl http2;\r\n    include     conf.d/self-signed.conf;\r\n    include     conf.d/ssl-params.conf;\r\n    include     conf.d/header.conf;\r\n\r\n    server_name virtual-host3.com;\r\n\r\n    location = / {\r\n        proxy_pass http://tc3_servlets;\r\n    }\r\n\r\n    error_page  404              /404.html;\r\n    error_page  500 502 503 504  /50x.html;\r\n    location = /50x.html {\r\n        root   /usr/share/nginx/html;\r\n    }\r\n}\n"})})]})}function h(n={}){const{wrapper:e}={...(0,s.R)(),...n.components};return e?(0,t.jsx)(e,{...n,children:(0,t.jsx)(d,{...n})}):d(n)}},387156:(n,e,r)=>{r.d(e,{A:()=>t});const t=r.p+"assets/images/NGINX_Loadbalancer_01-4cbb51c6b0ab080065e73e289bba2091.png"},354473:(n,e,r)=>{r.d(e,{A:()=>t});const t=r.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-dbec03b1535301c8b293ac3087af0dd4.jpg"},28453:(n,e,r)=>{r.d(e,{R:()=>o,x:()=>c});var t=r(296540);const s={},a=t.createContext(s);function o(n){const e=t.useContext(a);return t.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:o(n.components),t.createElement(a.Provider,{value:e},n.children)}}}]);