"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[46777],{321475:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>a,toc:()=>d});var t=r(785893),s=r(603905);const o={sidebar_position:4730,slug:"2023-01-29",title:"Python Ray Deployments",authors:"mpolinowski",tags:["Python","Machine Learning","Ray"],description:"Use Ray to deploy your remote services."},i=void 0,a={id:"IoT-and-Machine-Learning/AIOps/2023-01-29-python-ray-deployments/index",title:"Python Ray Deployments",description:"Use Ray to deploy your remote services.",source:"@site/docs/IoT-and-Machine-Learning/AIOps/2023-01-29-python-ray-deployments/index.md",sourceDirName:"IoT-and-Machine-Learning/AIOps/2023-01-29-python-ray-deployments",slug:"/IoT-and-Machine-Learning/AIOps/2023-01-29-python-ray-deployments/2023-01-29",permalink:"/docs/IoT-and-Machine-Learning/AIOps/2023-01-29-python-ray-deployments/2023-01-29",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/IoT-and-Machine-Learning/AIOps/2023-01-29-python-ray-deployments/index.md",tags:[{label:"Python",permalink:"/docs/tags/python"},{label:"Machine Learning",permalink:"/docs/tags/machine-learning"},{label:"Ray",permalink:"/docs/tags/ray"}],version:"current",sidebarPosition:4730,frontMatter:{sidebar_position:4730,slug:"2023-01-29",title:"Python Ray Deployments",authors:"mpolinowski",tags:["Python","Machine Learning","Ray"],description:"Use Ray to deploy your remote services."},sidebar:"tutorialSidebar",previous:{title:"Python Ray Model Serving",permalink:"/docs/IoT-and-Machine-Learning/AIOps/2023-01-31-python-ray-model-serving/2023-01-31"},next:{title:"Python Ray Remote Actors",permalink:"/docs/IoT-and-Machine-Learning/AIOps/2023-01-26-python-ray-remote-actors/2023-01-26"}},l={},d=[{value:"Deployments with Ray",id:"deployments-with-ray",level:2},{value:"Simple Deployment",id:"simple-deployment",level:3},{value:"Scaled Deployment",id:"scaled-deployment",level:3},{value:"Request Routing with FastAPI",id:"request-routing-with-fastapi",level:3},{value:"Deployment Composition",id:"deployment-composition",level:2},{value:"Canary Deployments",id:"canary-deployments",level:3}];function c(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.ah)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Guangzhou, China",src:r(473590).Z+"",width:"1500",height:"662"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"#deployments-with-ray",children:"Deployments with Ray"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#simple-deployment",children:"Simple Deployment"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#scaled-deployment",children:"Scaled Deployment"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#request-routing-with-fastapi",children:"Request Routing with FastAPI"})}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"#deployment-composition",children:"Deployment Composition"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#canary-deployments",children:"Canary Deployments"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["Source: ",(0,t.jsx)(n.a,{href:"https://github.com/scalingpythonml/scaling-python-with-ray",children:"Scaling Python with Ray"})]}),"\n"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://github.com/mpolinowski/ray-deployments",children:"Github Repository"})}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"deployments-with-ray",children:"Deployments with Ray"}),"\n",(0,t.jsxs)(n.p,{children:["Use ",(0,t.jsx)(n.strong,{children:"Ray Serve"})," for implementing a general-purpose microservice framework and how to use this framework for model serving. ",(0,t.jsx)(n.strong,{children:"Ray Serve"})," is implemented on top of Ray with Ray actors. Three kinds of actors are created to make up a Serve instance:"]}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Ray Actor"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"Controller"})}),(0,t.jsxs)(n.td,{children:["The controller is responsible for creating, updating, and destroying other actors. All of the ",(0,t.jsx)(n.strong,{children:"Serve API"})," calls (e.g., creating or getting a deployment) use the controller for their execution."]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"Router"})}),(0,t.jsx)(n.td,{children:"There is one router per node. Each router is a HTTP server that accepts incoming requests, forwards them to replicas, and responds after they are completed."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"Worker Replica"})}),(0,t.jsx)(n.td,{children:"Worker replicas execute the user-defined code in response to a request."})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"simple-deployment",children:"Simple Deployment"}),"\n",(0,t.jsxs)(n.p,{children:["A deployment defines the logic that will handle incoming requests and the way this logic is exposed over\nHTTP or in Python. A deployment is defined by the annotation ",(0,t.jsx)(n.code,{children:"@serve.deployment"})," and since it will start Ray actors it can be vertically scaled accordingly. Here we can also define the route prefix for the HTTP entpoint we want to use for the API calls to the actor:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-py",children:'@serve.deployment(ray_actor_options={"num_cpus": 2, "num_gpus":1}, route_prefix="/converter")\n'})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-py",children:'import ray\nfrom ray import serve\nimport requests\nfrom starlette.requests import Request\n\n# start Ray\nray.init()\n\n# start Serve\nserve.start()\n\n#define deployment\n@serve.deployment\nclass Converter:\n    def __call__(self, request):\n        if request.query_params["conversion"] == \'CF\' :\n            return {"INFO :: Fahrenheit temperature":\n                        9.0/5.0 * float(request.query_params["temp"]) + 32.0}\n        elif request.query_params["conversion"] == \'FC\' :\n            return {"INFO :: Celsius temperature":\n                        (float(request.query_params["temp"]) - 32.0) * 5.0/9.0 }\n        else:\n            return {"ERROR :: Unknown conversion code" : request.query_params["conversion"]}\n\n\nConverter.deploy()\n# list current deployment\nprint(serve.list_deployments())\n'})}),"\n",(0,t.jsxs)(n.p,{children:["With ",(0,t.jsx)(n.code,{children:"serve.start()"})," an ingress HTTP server is started on only the head node. If your deployments begin to exceed about three thousand requests per second, you can start an HTTP server on every node by using:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-py",children:'serve.start(http_options={"location":"EveryNode"})\n'})}),"\n",(0,t.jsxs)(n.p,{children:["The rest of the code starts an API server that can converts incoming temperature readings into degree Celsius or Fahrenheit depending on the appended Parameter. The HTTP Server will run on port ",(0,t.jsx)(n.code,{children:"8000"})," by default and serve our function on the endpoint ",(0,t.jsx)(n.code,{children:"/Converter"})," for us. When running this code I ran into an error message that fastAPI was missing as a dependency:"]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Error"})," missing dependencies: ",(0,t.jsx)(n.code,{children:"ModuleNotFoundError: No module named 'fastapi'. You can run "}),'pip install "ray[serve]"',(0,t.jsx)(n.code,{children:" to install all Ray Serve dependencies."})]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["With ",(0,t.jsx)(n.code,{children:"ray[serve]"})," installed I can now run 3 request trying out the 3 possible API responses:"]}),"\n",(0,t.jsx)(n.p,{children:"Converting:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Celsius -> Fahrenheit"}),"\n",(0,t.jsx)(n.li,{children:"Fahrenheit -> Celsius"}),"\n",(0,t.jsx)(n.li,{children:"an unknown unit"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-py",children:'# query our endpoint over http\nprint(requests.get("http://127.0.0.1:8000/Converter?temp=999.0&conversion=CF").text)\nprint(requests.get("http://127.0.0.1:8000/Converter?temp=999.0&conversion=FC").text)\nprint(requests.get("http://127.0.0.1:8000/Converter?temp=999.0&conversion=CC").text)\n'})}),"\n",(0,t.jsx)(n.p,{children:"This returns the following responses:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'python 01_ray_simple_deployments.py\n\n{\'Converter\': Deployment(name=Converter,version=None,route_prefix=/Converter)}\n{"INFO :: Fahrenheit temperature": 1830.2}\n{"INFO :: Celsius temperature": 537.2222222222222}\n{"ERROR :: Unknown conversion code": "CC"}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["The API request can also be handled with a regular ",(0,t.jsx)(n.code,{children:"ray.get()"})," by using the deployment handle - in our case ",(0,t.jsx)(n.code,{children:"Converter"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-py",children:'# direct invocation\nhandle = serve.get_deployment(\'Converter\').get_handle()\n\nprint(ray.get(handle.remote(Request({"type": "http", "query_string": b"temp=666.0&type=CF"}))))\nprint(ray.get(handle.remote(Request({"type": "http", "query_string": b"temp=666.0&type=FC"}))))\nprint(ray.get(handle.remote(Request({"type": "http", "query_string": b"temp=666.0&type=CC"}))))\n'})}),"\n",(0,t.jsxs)(n.p,{children:["The return is identical to the HTTP request earlier (we now get two responses - one for the vallu ",(0,t.jsx)(n.code,{children:"999.0"})," and for ",(0,t.jsx)(n.code,{children:"666.0"}),"):"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"python 01_ray_simple_deployments.py\n\n{'Converter': Deployment(name=Converter,version=None,route_prefix=/Converter)}\n{\"INFO :: Fahrenheit temperature\": 1830.2}\n{\"INFO :: Celsius temperature\": 537.2222222222222}\n{\"ERROR :: Unknown conversion code\": \"CC\"}\n{'INFO :: Fahrenheit temperature': 1230.8}\n{'INFO :: Celsius temperature': 352.22222222222223}\n{'ERROR :: Unknown conversion code': 'CC'}\n"})}),"\n",(0,t.jsx)(n.p,{children:"All of this can be simplified to:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-py",children:"# simplifying the converter\n@serve.deployment\nclass ConverterSimple:\n    def celcius_fahrenheit(self, temp):\n        return 9.0/5.0 * temp + 32.0\n\n    def fahrenheit_celcius(self, temp):\n        return (temp - 32.0) * 5.0/9.0\n\n\nConverterSimple.deploy()\n# list current deployment\nprint(serve.list_deployments()) \n\n\nhandleSimple = serve.get_deployment('ConverterSimple').get_handle()\n\nprint(ray.get(handleSimple.celcius_fahrenheit.remote(333.0)))\nprint(ray.get(handleSimple.fahrenheit_celcius.remote(333.0)))\n"})}),"\n",(0,t.jsx)(n.p,{children:"And we get the following return:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"{'Converter': Deployment(name=Converter,version=None,route_prefix=/Converter), 'ConverterSimple': Deployment(name=ConverterSimple,version=None,route_prefix=/ConverterSimple)}\n631.4\n167.22222222222223\n"})}),"\n",(0,t.jsx)(n.h3,{id:"scaled-deployment",children:"Scaled Deployment"}),"\n",(0,t.jsxs)(n.p,{children:["By default, ",(0,t.jsx)(n.code,{children:"deployment.deploy"})," creates a single instance of a deployment. By specifying the number of replicas in ",(0,t.jsx)(n.code,{children:"@serve.deployment"}),", you can scale out a deployment. I will also add a UUID to each instance that is being created so we can differentiate them:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-py",children:'# simplifying the converter\n# adding scale factor\n@serve.deployment(num_replicas=2)\nclass ConverterSimple:\n    # generate instance id\n    def __init__ (self):\n        self.id = str(uuid4())\n\n    def celcius_fahrenheit(self, temp):\n        output = self.id, "INFO :: Fahrenheit temperature", 9.0/5.0 * temp + 32.0\n        return output\n\n    def fahrenheit_celcius(self, temp):\n        output = self.id, "INFO :: Celsius temperature", (temp - 32.0) * 5.0/9.0\n        return output\n'})}),"\n",(0,t.jsx)(n.p,{children:"If we run the code again we can now see that 2 instances are created and incoming requests are load-balanced in a round-robin fashion (the replies come from 2 different IDs):"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"(ServeController pid=53210) INFO 2023-01-29 16:39:57,500 controller 53210 deployment_state.py:1310 - Adding 2 replicas to deployment 'ConverterSimple'.\n{'Converter': Deployment(name=Converter,version=None,route_prefix=/Converter), 'ConverterSimple': Deployment(name=ConverterSimple,version=None,route_prefix=/ConverterSimple)}\n('cf9a204c-8337-4fe9-b301-43cd0f4fbeb1', 'INFO :: Fahrenheit temperature', 631.4)\n('6b150f9a-ba6d-48b0-95ac-bbbd6de2e5ae', 'INFO :: Celsius temperature', 167.22222222222223)\n('cf9a204c-8337-4fe9-b301-43cd0f4fbeb1', 'INFO :: Fahrenheit temperature', 431.6)\n('6b150f9a-ba6d-48b0-95ac-bbbd6de2e5ae', 'INFO :: Celsius temperature', 105.55555555555556)\n"})}),"\n",(0,t.jsx)(n.h3,{id:"request-routing-with-fastapi",children:"Request Routing with FastAPI"}),"\n",(0,t.jsx)(n.p,{children:"In the previous example we had to define the conversion type to be handed the correct conversion method for our value input. A cleaner option is to use FastAPI to generate different URL endpoints for every method:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-py",children:'#define deployment\n@serve.deployment(route_prefix="/converter")\n@serve.ingress(app)\nclass Converter:\n    @app.get("/to_fahrenheit")\n    def celcius_fahrenheit(self, temp):\n        return {"INFO :: Fahrenheit temperature": 9.0/5.0 * float(temp) + 32.0}\n\n    @app.get("/to_celsius")\n    def fahrenheit_celcius(self, temp):\n        return {"INFO :: Celsius temperature": (float(temp) - 32.0) * 5.0/9.0}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["This changes the API endpoints to ",(0,t.jsx)(n.code,{children:"/converter/to_fahrenheit"})," and ",(0,t.jsx)(n.code,{children:"/converter/to_celsius"})," and we can use them with:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-py",children:'# Query our endpoint over HTTP.\nprint(requests.get("http://127.0.0.1:8000/converter/to_fahrenheit?temp=1111.0&").text)\nprint(requests.get("http://127.0.0.1:8000/converter/to_celsius?temp=1111.0").text)\n'})}),"\n",(0,t.jsx)(n.p,{children:"The direct invocation is not affected by this change:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-py",children:"handle = serve.get_deployment('FastConverter').get_handle()\n\nprint(ray.get(handle.celcius_fahrenheit.remote(555.0)))\nprint(ray.get(handle.fahrenheit_celcius.remote(555.0))) \n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"python 02_ray_fastAPI_deployments.py\n\n{'FastConverter': Deployment(name=FastConverter,version=None,route_prefix=/converter)}\n{\"INFO :: Fahrenheit temperature\":2031.8}\n{\"INFO :: Celsius temperature\":599.4444444444445}\n{'INFO :: Fahrenheit temperature': 1031.0}\n{'INFO :: Celsius temperature': 290.55555555555554}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"deployment-composition",children:"Deployment Composition"}),"\n",(0,t.jsx)(n.p,{children:"Make deployments that are compositions of further deployments."}),"\n",(0,t.jsx)(n.h3,{id:"canary-deployments",children:"Canary Deployments"}),"\n",(0,t.jsx)(n.p,{children:"One example is the slow rollout of a new version of your service to a limited amount of incoming request, e.g.:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-py",children:'@serve.deployment\ndef version_one(data):\n    return {"version": "I am the old version..."}\n\nversion_one.deploy()\n\n@serve.deployment\ndef version_two(data):\n    return {"version": "I am the new version!"}\n\nversion_two.deploy()\n'})}),"\n",(0,t.jsx)(n.p,{children:"To implement the canary deployment we can use the following code:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-py",children:'\n@serve.deployment(route_prefix="/get_version")\nclass Canary:\n    def __init__(self, canary_percent):\n        from random import random\n        self.version_one = version_one.get_handle()\n        self.version_two = version_two.get_handle()\n        self.canary_percent = canary_percent\n\n    # This method can be called concurrently!\n    async def __call__(self, request):\n        data = await request.body()\n        if(random() > self.canary_percent):\n            return await self.version_one.remote(data=data)\n        else:\n            return await self.version_two.remote(data=data)\n\n# invocation with canary_percent of 20%\nCanary.deploy(.2)\n'})}),"\n",(0,t.jsx)(n.p,{children:"Now we can call the API 10 time and see the NEW/OLD distribution of the responses we get:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-py",children:'# call api 10 times\nfor _ in range(10):\n    resp = requests.get("http://127.0.0.1:8000/get_version", data="some string, doesn\'t matter")\n    print(resp.json())\n'})}),"\n",(0,t.jsx)(n.p,{children:"This makes sure that if there is an issue with the new version only a limited amount of requests will be affected by it:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"{'version': 'I am the new version!'}\n{'version': 'I am the old version...'}\n{'version': 'I am the old version...'}\n{'version': 'I am the old version...'}\n{'version': 'I am the old version...'}\n{'version': 'I am the old version...'}\n{'version': 'I am the old version...'}\n{'version': 'I am the new version!'}\n{'version': 'I am the old version...'}\n{'version': 'I am the old version...'}\n"})})]})}function p(e={}){const{wrapper:n}={...(0,s.ah)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},603905:(e,n,r)=>{r.d(n,{ah:()=>d});var t=r(667294);function s(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function o(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,t)}return r}function i(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?o(Object(r),!0).forEach((function(n){s(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function a(e,n){if(null==e)return{};var r,t,s=function(e,n){if(null==e)return{};var r,t,s={},o=Object.keys(e);for(t=0;t<o.length;t++)r=o[t],n.indexOf(r)>=0||(s[r]=e[r]);return s}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(t=0;t<o.length;t++)r=o[t],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(s[r]=e[r])}return s}var l=t.createContext({}),d=function(e){var n=t.useContext(l),r=n;return e&&(r="function"==typeof e?e(n):i(i({},n),e)),r},c={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},p=t.forwardRef((function(e,n){var r=e.components,s=e.mdxType,o=e.originalType,l=e.parentName,p=a(e,["components","mdxType","originalType","parentName"]),h=d(r),m=s,u=h["".concat(l,".").concat(m)]||h[m]||c[m]||o;return r?t.createElement(u,i(i({ref:n},p),{},{components:r})):t.createElement(u,i({ref:n},p))}));p.displayName="MDXCreateElement"},473590:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-296769d73822f07b0ac5dc952f56bfa1.jpg"}}]);