"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[40256],{485784:(n,t,e)=>{e.r(t),e.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>s,metadata:()=>a,toc:()=>c});var o=e(474848),i=e(28453);const s={sidebar_position:6080,slug:"2022-07-22",title:"Go - MQTT Hello World",authors:"mpolinowski",tags:["IoT"],image:"https://mpolinowski.github.io/img/search/mqtt.png",description:"Writing a Go program that connects to my camera MQTT broker, subscribes to the last-will topic and publishes updates to the privacy mask to turn it on and off again after 15s. The client disconnects after 250ms after that."},r=void 0,a={id:"Automation_and_Robotics/MQTT/2022-07-22-go-hello-world/index",title:"Go - MQTT Hello World",description:"Writing a Go program that connects to my camera MQTT broker, subscribes to the last-will topic and publishes updates to the privacy mask to turn it on and off again after 15s. The client disconnects after 250ms after that.",source:"@site/docs/Automation_and_Robotics/MQTT/2022-07-22-go-hello-world/index.md",sourceDirName:"Automation_and_Robotics/MQTT/2022-07-22-go-hello-world",slug:"/Automation_and_Robotics/MQTT/2022-07-22-go-hello-world/2022-07-22",permalink:"/docs/Automation_and_Robotics/MQTT/2022-07-22-go-hello-world/2022-07-22",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Automation_and_Robotics/MQTT/2022-07-22-go-hello-world/index.md",tags:[{label:"IoT",permalink:"/docs/tags/io-t"}],version:"current",sidebarPosition:6080,frontMatter:{sidebar_position:6080,slug:"2022-07-22",title:"Go - MQTT Hello World",authors:"mpolinowski",tags:["IoT"],image:"https://mpolinowski.github.io/img/search/mqtt.png",description:"Writing a Go program that connects to my camera MQTT broker, subscribes to the last-will topic and publishes updates to the privacy mask to turn it on and off again after 15s. The client disconnects after 250ms after that."},sidebar:"tutorialSidebar",previous:{title:"Mosquitto Broker from Source",permalink:"/docs/Automation_and_Robotics/MQTT/2022-07-23-mosquitto-broker-compilation/2022-07-23"},next:{title:"Rust - MQTT Hello World",permalink:"/docs/Automation_and_Robotics/MQTT/2022-07-21-rust-hello-world/2022-07-21"}},l={},c=[{value:"Go Paho MQTT Client",id:"go-paho-mqtt-client",level:2},{value:"Connect to the MQTT broker",id:"connect-to-the-mqtt-broker",level:3},{value:"Running the Program",id:"running-the-program",level:3},{value:"Cross Compiling with Go",id:"cross-compiling-with-go",level:2}];function d(n){const t={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...n.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Guangzhou, China",src:e(892710).A+"",width:"2385",height:"962"})}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.a,{href:"#go-paho-mqtt-client",children:"Go Paho MQTT Client"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:(0,o.jsx)(t.a,{href:"#connect-to-the-mqtt-broker",children:"Connect to the MQTT broker"})}),"\n",(0,o.jsx)(t.li,{children:(0,o.jsx)(t.a,{href:"#running-the-program",children:"Running the Program"})}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(t.li,{children:(0,o.jsx)(t.a,{href:"#cross-compiling-with-go",children:"Cross Compiling with Go"})}),"\n"]}),"\n",(0,o.jsx)(t.h2,{id:"go-paho-mqtt-client",children:"Go Paho MQTT Client"}),"\n",(0,o.jsxs)(t.p,{children:["I already wrote a ",(0,o.jsx)(t.a,{href:"/docs/Automation_and_Robotics/MQTT/2021-09-12--golang-paho-mqtt/2021-09-12/",children:"Go MQTT client"})," before. I will try to expand this a little bit:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"go mod init go/go-mqtt\ngo get github.com/eclipse/paho.mqtt.golang@latest\n"})}),"\n",(0,o.jsx)(t.h3,{id:"connect-to-the-mqtt-broker",children:"Connect to the MQTT broker"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.strong,{children:"Broker IP"}),": ",(0,o.jsx)(t.code,{children:"192.168.2.115"})]}),"\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.strong,{children:"MQTT Service Port"}),": ",(0,o.jsx)(t.code,{children:"1883"})]}),"\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.strong,{children:"Broker Login"}),": ",(0,o.jsx)(t.code,{children:"admin/instar"})]}),"\n"]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Go - MQTT Hello World",src:e(537014).A+"",width:"1031",height:"693"})}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.em,{children:"./main.go"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-go",children:'package main\n\nimport (\n\t"fmt"\n\t"time"\n\n\tmqtt "github.com/eclipse/paho.mqtt.golang"\n)\n\nvar messagePubHandler mqtt.MessageHandler = func(client mqtt.Client, msg mqtt.Message) {\n\tfmt.Printf("Topic: %s | %s\\n", msg.Topic(), msg.Payload())\n}\n\nvar connectHandler mqtt.OnConnectHandler = func(client mqtt.Client) {\n\tfmt.Println("Connected")\n}\n\nvar connectLostHandler mqtt.ConnectionLostHandler = func(client mqtt.Client, err error) {\n\tfmt.Printf("Connect lost: %+v", err)\n}\n\nfunc main() {\n\tvar broker = "192.168.2.115"\n\tvar port = 1883\n\topts := mqtt.NewClientOptions()\n\topts.AddBroker(fmt.Sprintf("tcp://%s:%d", broker, port))\n\topts.SetClientID("go_mqtt_client")\n\topts.SetUsername("admin")\n\topts.SetPassword("instar")\n\topts.SetDefaultPublishHandler(messagePubHandler)\n\topts.OnConnect = connectHandler\n\topts.OnConnectionLost = connectLostHandler\n\tclient := mqtt.NewClient(opts)\n\tif token := client.Connect(); token.Wait() && token.Error() != nil {\n\t\tpanic(token.Error())\n\t}\n\n\tsub(client)\n\tpublish(client)\n\n\tclient.Disconnect(250)\n}\n\nfunc publish(client mqtt.Client) {\n\t// Turn privacy mask 1 on and off again after 15s\n\tnums := []int{1, 0}\n\tfor _, num := range nums {\n\t\tvalue := fmt.Sprintf("%d", num)\n\t\ttoken := client.Publish("cameras/115/multimedia/privacy/region1/enable/raw", 0, false, value)\n\t\ttoken.Wait()\n\t\ttime.Sleep(15 * time.Second)\n\t}\n}\n\nfunc sub(client mqtt.Client) {\n\t// Subscribe to the LWT connection status\n\ttopic := "cameras/115/status/testament"\n\ttoken := client.Subscribe(topic, 1, nil)\n\ttoken.Wait()\n\tfmt.Println("Subscribed to LWT", topic)\n}\n'})}),"\n",(0,o.jsx)(t.h3,{id:"running-the-program",children:"Running the Program"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:'go run .\\main.go\nConnected\nSubscribed to LWT cameras/115/status/testament\nTopic: cameras/115/status/testament | {"val":"alive"}\n'})}),"\n",(0,o.jsx)(t.p,{children:"The program connects to my camera broker, subscribes to the last-will topic and publishes updates to the privacy mask to turn it on and off again after 15s. The client disconnects after 250ms after that."}),"\n",(0,o.jsx)(t.p,{children:"To get a binary file out I can run the build command:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"go build ./main.go -o mqtt\n"})}),"\n",(0,o.jsxs)(t.p,{children:["And run the binary with ",(0,o.jsx)(t.code,{children:"./mqtt"}),"."]}),"\n",(0,o.jsx)(t.h2,{id:"cross-compiling-with-go",children:"Cross Compiling with Go"}),"\n",(0,o.jsx)(t.p,{children:"Go supports a variety of platforms and operating systems, including:"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:"Android"}),"\n",(0,o.jsx)(t.li,{children:"Darwin"}),"\n",(0,o.jsx)(t.li,{children:"Linux"}),"\n",(0,o.jsx)(t.li,{children:"Windows"}),"\n"]}),"\n",(0,o.jsxs)(t.p,{children:["The file created requires a 64bit ",(0,o.jsx)(t.code,{children:"x86-64"})," system to be executed:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"file main\nmain: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, Go BuildID=GkWKfp1sGIj5CJ0LesYM/P1txXPn8ar3YIQEGRF3P/hbjIOYuyC5-d1UMZN32q/CGL0UrtrAC1goylMkfFl, with debug_info, not stripped\n"})}),"\n",(0,o.jsx)(t.p,{children:"So how do I get a file that I can use on my IP camera that uses an ARM7 processor?"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"uname -m\narmv7l\n"})}),"\n",(0,o.jsx)(t.p,{children:"So how do I find out what systems are supported?"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"go tool dist list\n\nandroid/386\nandroid/amd64\nandroid/arm\nandroid/arm64\nios/amd64\nios/arm64\njs/wasm\nlinux/386\nlinux/amd64\nlinux/arm\nlinux/arm64\nlinux/loong64\nlinux/mips\nlinux/mips64\nlinux/mips64le\nlinux/mipsle\nlinux/ppc64\nlinux/ppc64le\nlinux/riscv64\nlinux/s390x\nwindows/386\nwindows/amd64\nwindows/arm\nwindows/arm64\n\n...\n"})}),"\n",(0,o.jsx)(t.p,{children:"I can add the information as a environment variable when running the build:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"env GOOS=linux GOARCH=arm go build -o mqtt_arm\n"})}),"\n",(0,o.jsx)(t.p,{children:"Now I got a binary that can be executed on a 32bit ARM system:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"file mqtt_arm\nmqtt_arm: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), statically linked, Go BuildID=msMp-jFIWHH3UaYAwNkh/TSOtDFvNMz_m1j_2VuU-/jOS7whdSr12-3_dBf4qC/xOLKo5WJnx4cluesUzqW, with debug_info, not stripped\n"})}),"\n",(0,o.jsxs)(t.p,{children:["And this worked - just copying the binary onto my IP Camera and executing it and I got the broker connection. Very nice ",(0,o.jsx)(t.code,{children:"<3"})]})]})}function h(n={}){const{wrapper:t}={...(0,i.R)(),...n.components};return t?(0,o.jsx)(t,{...n,children:(0,o.jsx)(d,{...n})}):d(n)}},537014:(n,t,e)=>{e.d(t,{A:()=>o});const o=e.p+"assets/images/Rust_MQTT_Hello_World_01-68435046037215dc6dc8ad7c87b5b34c.png"},892710:(n,t,e)=>{e.d(t,{A:()=>o});const o=e.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-4dda98a4eb3b498839926e0b6a5039aa.jpg"},28453:(n,t,e)=>{e.d(t,{R:()=>r,x:()=>a});var o=e(296540);const i={},s=o.createContext(i);function r(n){const t=o.useContext(s);return o.useMemo((function(){return"function"==typeof n?n(t):{...t,...n}}),[t,n])}function a(n){let t;return t=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:r(n.components),o.createElement(s.Provider,{value:t},n.children)}}}]);