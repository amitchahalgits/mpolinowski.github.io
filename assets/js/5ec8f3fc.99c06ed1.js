"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[82856],{495434:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>c,default:()=>h,frontMatter:()=>i,metadata:()=>a,toc:()=>d});var r=t(474848),o=t(28453);const i={sidebar_position:5980,slug:"2022-11-10",title:"WebRTC Introduction - Interactive Connectivity Establishment",authors:"mpolinowski",tags:["Javascript","WebRTC"],description:"Establishing a connection between the clients"},c=void 0,a={id:"Development/Javascript/2022-11-10-webrtc-introduction-video-chat-part2/index",title:"WebRTC Introduction - Interactive Connectivity Establishment",description:"Establishing a connection between the clients",source:"@site/docs/Development/Javascript/2022-11-10-webrtc-introduction-video-chat-part2/index.md",sourceDirName:"Development/Javascript/2022-11-10-webrtc-introduction-video-chat-part2",slug:"/Development/Javascript/2022-11-10-webrtc-introduction-video-chat-part2/2022-11-10",permalink:"/docs/Development/Javascript/2022-11-10-webrtc-introduction-video-chat-part2/2022-11-10",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Development/Javascript/2022-11-10-webrtc-introduction-video-chat-part2/index.md",tags:[{label:"Javascript",permalink:"/docs/tags/javascript"},{label:"WebRTC",permalink:"/docs/tags/web-rtc"}],version:"current",sidebarPosition:5980,frontMatter:{sidebar_position:5980,slug:"2022-11-10",title:"WebRTC Introduction - Interactive Connectivity Establishment",authors:"mpolinowski",tags:["Javascript","WebRTC"],description:"Establishing a connection between the clients"},sidebar:"tutorialSidebar",previous:{title:"Web3.js Blockchain Application",permalink:"/docs/Development/Javascript/2022-11-19-web3-javascript-app/2022-11-19"},next:{title:"WebRTC Introduction - Client Side Signalling",permalink:"/docs/Development/Javascript/2022-10-30-webrtc-introduction-video-chat-part1/2022-10-30"}},s={},d=[{value:"Interactive Connectivity Establishment (ICE)",id:"interactive-connectivity-establishment-ice",level:2},{value:"Peer Connection",id:"peer-connection",level:3},{value:"Negotiate Media (SDP)",id:"negotiate-media-sdp",level:2},{value:"Offer",id:"offer",level:4},{value:"Answer",id:"answer",level:4}];function l(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Shenzhen, China",src:t(344944).A+"",width:"2208",height:"757"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"#interactive-connectivity-establishment-ice",children:"Interactive Connectivity Establishment (ICE)"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#peer-connection",children:"Peer Connection"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"#negotiate-media-sdp",children:"Negotiate Media (SDP)"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#offer",children:"Offer"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#answer",children:"Answer"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"WIP"})," "]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/docs/Development/Javascript/2022-10-29-webrtc-introduction-realtime-chat/2022-10-29",children:"WebRTC Introduction - Websockets"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/docs/Development/Javascript/2022-10-30-webrtc-introduction-video-chat-part1/2022-10-30",children:"WebRTC Introduction - Client Side Signalling"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/docs/Development/Javascript/2022-11-10-webrtc-introduction-video-chat-part2/2022-11-10",children:"WebRTC Introduction - Interactive Connectivity Establishment"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"interactive-connectivity-establishment-ice",children:"Interactive Connectivity Establishment (ICE)"}),"\n",(0,r.jsx)(n.h3,{id:"peer-connection",children:"Peer Connection"}),"\n",(0,r.jsx)(n.p,{children:"Use STUN servers to exchange your public address:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://ourcodeworld.com/articles/read/1536/list-of-free-functional-public-stun-servers-2021",children:"List of Public STUN Server"})}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:'// List of STUN server to exchange public IPs\nconst iceServers = {\n  iceServers: [\n    { urls: "stun:stun.l.google.com:19302" },\n    { urls: "stun:stun.nextcloud.com:443" }\n  ]\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection",children:"RTCPeerConnection"})," interface represents a WebRTC connection between the local computer and a remote peer. It provides methods to connect to a remote peer, maintain and monitor the connection, and close the connection once it's no longer needed."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"rtcPeerConnection"})," is an interface that provides several functions that need to be defined. First we need to handle the local stream that we get from ",(0,r.jsx)(n.code,{children:"fetchLocalStream"})," in form of the ",(0,r.jsx)(n.code,{children:"userStream"})," object. This is done by ",(0,r.jsx)(n.code,{children:"addTrack()"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"// Room is ready event\nsocket.on('ready', function() {\n  if (creator) {\n    rtcPeerConnection = new RTCPeerConnection(iceServers)\n    rtcPeerConnection.oniceccandidate = onIceCandidate()\n    rtcPeerConnection.ontrack = onTrack()\n    // get local audio stream from userStream object\n    rtcPeerConnection.addTrack(userStream.getTracks()[0], userstream)\n    // get local video stream from userStream object\n    rtcPeerConnection.addTrack(userStream.getTracks()[0], userstream)\n  }\n})\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The second one is ",(0,r.jsx)(n.code,{children:"onIceCandidate()"})," returns a candidate for the connection that needs to be published through our websocket:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:'// If ICE candidate is returned emit over ws\nfunction onIceCandidate(event) {\n  if (event.candidate) {\n    socket.emit("candidate", event.candidate, chatRoom.value);\n  }\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["The third function we need to handle is ",(0,r.jsx)(n.code,{children:"onTrack()"})," that handles the media stream that is provided by the remote candidate:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"// If ICE candidate starts streaming media emit over ws\nfunction onTrack(event) {\n  peerVideo.srcObject = event.streams[0];\n  peerVideo.onloadedmetadata = function (e) {\n    peerVideo.play();\n  };\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"negotiate-media-sdp",children:"Negotiate Media (SDP)"}),"\n",(0,r.jsx)(n.p,{children:"The creator of the room now needs to use the established connection to send an offer to the remote candidate. Since the answering remote candidate will have to send the same media information I will export those functions and recycle them."}),"\n",(0,r.jsx)(n.p,{children:"When the room is created and ready get public address of the remote candidate and collect your local media information"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"function rtcPeering() {\n  rtcPeerConnection = new RTCPeerConnection(iceServers)\n  rtcPeerConnection.oniceccandidate = onIceCandidate()\n  rtcPeerConnection.ontrack = onTrack()\n  // get audio stream from userStream object\n  rtcPeerConnection.addTrack(userStream.getTracks()[0], userstream)\n  // get video stream from userStream object\n  rtcPeerConnection.addTrack(userStream.getTracks()[0], userstream)\n}\n"})}),"\n",(0,r.jsx)(n.h4,{id:"offer",children:"Offer"}),"\n",(0,r.jsx)(n.p,{children:"Send the offer to your remote candidate:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"// Room is ready event\nsocket.on('ready', function() {\n  console.log('INFO :: Room ready.')\n  // Room creator generates offer for remote candidate to join\n  if (creator) {\n    rtcPeering()\n    // create offer\n    rtcPeerConnection\n    .createOffer()\n    .then((offer) => {\n      rtcPeerConnection.setLocalDescription(offer);\n      socket.emit(\"offer\", offer, roomName);\n    })\n\n    .catch((error) => {\n      console.log(error);\n    });\n  }\n  console.log('INFO :: Offer send.')\n})\n"})}),"\n",(0,r.jsx)(n.h4,{id:"answer",children:"Answer"}),"\n",(0,r.jsx)(n.p,{children:"When the remote candidate receives the offer it will provide the following answer containing the same information but it's local media:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:'// Triggered on receiving an offer from the person who created the room.\nsocket.on("offer", function (offer) {\n  // If not creator send answer to offer\n  if (!creator) {\n    rtcPeering()\n    rtcPeerConnection.setRemoteDescription(offer);\n    rtcPeerConnection\n      .createAnswer()\n      .then((answer) => {\n        rtcPeerConnection.setLocalDescription(answer);\n        socket.emit("answer", answer, roomName);\n      })\n      .catch((error) => {\n        console.log(error);\n      });\n  }\n  console.log(\'INFO :: Answer send.\')\n});\n'})})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},344944:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-e38404fdf0e14587f660e537829bfab5.jpg"},28453:(e,n,t)=>{t.d(n,{R:()=>c,x:()=>a});var r=t(296540);const o={},i=r.createContext(o);function c(e){const n=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:c(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);