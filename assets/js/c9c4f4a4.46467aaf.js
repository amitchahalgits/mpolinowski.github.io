"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[61603],{539647:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>t,metadata:()=>s,toc:()=>l});var o=a(785893),r=a(603905);const t={sidebar_position:3980,slug:"2022-11-15",title:"Hashicorp Nomad for NGINX Load-balancing",authors:"mpolinowski",tags:["Nomad","Consul","LINUX","NTS"],description:"Following along the official NGINX load-balancing tutorial."},i=void 0,s={id:"DevOps/Hashicorp/2022-11-15-hashicorp-nomad-nginx-load-balancing/index",title:"Hashicorp Nomad for NGINX Load-balancing",description:"Following along the official NGINX load-balancing tutorial.",source:"@site/docs/DevOps/Hashicorp/2022-11-15-hashicorp-nomad-nginx-load-balancing/index.md",sourceDirName:"DevOps/Hashicorp/2022-11-15-hashicorp-nomad-nginx-load-balancing",slug:"/DevOps/Hashicorp/2022-11-15-hashicorp-nomad-nginx-load-balancing/2022-11-15",permalink:"/docs/DevOps/Hashicorp/2022-11-15-hashicorp-nomad-nginx-load-balancing/2022-11-15",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Hashicorp/2022-11-15-hashicorp-nomad-nginx-load-balancing/index.md",tags:[{label:"Nomad",permalink:"/docs/tags/nomad"},{label:"Consul",permalink:"/docs/tags/consul"},{label:"LINUX",permalink:"/docs/tags/linux"},{label:"NTS",permalink:"/docs/tags/nts"}],version:"current",sidebarPosition:3980,frontMatter:{sidebar_position:3980,slug:"2022-11-15",title:"Hashicorp Nomad for NGINX Load-balancing",authors:"mpolinowski",tags:["Nomad","Consul","LINUX","NTS"],description:"Following along the official NGINX load-balancing tutorial."},sidebar:"tutorialSidebar",previous:{title:"Deploy Mautic with Hashicorp Nomad",permalink:"/docs/DevOps/Hashicorp/2022-11-16-hashicorp-nomad-mautic/2022-11-16"},next:{title:"Hashicorp Nomad Secure & Balanced NTS Time Service",permalink:"/docs/DevOps/Hashicorp/2022-11-15-hashicorp-nomad-balanced-nts/2022-11-15"}},c={},l=[{value:"Load Balancing with NGINX",id:"load-balancing-with-nginx",level:2},{value:"Demo Web App",id:"demo-web-app",level:3},{value:"NGINX Load Balancer",id:"nginx-load-balancer",level:3}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.ah)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Shen Zhen, China",src:a(686189).Z+"",width:"2230",height:"839"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"#load-balancing-with-nginx",children:"Load Balancing with NGINX"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"#demo-web-app",children:"Demo Web App"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"#nginx-load-balancer",children:"NGINX Load Balancer"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"load-balancing-with-nginx",children:"Load Balancing with NGINX"}),"\n",(0,o.jsxs)(n.p,{children:["You can use Nomad's template stanza to configure NGINX so that it can dynamically update its ",(0,o.jsx)(n.a,{href:"https://developer.hashicorp.com/nomad/tutorials/load-balancing",children:"load balancer configuration"})," to scale along with your services. The main use case for NGINX in this scenario is to distribute incoming HTTP(S) and TCP requests from the Internet to front-end services that can handle these requests."]}),"\n",(0,o.jsx)(n.h3,{id:"demo-web-app",children:"Demo Web App"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.em,{children:"webapp.tf"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'job "demo_webapp" {\n  datacenters = ["dc1"]\n\n  group "demo" {\n    count = 3\n    network {\n      port "http" {\n        to = -1\n      }\n    }\n\n    service {\n      name = "demo-webapp"\n      port = "http"\n\n      check {\n        type     = "http"\n        path     = "/"\n        interval = "2s"\n        timeout  = "2s"\n      }\n    }\n\n    task "server" {\n      env {\n        PORT    = "${NOMAD_PORT_http}"\n        NODE_IP = "${NOMAD_IP_http}"\n      }\n\n      driver = "docker"\n\n      config {\n        image = "hashicorp/demo-webapp-lb-guide"\n        ports = ["http"]\n      }\n    }\n  }\n}\n\n'})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'nomad plan webapp.tf                                                                                            [\xb1master \u25cf]\n+ Job: "demo_webapp"\n+ Task Group: "demo" (3 create)\n  + Task: "server" (forces create)\n\nScheduler dry-run:\n- All tasks successfully allocated.\n\nJob Modify Index: 0\nTo submit the job with version verification run:\n\nnomad job run -check-index 0 webapp.tf\n'})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Hashicorp Nomad for NGINX Load-balancing",src:a(4748).Z+"",width:"1171",height:"246"})}),"\n",(0,o.jsx)(n.p,{children:"The 3 instances have now been deployed to the host system exposing random port:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"docker ps\nCONTAINER ID   IMAGE                          PORTS\n17288d176334   hashicorp/demo-webapp-lb-guide server-ip:30809->30809/tcp\n17c426f00330   hashicorp/demo-webapp-lb-guide server-ip:24931->24931/tcp\n3f863e8dc822   hashicorp/demo-webapp-lb-guide server-ip:27252->27252/tcp\n"})}),"\n",(0,o.jsx)(n.h3,{id:"nginx-load-balancer",children:"NGINX Load Balancer"}),"\n",(0,o.jsx)(n.p,{children:"This NGINX instance balances requests across the deployed instances of the web application:"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.em,{children:"nginx.tf"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'job "nginx" {\n  datacenters = ["dc1"]\n\n  group "nginx" {\n    count = 1\n\n    network {\n      port "http" {\n        static = 80\n      }\n    }\n\n    service {\n      name = "nginx"\n      port = "http"\n    }\n\n    task "nginx" {\n      driver = "docker"\n\n      config {\n        image = "nginx:alpine"\n        network_mode = "host"\n\n        volumes = [\n          "local:/etc/nginx/conf.d",\n        ]\n      }\n\n      template {\n        data = <<EOF\nupstream backend {\n{{ range service "demo-webapp" }}\n  server {{ .Address }}:{{ .Port }};\n{{ else }}server 127.0.0.1:65535; # force a 502\n{{ end }}\n}\n\nserver {\n   listen 80;\n\n   location / {\n      proxy_pass http://backend;\n   }\n}\nEOF\n\n        destination   = "local/load-balancer.conf"\n        change_mode   = "signal"\n        change_signal = "SIGHUP"\n      }\n    }\n  }\n}\n'})}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"NOTE"})," I kept getting a ",(0,o.jsx)(n.strong,{children:"502 Bad Gateway"})," error from NGINX when following the ",(0,o.jsx)(n.a,{href:"https://developer.hashicorp.com/nomad/tutorials/load-balancing/load-balancing-nginx",children:"official tutorial"}),'. This happened because - unlike with Docker-Compose where I would add all container to the same virtual network and use the internal DNS service to connect them - here the container are unable to "see" each other directly. Communication always has to leave the local environment using the WAN IP of my host server - which is where my firewall sabotaged my efforts. I am not sure what the recommended way is to handle this issue - don\'t you use firewalls, or should I try to dynamically configure it using Nomads ',(0,o.jsx)(n.code,{children:"exec_raw"})," driver? I solved the issue for now by lifting the Load-Balancer onto my host network stack using ",(0,o.jsx)(n.code,{children:'network_mode = "host"'}),"."]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["This configuration uses Nomad's template to populate the load balancer configuration for NGINX. It uses Consul to get the address and port of services named ",(0,o.jsx)(n.code,{children:"demo-webapp"}),", which are created in the demo web application's job specification. It then makes those services available over static port of 8080 from the load balancer."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'nomad plan nginx.tf                                                                                             [\xb1master \u25cf]\n+ Job: "nginx"\n+ Task Group: "nginx" (1 create)\n  + Task: "nginx" (forces create)\n\nScheduler dry-run:\n- All tasks successfully allocated.\n\nJob Modify Index: 0\nTo submit the job with version verification run:\n\nnomad job run -check-index 0 nginx.tf\n'})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Hashicorp Nomad for NGINX Load-balancing",src:a(393024).Z+"",width:"1175",height:"246"})}),"\n",(0,o.jsx)(n.p,{children:"Testing the round-robin load-balancing:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"curl server-ip\nWelcome! You are on node server-ip:25447\ncurl server-ip\nWelcome! You are on node server-ip:29597\ncurl server-ip\nWelcome! You are on node server-ip:29709\ncurl server-ip\nWelcome! You are on node server-ip:25447\n"})})]})}function h(e={}){const{wrapper:n}={...(0,r.ah)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},603905:(e,n,a)=>{a.d(n,{ah:()=>l});var o=a(667294);function r(e,n,a){return n in e?Object.defineProperty(e,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[n]=a,e}function t(e,n){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),a.push.apply(a,o)}return a}function i(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?t(Object(a),!0).forEach((function(n){r(e,n,a[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):t(Object(a)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(a,n))}))}return e}function s(e,n){if(null==e)return{};var a,o,r=function(e,n){if(null==e)return{};var a,o,r={},t=Object.keys(e);for(o=0;o<t.length;o++)a=t[o],n.indexOf(a)>=0||(r[a]=e[a]);return r}(e,n);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);for(o=0;o<t.length;o++)a=t[o],n.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var c=o.createContext({}),l=function(e){var n=o.useContext(c),a=n;return e&&(a="function"==typeof e?e(n):i(i({},n),e)),a},d={inlineCode:"code",wrapper:function(e){var n=e.children;return o.createElement(o.Fragment,{},n)}},h=o.forwardRef((function(e,n){var a=e.components,r=e.mdxType,t=e.originalType,c=e.parentName,h=s(e,["components","mdxType","originalType","parentName"]),p=l(a),u=r,m=p["".concat(c,".").concat(u)]||p[u]||d[u]||t;return a?o.createElement(m,i(i({ref:n},h),{},{components:a})):o.createElement(m,i({ref:n},h))}));h.displayName="MDXCreateElement"},4748:(e,n,a)=>{a.d(n,{Z:()=>o});const o=a.p+"assets/images/Hashicorp_Nomad_for_NGINX_Load-balancing_01-af05ef13977114a22d8d3257c5cc46c7.png"},393024:(e,n,a)=>{a.d(n,{Z:()=>o});const o=a.p+"assets/images/Hashicorp_Nomad_for_NGINX_Load-balancing_02-cb1c55f543924f884c4f04372d8e1793.png"},686189:(e,n,a)=>{a.d(n,{Z:()=>o});const o=a.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-6c1edb088dfea3a7d39f8eebb8e9dc23.jpg"}}]);