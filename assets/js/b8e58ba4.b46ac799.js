"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[51971],{3905:(e,n,t)=>{t.d(n,{Zo:()=>m,kt:()=>d});var a=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var s=a.createContext({}),c=function(e){var n=a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},m=function(e){var n=c(e.components);return a.createElement(s.Provider,{value:n},e.children)},p={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},u=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,m=l(e,["components","mdxType","originalType","parentName"]),u=c(t),d=r,g=u["".concat(s,".").concat(d)]||u[d]||p[d]||o;return t?a.createElement(g,i(i({ref:n},m),{},{components:t})):a.createElement(g,i({ref:n},m))}));function d(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var o=t.length,i=new Array(o);i[0]=u;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var c=2;c<o;c++)i[c]=t[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}u.displayName="MDXCreateElement"},3713:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>l,toc:()=>c});var a=t(87462),r=(t(67294),t(3905));const o={sidebar_position:6080,slug:"2022-07-22",title:"Go - MQTT Hello World",authors:"mpolinowski",tags:["IoT"]},i=void 0,l={unversionedId:"IoT-and-Machine-Learning/MQTT/2022-07-22-go-hello-world/index",id:"IoT-and-Machine-Learning/MQTT/2022-07-22-go-hello-world/index",title:"Go - MQTT Hello World",description:"Guangzhou, China",source:"@site/docs/IoT-and-Machine-Learning/MQTT/2022-07-22-go-hello-world/index.md",sourceDirName:"IoT-and-Machine-Learning/MQTT/2022-07-22-go-hello-world",slug:"/IoT-and-Machine-Learning/MQTT/2022-07-22-go-hello-world/2022-07-22",permalink:"/docs/IoT-and-Machine-Learning/MQTT/2022-07-22-go-hello-world/2022-07-22",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/IoT-and-Machine-Learning/MQTT/2022-07-22-go-hello-world/index.md",tags:[{label:"IoT",permalink:"/docs/tags/io-t"}],version:"current",sidebarPosition:6080,frontMatter:{sidebar_position:6080,slug:"2022-07-22",title:"Go - MQTT Hello World",authors:"mpolinowski",tags:["IoT"]},sidebar:"tutorialSidebar",previous:{title:"Mosquitto Broker from Source",permalink:"/docs/IoT-and-Machine-Learning/MQTT/2022-07-23-mosquitto-broker-compilation/2022-07-23"},next:{title:"Rust - MQTT Hello World",permalink:"/docs/IoT-and-Machine-Learning/MQTT/2022-07-21-rust-hello-world/2022-07-21"}},s={},c=[{value:"Go Paho MQTT Client",id:"go-paho-mqtt-client",level:2},{value:"Connect to the MQTT broker",id:"connect-to-the-mqtt-broker",level:3},{value:"Running the Program",id:"running-the-program",level:3},{value:"Cross Compiling with Go",id:"cross-compiling-with-go",level:2}],m={toc:c};function p(e){let{components:n,...o}=e;return(0,r.kt)("wrapper",(0,a.Z)({},m,o,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Guangzhou, China",src:t(98796).Z,width:"2385",height:"962"})),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#go-paho-mqtt-client"},"Go Paho MQTT Client"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#connect-to-the-mqtt-broker"},"Connect to the MQTT broker")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#running-the-program"},"Running the Program")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#cross-compiling-with-go"},"Cross Compiling with Go"))),(0,r.kt)("h2",{id:"go-paho-mqtt-client"},"Go Paho MQTT Client"),(0,r.kt)("p",null,"I already wrote a ",(0,r.kt)("a",{parentName:"p",href:"/docs/IoT-and-Machine-Learning/MQTT/2021-09-12--golang-paho-mqtt/2021-09-12/"},"Go MQTT client")," before. I will try to expand this a little bit:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"go mod init go/go-mqtt\ngo get github.com/eclipse/paho.mqtt.golang@latest\n")),(0,r.kt)("h3",{id:"connect-to-the-mqtt-broker"},"Connect to the MQTT broker"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Broker IP"),": ",(0,r.kt)("inlineCode",{parentName:"li"},"192.168.2.115")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"MQTT Service Port"),": ",(0,r.kt)("inlineCode",{parentName:"li"},"1883")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Broker Login"),": ",(0,r.kt)("inlineCode",{parentName:"li"},"admin/instar"))),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Go - MQTT Hello World",src:t(2255).Z,width:"1031",height:"693"})),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"./main.go")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'package main\n\nimport (\n    "fmt"\n    "time"\n\n    mqtt "github.com/eclipse/paho.mqtt.golang"\n)\n\nvar messagePubHandler mqtt.MessageHandler = func(client mqtt.Client, msg mqtt.Message) {\n    fmt.Printf("Topic: %s | %s\\n", msg.Topic(), msg.Payload())\n}\n\nvar connectHandler mqtt.OnConnectHandler = func(client mqtt.Client) {\n    fmt.Println("Connected")\n}\n\nvar connectLostHandler mqtt.ConnectionLostHandler = func(client mqtt.Client, err error) {\n    fmt.Printf("Connect lost: %+v", err)\n}\n\nfunc main() {\n    var broker = "192.168.2.115"\n    var port = 1883\n    opts := mqtt.NewClientOptions()\n    opts.AddBroker(fmt.Sprintf("tcp://%s:%d", broker, port))\n    opts.SetClientID("go_mqtt_client")\n    opts.SetUsername("admin")\n    opts.SetPassword("instar")\n    opts.SetDefaultPublishHandler(messagePubHandler)\n    opts.OnConnect = connectHandler\n    opts.OnConnectionLost = connectLostHandler\n    client := mqtt.NewClient(opts)\n    if token := client.Connect(); token.Wait() && token.Error() != nil {\n        panic(token.Error())\n    }\n\n    sub(client)\n    publish(client)\n\n    client.Disconnect(250)\n}\n\nfunc publish(client mqtt.Client) {\n    // Turn privacy mask 1 on and off again after 15s\n    nums := []int{1, 0}\n    for _, num := range nums {\n        value := fmt.Sprintf("%d", num)\n        token := client.Publish("cameras/115/multimedia/privacy/region1/enable/raw", 0, false, value)\n        token.Wait()\n        time.Sleep(15 * time.Second)\n    }\n}\n\nfunc sub(client mqtt.Client) {\n    // Subscribe to the LWT connection status\n    topic := "cameras/115/status/testament"\n    token := client.Subscribe(topic, 1, nil)\n    token.Wait()\n    fmt.Println("Subscribed to LWT", topic)\n}\n')),(0,r.kt)("h3",{id:"running-the-program"},"Running the Program"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'go run .\\main.go\nConnected\nSubscribed to LWT cameras/115/status/testament\nTopic: cameras/115/status/testament | {"val":"alive"}\n')),(0,r.kt)("p",null,"The program connects to my camera broker, subscribes to the last-will topic and publishes updates to the privacy mask to turn it on and off again after 15s. The client disconnects after 250ms after that."),(0,r.kt)("p",null,"To get a binary file out I can run the build command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"go build ./main.go -o mqtt\n")),(0,r.kt)("p",null,"And run the binary with ",(0,r.kt)("inlineCode",{parentName:"p"},"./mqtt"),"."),(0,r.kt)("h2",{id:"cross-compiling-with-go"},"Cross Compiling with Go"),(0,r.kt)("p",null,"Go supports a variety of platforms and operating systems, including:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Android"),(0,r.kt)("li",{parentName:"ul"},"Darwin"),(0,r.kt)("li",{parentName:"ul"},"Linux"),(0,r.kt)("li",{parentName:"ul"},"Windows")),(0,r.kt)("p",null,"The file created requires a 64bit ",(0,r.kt)("inlineCode",{parentName:"p"},"x86-64")," system to be executed:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"file main\nmain: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, Go BuildID=GkWKfp1sGIj5CJ0LesYM/P1txXPn8ar3YIQEGRF3P/hbjIOYuyC5-d1UMZN32q/CGL0UrtrAC1goylMkfFl, with debug_info, not stripped\n")),(0,r.kt)("p",null,"So how do I get a file that I can use on my IP camera that uses an ARM7 processor?"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"uname -m\narmv7l\n")),(0,r.kt)("p",null,"So how do I find out what systems are supported?"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"go tool dist list\n\nandroid/386\nandroid/amd64\nandroid/arm\nandroid/arm64\nios/amd64\nios/arm64\njs/wasm\nlinux/386\nlinux/amd64\nlinux/arm\nlinux/arm64\nlinux/loong64\nlinux/mips\nlinux/mips64\nlinux/mips64le\nlinux/mipsle\nlinux/ppc64\nlinux/ppc64le\nlinux/riscv64\nlinux/s390x\nwindows/386\nwindows/amd64\nwindows/arm\nwindows/arm64\n\n...\n")),(0,r.kt)("p",null,"I can add the information as a environment variable when running the build:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"env GOOS=linux GOARCH=arm go build -o mqtt_arm\n")),(0,r.kt)("p",null,"Now I got a binary that can be executed on a 32bit ARM system:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"file mqtt_arm\nmqtt_arm: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), statically linked, Go BuildID=msMp-jFIWHH3UaYAwNkh/TSOtDFvNMz_m1j_2VuU-/jOS7whdSr12-3_dBf4qC/xOLKo5WJnx4cluesUzqW, with debug_info, not stripped\n")),(0,r.kt)("p",null,"And this worked - just copying the binary onto my IP Camera and executing it and I got the broker connection. Very nice <3"))}p.isMDXComponent=!0},2255:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/Rust_MQTT_Hello_World_01-68435046037215dc6dc8ad7c87b5b34c.png"},98796:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-4dda98a4eb3b498839926e0b6a5039aa.jpg"}}]);