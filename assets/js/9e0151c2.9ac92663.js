"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[59225],{791811:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>t,toc:()=>l});var r=s(474848),i=s(28453);const a={sidebar_position:8e3,slug:"2021-08-10",title:"Hashicorp Consul Refresher - Key Value Store",authors:"mpolinowski",tags:["Consul","Linux"]},o=void 0,t={id:"DevOps/Hashicorp/2021-08-10--hashicorp-consul-key-value-store/index",title:"Hashicorp Consul Refresher - Key Value Store",description:"Mongkok, Hongkong",source:"@site/docs/DevOps/Hashicorp/2021-08-10--hashicorp-consul-key-value-store/index.md",sourceDirName:"DevOps/Hashicorp/2021-08-10--hashicorp-consul-key-value-store",slug:"/DevOps/Hashicorp/2021-08-10--hashicorp-consul-key-value-store/2021-08-10",permalink:"/docs/DevOps/Hashicorp/2021-08-10--hashicorp-consul-key-value-store/2021-08-10",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Hashicorp/2021-08-10--hashicorp-consul-key-value-store/index.md",tags:[{label:"Consul",permalink:"/docs/tags/consul"},{label:"Linux",permalink:"/docs/tags/linux"}],version:"current",sidebarPosition:8e3,frontMatter:{sidebar_position:8e3,slug:"2021-08-10",title:"Hashicorp Consul Refresher - Key Value Store",authors:"mpolinowski",tags:["Consul","Linux"]},sidebar:"tutorialSidebar",previous:{title:"Hashicorp Consul Refresher - Backups",permalink:"/docs/DevOps/Hashicorp/2021-08-11--hashicorp-consul-backups/2021-08-11"},next:{title:"Hashicorp Consul Refresher - Services",permalink:"/docs/DevOps/Hashicorp/2021-08-09--hashicorp-consul-services/2021-08-09"}},c={},l=[{value:"Add Data",id:"add-data",level:2},{value:"Query Data",id:"query-data",level:2},{value:"Delete Data",id:"delete-data",level:2},{value:"Consul REST API",id:"consul-rest-api",level:2},{value:"Working with KV",id:"working-with-kv",level:2},{value:"Monitor KV Changes",id:"monitor-kv-changes",level:3},{value:"Writing to Environment",id:"writing-to-environment",level:3},{value:"Creating Configuration Files",id:"creating-configuration-files",level:3}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Mongkok, Hongkong",src:s(20257).A+"",width:"1500",height:"556"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#add-data",children:"Add Data"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#query-data",children:"Query Data"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#delete-data",children:"Delete Data"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#consul-rest-api",children:"Consul REST API"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"#working-with-kv",children:"Working with KV"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#monitor-kv-changes",children:"Monitor KV Changes"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#writing-to-environment",children:"Writing to Environment"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#creating-configuration-files",children:"Creating Configuration Files"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Consul includes a ",(0,r.jsx)(n.a,{href:"https://www.consul.io/api/kv",children:"key value store"}),", which you can use to dynamically configure applications. Everything stored inside the KV Store ",(0,r.jsx)(n.strong,{children:"is not encrypted"}),"! I cannot be used for sensitive data like logins, etc. Those have to be stored in Hashicorp Vault."]}),"\n",(0,r.jsx)(n.h2,{id:"add-data",children:"Add Data"}),"\n",(0,r.jsxs)(n.p,{children:["First, insert or PUT some values into the KV store with the ",(0,r.jsx)(n.code,{children:"consul kv put"})," command. The first entry after the command is the key, and the second entry is the value:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"consul kv put redis/config/minconns 1\r\nSuccess! Data written to: redis/config/minconns\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Hashicorp Consul KV",src:s(477283).A+"",width:"1294",height:"629"})}),"\n",(0,r.jsx)(n.h2,{id:"query-data",children:"Query Data"}),"\n",(0,r.jsx)(n.p,{children:"Now, query for the value of one of the keys you just entered:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"consul kv get redis/config/minconns\r\n1\n"})}),"\n",(0,r.jsxs)(n.p,{children:["You can also get some more ",(0,r.jsx)(n.code,{children:"-detailed"})," information:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"consul kv get -detailed redis/config/minconns\r\n\r\nCreateIndex      11763\r\nFlags            0\r\nKey              redis/config/minconns\r\nLockIndex        0\r\nModifyIndex      11763\r\nSession          -\r\nValue            1\n"})}),"\n",(0,r.jsxs)(n.p,{children:["List all the keys in the store using the ",(0,r.jsx)(n.code,{children:"-recurse"})," options. Results are returned in lexicographical order:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"consul kv get -recurse\r\nredis/config/minconns:1\n"})}),"\n",(0,r.jsx)(n.h2,{id:"delete-data",children:"Delete Data"}),"\n",(0,r.jsxs)(n.p,{children:["Delete a key from the Consul KV store, issue a ",(0,r.jsx)(n.code,{children:"delete"})," call."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"consul kv delete redis/config/minconns\r\nSuccess! Deleted key: redis/config/minconns\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Consul lets you interact with keys in a folder-like way. Delete all the keys with the redis prefix using the ",(0,r.jsx)(n.code,{children:"-recurse"})," option:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"consul kv delete -recurse redis\r\nSuccess! Deleted keys with prefix: redis\r\n\r\nconsul kv get redis/config/minconns\r\nError! No key exists at: redis/config/minconns\n"})}),"\n",(0,r.jsx)(n.h2,{id:"consul-rest-api",children:"Consul REST API"}),"\n",(0,r.jsx)(n.p,{children:"You can also use the REST API to store values:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"curl --request PUT --data 'active' http://192.168.2.110:8500/v1/kv/redis/state\r\ntrue\n"})}),"\n",(0,r.jsx)(n.p,{children:"And recall them with a GET request:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'curl --request GET http://192.168.2.110:8500/v1/kv/redis/state | jq\r\n\r\n[\r\n  {\r\n    "LockIndex": 0,\r\n    "Key": "redis/state",\r\n    "Flags": 0,\r\n    "Value": "YWN0aXZl",\r\n    "CreateIndex": 11924,\r\n    "ModifyIndex": 11924\r\n  }\r\n]\n'})}),"\n",(0,r.jsx)(n.p,{children:"Values are stored base64 encoded and have to be decoded to become readable:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"echo 'YWN0aXZl' | base64 --decode\r\nactive\n"})}),"\n",(0,r.jsx)(n.p,{children:"And everything can be deleted again with:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"curl --request DELETE http://192.168.2.110:8500/v1/kv/redis/state\r\ntrue\n"})}),"\n",(0,r.jsx)(n.h2,{id:"working-with-kv",children:"Working with KV"}),"\n",(0,r.jsx)(n.h3,{id:"monitor-kv-changes",children:"Monitor KV Changes"}),"\n",(0,r.jsx)(n.p,{children:"You can trigger actions when a value is changed - e.g. triggering a script execution:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"consul watch -type=key -key=db/update/postgres /opt/consul/scripts/update_postgres.sh\n"})}),"\n",(0,r.jsx)(n.h3,{id:"writing-to-environment",children:"Writing to Environment"}),"\n",(0,r.jsxs)(n.p,{children:["You can write Key/Values to environment variables on your minion server using ",(0,r.jsx)(n.a,{href:"https://releases.hashicorp.com/envconsul/",children:"envconsul"}),". Download the latest version on your minion:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"wget https://releases.hashicorp.com/envconsul/0.11.0/envconsul_0.11.0_linux_amd64.zip\r\nunzip envconsul_0.11.0_linux_amd64.zip\r\nmv envconsul /usr/local/bin\r\nenvconsul -v\r\n\r\nenvconsul v0.11.0 (9f66f6c5)\n"})}),"\n",(0,r.jsx)(n.p,{children:"We can now add a few values to the Consul KV store on our master server that we need to be available to the local instance of our web app - e.g.:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"consul kv put frontend/elasticsearch/connection_string 'https://elasticsearch.mydomain.com'\r\nconsul kv put frontend/elasticsearch/index 'dev_2021_08_23'\r\nconsul kv put frontend/elasticsearch/_type '_doc'\n"})}),"\n",(0,r.jsx)(n.p,{children:"Make sure the minion server has access to those variables:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"consul kv get -recurse\r\n\r\nfrontend/elasticsearch/_type:_doc\r\nfrontend/elasticsearch/connection_string:https://elasticsearch.mydomain.com\r\nfrontend/elasticsearch/index:dev_2021_08_23\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Now we can use ",(0,r.jsx)(n.code,{children:"envconsul"})," to read those entries and write them into the system environment:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"envconsul -upcase -prefix frontend/elasticsearch env\r\n\r\n_TYPE=_doc\r\nINDEX=dev_2021_08_23\r\nCONNECTION_STRING=https://elasticsearch.mydomain.com\n"})}),"\n",(0,r.jsx)(n.h3,{id:"creating-configuration-files",children:"Creating Configuration Files"}),"\n",(0,r.jsxs)(n.p,{children:["Hashicorp ",(0,r.jsx)(n.a,{href:"https://github.com/hashicorp/consul-template",children:"Consul Template"})," is a Template rendering, notifier, and supervisor for @hashicorp Consul and Vault data. This project provides a convenient way to populate values from Consul into the file system using the consul-template daemon."]}),"\n",(0,r.jsxs)(n.p,{children:["The daemon consul-template queries a Consul or Vault cluster and updates any number of specified templates on the file system. As an added bonus, it can optionally run arbitrary commands when the update process completes. Please see the examples folder for some scenarios where this functionality might prove useful. Download the ",(0,r.jsx)(n.a,{href:"https://releases.hashicorp.com/consul-template/",children:"latest version"})," and unzip it to ",(0,r.jsx)(n.code,{children:"/usr/local/bin"})," on your minion server:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"wget https://releases.hashicorp.com/consul-template/0.27.0/consul-template_0.27.0_linux_amd64.zip\r\nunzip consul-template_0.27.0_linux_amd64.zip\r\nmv consul-template /usr/local/bin\r\nconsul-template -v\r\n\r\nconsul-template v0.27.0 (d4af0222)\n"})}),"\n",(0,r.jsx)(n.p,{children:"We can now create a configuration template file that can be populated with data from the Consul K/V store:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"nano es_config.json.tmpl\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cfg",children:'connection_string: {{ key "frontend/elasticsearch/connection_string" }}\r\nindex: {{ key "frontend/elasticsearch/index" }}\r\n_type_: {{ key "frontend/elasticsearch/_type" }}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["We can now use ",(0,r.jsx)(n.code,{children:"consul-template"})," to populate the configuration file for us:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'consul-template -template "es_config.json.tmpl:config.json" -once\n'})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:["Without the ",(0,r.jsx)(n.code,{children:"-once"})," flag the configuration will automatically be update every time a value in the Consul KV store is updated!"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cat config.json\r\n\r\nconnection_string: https://elasticsearch.mydomain.com\r\nindex: dev_2021_08_23\r\n_type_: _doc\n"})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},477283:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Hashicorp_Consul_KV_01-4a873880705a33f63b83540f3e193c83.png"},20257:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-d415091b78f8a4ac96caeb7f698effe6.jpg"},28453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>t});var r=s(296540);const i={},a=r.createContext(i);function o(e){const n=r.useContext(a);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);