"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[13024],{104888:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>a,default:()=>d,frontMatter:()=>i,metadata:()=>c,toc:()=>l});var s=n(785893),r=n(603905);const i={sidebar_position:8960,slug:"2022-10-14",title:"Python - Working with the Elasticsearch REST API",authors:"mpolinowski",tags:["Python"],description:"Run OpenSearch search queries and process the JSON response."},a=void 0,c={id:"Development/Python/2022-10-14-python-rest-elastic/index",title:"Python - Working with the Elasticsearch REST API",description:"Run OpenSearch search queries and process the JSON response.",source:"@site/docs/Development/Python/2022-10-14-python-rest-elastic/index.md",sourceDirName:"Development/Python/2022-10-14-python-rest-elastic",slug:"/Development/Python/2022-10-14-python-rest-elastic/2022-10-14",permalink:"/docs/Development/Python/2022-10-14-python-rest-elastic/2022-10-14",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Development/Python/2022-10-14-python-rest-elastic/index.md",tags:[{label:"Python",permalink:"/docs/tags/python"}],version:"current",sidebarPosition:8960,frontMatter:{sidebar_position:8960,slug:"2022-10-14",title:"Python - Working with the Elasticsearch REST API",authors:"mpolinowski",tags:["Python"],description:"Run OpenSearch search queries and process the JSON response."},sidebar:"tutorialSidebar",previous:{title:"Python - Build a REST API",permalink:"/docs/Development/Python/2022-10-15-python-rest-server/2022-10-15"},next:{title:"Python - Working with REST API Requests",permalink:"/docs/Development/Python/2022-10-13-python-rest-api/2022-10-13"}},o={},l=[{value:"Search - cURL to Python",id:"search---curl-to-python",level:2},{value:"Dynamic Search Terms",id:"dynamic-search-terms",level:2},{value:"Elasticsearch Flask Client",id:"elasticsearch-flask-client",level:2}];function h(e){const t={a:"a",blockquote:"blockquote",code:"code",em:"em",h2:"h2",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.ah)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"Sham Sui Po, Hong Kong",src:n(724552).Z+"",width:"1500",height:"548"})}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"#search---curl-to-python",children:"Search - cURL to Python"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"#dynamic-search-terms",children:"Dynamic Search Terms"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"#elasticsearch-flask-client",children:"Elasticsearch Flask Client"})}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.a,{href:"https://github.com/mpolinowski/python-search",children:"Github Repository"})}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Step 1"}),": ",(0,s.jsx)(t.a,{href:"/docs/DevOps/Elasticsearch/2022-10-11--opensearch-docker-compose/2022-10-11",children:"Set up a Single Node Opensearch or Elasticsearch Cluster"})]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Step 2"}),": ",(0,s.jsx)(t.a,{href:"/docs/Development/Python/2022-10-07-python-docusaurus-elasticsearch/2022-10-07#elasticsearch",children:"Create an Index Mapping and Ingest your Data"})]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Step 3"}),": ",(0,s.jsx)(t.a,{href:"/docs/Development/Python/2022-10-13-python-rest-api/2022-10-13",children:"Testing the Opensearch Rest API using cURL"})]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"search---curl-to-python",children:"Search - cURL to Python"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"curl -XGET \"https://localhost:9200/_search?q=Continuous%20Integration&filter_path=took,hits.hits._id,hits.hits._score,hits.hits._source&_source=title&pretty\" --insecure -H 'Content-Type: application/json' -u admin\n"})}),"\n",(0,s.jsxs)(t.p,{children:["In Python again, I am running into the HTTPS/Certificate issue on localhost and have to add a ",(0,s.jsx)(t.code,{children:", verify=False"})," to the request:"]}),"\n",(0,s.jsxs)(t.blockquote,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.code,{children:"requests.exceptions.SSLError: HTTPSConnectionPool(host='localhost', port=9200): Max retries exceeded with url: /_search?q=Continuous%20Integration&filter_path=took,hits.hits._id,hits.hits._score,hits.hits._source&_source=title&pretty (Caused by SSLError(SSLCertVerificationError(1, '[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:997)')))"})}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-py",children:"import requests\nimport json\nfrom requests.auth import HTTPBasicAuth\n\nusername = 'admin'\npassword = 'admin'\n\nresponse = requests.get('https://localhost:9200/_search?q=Continuous%20Integration&filter_path=took,hits.hits._id,hits.hits._score,hits.hits._source&_source=title', auth = HTTPBasicAuth(username, password), verify=False)\n\nprint(response.content)\n"})}),"\n",(0,s.jsx)(t.p,{children:"This returns the correctly filtered byte response:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:'b\'{"took":5,"hits":{"hits":[{"_id":"docs_ci-cd","_score":3.0692163,"_source":{"title":"What is meant by CI/CD?"}},{"_id":"docs_dev-intro","_score":0.7032547,"_source":{"title":"Application Development and Server Operation"}}]}}\'\n'})}),"\n",(0,s.jsx)(t.p,{children:"To extract the JSON string:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-py",children:"result = response.content.decode()\nprint(type(result))\n\nresult_dictionary = json.loads(result)\nprint(type(result_dictionary))\n\nbest_match = result_dictionary['hits']['hits'][0]\nprint(best_match)\n"})}),"\n",(0,s.jsx)(t.p,{children:"This decoded the bytes into a string and extracted the JSON object from it:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"<class 'str'>\n<class 'dict'>\n{'_id': 'docs_ci-cd', '_score': 3.0692163, '_source': {'title': 'What is meant by CI/CD?'}}\n"})}),"\n",(0,s.jsx)(t.h2,{id:"dynamic-search-terms",children:"Dynamic Search Terms"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-py",children:"import requests\nimport json\nfrom requests.auth import HTTPBasicAuth\n\nfrom elastic_config import *\n\ndef ask_es(query):\n    url = f'https://{elastic_url}/{elastic_index}/_search?q={query}'\n    response = requests.get(url, auth = HTTPBasicAuth(elastic_user, elastic_pass), verify=False)\n    result = response.content.decode()\n    result_dictionary = json.loads(result)\n    \n    return result_dictionary\n\nresults = ask_es(query='Continuous%20Integration')\n\nfor result in results['hits']['hits']:\n    print(result['_source']['title'])\n    print(result['_source']['abstract'])\n"})}),"\n",(0,s.jsxs)(t.p,{children:["with ",(0,s.jsx)(t.code,{children:"elastic_config.py"}),":"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-py",children:"elastic_user = 'admin'\nelastic_pass = 'admin'\nelastic_url = 'localhost:9200'\nelastic_index = 'dev_2022_08_20' \n"})}),"\n",(0,s.jsx)(t.h2,{id:"elasticsearch-flask-client",children:"Elasticsearch Flask Client"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-py",children:"from flask import Flask, render_template, request\nimport urllib.parse\nimport requests\nimport json\n\nelastic_user = 'admin'\nelastic_pass = 'admin'\n\ndef ask_elastic(query, elastic_url, elastic_index):\n    url = f'https://{elastic_url}/{elastic_index}/_search?q={query}'\n    response = requests.get(url, auth = requests.auth.HTTPBasicAuth(elastic_user, elastic_pass), verify=False)\n    result = response.content.decode()\n    result_dictionary = json.loads(result)\n    \n    return result_dictionary\n\napp = Flask(__name__)\n\n@app.route('/', methods=['GET'])\ndef home_get():\n    return render_template('index.html')\n\n@app.route('/', methods=['POST'])\ndef home_post():\n    elastic_url = request.form['elastic_url']\n    elastic_index = request.form['elastic_index']\n    query = request.form['query']\n    safe_request = urllib.parse.quote(query)\n    # print(safe_request)\n    response = ask_elastic(query=safe_request, elastic_url=elastic_url, elastic_index=elastic_index)\n    results = response['hits']['hits']\n    return render_template('results.html', query = query, len = len(results), result = results)\n\napp.run(host='0.0.0.0') \n"})}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"Python - Working with the Elasticsearch REST API",src:n(520089).Z+"",width:"1071",height:"400"})}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.em,{children:"index.html"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-html",children:'<!DOCTYPE html>\n<html lang="en">\n  <head>\n    <meta charset="utf-8">\n    <title>Elastic Flask</title>\n  </head>\n  <body>\n    <header>\n      <h1>Elasticsearch Client</h1>\n    </header>\n    <main>\n      <p>Enter a search request:</p>\n      <form method="POST">\n        <div><p>Elasticsearch URL : </p><input placeholder="Elasticsearch URL" value="localhost:9200" name="elastic_url"></input></div>\n        <div><p>Elasticsearch Index : </p><input placeholder="Elasticsearch Index" value="dev_2022_08_20" name="elastic_index"></input></div>\n        <div><p>Search Query : </p><input placeholder="Search Query" name="query"></input></div>\n        <br/>\n        <button>Ask Elastic</button>\n      </form>\n    </main>\n  </body>\n</html>\n'})}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"Python - Working with the Elasticsearch REST API",src:n(730145).Z+"",width:"1009",height:"278"})}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.em,{children:"results.html"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-html",children:'<!DOCTYPE html>\n<html lang="en">\n  <head>\n    <meta charset="utf-8">\n    <title>Elastic Flask</title>\n  </head>\n  <body>\n    <header>\n      <h1>Elasticsearch Client</h1>\n    </header>\n    <main>\n      <p>Enter a search request:</p>\n      <form method="POST">\n        <div><input value="{{query}}" name="query"></input></div>\n        <h3>Search Results</h3>\n        <ol>\n          {%for i in range(0, len)%}\n              <li>{{result[i][\'_source\'][\'title\']}}</li>\n          {%endfor%}\n        </ol>\n      </form>\n    </main>\n  </body>\n</html>\n'})})]})}function d(e={}){const{wrapper:t}={...(0,r.ah)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},603905:(e,t,n)=>{n.d(t,{ah:()=>l});var s=n(667294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,s)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,s,r=function(e,t){if(null==e)return{};var n,s,r={},i=Object.keys(e);for(s=0;s<i.length;s++)n=i[s],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(s=0;s<i.length;s++)n=i[s],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var o=s.createContext({}),l=function(e){var t=s.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},h={inlineCode:"code",wrapper:function(e){var t=e.children;return s.createElement(s.Fragment,{},t)}},d=s.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,o=e.parentName,d=c(e,["components","mdxType","originalType","parentName"]),u=l(n),p=r,m=u["".concat(o,".").concat(p)]||u[p]||h[p]||i;return n?s.createElement(m,a(a({ref:t},d),{},{components:n})):s.createElement(m,a({ref:t},d))}));d.displayName="MDXCreateElement"},520089:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/Opensearch_Rest_API_01-96429c082519af574aa19900caac2086.png"},730145:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/Opensearch_Rest_API_02-13be1e22ae12cb8fbddeb9ae6f9e2de2.png"},724552:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-5f44d483789c3ce79f05418f930f5cd2.jpg"}}]);