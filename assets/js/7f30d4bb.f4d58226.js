"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[3393],{676244:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>t,default:()=>h,frontMatter:()=>o,metadata:()=>c,toc:()=>l});var r=s(474848),i=s(28453);const o={sidebar_position:9060,slug:"2020-08-18",title:"Consul Service Mesh",authors:"mpolinowski",tags:["LINUX","Consul"]},t=void 0,c={id:"DevOps/Hashicorp/2020-08-18--consul-service-mesh/index",title:"Consul Service Mesh",description:"TST, Hong Kong",source:"@site/docs/DevOps/Hashicorp/2020-08-18--consul-service-mesh/index.md",sourceDirName:"DevOps/Hashicorp/2020-08-18--consul-service-mesh",slug:"/DevOps/Hashicorp/2020-08-18--consul-service-mesh/2020-08-18",permalink:"/docs/DevOps/Hashicorp/2020-08-18--consul-service-mesh/2020-08-18",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Hashicorp/2020-08-18--consul-service-mesh/index.md",tags:[{label:"LINUX",permalink:"/docs/tags/linux"},{label:"Consul",permalink:"/docs/tags/consul"}],version:"current",sidebarPosition:9060,frontMatter:{sidebar_position:9060,slug:"2020-08-18",title:"Consul Service Mesh",authors:"mpolinowski",tags:["LINUX","Consul"]},sidebar:"tutorialSidebar",previous:{title:"Consul Deployment Guide",permalink:"/docs/DevOps/Hashicorp/2020-08-19--consul-deployment-guide/2020-08-19"},next:{title:"Joining Consul Clients",permalink:"/docs/DevOps/Hashicorp/2020-08-18--consul-mock-datacenter/2020-08-19"}},a={},l=[{value:"Connect Services with Consul Service Mesh",id:"connect-services-with-consul-service-mesh",level:2},{value:"Register a Service and Proxy with Consul",id:"register-a-service-and-proxy-with-consul",level:3}];function d(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"TST, Hong Kong",src:s(659314).A+"",width:"1500",height:"562"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"#connect-services-with-consul-service-mesh",children:"Connect Services with Consul Service Mesh"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#register-a-service-and-proxy-with-consul",children:"Register a Service and Proxy with Consul"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#register-a-dependent-service-and-proxy---",children:"Register a Dependent Service and Proxy --\x3e"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"connect-services-with-consul-service-mesh",children:"Connect Services with Consul Service Mesh"}),"\n",(0,r.jsx)(n.p,{children:"In addition to providing IP addresses directly to services with the DNS interface or HTTP API, Consul can connect services to each other via sidecar proxies that you deploy locally with each service instance. This type of deployment, local sidecar proxies that control network traffic between service instances, is a service mesh."}),"\n",(0,r.jsx)(n.p,{children:"Consul service mesh lets you secure and observe communication between your services without modifying their code. Instead Consul configures sidecar proxies to establish mutual TLS between your services and either allow or deny communication between them based on their registered names. Because sidecar proxies control all service-to-service traffic, they can gather metrics about them and export them to a third party aggregator like Prometheus."}),"\n",(0,r.jsx)(n.h3,{id:"register-a-service-and-proxy-with-consul",children:"Register a Service and Proxy with Consul"}),"\n",(0,r.jsxs)(n.p,{children:["Begin by starting a service that is unaware of Consul. I am going to start a HTTP web services on port 80 that is serving a simple ",(0,r.jsx)(n.code,{children:"hello world"})," html page (see previous tutorial)."]}),"\n",(0,r.jsx)(n.p,{children:"Next, register the service with Consul by writing a new service definition, like you did in the last tutorial. This time you will include a Connect stanza in the registration that will register a sidecar proxy to handle traffic for this backend service instance."}),"\n",(0,r.jsxs)(n.p,{children:["Add a file called ",(0,r.jsx)(n.code,{children:"web.json"})," to the consul.d directory with the following command:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"nano /etc/consul.d/web.json\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\r\n  "service": {\r\n    "name": "web",\r\n    "tags": [\r\n      "frontend"\r\n    ],\r\n    "port": 80,\r\n    "connect": { \r\n      "sidecar_service": {}\r\n    },\r\n    "check": {\r\n      "args": [\r\n        "curl",\r\n        "localhost"\r\n      ],\r\n      "interval": "10s"\r\n    }\r\n  }\r\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"Now run Consul so it will read the new configuration."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"consul agent -dev -enable-script-checks -config-dir=/etc/consul.d\n"})}),"\n",(0,r.jsx)(n.p,{children:"Consul does not automatically start the proxy process for you. This is because Consul Connect service mesh allows you to chose the proxy you'd like to use."}),"\n",(0,r.jsx)(n.p,{children:"Consul comes with a L4 proxy for testing purposes, and first-class support for Envoy, which you should use for production deployments and layer 7 traffic management. You'll use the L4 proxy in this tutorial, because, unlike Envoy, it comes with Consul and doesn't require any extra installation. Start the proxy process in another terminal window using the consul connect proxy command, and specify which service instance and proxy registration it corresponds to."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'consul connect proxy -sidecar-for web\r\n\r\n==> Consul Connect proxy starting...\r\n    Configuration mode: Agent API\r\n        Sidecar for ID: web\r\n              Proxy ID: web-sidecar-proxy\r\n\r\n==> Log data will now stream in as it occurs:\r\n\r\n    2020-08-30T14:25:30.585Z [INFO]  proxy: Proxy loaded config and ready to serve\r\n    2020-08-30T14:25:30.585Z [INFO]  proxy: Parsed TLS identity: uri=spiffe://db65c1da-8cb1-4641-3a8a-1996e1dc9f1e.consul/ns/default/dc/dc1/svc/web roots=[pri-7ba54zn.consul.ca.db65c1da.consul]\r\n    2020-08-30T14:25:30.585Z [INFO]  proxy: Starting listener: listener="public listener" bind_addr=0.0.0.0:21000\n'})}),"\n",(0,r.jsxs)(n.p,{children:["You can check the Consul webUI - all health checks should now be ",(0,r.jsx)(n.strong,{children:"green"}),":"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Consul Service Mesh",src:s(354492).A+"",width:"1131",height:"678"})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},354492:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/Consul_Service_Mesh_01-83ac331591fffa073f0ea03b3cb080fd.png"},659314:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-57269f97e6ae2616c9623b1eb52b5373.jpg"},28453:(e,n,s)=>{s.d(n,{R:()=>t,x:()=>c});var r=s(296540);const i={},o=r.createContext(i);function t(e){const n=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);