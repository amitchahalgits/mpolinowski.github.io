"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[99366],{949437:(s,e,n)=>{n.r(e),n.d(e,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>t,metadata:()=>i,toc:()=>c});var r=n(474848),o=n(28453);const t={sidebar_position:8060,slug:"2021-03-26",title:"Elasticsearch 7 to log Linux System Events",authors:"mpolinowski",tags:["LINUX","Elasticsearch"]},a=void 0,i={id:"DevOps/Elasticsearch/2021-03-26-elasticsearch7-for-syslog-messages/index",title:"Elasticsearch 7 to log Linux System Events",description:"Harbin, China",source:"@site/docs/DevOps/Elasticsearch/2021-03-26-elasticsearch7-for-syslog-messages/index.md",sourceDirName:"DevOps/Elasticsearch/2021-03-26-elasticsearch7-for-syslog-messages",slug:"/DevOps/Elasticsearch/2021-03-26-elasticsearch7-for-syslog-messages/2021-03-26",permalink:"/docs/DevOps/Elasticsearch/2021-03-26-elasticsearch7-for-syslog-messages/2021-03-26",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Elasticsearch/2021-03-26-elasticsearch7-for-syslog-messages/index.md",tags:[{label:"LINUX",permalink:"/docs/tags/linux"},{label:"Elasticsearch",permalink:"/docs/tags/elasticsearch"}],version:"current",sidebarPosition:8060,frontMatter:{sidebar_position:8060,slug:"2021-03-26",title:"Elasticsearch 7 to log Linux System Events",authors:"mpolinowski",tags:["LINUX","Elasticsearch"]},sidebar:"tutorialSidebar",previous:{title:"Elasticsearch 7 Aggregations",permalink:"/docs/DevOps/Elasticsearch/2021-03-27-elasticsearch7-aggregations/2021-03-27"},next:{title:"Log all the searches going through Elasticsearch",permalink:"/docs/DevOps/Elasticsearch/2021-03-25-elasticsearch7-activate-logging-of-search-queries/2021-03-25"}},l={},c=[{value:"Configuring Logstash",id:"configuring-logstash",level:2},{value:"Running Logstash",id:"running-logstash",level:2},{value:"Kibana",id:"kibana",level:2}];function g(s){const e={a:"a",blockquote:"blockquote",code:"code",em:"em",h2:"h2",img:"img",p:"p",pre:"pre",...(0,o.R)(),...s.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{alt:"Harbin, China",src:n(283325).A+"",width:"1500",height:"376"})}),"\n",(0,r.jsxs)(e.p,{children:["Logstash together with Remote Syslog (",(0,r.jsx)(e.em,{children:"rsyslog"}),") can monitor remote host systems via an UDP or TCP connection. But I personally prefer to use ",(0,r.jsx)(e.a,{href:"/docs/DevOps/Zabbix/2020-07-15--zabbix-docker-installation/2020-07-15",children:"Zabbix to monitor remote servers"}),". But it might be interesting to spin up an ELK cluster on your server to debug a problem. For this I am going to use Logstash to monitor the local ",(0,r.jsx)(e.code,{children:"/var/log/syslog"}),":"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"head -10 /var/log/syslog \n"})}),"\n",(0,r.jsx)(e.h2,{id:"configuring-logstash",children:"Configuring Logstash"}),"\n",(0,r.jsxs)(e.p,{children:["And I am going to use the ",(0,r.jsx)(e.a,{href:"https://github.com/coralogix-resources/logstash-syslog/blob/master/logstash-monitoring-syslog.conf",children:"Coralogix Logstash configuration file"})," to run Logstash:"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-json",children:'input {\r\n  file {\r\n     path => ["/usr/share/logstash/syslog"]\r\n     type => "syslog"\r\n     start_position => "beginning"\r\n   }\r\n}\r\nfilter {\r\n       if [type] == "syslog" {\r\n    grok {\r\n      match => { "message" => "%{SYSLOGTIMESTAMP:syslog_timestamp} %{SYSLOGHOST:syslog_hostname} %{DATA:syslog_program}(?:\\[%{POSINT:syslog_pid}\\])?: %{GREEDYDATA:syslog_message}" }\r\n      add_field => [ "received_at", "%{@timestamp}" ]\r\n      add_field => [ "received_from", "%{host}" ]\r\n    }\r\n    date {\r\n      match => [ "syslog_timestamp", "MMM  d HH:mm:ss", "MMM dd HH:mm:ss" ]\r\n      target => "syslog_timestamp"\r\n    }\r\n  }\r\n}\r\noutput{\r\n  elasticsearch{\r\n    hosts => ["localhost:9200"] \r\n    index => "syslog-monitor" \r\n  }\r\n}\n'})}),"\n",(0,r.jsx)(e.h2,{id:"running-logstash",children:"Running Logstash"}),"\n",(0,r.jsx)(e.p,{children:"I will now try to ingest the entire log into Elasticsearch using my Logstash container:"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:'docker run \\\r\n   --name logstash \\\r\n   --net=host \\\r\n   --rm -it \\\r\n   -v /opt/logstash/pipeline/logstash.conf:/usr/share/logstash/pipeline/logstash.conf \\\r\n   -v /var/log/syslog:/usr/share/logstash/syslog:Z \\\r\n   -e "ELASTIC_HOST=localhost:9200" \\\r\n   -e "XPACK_SECURITY_ENABLED=false" \\\r\n   -e "XPACK_REPORTING_ENABLED=false" \\\r\n   -e "XPACK_MONITORING_ENABLED=false" \\\r\n   -e "XPACK_MONITORING_ELASTICSEARCH_USERNAME=elastic" \\\r\n   -e "XPACK_MONITORING_ELASTICSEARCH_PASSWORD=changeme" \\\r\n   logstash:7.13.4\n'})}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsxs)(e.p,{children:["I ran into permission issues here: ",(0,r.jsx)(e.code,{children:'failed to open file {:path=>"/usr/share/logstash/syslog", :exception=>Errno::EACCES, :message=>"Permission denied - /usr/share/logstash/syslog"}'}),". Had to chmod the syslog file to give Docker access."]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Logstash is running quietly in the background. To check if there is content data being indexed run the following command and you should see last 2 documents that were generated:"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"curl -XGET \"http://localhost:9200/syslog-monitor/_search?pretty\"  -H 'Content-Type: application/json' -d ' { \"size\": 2 }'\n"})}),"\n",(0,r.jsx)(e.p,{children:"And it looks like it is working:"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-json",children:'{\r\n  "took" : 0,\r\n  "timed_out" : false,\r\n  "_shards" : {\r\n    "total" : 1,\r\n    "successful" : 1,\r\n    "skipped" : 0,\r\n    "failed" : 0\r\n  },\r\n  "hits" : {\r\n    "total" : {\r\n      "value" : 8307,\r\n      "relation" : "eq"\r\n    },\r\n    "max_score" : 1.0,\r\n    "hits" : [\r\n      {\r\n        "_index" : "syslog-monitor",\r\n        "_type" : "_doc",\r\n        "_id" : "CBVIDHsBhWUvimFeD-Tj",\r\n        "_score" : 1.0,\r\n        "_source" : {\r\n          "syslog_message" : "var-lib-docker-overlay2-eb8de377cf683367ca97a620a723c4c6ddd7ccd68090fb050c9ab427ea5c2d47-merged.mount: Succeeded.",\r\n          "type" : "syslog",\r\n          "syslog_program" : "systemd",\r\n          "syslog_hostname" : "debian11",\r\n          "received_at" : "2021-08-03T13:50:54.304Z",\r\n          "syslog_timestamp" : "2021-08-03T21:46:24.000Z",\r\n          "host" : "debian11",\r\n          "@timestamp" : "2021-08-03T13:50:54.304Z",\r\n          "path" : "/usr/share/logstash/syslog",\r\n          "syslog_pid" : "1",\r\n          "received_from" : "debian11",\r\n          "message" : "Aug  3 21:46:24 debian11 systemd[1]: var-lib-docker-overlay2-eb8de377cf683367ca97a620a723c4c6ddd7ccd68090fb050c9ab427ea5c2d47-merged.mount: Succeeded.",\r\n          "@version" : "1"\r\n        }\r\n      },\r\n      {\r\n        "_index" : "syslog-monitor",\r\n        "_type" : "_doc",\r\n        "_id" : "CRVLDHsBhWUvimFeuuQO",\r\n        "_score" : 1.0,\r\n        "_source" : {\r\n          "@timestamp" : "2021-08-03T13:54:53.923Z",\r\n          "syslog_message" : "Finished Rotate log files.",\r\n          "type" : "syslog",\r\n          "host" : "debian11",\r\n          "syslog_hostname" : "debian11",\r\n          "received_at" : "2021-08-03T13:54:53.923Z",\r\n          "received_from" : "debian11",\r\n          "syslog_program" : "systemd",\r\n          "@version" : "1",\r\n          "path" : "/usr/share/logstash/syslog",\r\n          "syslog_timestamp" : "2021-08-01T17:55:44.000Z",\r\n          "syslog_pid" : "1",\r\n          "message" : "Aug  1 17:55:44 debian11 systemd[1]: Finished Rotate log files."\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\n'})}),"\n",(0,r.jsx)(e.h2,{id:"kibana",children:"Kibana"}),"\n",(0,r.jsxs)(e.p,{children:["I can now create an Index Pattern in Kibana with ",(0,r.jsx)(e.code,{children:"received_at"})," as the primary time field:"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{alt:"Logstash for Syslogs",src:n(860135).A+"",width:"1497",height:"479"})}),"\n",(0,r.jsx)(e.p,{children:"And drill down the log entries on a time line:"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{alt:"Logstash for Syslogs",src:n(991660).A+"",width:"1489",height:"703"})})]})}function d(s={}){const{wrapper:e}={...(0,o.R)(),...s.components};return e?(0,r.jsx)(e,{...s,children:(0,r.jsx)(g,{...s})}):g(s)}},860135:(s,e,n)=>{n.d(e,{A:()=>r});const r=n.p+"assets/images/Logstash_for_Syslogs_01-7da163880bb8b9131d6d293125f63755.png"},991660:(s,e,n)=>{n.d(e,{A:()=>r});const r=n.p+"assets/images/Logstash_for_Syslogs_02-49dc0db2229731bdfa8dd7d2d016ca25.png"},283325:(s,e,n)=>{n.d(e,{A:()=>r});const r=n.p+"assets/images/photo-456tdsfggd_67gfh6dgdf4_d-ead0c98a32466e0f9eb24be25c9fe588.jpg"},28453:(s,e,n)=>{n.d(e,{R:()=>a,x:()=>i});var r=n(296540);const o={},t=r.createContext(o);function a(s){const e=r.useContext(t);return r.useMemo((function(){return"function"==typeof s?s(e):{...e,...s}}),[e,s])}function i(s){let e;return e=s.disableParentContext?"function"==typeof s.components?s.components(o):s.components||o:a(s.components),r.createElement(t.Provider,{value:e},s.children)}}}]);