"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[79741],{405981:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>t,default:()=>h,frontMatter:()=>o,metadata:()=>c,toc:()=>l});var s=i(474848),r=i(28453);const o={sidebar_position:7080,slug:"2021-08-12",title:"Hashicorp Consul Refresher - Service Mesh",authors:"mpolinowski",tags:["Consul","Linux"]},t=void 0,c={id:"DevOps/Hashicorp/2021-08-12--hashicorp-consul-service-mesh/index",title:"Hashicorp Consul Refresher - Service Mesh",description:"Wan Chai, Hongkong",source:"@site/docs/DevOps/Hashicorp/2021-08-12--hashicorp-consul-service-mesh/index.md",sourceDirName:"DevOps/Hashicorp/2021-08-12--hashicorp-consul-service-mesh",slug:"/DevOps/Hashicorp/2021-08-12--hashicorp-consul-service-mesh/2021-08-12",permalink:"/docs/DevOps/Hashicorp/2021-08-12--hashicorp-consul-service-mesh/2021-08-12",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Hashicorp/2021-08-12--hashicorp-consul-service-mesh/index.md",tags:[{label:"Consul",permalink:"/docs/tags/consul"},{label:"Linux",permalink:"/docs/tags/linux"}],version:"current",sidebarPosition:7080,frontMatter:{sidebar_position:7080,slug:"2021-08-12",title:"Hashicorp Consul Refresher - Service Mesh",authors:"mpolinowski",tags:["Consul","Linux"]},sidebar:"tutorialSidebar",previous:{title:"Hashicorp Consul Refresher - Access Control Lists",permalink:"/docs/DevOps/Hashicorp/2021-08-13--hashicorp-consul-access-control-lists/2021-08-13"},next:{title:"Hashicorp Consul Refresher - Backups",permalink:"/docs/DevOps/Hashicorp/2021-08-11--hashicorp-consul-backups/2021-08-11"}},a={},l=[{value:"Consul Connect",id:"consul-connect",level:2},{value:"Application Security",id:"application-security",level:3},{value:"Observability",id:"observability",level:3},{value:"Sidecar Service Registration",id:"sidecar-service-registration",level:2},{value:"Intentions",id:"intentions",level:2},{value:"Wildcard Intentions",id:"wildcard-intentions",level:3},{value:"Load Balancing Services with Envoy",id:"load-balancing-services-with-envoy",level:2}];function d(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Wan Chai, Hongkong",src:i(425563).A+"",width:"1500",height:"557"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"#consul-connect",children:"Consul Connect"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#application-security",children:"Application Security"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#observability",children:"Observability"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#sidecar-service-registration",children:"Sidecar Service Registration"})}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"#intentions",children:"Intentions"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#wildcard-intentions",children:"Wildcard Intentions"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#load-balancing-services-with-envoy",children:"Load Balancing Services with Envoy"})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"consul-connect",children:"Consul Connect"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://www.consul.io/docs/connect",children:"Consul Connect"})," provides service-to-service connection authorization and encryption using mutual Transport Layer Security (TLS). Applications can use ",(0,s.jsx)(n.a,{href:"https://www.consul.io/docs/connect/proxies/built-in",children:"Sidecar Proxies"})," in a service mesh configuration to establish TLS connections for inbound and outbound connections without being aware of Connect at all."]}),"\n",(0,s.jsxs)(n.p,{children:["The first step to use Connect is to enable Connect for your Consul cluster. By default, Connect is disabled. Enabling Connect requires changing the configuration of only your Consul servers (",(0,s.jsx)(n.strong,{children:"not client agents"}),"). To enable Connect, add the following to a new or existing server configuration file. In an existing cluster, this configuration change requires a Consul server restart:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo nano /etc/consul.d/consul.hcl\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Add the following lines to the end of the file and ",(0,s.jsx)(n.code,{children:"service consul restart"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:"connect {\r\n  enabled = true\r\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"application-security",children:"Application Security"}),"\n",(0,s.jsx)(n.p,{children:"Connect enables secure deployment best-practices with automatic service-to-service encryption, and identity-based authorization. Connect uses the registered service identity (rather than IP addresses) to enforce access control with intentions."}),"\n",(0,s.jsx)(n.h3,{id:"observability",children:"Observability"}),"\n",(0,s.jsx)(n.p,{children:'One of the key benefits of Consul Connect is the uniform and consistent view it can provide of all the services on your network, irrespective of their different programming languages and frameworks. When you configure Consul Connect to use sidecar proxies, those proxies "see" all service-to-service traffic and can collect data about it.'}),"\n",(0,s.jsx)(n.h2,{id:"sidecar-service-registration",children:"Sidecar Service Registration"}),"\n",(0,s.jsxs)(n.p,{children:["To make Connect aware of proxies you will need to register them in a ",(0,s.jsx)(n.a,{href:"https://www.consul.io/docs/agent/services",children:"Service Definition"}),", just like you would register any other service with Consul. To reduce the amount of boilerplate needed for a sidecar proxy, application service definitions may define an inline sidecar service block."]}),"\n",(0,s.jsxs)(n.p,{children:["Connect proxies are typically deployed as ",(0,s.jsx)(n.strong,{children:"Sidecars"})," that run on the same node as the single service instance that they handle traffic for:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\r\n  "service": {\r\n    "name": "web",\r\n    "port": 8080,\r\n    "connect": { "sidecar_service": {} }\r\n  }\r\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["This will register the web service as normal, but will also register another ",(0,s.jsx)(n.a,{href:"https://www.consul.io/docs/connect/registration/service-registration",children:"Proxy Service"})," with defaults values used. The above expands out to be equivalent to the following explicit service definitions:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\r\n  "service": {\r\n    "name": "web",\r\n    "port": 8080,\r\n  }\r\n}\r\n{\r\n  "name": "web-sidecar-proxy",\r\n  "port": 20000,\r\n  "kind": "connect-proxy",\r\n  "checks": [\r\n    {\r\n      "Name": "Connect Sidecar Listening",\r\n      "TCP": "127.0.0.1:20000",\r\n      "Interval": "10s"\r\n    },\r\n    {\r\n      "name": "Connect Sidecar Aliasing web",\r\n      "alias_service": "web"\r\n    }\r\n  ],\r\n  "proxy": {\r\n    "destination_service_name": "web",\r\n    "destination_service_id": "web",\r\n    "local_service_address": "127.0.0.1",\r\n    "local_service_port": 8080,\r\n  }\r\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"intentions",children:"Intentions"}),"\n",(0,s.jsxs)(n.p,{children:["Intentions define access control for services via Connect and are used to control which services may establish connections or make requests. Intentions can be managed via the API, CLI, or UI. Intentions are managed primarily via service-intentions config entries or the UI. Some simpler tasks can also be achieved with the older ",(0,s.jsx)(n.a,{href:"https://www.consul.io/api-docs/connect/intentions",children:"API"})," or ",(0,s.jsx)(n.a,{href:"https://www.consul.io/commands/intention",children:"CLI"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["A basic ",(0,s.jsx)(n.code,{children:"service-intentions"})," config entry representing two simple intentions looks like:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'Kind = "service-intentions"\r\nName = "db"\r\nSources = [\r\n  {\r\n    Name   = "web"\r\n    Action = "deny"\r\n  },\r\n  {\r\n    Name   = "api"\r\n    Action = "allow"\r\n  }\r\n]\n'})}),"\n",(0,s.jsxs)(n.p,{children:["This config entry defines two intentions with a common destination of ",(0,s.jsx)(n.code,{children:"db"}),". The first intention above is a deny intention with a source of ",(0,s.jsx)(n.code,{children:"web"}),". This says that connections from web to ",(0,s.jsx)(n.code,{children:"db"})," are not allowed and the connection will be rejected. The second intention is an allow intention with a source of ",(0,s.jsx)(n.code,{children:"api"}),". This says that connections from api to db are allowed and connections will be accepted."]}),"\n",(0,s.jsx)(n.h3,{id:"wildcard-intentions",children:"Wildcard Intentions"}),"\n",(0,s.jsxs)(n.p,{children:["An intention source or destination may also be the special wildcard value ",(0,s.jsx)(n.code,{children:"*"}),". This matches any value and is used as a catch-all. This example says that the ",(0,s.jsx)(n.code,{children:"web"})," service cannot connect to any service:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'Kind = "service-intentions"\r\nName = "*"\r\nSources = [\r\n  {\r\n    Name   = "web"\r\n    Action = "deny"\r\n  }\r\n]\n'})}),"\n",(0,s.jsxs)(n.p,{children:["And this example says that no service can connect to the ",(0,s.jsx)(n.code,{children:"db"})," service:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'Kind = "service-intentions"\r\nName = "db"\r\nSources = [\r\n  {\r\n    Name   = "*"\r\n    Action = "deny"\r\n  }\r\n]\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Intentions are matched in an implicit order ",(0,s.jsx)(n.a,{href:"https://www.consul.io/docs/connect/intentions#precedence-and-match-order",children:"based on specificity"}),", preferring deny over allow. Specificity is determined by whether a value is an exact specified value or is the wildcard value *."]}),"\n",(0,s.jsx)(n.h2,{id:"load-balancing-services-with-envoy",children:"Load Balancing Services with Envoy"}),"\n",(0,s.jsxs)(n.p,{children:["Consul 1.9.0 introduces the ",(0,s.jsx)(n.a,{href:"https://learn.hashicorp.com/tutorials/consul/load-balancing-envoy?in=consul/service-mesh-traffic-management",children:"ability to change the load balancing policy used by the Envoy data plane proxy"})," by specifying the desired algorithm with Consul configuration entries."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"WIP"})})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},425563:(e,n,i)=>{i.d(n,{A:()=>s});const s=i.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-a2980141250edbaa2e8933107deb9f60.jpg"},28453:(e,n,i)=>{i.d(n,{R:()=>t,x:()=>c});var s=i(296540);const r={},o=s.createContext(r);function t(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);