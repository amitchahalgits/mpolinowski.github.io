"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[31926],{257191:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>c,contentTitle:()=>i,default:()=>m,frontMatter:()=>r,metadata:()=>s,toc:()=>l});var a=t(785893),o=t(603905);const r={sidebar_position:3970,slug:"2022-11-16",title:"Deploy Mautic with Hashicorp Nomad",authors:"mpolinowski",tags:["Nomad","Consul","LINUX"],description:"Using Nomad to deploy the Mautic Marketing Automation Platform"},i=void 0,s={id:"DevOps/Hashicorp/2022-11-16-hashicorp-nomad-mautic/index",title:"Deploy Mautic with Hashicorp Nomad",description:"Using Nomad to deploy the Mautic Marketing Automation Platform",source:"@site/docs/DevOps/Hashicorp/2022-11-16-hashicorp-nomad-mautic/index.md",sourceDirName:"DevOps/Hashicorp/2022-11-16-hashicorp-nomad-mautic",slug:"/DevOps/Hashicorp/2022-11-16-hashicorp-nomad-mautic/2022-11-16",permalink:"/docs/DevOps/Hashicorp/2022-11-16-hashicorp-nomad-mautic/2022-11-16",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Hashicorp/2022-11-16-hashicorp-nomad-mautic/index.md",tags:[{label:"Nomad",permalink:"/docs/tags/nomad"},{label:"Consul",permalink:"/docs/tags/consul"},{label:"LINUX",permalink:"/docs/tags/linux"}],version:"current",sidebarPosition:3970,frontMatter:{sidebar_position:3970,slug:"2022-11-16",title:"Deploy Mautic with Hashicorp Nomad",authors:"mpolinowski",tags:["Nomad","Consul","LINUX"],description:"Using Nomad to deploy the Mautic Marketing Automation Platform"},sidebar:"tutorialSidebar",previous:{title:"Deploy Grav CMS with Hashicorp Nomad",permalink:"/docs/DevOps/Hashicorp/2022-11-18-hashicorp-nomad-grav/2022-11-18"},next:{title:"Hashicorp Nomad for NGINX Load-balancing",permalink:"/docs/DevOps/Hashicorp/2022-11-15-hashicorp-nomad-nginx-load-balancing/2022-11-15"}},c={},l=[{value:"Docker-Compose",id:"docker-compose",level:2},{value:"Nomad Job",id:"nomad-job",level:2},{value:"Complete Job File",id:"complete-job-file",level:3}];function d(n){const e={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.ah)(),...n.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(e.p,{children:(0,a.jsx)(e.img,{alt:"Shen Zhen, China",src:t(673758).Z+"",width:"2230",height:"839"})}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#docker-compose",children:"Docker-Compose"})}),"\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.a,{href:"#nomad-job",children:"Nomad Job"}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#complete-job-file",children:"Complete Job File"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(e.h2,{id:"docker-compose",children:"Docker-Compose"}),"\n",(0,a.jsxs)(e.p,{children:["To test the container we can use ",(0,a.jsx)(e.code,{children:"docker compose up -d"})," (see ",(0,a.jsx)(e.a,{href:"/docs/DevOps/Provisioning/2022-11-16--mautic-docker/2022-11-16",children:"initial setup"}),"):"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yml",children:'version: "3.9"\n\nservices:\n  database:\n    image: mariadb:latest\n    container_name: mautic-db\n    environment:\n      MYSQL_ROOT_PASSWORD: mypassword\n    ports:\n      - "3306:3306"\n    volumes:\n      - mautic-db:/var/lib/mysql:rw\n    restart: always\n    networks:\n      - mauticnet\n    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci --sql-mode=""\n\n  mautic:\n    container_name: mautic\n    image: mautic/mautic:v4-apache\n    volumes:\n      - mautic-data:/var/www/html:rw\n    environment:\n      - MAUTIC_DB_HOST=database\n      - MAUTIC_DB_USER=root\n      - MAUTIC_DB_PASSWORD=mypassword\n      - MAUTIC_DB_NAME=mautic4\n      - MAUTIC_DB_TABLE_PREFIX=mautic4\n    restart: always\n    depends_on:\n      - database\n    links:\n      - database\n    networks:\n      - mauticnet\n    ports:\n      - "8888:80"\n\nnetworks:\n  mauticnet:\n\nvolumes:\n  mautic-db:\n  mautic-data:\n'})}),"\n",(0,a.jsx)(e.h2,{id:"nomad-job",children:"Nomad Job"}),"\n",(0,a.jsxs)(e.p,{children:["In Nomad we first need to create the volumes on our host in ",(0,a.jsx)(e.em,{children:"/etc/nomad.d/client.hcl"})," and then define it here:"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-bash",children:'volume "mautic_db" {\n    type      = "host"\n    read_only = false\n    source    = "mautic_db"\n}\n\nvolume "mautic_data" {\n    type      = "host"\n    read_only = false\n    source    = "mautic_data"\n}\n'})}),"\n",(0,a.jsx)(e.p,{children:"It can then be mounted into the container:"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-bash",children:'volume_mount {\n    volume      = "mautic_db"\n    destination = "/var/lib/mysql"\n    read_only   = false\n}\n\nvolume_mount {\n    volume      = "mautic_data"\n    destination = "/var/www/html"\n    read_only   = false\n}\n'})}),"\n",(0,a.jsx)(e.h3,{id:"complete-job-file",children:"Complete Job File"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-bash",children:'job "mautic" {\n  datacenters = ["dc1"]\n    group "mautic" {\n        \n        network {\n            mode = "host"\n            port "tcp" {\n                static = 3306\n            }\n            port "http" {\n                static = 80\n            }\n        }\n\n        update {\n            max_parallel = 1\n            min_healthy_time  = "10s"\n            healthy_deadline  = "5m"\n            progress_deadline = "10m"\n            auto_revert = true\n            auto_promote = true\n            canary = 1\n        }\n\n        restart {\n            attempts = 10\n            interval = "5m"\n            delay    = "25s"\n            mode     = "delay"\n        }\n\n        volume "mautic_db" {\n            type      = "host"\n            read_only = false\n            source    = "mautic_db"\n        }\n\n        volume "mautic_data" {\n            type      = "host"\n            read_only = false\n            source    = "mautic_data"\n        }\n\n        service {\n            name = "mautic-db"\n            port = "tcp"\n            tags = [\n                "database"\n            ]\n\n            check {\n                name     = "DB Health"\n                port     = "tcp"\n                type     = "tcp"\n                interval = "30s"\n                timeout  = "4s"\n            }\n        }\n\n        service {\n            name = "mautic-frontend"\n            port = "http"\n            tags = [\n                "frontend"\n            ]\n\n            check {\n                name     = "HTTP Health"\n                path     = "/"\n                type     = "http"\n                protocol = "http"\n                interval = "10s"\n                timeout  = "2s"\n            }\n        }\n\n        task "mautic-db" {\n            driver = "docker"\n\n            config {\n                image = "mariadb:latest"\n                ports = ["tcp"]\n                network_mode = "host"\n                force_pull = false\n            }\n\n            volume_mount {\n                volume      = "mautic_db"\n                destination = "/var/lib/mysql" # <-- inside container\n                read_only   = false\n            }\n\n            env {\n                MYSQL_ROOT_PASSWORD = "mypassword"\n                MYSQL_USER = "mautic4"\n                MYSQL_PASSWORD = "mypassword"\n                MYSQL_DATABASE = "mautic4"\n                CONTAINER_NAME = "127.0.0.1"\n            }\n        }\n\n        task "mautic-frontend" {\n            driver = "docker"\n\n            volume_mount {\n                volume      = "mautic_data"\n                destination = "/var/www/html"\n                read_only   = false\n            }\n\n            config {\n                image = "mautic/mautic:v4-apache"\n                ports = ["http"]\n                network_mode = "host"\n                force_pull = false\n            }\n\n            env {\n              MAUTIC_DB_HOST = "127.0.0.1"\n              MAUTIC_DB_USER = "mautic4"\n              MAUTIC_DB_PASSWORD = "mypassword"\n              MAUTIC_DB_NAME = "mautic4"\n              MAUTIC_DB_TABLE_PREFIX = "mautic4"\n            }\n\n            resources {\n                cpu    = 1000\n                memory = 1024\n            }\n        }\n    }\n}\n'})})]})}function m(n={}){const{wrapper:e}={...(0,o.ah)(),...n.components};return e?(0,a.jsx)(e,{...n,children:(0,a.jsx)(d,{...n})}):d(n)}},603905:(n,e,t)=>{t.d(e,{ah:()=>l});var a=t(667294);function o(n,e,t){return e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function r(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(n);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,a)}return t}function i(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?r(Object(t),!0).forEach((function(e){o(n,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))}))}return n}function s(n,e){if(null==n)return{};var t,a,o=function(n,e){if(null==n)return{};var t,a,o={},r=Object.keys(n);for(a=0;a<r.length;a++)t=r[a],e.indexOf(t)>=0||(o[t]=n[t]);return o}(n,e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);for(a=0;a<r.length;a++)t=r[a],e.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(n,t)&&(o[t]=n[t])}return o}var c=a.createContext({}),l=function(n){var e=a.useContext(c),t=e;return n&&(t="function"==typeof n?n(e):i(i({},e),n)),t},d={inlineCode:"code",wrapper:function(n){var e=n.children;return a.createElement(a.Fragment,{},e)}},m=a.forwardRef((function(n,e){var t=n.components,o=n.mdxType,r=n.originalType,c=n.parentName,m=s(n,["components","mdxType","originalType","parentName"]),u=l(t),p=o,h=u["".concat(c,".").concat(p)]||u[p]||d[p]||r;return t?a.createElement(h,i(i({ref:e},m),{},{components:t})):a.createElement(h,i({ref:e},m))}));m.displayName="MDXCreateElement"},673758:(n,e,t)=>{t.d(e,{Z:()=>a});const a=t.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-6c1edb088dfea3a7d39f8eebb8e9dc23.jpg"}}]);