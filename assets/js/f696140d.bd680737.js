"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[77],{638168:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>b,frontMatter:()=>t,metadata:()=>s,toc:()=>c});var r=i(474848),a=i(28453);const t={sidebar_position:8050,slug:"2022-01-14",title:"Zabbix v6 Docker Monitor",authors:"mpolinowski",tags:["Zabbix","Linux","Docker"]},o=void 0,s={id:"DevOps/Zabbix/2022-01-14--zabbix-docker-monitor/index",title:"Zabbix v6 Docker Monitor",description:"Guangzhou, China",source:"@site/docs/DevOps/Zabbix/2022-01-14--zabbix-docker-monitor/index.md",sourceDirName:"DevOps/Zabbix/2022-01-14--zabbix-docker-monitor",slug:"/DevOps/Zabbix/2022-01-14--zabbix-docker-monitor/2022-01-14",permalink:"/docs/DevOps/Zabbix/2022-01-14--zabbix-docker-monitor/2022-01-14",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Zabbix/2022-01-14--zabbix-docker-monitor/index.md",tags:[{label:"Zabbix",permalink:"/docs/tags/zabbix"},{label:"Linux",permalink:"/docs/tags/linux"},{label:"Docker",permalink:"/docs/tags/docker"}],version:"current",sidebarPosition:8050,frontMatter:{sidebar_position:8050,slug:"2022-01-14",title:"Zabbix v6 Docker Monitor",authors:"mpolinowski",tags:["Zabbix","Linux","Docker"]},sidebar:"tutorialSidebar",previous:{title:"Zabbix HTTPS Certificate Monitor",permalink:"/docs/DevOps/Zabbix/2022-01-14--zabbix-http-cert-monitor/2022-01-14"},next:{title:"Zabbix v6 Apache 2 Monitor",permalink:"/docs/DevOps/Zabbix/2022-01-14--zabbix-apache2-monitor/2022-01-14"}},l={},c=[{value:"Install Agent 2",id:"install-agent-2",level:2},{value:"Error: Configuration file not loaded",id:"error-configuration-file-not-loaded",level:2},{value:"Solution",id:"solution",level:3},{value:"Docker Plugin",id:"docker-plugin",level:2}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Guangzhou, China",src:i(96174).A+"",width:"1500",height:"467"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#install-agent-2",children:"Install Agent 2"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"#error-configuration-file-not-loaded",children:"Error: Configuration file not loaded"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#solution",children:"Solution"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#docker-plugin",children:"Docker Plugin"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"install-agent-2",children:"Install Agent 2"}),"\n",(0,r.jsx)(n.p,{children:"Remove Agent v1 (if present) and install version 2:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"wget https://repo.zabbix.com/zabbix/5.5/debian/pool/main/z/zabbix-release/zabbix-release_5.5-1+debian11_all.deb\r\ndpkg -i zabbix-release_5.5-1+debian11_all.deb\r\napt update && apt install zabbix-agent2\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"/docs/DevOps/Zabbix/2020-07-16--zabbix-agent/2020-07-16",children:"Configure the agent according to your server setup"}),". And in addition to that un-comment the following line in ",(0,r.jsx)(n.em,{children:"/etc/zabbix/zabbix_agent2.conf"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-conf",children:"### Option: Plugins.Docker.Endpoint\r\n#       Docker API endpoint.\r\n#\r\n# Mandatory: no\r\n# Default: unix:///var/run/docker.sock\r\nPlugins.Docker.Endpoint=unix:///var/run/docker.sock\n"})}),"\n",(0,r.jsx)(n.h2,{id:"error-configuration-file-not-loaded",children:"Error: Configuration file not loaded"}),"\n",(0,r.jsxs)(n.p,{children:["After starting ",(0,r.jsx)(n.code,{children:"systemctl enable zabbix-agent2 --now"})," the agent is still using the default config and trying to connect to localhost instead of my Zabbix Master:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cat /var/log/zabbix/zabbix_agent2.log\r\n\r\n2021/11/11 09:54:39.261862 Zabbix Agent2 hostname: [Zabbix server]\r\n2021/11/11 09:54:40.264710 [101] active check configuration update from [127.0.0.1:10051 Zabbix server] started to fail (dial tcp :0->127.0.0.1:10051: connect: connection refused)\n"})}),"\n",(0,r.jsx)(n.h3,{id:"solution",children:"Solution"}),"\n",(0,r.jsxs)(n.p,{children:["The service file points to ",(0,r.jsx)(n.code,{children:"PIDFile=/run/zabbix/zabbix_agent2.pid"}),":"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.em,{children:"/usr/lib/systemd/system/zabbix-agent2.service"})," / ",(0,r.jsx)(n.em,{children:"/lib/systemd/system/zabbix-agent2.service"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-conf",children:'[Unit]\r\nDescription=Zabbix Agent 2\r\nAfter=syslog.target\r\nAfter=network.target\r\n\r\n[Service]\r\nEnvironment="CONFFILE=/etc/zabbix/zabbix_agent2.conf"\r\nEnvironmentFile=-/etc/default/zabbix-agent2\r\nType=simple\r\nRestart=on-failure\r\nPIDFile=/run/zabbix/zabbix_agent2.pid\r\nKillMode=control-group\r\nExecStart=/usr/sbin/zabbix_agent2 -c $CONFFILE\r\nExecStop=/bin/sh -c \'[ -n "$1" ] && kill -s TERM "$1"\' -- "$MAINPID"\r\nRestartSec=10s\r\nUser=zabbix\r\nGroup=zabbix\r\n\r\n[Install]\r\nWantedBy=multi-user.target\n'})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:["I just encountered another issue on a different server - here the variable inside the service file was written ",(0,r.jsx)(n.code,{children:"PidFile"})," instead of ",(0,r.jsx)(n.code,{children:"PIDFile"})," and this lead to the same issue..."]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["But the Agent conf should says ",(0,r.jsx)(n.em,{children:"PidFile=/var/run/zabbix/zabbix_agent2.pid"}),":"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.em,{children:"/etc/zabbix/zabbix_agent2.conf"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# This is a configuration file for Zabbix agent 2 (Unix)\r\n# To get more information about Zabbix, visit http://www.zabbix.com\r\n\r\n############ GENERAL PARAMETERS #################\r\n\r\n### Option: PidFile\r\n#       Name of PID file.\r\n#\r\n# Mandatory: no\r\n# Default:\r\n# PidFile=/tmp/zabbix_agent2.pid\r\n\r\nPidFile=/var/run/zabbix/zabbix_agent2.pid\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.em,{children:"/usr/lib/tmpfiles.d/zabbix-agent2.conf"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"d /var/run/zabbix 0755 zabbix zabbix - -\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Change the service file to path to ",(0,r.jsx)(n.code,{children:"/var/run/zabbix/zabbix_agent2.pid"})," and reload the daemon:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"systemctl daemon-reload\r\nsystemctl restart zabbix-agent2\n"})}),"\n",(0,r.jsx)(n.h2,{id:"docker-plugin",children:"Docker Plugin"}),"\n",(0,r.jsx)(n.p,{children:"Add the docker group to the Zabbix user and restart the agent to apply the new user group:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"usermod -a -G docker zabbix\r\nsystemctl restart zabbix-agent2\n"})}),"\n",(0,r.jsx)(n.p,{children:"Add the Docker Template from the Zabbix Server UI:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Zabbix Docker Monitor",src:i(109936).A+"",width:"1047",height:"266"})}),"\n",(0,r.jsx)(n.p,{children:"And shortly afterwards you should start seeing Docker Data coming in:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Zabbix Docker Monitor",src:i(75339).A+"",width:"1218",height:"697"})}),"\n",(0,r.jsx)(n.p,{children:"Available triggers:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Zabbix Docker Monitor",src:i(311682).A+"",width:"1241",height:"259"})})]})}function b(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},109936:(e,n,i)=>{i.d(n,{A:()=>r});const r=i.p+"assets/images/Zabbix_Docker_Monitor_01-9af5376cdd8c37a776bcea8654f682d8.png"},75339:(e,n,i)=>{i.d(n,{A:()=>r});const r=i.p+"assets/images/Zabbix_Docker_Monitor_02-24bbdd08df1bdbd453d360a4c3f6b4da.png"},311682:(e,n,i)=>{i.d(n,{A:()=>r});const r=i.p+"assets/images/Zabbix_Docker_Monitor_03-0f85e3274bb8985fe83dc391e11e8242.png"},96174:(e,n,i)=>{i.d(n,{A:()=>r});const r=i.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-539dc0d90c8fd4caf3d5cd5162b8ded5.jpg"},28453:(e,n,i)=>{i.d(n,{R:()=>o,x:()=>s});var r=i(296540);const a={},t=r.createContext(a);function o(e){const n=r.useContext(t);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);