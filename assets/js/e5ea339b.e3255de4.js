"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[51196],{937368:(e,r,t)=>{t.r(r),t.d(r,{assets:()=>l,contentTitle:()=>a,default:()=>g,frontMatter:()=>s,metadata:()=>o,toc:()=>c});var i=t(785893),n=t(603905);const s={sidebar_position:9960,slug:"2020-08-03",title:"Gitlab as Docker Registry",authors:"mpolinowski",tags:["LINUX","Gitlab"]},a=void 0,o={id:"DevOps/GitOps/2020-08-03--gitlab-as-docker-registry/index",title:"Gitlab as Docker Registry",description:"Guangzhou, China",source:"@site/docs/DevOps/GitOps/2020-08-03--gitlab-as-docker-registry/index.md",sourceDirName:"DevOps/GitOps/2020-08-03--gitlab-as-docker-registry",slug:"/DevOps/GitOps/2020-08-03--gitlab-as-docker-registry/2020-08-03",permalink:"/docs/DevOps/GitOps/2020-08-03--gitlab-as-docker-registry/2020-08-03",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/GitOps/2020-08-03--gitlab-as-docker-registry/index.md",tags:[{label:"LINUX",permalink:"/docs/tags/linux"},{label:"Gitlab",permalink:"/docs/tags/gitlab"}],version:"current",sidebarPosition:9960,frontMatter:{sidebar_position:9960,slug:"2020-08-03",title:"Gitlab as Docker Registry",authors:"mpolinowski",tags:["LINUX","Gitlab"]},sidebar:"tutorialSidebar",previous:{title:"Working with Gitlab",permalink:"/docs/DevOps/GitOps/2020-08-04--working-with-gitlab/2020-08-04"},next:{title:"Setting up Gitlab",permalink:"/docs/DevOps/GitOps/2020-08-02--gitlab-setup/2020-08-02"}},l={},c=[{value:"Setting Up GitLab\u2019s Docker Registry",id:"setting-up-gitlabs-docker-registry",level:2},{value:"Building a Docker Image",id:"building-a-docker-image",level:2},{value:"Test your Docker Registry",id:"test-your-docker-registry",level:2},{value:"Clean Up",id:"clean-up",level:2}];function d(e){const r={a:"a",code:"code",h2:"h2",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,n.ah)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.p,{children:(0,i.jsx)(r.img,{alt:"Guangzhou, China",src:t(864435).Z+"",width:"1500",height:"625"})}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"#setting-up-gitlabs-docker-registry",children:"Setting Up GitLab\u2019s Docker Registry"})}),"\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"#building-a-docker-image",children:"Building a Docker Image"})}),"\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"#test-your-docker-registry",children:"Test your Docker Registry"})}),"\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"#clean-up",children:"Clean Up"})}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"setting-up-gitlabs-docker-registry",children:"Setting Up GitLab\u2019s Docker Registry"}),"\n",(0,i.jsx)(r.p,{children:"GitLab will set up a private Docker registry with just a few configuration updates. First we\u2019ll set up the URL where the registry will reside. SSH into your GitLab server, then open up the GitLab configuration file:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:"sudo nano /etc/gitlab/gitlab.rb\n"})}),"\n",(0,i.jsxs)(r.p,{children:["Scroll down to the ",(0,i.jsx)(r.strong,{children:"Container Registry"})," settings section. We\u2019re going to uncomment the ",(0,i.jsx)(r.code,{children:"registry_external_url"})," line and set it to our GitLab hostname with a port number:"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:"registry_external_url 'https://gitlab.example.com:34578'\n"})}),"\n",(0,i.jsx)(r.p,{children:"Save and close the file, then reconfigure GitLab:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:"sudo gitlab-ctl reconfigure\n"})}),"\n",(0,i.jsx)(r.p,{children:"Now switch to another machine with Docker installed, and log in to the private Docker registry:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:"docker login gitlab.example.com:34578\n"})}),"\n",(0,i.jsx)(r.p,{children:"You will be prompted for your username and password. Use your GitLab credentials to log in."}),"\n",(0,i.jsx)(r.h2,{id:"building-a-docker-image",children:"Building a Docker Image"}),"\n",(0,i.jsxs)(r.p,{children:["To get our app building in Docker, we need to update the ",(0,i.jsx)(r.code,{children:".gitlab-ci.yml"})," file:"]}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.img,{alt:"Gitlab Privat Docker Registry",src:t(788023).Z+"",width:"1049",height:"576"})}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-yml",children:'image: docker:19.03.0-dind\r\n\r\nvariables:\r\n  DOCKER_HOST: tcp://docker:2375\r\n  DOCKER_TLS_CERTDIR: ""\r\n\r\nservices:\r\n  - name: docker:19.03.12-dind\r\n    entrypoint: ["env", "-u", "DOCKER_HOST"]\r\n    command: ["dockerd-entrypoint.sh"]\r\n\r\n\r\nstages:\r\n- build\r\n# - test\r\n- release\r\n\r\nvariables:\r\n  TEST_IMAGE: gitlab.example.com:34578/wiki/wiki-instar-en-docker:$CI_COMMIT_REF_NAME\r\n  RELEASE_IMAGE: gitlab.example.com:34578/wiki/wiki-instar-en-docker:latest\r\n\r\nbefore_script:\r\n  - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN gitlab.example.com:34578\r\n\r\nbuild:\r\n  stage: build\r\n  script:\r\n    - docker build --pull -t $TEST_IMAGE .\r\n    - docker push $TEST_IMAGE\r\n\r\n# test:\r\n#   stage: test\r\n#     - docker pull $TEST_IMAGE\r\n#     - docker run $TEST_IMAGE npm test\r\n\r\nrelease:\r\n  stage: release\r\n  script:\r\n    - docker pull $TEST_IMAGE\r\n    - docker tag $TEST_IMAGE $RELEASE_IMAGE\r\n    - docker push $RELEASE_IMAGE\r\n  only:\r\n    - master\n'})}),"\n",(0,i.jsx)(r.p,{children:"Once you commit your CI script the job will be started:"}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.img,{alt:"Gitlab Privat Docker Registry",src:t(984814).Z+"",width:"1046",height:"253"})}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.img,{alt:"Gitlab Privat Docker Registry",src:t(594804).Z+"",width:"1029",height:"292"})}),"\n",(0,i.jsx)(r.h2,{id:"test-your-docker-registry",children:"Test your Docker Registry"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:"docker pull gitlab.example.com:34578/wiki/wiki-instar-en-docker:latest\r\ndocker run -p 80:7777 gitlab.example.com:34578/wiki/wiki-instar-en-docker:latest\n"})}),"\n",(0,i.jsx)(r.h2,{id:"clean-up",children:"Clean Up"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:"gitlab-ctl registry-garbage-collect -m\n"})}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.a,{href:"https://forums.docker.com/t/some-way-to-clean-up-identify-contents-of-var-lib-docker-overlay/30604/29",children:"https://forums.docker.com/t/some-way-to-clean-up-identify-contents-of-var-lib-docker-overlay/30604/29"})}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.a,{href:"https://gitlab.com/gitlab-org/gitlab-foss/-/issues/21690",children:"https://gitlab.com/gitlab-org/gitlab-foss/-/issues/21690"})}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.a,{href:"https://gitlab.com/gitlab-org/docker-distribution-pruner",children:"https://gitlab.com/gitlab-org/docker-distribution-pruner"})})]})}function g(e={}){const{wrapper:r}={...(0,n.ah)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},603905:(e,r,t)=>{t.d(r,{ah:()=>c});var i=t(667294);function n(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function s(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);r&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,i)}return t}function a(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?s(Object(t),!0).forEach((function(r){n(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function o(e,r){if(null==e)return{};var t,i,n=function(e,r){if(null==e)return{};var t,i,n={},s=Object.keys(e);for(i=0;i<s.length;i++)t=s[i],r.indexOf(t)>=0||(n[t]=e[t]);return n}(e,r);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(i=0;i<s.length;i++)t=s[i],r.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(n[t]=e[t])}return n}var l=i.createContext({}),c=function(e){var r=i.useContext(l),t=r;return e&&(t="function"==typeof e?e(r):a(a({},r),e)),t},d={inlineCode:"code",wrapper:function(e){var r=e.children;return i.createElement(i.Fragment,{},r)}},g=i.forwardRef((function(e,r){var t=e.components,n=e.mdxType,s=e.originalType,l=e.parentName,g=o(e,["components","mdxType","originalType","parentName"]),p=c(t),u=n,h=p["".concat(l,".").concat(u)]||p[u]||d[u]||s;return t?i.createElement(h,a(a({ref:r},g),{},{components:t})):i.createElement(h,a({ref:r},g))}));g.displayName="MDXCreateElement"},984814:(e,r,t)=>{t.d(r,{Z:()=>i});const i=t.p+"assets/images/Gitlab_Docker_Registry_01-5bb962504226c81f718329e69f218173.png"},594804:(e,r,t)=>{t.d(r,{Z:()=>i});const i=t.p+"assets/images/Gitlab_Docker_Registry_02-ea523e9b85f1b713a57edaec301b55ed.png"},788023:(e,r,t)=>{t.d(r,{Z:()=>i});const i=t.p+"assets/images/Gitlab_Docker_Registry_03-d472891a8b04155b81d06c17f8802868.png"},864435:(e,r,t)=>{t.d(r,{Z:()=>i});const i=t.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-3c682f7dbaf3c13bccb0cad63672e020.jpg"}}]);