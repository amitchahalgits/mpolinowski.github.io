"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[61188],{286833:(t,e,n)=>{n.r(e),n.d(e,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>s,metadata:()=>a,toc:()=>l});var o=n(785893),i=n(603905);const s={sidebar_position:6970,slug:"2023-04-17",title:"(Re) Introduction to Home Assistant Auto-discovery",authors:"mpolinowski",tags:["IoT"],image:"https://mpolinowski.github.io/img/search/mqtt.png",description:"Using the INSTAR IP Cameras MQTT Interface to add your Camera to Home Assistant."},r="(Re) Introduction to Home Assistant Auto-discovery",a={id:"Automation_and_Robotics/Home_Automation/2023-04-17-home-assistant-mqtt-autodiscovery-part-iii/index",title:"(Re) Introduction to Home Assistant Auto-discovery",description:"Using the INSTAR IP Cameras MQTT Interface to add your Camera to Home Assistant.",source:"@site/docs/Automation_and_Robotics/Home_Automation/2023-04-17-home-assistant-mqtt-autodiscovery-part-iii/index.md",sourceDirName:"Automation_and_Robotics/Home_Automation/2023-04-17-home-assistant-mqtt-autodiscovery-part-iii",slug:"/Automation_and_Robotics/Home_Automation/2023-04-17-home-assistant-mqtt-autodiscovery-part-iii/2023-04-17",permalink:"/docs/Automation_and_Robotics/Home_Automation/2023-04-17-home-assistant-mqtt-autodiscovery-part-iii/2023-04-17",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Automation_and_Robotics/Home_Automation/2023-04-17-home-assistant-mqtt-autodiscovery-part-iii/index.md",tags:[{label:"IoT",permalink:"/docs/tags/io-t"}],version:"current",sidebarPosition:6970,frontMatter:{sidebar_position:6970,slug:"2023-04-17",title:"(Re) Introduction to Home Assistant Auto-discovery",authors:"mpolinowski",tags:["IoT"],image:"https://mpolinowski.github.io/img/search/mqtt.png",description:"Using the INSTAR IP Cameras MQTT Interface to add your Camera to Home Assistant."},sidebar:"tutorialSidebar",previous:{title:"Camera Surveillance System with OpenCV",permalink:"/docs/Automation_and_Robotics/Home_Automation/2023-02-07-python-home-security/2023-02-07"},next:{title:"OpenThread Border Router with Docker with Docker",permalink:"/docs/Automation_and_Robotics/Home_Automation/2023-01-23-thread-edge-router-docker/2023-01-23"}},c={},l=[{value:"Docker",id:"docker",level:2},{value:"MQTT Autodiscovery",id:"mqtt-autodiscovery",level:2},{value:"Last-Will Trigger",id:"last-will-trigger",level:3},{value:"Shell Script",id:"shell-script",level:3},{value:"Automation",id:"automation",level:3},{value:"Python Script",id:"python-script",level:3},{value:"Broker Configuration",id:"broker-configuration",level:4}];function d(t){const e={a:"a",blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.ah)(),...t.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(e.p,{children:(0,o.jsx)(e.img,{alt:"Guangzhou, China",src:n(493861).Z+"",width:"1500",height:"526"})}),"\n",(0,o.jsxs)(e.ul,{children:["\n",(0,o.jsxs)(e.li,{children:[(0,o.jsx)(e.a,{href:"#re-introduction-to-home-assistant-auto-discovery",children:"(Re) Introduction to Home Assistant Auto-discovery"}),"\n",(0,o.jsxs)(e.ul,{children:["\n",(0,o.jsx)(e.li,{children:(0,o.jsx)(e.a,{href:"#docker",children:"Docker"})}),"\n",(0,o.jsxs)(e.li,{children:[(0,o.jsx)(e.a,{href:"#mqtt-autodiscovery",children:"MQTT Autodiscovery"}),"\n",(0,o.jsxs)(e.ul,{children:["\n",(0,o.jsx)(e.li,{children:(0,o.jsx)(e.a,{href:"#last-will-trigger",children:"Last-Will Trigger"})}),"\n",(0,o.jsx)(e.li,{children:(0,o.jsx)(e.a,{href:"#shell-script",children:"Shell Script"})}),"\n",(0,o.jsx)(e.li,{children:(0,o.jsx)(e.a,{href:"#automation",children:"Automation"})}),"\n",(0,o.jsxs)(e.li,{children:[(0,o.jsx)(e.a,{href:"#python-script",children:"Python Script"}),"\n",(0,o.jsxs)(e.ul,{children:["\n",(0,o.jsx)(e.li,{children:(0,o.jsx)(e.a,{href:"#broker-configuration",children:"Broker Configuration"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(e.p,{children:"The abstracted version to:"}),"\n",(0,o.jsxs)(e.ul,{children:["\n",(0,o.jsx)(e.li,{children:(0,o.jsx)(e.a,{href:"https://mpolinowski.github.io/docs/IoT-and-Machine-Learning/Home_Automation/2022-07-10-home-assistant-mqtt-autodiscovery-part-i/2022-07-10",children:"Home Assistant - MQTT Auto-Discovery :: Configuration"})}),"\n",(0,o.jsx)(e.li,{children:(0,o.jsx)(e.a,{href:"https://mpolinowski.github.io/docs/IoT-and-Machine-Learning/Home_Automation/2022-07-11-home-assistant-mqtt-autodiscovery-part-ii/2022-07-11",children:"Home Assistant - MQTT Auto-Discovery :: Automation"})}),"\n",(0,o.jsx)(e.li,{children:(0,o.jsx)(e.a,{href:"https://mpolinowski.github.io/docs/IoT-and-Machine-Learning/Home_Automation/2022-07-12-home-assistant-mqtt-python/2022-07-12",children:"Home Assistant - Python Scripts as Service"})}),"\n"]}),"\n",(0,o.jsx)(e.h1,{id:"re-introduction-to-home-assistant-auto-discovery",children:"(Re) Introduction to Home Assistant Auto-discovery"}),"\n",(0,o.jsx)(e.h2,{id:"docker",children:"Docker"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-bash",children:"docker pull homeassistant/home-assistant:stable\n"})}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-bash",children:"mkdir -p /opt/homeassistant/{config}\nchmod -R 775 /opt/homeassistant\n"})}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-bash",children:"docker run -d --rm --privileged --net=host --name='home-assistant' -e 'TZ=Europe/Berlin' -v /opt/homeassistant/config:/config homeassistant/home-assistant:stable\n"})}),"\n",(0,o.jsxs)(e.blockquote,{children:["\n",(0,o.jsx)(e.p,{children:(0,o.jsx)(e.code,{children:"http://localhost:8123"})}),"\n"]}),"\n",(0,o.jsx)(e.h2,{id:"mqtt-autodiscovery",children:"MQTT Autodiscovery"}),"\n",(0,o.jsx)(e.h3,{id:"last-will-trigger",children:"Last-Will Trigger"}),"\n",(0,o.jsxs)(e.p,{children:["Add the Last-Will Topic as an ",(0,o.jsx)(e.strong,{children:"MQTT Sensor"})," to your HA configuration file, e.g. ",(0,o.jsx)(e.code,{children:"/opt/homeassistant/config/configuration.yaml"}),":"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-yml",children:'mqtt:\n  sensor:\n    - device:\n        identifiers: in8401_office\n        manufacturer: INSTAR Deutschland GmbH\n        model: INSTAR 2k+ IN-8401 WLAN\n        name: IN-8401 2k+ Garden\n        configuration_url: "http://192.168.2.120:80"\n      availability:\n        topic: "cameras/120/status/connection"\n        payload_available: \'{"val":"online"}\'\n        payload_not_available: \'{"val":"offline"}\'\n      object_id: in8401_office_testament\n      unique_id: in8401_office_testament\n      name: "LWT Office Camera"\n      state_topic: "cameras/120/status/connection"\n      value_template: "{{ value_json.val }}"\n      icon: mdi:coffin\n      qos: 1\n'})}),"\n",(0,o.jsx)(e.p,{children:"The entity will show up once you reload the configuration:"}),"\n",(0,o.jsx)(e.p,{children:(0,o.jsx)(e.img,{alt:"(Re) Introduction to Home Assistant Auto-discovery",src:n(667842).Z+"",width:"1101",height:"343"})}),"\n",(0,o.jsxs)(e.p,{children:["This entity will change it's value from ",(0,o.jsx)(e.code,{children:"offline"})," to ",(0,o.jsx)(e.code,{children:"online"})," when the camera connects. This event can be used in an ",(0,o.jsx)(e.strong,{children:"Automation"})," to trigger a script that automatically adds your camera as an ",(0,o.jsx)(e.strong,{children:"Home Assistant Entity"}),"."]}),"\n",(0,o.jsx)(e.h3,{id:"shell-script",children:"Shell Script"}),"\n",(0,o.jsxs)(e.p,{children:["To be able to use the before mentioned Python script we need to create a tiny shell script that can be used in the ",(0,o.jsx)(e.strong,{children:"Home Assistant Automation"}),". Enter your Home Assistant ",(0,o.jsx)(e.code,{children:"config"})," directory, e.g. ",(0,o.jsx)(e.code,{children:"/opt/homeassistant/config"})," and create a sub-directory ",(0,o.jsx)(e.code,{children:"shell"}),":"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-bash",children:"mkdir shell\nnano ./shell/mqtt_autodiscover_8401_office.sh\n"})}),"\n",(0,o.jsx)(e.p,{children:"The shell script only needs to direct the Python binary to the location you used for the Python Script (that we will create in the last step):"}),"\n",(0,o.jsx)(e.p,{children:(0,o.jsx)(e.em,{children:"mqtt_autodiscover_8401_office.sh"})}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-bash",children:"#!/bin/bash\npython /config/python_scripts/mqtt5_client.py -f config_topics_8401.json\n"})}),"\n",(0,o.jsxs)(e.p,{children:["To activate the Shell Extension and expose our script to HA we need to add the following lines to the ",(0,o.jsx)(e.code,{children:"config/configuration.yml"}),":"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-bash",children:"# Auto configure 8401 office with mqtt\nshell_command:\n  mqtt_autodiscover_8401_office: /bin/ash /config/shell/mqtt_autodiscover_8401_office.sh\n"})}),"\n",(0,o.jsx)(e.p,{children:"Reload the configuration or restart Home Assistant:"}),"\n",(0,o.jsx)(e.p,{children:(0,o.jsx)(e.img,{alt:"(Re) Introduction to Home Assistant Auto-discovery",src:n(248106).Z+"",width:"1318",height:"506"})}),"\n",(0,o.jsx)(e.h3,{id:"automation",children:"Automation"}),"\n",(0,o.jsxs)(e.p,{children:["We can now add a new ",(0,o.jsx)(e.strong,{children:"Automation"}),":"]}),"\n",(0,o.jsx)(e.p,{children:(0,o.jsx)(e.img,{alt:"(Re) Introduction to Home Assistant Auto-discovery",src:n(287482).Z+"",width:"1323",height:"584"})}),"\n",(0,o.jsxs)(e.p,{children:["The ",(0,o.jsx)(e.strong,{children:"Automation"})," should be triggered every time the ",(0,o.jsx)(e.strong,{children:"Last-Will Entity"})," created in the first step changes it's value from ",(0,o.jsx)(e.code,{children:"offline"})," to ",(0,o.jsx)(e.code,{children:"online"})," (",(0,o.jsx)(e.strong,{children:"Note"})," these values can be configured in your camera's webUI - see below right):"]}),"\n",(0,o.jsx)(e.p,{children:(0,o.jsx)(e.img,{alt:"(Re) Introduction to Home Assistant Auto-discovery",src:n(511159).Z+"",width:"1762",height:"700"})}),"\n",(0,o.jsxs)(e.p,{children:["As ",(0,o.jsx)(e.strong,{children:"Action"})," select ",(0,o.jsx)(e.strong,{children:"Call Service"})," and to execute the Python script with the ",(0,o.jsx)(e.strong,{children:"Shell Script"})," option:"]}),"\n",(0,o.jsx)(e.p,{children:(0,o.jsx)(e.img,{alt:"(Re) Introduction to Home Assistant Auto-discovery",src:n(240760).Z+"",width:"1463",height:"313"})}),"\n",(0,o.jsx)(e.p,{children:"If the option does not show up in drop down menu verify that you added the shell script and restarted Home Assistant as described in the previous step."}),"\n",(0,o.jsx)(e.h3,{id:"python-script",children:"Python Script"}),"\n",(0,o.jsxs)(e.p,{children:["The Python Script provides an MQTT5 Client that will help us auto-registering our camera. All necessary files can be cloned from ",(0,o.jsx)(e.a,{href:"https://github.com/mpolinowski/ha-mqtt-python/",children:"this repository"}),". Those are the ",(0,o.jsx)(e.strong,{children:"MQTT Client Script"}),", a ",(0,o.jsx)(e.strong,{children:"Configuration File"})," that contains your MQTT Broker configuration and a ",(0,o.jsx)(e.strong,{children:"JSON File"})," that contains all the MQTT Entities you want to add to Home Assistant that allow you to control your camera:"]}),"\n",(0,o.jsxs)(e.ul,{children:["\n",(0,o.jsx)(e.li,{children:(0,o.jsx)(e.a,{href:"https://github.com/mpolinowski/ha-mqtt-python/blob/master/mqtt5_client.py",children:"mqtt5_client.py"})}),"\n",(0,o.jsx)(e.li,{children:(0,o.jsx)(e.a,{href:"https://github.com/mpolinowski/ha-mqtt-python/blob/master/config.py",children:"config.py"})}),"\n",(0,o.jsx)(e.li,{children:(0,o.jsx)(e.a,{href:"https://github.com/mpolinowski/ha-mqtt-python/blob/master/config_topics_8401.json",children:"config_topics_8401.json"})}),"\n",(0,o.jsx)(e.li,{children:(0,o.jsx)(e.a,{href:"https://github.com/mpolinowski/ha-mqtt-python/blob/master/config_topics_9408.json",children:"config_topics_9408.json"})}),"\n"]}),"\n",(0,o.jsxs)(e.p,{children:["Take those files and place them inside a folder called ",(0,o.jsx)(e.code,{children:"python_scripts"})," inside the Home Assistant configuration directory, e.g. ",(0,o.jsx)(e.code,{children:"/opt/homeassistant/config"}),":"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-bash",children:"mkdir python_scripts\n"})}),"\n",(0,o.jsx)(e.p,{children:"Your configuration directory should now contain the following sub dirs and files:"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-bash",children:"/opt/homeassistant/config\n\u251c\u2500\u2500 automations.yaml\n\u251c\u2500\u2500 blueprints\n\u2502\xa0\xa0 \u251c\u2500\u2500 automation\n\u2502\xa0\xa0 \u2514\u2500\u2500 script\n\u251c\u2500\u2500 configuration.yaml\n\u251c\u2500\u2500 deps\n\u251c\u2500\u2500 home-assistant.log\n\u251c\u2500\u2500 home-assistant_v2.db\n\u251c\u2500\u2500 python_scripts\n\u2502\xa0\xa0 \u251c\u2500\u2500 config.py\n\u2502\xa0\xa0 \u251c\u2500\u2500 config_topics_8401.json\n\u2502\xa0\xa0 \u2514\u2500\u2500 mqtt5_client.py\n\u251c\u2500\u2500 scenes.yaml\n\u251c\u2500\u2500 scripts.yaml\n\u251c\u2500\u2500 secrets.yaml\n\u251c\u2500\u2500 shell\n\u2502\xa0\xa0 \u2514\u2500\u2500 mqtt_autodiscover_8401_office.sh\n\u2514\u2500\u2500 tts\n"})}),"\n",(0,o.jsx)(e.h4,{id:"broker-configuration",children:"Broker Configuration"}),"\n",(0,o.jsxs)(e.p,{children:["Now add your broker configuration to ",(0,o.jsx)(e.a,{href:"https://github.com/mpolinowski/ha-mqtt-python/blob/master/config.py",children:"config.py"}),", e.g. :"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-bash",children:'mqtt_server_host = "192.168.2.112"\nmqtt_server_port = 1883\nmqtt_bind_address = ""\nmqtt_bind_port = 0\nmqtt_username = "admin"\nmqtt_password = "instar"\nmqtt_transport = "tcp"\nmqtt_keepalive = 60\nmqtt_client_id = "mqtt5_client"\n'})}),"\n",(0,o.jsxs)(e.p,{children:["This is the configuration that the Python MQTT Client is going to use to connect to your broker when it is triggered by our ",(0,o.jsx)(e.strong,{children:"Home Assistant Automation"}),"."]})]})}function h(t={}){const{wrapper:e}={...(0,i.ah)(),...t.components};return e?(0,o.jsx)(e,{...t,children:(0,o.jsx)(d,{...t})}):d(t)}},603905:(t,e,n)=>{n.d(e,{ah:()=>l});var o=n(667294);function i(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function s(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,o)}return n}function r(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?s(Object(n),!0).forEach((function(e){i(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function a(t,e){if(null==t)return{};var n,o,i=function(t,e){if(null==t)return{};var n,o,i={},s=Object.keys(t);for(o=0;o<s.length;o++)n=s[o],e.indexOf(n)>=0||(i[n]=t[n]);return i}(t,e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);for(o=0;o<s.length;o++)n=s[o],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(i[n]=t[n])}return i}var c=o.createContext({}),l=function(t){var e=o.useContext(c),n=e;return t&&(n="function"==typeof t?t(e):r(r({},e),t)),n},d={inlineCode:"code",wrapper:function(t){var e=t.children;return o.createElement(o.Fragment,{},e)}},h=o.forwardRef((function(t,e){var n=t.components,i=t.mdxType,s=t.originalType,c=t.parentName,h=a(t,["components","mdxType","originalType","parentName"]),m=l(n),u=i,p=m["".concat(c,".").concat(u)]||m[u]||d[u]||s;return n?o.createElement(p,r(r({ref:e},h),{},{components:n})):o.createElement(p,r({ref:e},h))}));h.displayName="MDXCreateElement"},667842:(t,e,n)=>{n.d(e,{Z:()=>o});const o=n.p+"assets/images/Home_Assistant_MQTT_Auto-Discovery_01-bd4659f612705452a274d7254e4c1f52.png"},248106:(t,e,n)=>{n.d(e,{Z:()=>o});const o=n.p+"assets/images/Home_Assistant_MQTT_Auto-Discovery_02-218081f6c3deaddf0f539392132cf6cc.png"},287482:(t,e,n)=>{n.d(e,{Z:()=>o});const o=n.p+"assets/images/Home_Assistant_MQTT_Auto-Discovery_03-fdbf767da90761ca48a89aac082af73f.png"},511159:(t,e,n)=>{n.d(e,{Z:()=>o});const o=n.p+"assets/images/Home_Assistant_MQTT_Auto-Discovery_04-00a19823da480fd24de0dae184917eec.png"},240760:(t,e,n)=>{n.d(e,{Z:()=>o});const o=n.p+"assets/images/Home_Assistant_MQTT_Auto-Discovery_05-a791d5a74b606cb3c7799e4068805fdf.png"},493861:(t,e,n)=>{n.d(e,{Z:()=>o});const o=n.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-98d71e33f881256303c68773a2ed92ba.jpg"}}]);