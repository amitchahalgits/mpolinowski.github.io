"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[75118],{105907:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>c,contentTitle:()=>r,default:()=>m,frontMatter:()=>n,metadata:()=>a,toc:()=>d});var i=o(785893),s=o(603905);const n={sidebar_position:6990,slug:"2022-07-17",title:"MQTT Auto-Discovery - Use Node-RED to register Smarthome Devices",authors:"mpolinowski",tags:["IoT"],image:"https://mpolinowski.github.io/img/search/mqtt.png",description:"Previously I wrote a Python Script that allowed me to register MQTT devices with Home Assistant using the HA internal auto-discovery service. The same script can be used to register those devices with OpenHAB using the homie convention. Now I want to use Node-RED to dynamically register devices, instead of providing fixed configuration files for each device."},r=void 0,a={id:"Automation_and_Robotics/Home_Automation/2022-07-17-node-red-for-mqtt-autodiscovery/index",title:"MQTT Auto-Discovery - Use Node-RED to register Smarthome Devices",description:"Previously I wrote a Python Script that allowed me to register MQTT devices with Home Assistant using the HA internal auto-discovery service. The same script can be used to register those devices with OpenHAB using the homie convention. Now I want to use Node-RED to dynamically register devices, instead of providing fixed configuration files for each device.",source:"@site/docs/Automation_and_Robotics/Home_Automation/2022-07-17-node-red-for-mqtt-autodiscovery/index.md",sourceDirName:"Automation_and_Robotics/Home_Automation/2022-07-17-node-red-for-mqtt-autodiscovery",slug:"/Automation_and_Robotics/Home_Automation/2022-07-17-node-red-for-mqtt-autodiscovery/2022-07-17",permalink:"/docs/Automation_and_Robotics/Home_Automation/2022-07-17-node-red-for-mqtt-autodiscovery/2022-07-17",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Automation_and_Robotics/Home_Automation/2022-07-17-node-red-for-mqtt-autodiscovery/index.md",tags:[{label:"IoT",permalink:"/docs/tags/io-t"}],version:"current",sidebarPosition:6990,frontMatter:{sidebar_position:6990,slug:"2022-07-17",title:"MQTT Auto-Discovery - Use Node-RED to register Smarthome Devices",authors:"mpolinowski",tags:["IoT"],image:"https://mpolinowski.github.io/img/search/mqtt.png",description:"Previously I wrote a Python Script that allowed me to register MQTT devices with Home Assistant using the HA internal auto-discovery service. The same script can be used to register those devices with OpenHAB using the homie convention. Now I want to use Node-RED to dynamically register devices, instead of providing fixed configuration files for each device."},sidebar:"tutorialSidebar",previous:{title:"OpenThread Border Router",permalink:"/docs/Automation_and_Robotics/Home_Automation/2023-01-23-thread-edge-router/2023-01-23"},next:{title:"Run Camera.UI with Docker-Compose",permalink:"/docs/Automation_and_Robotics/Home_Automation/2022-10-18-camera-ui-docker/2022-10-18"}},c={},d=[{value:"Home Assistant",id:"home-assistant",level:2},{value:"OpenHAB (homie)",id:"openhab-homie",level:2}];function h(e){const t={a:"a",blockquote:"blockquote",code:"code",em:"em",h2:"h2",img:"img",li:"li",p:"p",strong:"strong",ul:"ul",...(0,s.ah)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"Abashiri, Japan",src:o(524526).Z+"",width:"1500",height:"594"})}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"#home-assistant",children:"Home Assistant"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"#openhab-homie",children:"OpenHAB (homie)"})}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"/docs/IoT-and-Machine-Learning/Home_Automation/2022-07-12-home-assistant-mqtt-python/2022-07-12",children:"Previously I wrote a Python Script"})," that allowed me to register MQTT devices with Home Assistant using the HA internal auto-discovery service. The same script can be used to register those devices with ",(0,i.jsx)(t.a,{href:"/docs/IoT-and-Machine-Learning/Home_Automation/2022-07-16-openhab-mqtt-homie/2022-07-16",children:"OpenHAB using the homie convention"}),". Now I want to use Node-RED to dynamically register devices, instead of providing fixed configuration files for each device."]}),"\n",(0,i.jsxs)(t.blockquote,{children:["\n",(0,i.jsxs)(t.p,{children:["All flows can be downloaded from ",(0,i.jsx)(t.a,{href:"https://github.com/mpolinowski/node-red-mqtt-autodiscovery",children:"Github"}),"."]}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"home-assistant",children:"Home Assistant"}),"\n",(0,i.jsxs)(t.p,{children:["As a convention I am grouping all devices by prefix according to the device type. E.g. all MQTT cameras are in the ",(0,i.jsx)(t.code,{children:"cameras"})," group. I identify each device by it's IP address - e.g. ",(0,i.jsx)(t.em,{children:"192.168.2.120"})," would give the device ID ",(0,i.jsx)(t.code,{children:"120"}),":"]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"MQTT Auto-Discovery - Use Node-RED to register Smarthome Devices",src:o(133252).Z+"",width:"929",height:"522"})}),"\n",(0,i.jsxs)(t.p,{children:["To be able to register all my cameras with a Node-RED script I first have to inject the prefix and ID of the camera I want to target and then walk my way through the ",(0,i.jsx)(t.a,{href:"https://wiki.instar.com/en/Advanced_User/INSTAR_MQTT_Broker/MQTTv5_API/",children:"MQTT API"})," to extract all the information I need from this camera:"]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"MQTT Auto-Discovery - Use Node-RED to register Smarthome Devices",src:o(605417).Z+"",width:"1290",height:"560"})}),"\n",(0,i.jsxs)(t.p,{children:["By writing those information into flow variables I can then use them to build the ",(0,i.jsx)(t.a,{href:"/docs/IoT-and-Machine-Learning/Home_Automation/2022-07-10-home-assistant-mqtt-autodiscovery-part-i/2022-07-10",children:"Configuration Topics needed by the Home Assistant Auto-discovery"}),":"]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"MQTT Auto-Discovery - Use Node-RED to register Smarthome Devices",src:o(970207).Z+"",width:"1108",height:"438"})}),"\n",(0,i.jsx)(t.p,{children:"Now all I have to do is to inject the MQTT ID of the camera I want to register with Home Assistant (which has to be connected to the same MQTT Broker) and all the configuration topics will fire. This event can be coupled to the Last-Will topic of the device to have it register itself as soon as it connects with the broker."}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"MQTT Auto-Discovery - Use Node-RED to register Smarthome Devices",src:o(187589).Z+"",width:"1288",height:"887"})}),"\n",(0,i.jsx)(t.h2,{id:"openhab-homie",children:"OpenHAB (homie)"}),"\n",(0,i.jsxs)(t.p,{children:["OpenHAB uses the ",(0,i.jsx)(t.a,{href:"/docs/IoT-and-Machine-Learning/Home_Automation/2022-07-16-openhab-mqtt-homie/2022-07-16",children:"homie convention"})," to do the same thing. Again, I first need to extract all information through the ",(0,i.jsx)(t.a,{href:"https://wiki.instar.com/en/Advanced_User/INSTAR_MQTT_Broker/MQTTv5_API/",children:"MQTT API"}),":"]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"MQTT Auto-Discovery - Use Node-RED to register Smarthome Devices",src:o(318200).Z+"",width:"954",height:"414"})}),"\n",(0,i.jsxs)(t.p,{children:["Now I can continue building the configuration topics according to the ",(0,i.jsx)(t.a,{href:"https://homieiot.github.io/specification/",children:"homie convention"}),":"]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"MQTT Auto-Discovery - Use Node-RED to register Smarthome Devices",src:o(433870).Z+"",width:"996",height:"259"})}),"\n",(0,i.jsxs)(t.p,{children:["First we have to define the device by registering the ",(0,i.jsx)(t.code,{children:"$homie"})," version it is using, the ",(0,i.jsx)(t.code,{children:"$name"})," of the device, some more administrative work with the ",(0,i.jsx)(t.code,{children:"$extensions"})," and the online ",(0,i.jsx)(t.code,{children:"$state"})," that I have coupled to the camera ",(0,i.jsx)(t.strong,{children:"Last-Will & Testament"}),". The last point is a comma separated list of all the ",(0,i.jsx)(t.code,{children:"$nodes"})," we want to register to group ",(0,i.jsx)(t.code,{children:"$properties"})," that directly translate into ",(0,i.jsx)(t.strong,{children:"Thing"})," ",(0,i.jsx)(t.strong,{children:"Channels"})," and can be used as ",(0,i.jsx)(t.strong,{children:"Items"})," like switches or sliders:"]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"MQTT Auto-Discovery - Use Node-RED to register Smarthome Devices",src:o(959208).Z+"",width:"1022",height:"376"})}),"\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"$node"})," then lists all the ",(0,i.jsx)(t.code,{children:"$properties"})," it contains and then defines each of those - that directly correspond to a MQTT command topic on my camera:"]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"MQTT Auto-Discovery - Use Node-RED to register Smarthome Devices",src:o(558602).Z+"",width:"1112",height:"363"})}),"\n",(0,i.jsx)(t.p,{children:"Every property here is, thanks to Node-RED, directly coupled with the camera API and will receive change updates:"}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"MQTT Auto-Discovery - Use Node-RED to register Smarthome Devices",src:o(558602).Z+"",width:"1112",height:"363"})}),"\n",(0,i.jsxs)(t.p,{children:["In OpenHAB you should now see a new ",(0,i.jsx)(t.strong,{children:"Thing"})," in your Inbox:"]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"MQTT Auto-Discovery - Use Node-RED to register Smarthome Devices",src:o(302531).Z+"",width:"1203",height:"596"})}),"\n",(0,i.jsx)(t.p,{children:"Select your camera from the inbox and add it:"}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"MQTT Auto-Discovery - Use Node-RED to register Smarthome Devices",src:o(894962).Z+"",width:"1201",height:"471"})}),"\n",(0,i.jsxs)(t.p,{children:["All ",(0,i.jsx)(t.strong,{children:"homie"})," ",(0,i.jsx)(t.code,{children:"&properties"})," should now show up as ",(0,i.jsx)(t.strong,{children:"Channels"})," and are ready to use as dashboard ",(0,i.jsx)(t.strong,{children:"Items"})," or for automation:"]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"MQTT Auto-Discovery - Use Node-RED to register Smarthome Devices",src:o(309289).Z+"",width:"1195",height:"600"})}),"\n",(0,i.jsxs)(t.p,{children:["To toggle a value use the ",(0,i.jsx)(t.code,{children:"/set"})," command - e.g. the state topic defined to turn the alarm on is ",(0,i.jsx)(t.code,{children:"homie/120/alarm/alarm-armed"}),". You can toggle it by publishing an update to ",(0,i.jsx)(t.code,{children:"homie/120/alarm/alarm-armed/set"}),". Make sure that all subscriptions are active and send an update to the set-command:"]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"MQTT Auto-Discovery - Use Node-RED to register Smarthome Devices",src:o(696357).Z+"",width:"900",height:"95"})}),"\n",(0,i.jsxs)(t.p,{children:["Updating the command topic ",(0,i.jsx)(t.code,{children:"homie/120/alarm/alarm-armed/set"})," will now also update the value of the state topic ",(0,i.jsx)(t.code,{children:"homie/120/alarm/alarm-armed"})," and of course, since it is coupled with the device API, it will actually update the state on your device as well:"]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"MQTT Auto-Discovery - Use Node-RED to register Smarthome Devices",src:o(747126).Z+"",width:"1403",height:"795"})})]})}function m(e={}){const{wrapper:t}={...(0,s.ah)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},603905:(e,t,o)=>{o.d(t,{ah:()=>d});var i=o(667294);function s(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function n(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,i)}return o}function r(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?n(Object(o),!0).forEach((function(t){s(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):n(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function a(e,t){if(null==e)return{};var o,i,s=function(e,t){if(null==e)return{};var o,i,s={},n=Object.keys(e);for(i=0;i<n.length;i++)o=n[i],t.indexOf(o)>=0||(s[o]=e[o]);return s}(e,t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);for(i=0;i<n.length;i++)o=n[i],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(s[o]=e[o])}return s}var c=i.createContext({}),d=function(e){var t=i.useContext(c),o=t;return e&&(o="function"==typeof e?e(t):r(r({},t),e)),o},h={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},m=i.forwardRef((function(e,t){var o=e.components,s=e.mdxType,n=e.originalType,c=e.parentName,m=a(e,["components","mdxType","originalType","parentName"]),l=d(o),u=s,p=l["".concat(c,".").concat(u)]||l[u]||h[u]||n;return o?i.createElement(p,r(r({ref:t},m),{},{components:o})):i.createElement(p,r({ref:t},m))}));m.displayName="MDXCreateElement"},187589:(e,t,o)=>{o.d(t,{Z:()=>i});const i=o.p+"assets/images/Home_Assistant_MQTT_Auto-Discovery_04-d7c7193502a52b04fd04e3b1be33bdd1.png"},133252:(e,t,o)=>{o.d(t,{Z:()=>i});const i=o.p+"assets/images/home_assistant_auto_discovery_node-red_00-2af8b3efb0ca126a1a9a35186e6df3cd.png"},605417:(e,t,o)=>{o.d(t,{Z:()=>i});const i=o.p+"assets/images/home_assistant_auto_discovery_node-red_01-3d5cbd41ce9285ba1cd0abbae8ea3917.png"},970207:(e,t,o)=>{o.d(t,{Z:()=>i});const i=o.p+"assets/images/home_assistant_auto_discovery_node-red_02-4788096d37511a591610843f6b2fa3d7.png"},318200:(e,t,o)=>{o.d(t,{Z:()=>i});const i=o.p+"assets/images/homie_auto_discovery_node-red_01-b5b67441b318d89f6ac9ea1e049a297b.png"},433870:(e,t,o)=>{o.d(t,{Z:()=>i});const i=o.p+"assets/images/homie_auto_discovery_node-red_02a-d6a6fed30f394a8d9dd2da67d72307e3.png"},959208:(e,t,o)=>{o.d(t,{Z:()=>i});const i=o.p+"assets/images/homie_auto_discovery_node-red_02b-0a6b98e740e40332d4cf7dfa9f3cbb08.png"},558602:(e,t,o)=>{o.d(t,{Z:()=>i});const i=o.p+"assets/images/homie_auto_discovery_node-red_03a-598aafd7470e5c741ab5eff6e64fbfa8.png"},302531:(e,t,o)=>{o.d(t,{Z:()=>i});const i=o.p+"assets/images/homie_auto_discovery_node-red_04-0417d4d0bbc3b14607a3dece9379cfa8.png"},894962:(e,t,o)=>{o.d(t,{Z:()=>i});const i=o.p+"assets/images/homie_auto_discovery_node-red_05-31e45566c138cb26ff91255a28cfe5c2.png"},309289:(e,t,o)=>{o.d(t,{Z:()=>i});const i=o.p+"assets/images/homie_auto_discovery_node-red_06-6fa1bb051ea73e23d06e83e91dfbe3f6.png"},696357:(e,t,o)=>{o.d(t,{Z:()=>i});const i=o.p+"assets/images/homie_auto_discovery_node-red_07-2bf103f75bff381827598e4ce8563e9c.png"},747126:(e,t,o)=>{o.d(t,{Z:()=>i});const i=o.p+"assets/images/homie_auto_discovery_node-red_08-36cb419c1ab4fc2ab73fcf7287c6b8e3.png"},524526:(e,t,o)=>{o.d(t,{Z:()=>i});const i=o.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-877ed54046c637e78f96cc6a07569d43.jpg"}}]);