"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[50946],{31960:(n,t,e)=>{e.r(t),e.d(t,{assets:()=>c,contentTitle:()=>s,default:()=>p,frontMatter:()=>i,metadata:()=>a,toc:()=>l});var r=e(785893),o=e(603905);const i={sidebar_position:9010,slug:"2021-09-12",title:"Go Paho MQTT Client",authors:"mpolinowski",tags:["Go","MQTT"]},s=void 0,a={id:"Automation_and_Robotics/MQTT/2021-09-12--golang-paho-mqtt/index",title:"Go Paho MQTT Client",description:"Victoria Harbour, Hongkong",source:"@site/docs/Automation_and_Robotics/MQTT/2021-09-12--golang-paho-mqtt/index.md",sourceDirName:"Automation_and_Robotics/MQTT/2021-09-12--golang-paho-mqtt",slug:"/Automation_and_Robotics/MQTT/2021-09-12--golang-paho-mqtt/2021-09-12",permalink:"/docs/Automation_and_Robotics/MQTT/2021-09-12--golang-paho-mqtt/2021-09-12",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Automation_and_Robotics/MQTT/2021-09-12--golang-paho-mqtt/index.md",tags:[{label:"Go",permalink:"/docs/tags/go"},{label:"MQTT",permalink:"/docs/tags/mqtt"}],version:"current",sidebarPosition:9010,frontMatter:{sidebar_position:9010,slug:"2021-09-12",title:"Go Paho MQTT Client",authors:"mpolinowski",tags:["Go","MQTT"]},sidebar:"tutorialSidebar",previous:{title:"Mosquitto v2 MQTT Broker on Debian Bullseye",permalink:"/docs/Automation_and_Robotics/MQTT/2022-02-01--mosquitto-2-broker/2022-02-01"},next:{title:"MQTT Networks with Home Assistant",permalink:"/docs/Automation_and_Robotics/MQTT/2019-08-11--mqtt-home-assistant/2019-08-11"}},c={},l=[{value:"Project initialization",id:"project-initialization",level:2},{value:"Connect to the MQTT broker",id:"connect-to-the-mqtt-broker",level:2},{value:"Topic Subscription",id:"topic-subscription",level:2},{value:"Topic Update",id:"topic-update",level:2},{value:"Testing",id:"testing",level:2},{value:"Running the Program",id:"running-the-program",level:3}];function d(n){const t={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.ah)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Victoria Harbour, Hongkong",src:e(590166).Z+"",width:"1500",height:"368"})}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"#project-initialization",children:"Project initialization"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"#connect-to-the-mqtt-broker",children:"Connect to the MQTT broker"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"#topic-subscription",children:"Topic Subscription"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"#topic-update",children:"Topic Update"})}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.a,{href:"#testing",children:"Testing"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"#running-the-program",children:"Running the Program"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:["I want to create a Go MQTT client that can connect to the ",(0,r.jsx)(t.a,{href:"https://wiki.instar.com/enhttps://wiki.instar.com/en/Advanced_User/INSTAR_MQTT_Broker/",children:"INSTAR MQTT Broker"})," on an IN-8015 FHD camera on local IP ",(0,r.jsx)(t.code,{children:"192.168.2.77"}),". I want to be able to add topic subscriptions as well as publishing MQTT updates to the broker."]}),"\n",(0,r.jsx)(t.h2,{id:"project-initialization",children:"Project initialization"}),"\n",(0,r.jsx)(t.p,{children:"This project uses paho.mqtt.golang as MQTT client library, install:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"go mod init go/paho-mqtt\r\ngo get github.com/eclipse/paho.mqtt.golang\n"})}),"\n",(0,r.jsx)(t.h2,{id:"connect-to-the-mqtt-broker",children:"Connect to the MQTT broker"}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.em,{children:"./src/client/main.go"})}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-go",children:'package main\r\n\r\nimport (\r\n\t"fmt"\r\n\r\n\tmqtt "github.com/eclipse/paho.mqtt.golang"\r\n)\r\n\r\nvar messagePubHandler mqtt.MessageHandler = func(client mqtt.Client, msg mqtt.Message) {\r\n    fmt.Printf("Topic: %s | %s\\n", msg.Topic(), msg.Payload())\r\n}\r\n\r\nvar connectHandler mqtt.OnConnectHandler = func(client mqtt.Client) {\r\n    fmt.Println("Connected")\r\n}\r\n\r\nvar connectLostHandler mqtt.ConnectionLostHandler = func(client mqtt.Client, err error) {\r\n    fmt.Printf("Connect lost: %+v", err)\r\n}\r\n\r\nfunc main() {\r\n    var broker = "192.168.2.70"\r\n    var port = 1883\r\n    opts := mqtt.NewClientOptions()\r\n    opts.AddBroker(fmt.Sprintf("tcp://%s:%d", broker, port))\r\n    opts.SetClientID("go_mqtt_client")\r\n    opts.SetUsername("admin")\r\n    opts.SetPassword("instar")\r\n    opts.SetDefaultPublishHandler(messagePubHandler)\r\n    opts.OnConnect = connectHandler\r\n    opts.OnConnectionLost = connectLostHandler\r\n    client := mqtt.NewClient(opts)\r\n    if token := client.Connect(); token.Wait() && token.Error() != nil {\r\n        panic(token.Error())\r\n  }\r\n}\n'})}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"messagePubHandler"}),": global MQTT pub message processing"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"connectHandler"}),": callback for the connection"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"connectLostHandler"}),": callback for connection loss"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"ClientOptions"}),": used to set broker, port, client id, username, password and other options."]}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"topic-subscription",children:"Topic Subscription"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-go",children:'func sub(client mqtt.Client) {\r\n    // Subscribe to the LWT connection status\r\n    topic := "cameras/77/status/connection"\r\n    token := client.Subscribe(topic, 1, nil)\r\n    token.Wait()\r\n    fmt.Printf("Subscribed to LWT %s", topic)\r\n}\n'})}),"\n",(0,r.jsx)(t.h2,{id:"topic-update",children:"Topic Update"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-go",children:'func publish(client mqtt.Client) {\r\n    // Go to PTZ preset 2 and return to 1 after 15s\r\n    nums := []int{2, 1}\r\n    for _, num := range nums {\r\n        value := fmt.Sprintf("%d", num)\r\n        token := client.Publish("cameras/77/features/ptz/preset/raw", 0, false, value)\r\n        token.Wait()\r\n        time.Sleep(15 * time.Second)\r\n    }\r\n}\n'})}),"\n",(0,r.jsx)(t.h2,{id:"testing",children:"Testing"}),"\n",(0,r.jsx)(t.p,{children:"Now bringing it all together:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-go",children:'package main\r\n\r\nimport (\r\n\t"fmt"\r\n\t"time"\r\n\r\n\tmqtt "github.com/eclipse/paho.mqtt.golang"\r\n)\r\n\r\nvar messagePubHandler mqtt.MessageHandler = func(client mqtt.Client, msg mqtt.Message) {\r\n    fmt.Printf("Topic: %s | %s\\n", msg.Topic(), msg.Payload())\r\n}\r\n\r\nvar connectHandler mqtt.OnConnectHandler = func(client mqtt.Client) {\r\n    fmt.Println("Connected")\r\n}\r\n\r\nvar connectLostHandler mqtt.ConnectionLostHandler = func(client mqtt.Client, err error) {\r\n    fmt.Printf("Connect lost: %+v", err)\r\n}\r\n\r\nfunc main() {\r\n    var broker = "192.168.2.77"\r\n    var port = 1883\r\n    opts := mqtt.NewClientOptions()\r\n    opts.AddBroker(fmt.Sprintf("tcp://%s:%d", broker, port))\r\n    opts.SetClientID("go_mqtt_client")\r\n    opts.SetUsername("admin")\r\n    opts.SetPassword("instar")\r\n    opts.SetDefaultPublishHandler(messagePubHandler)\r\n    opts.OnConnect = connectHandler\r\n    opts.OnConnectionLost = connectLostHandler\r\n    client := mqtt.NewClient(opts)\r\n    if token := client.Connect(); token.Wait() && token.Error() != nil {\r\n        panic(token.Error())\r\n  }\r\n\r\n    sub(client)\r\n    publish(client)\r\n\r\n    client.Disconnect(250)\r\n}\r\n\r\nfunc publish(client mqtt.Client) {\r\n    // Go to PTZ preset 2 and return to 1 after 15s\r\n    nums := []int{2, 1}\r\n    for _, num := range nums {\r\n        value := fmt.Sprintf("%d", num)\r\n        token := client.Publish("cameras/77/features/ptz/preset/raw", 0, false, value)\r\n        token.Wait()\r\n        time.Sleep(15 * time.Second)\r\n    }\r\n}\r\n\r\nfunc sub(client mqtt.Client) {\r\n    // Subscribe to the LWT connection status\r\n    topic := "cameras/77/status/connection"\r\n    token := client.Subscribe(topic, 1, nil)\r\n    token.Wait()\r\n    fmt.Println("Subscribed to LWT", topic)\r\n}\n'})}),"\n",(0,r.jsx)(t.h3,{id:"running-the-program",children:"Running the Program"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:'go run .\\main.go\r\nConnected\r\nSubscribed to LWT cameras/77/status/connection        \r\nTopic: cameras/77/status/connection | {"val":"online"}\n'})}),"\n",(0,r.jsx)(t.p,{children:"The program will pan your camera to preset position 2, return it to preset 1 and then stop running."})]})}function p(n={}){const{wrapper:t}={...(0,o.ah)(),...n.components};return t?(0,r.jsx)(t,{...n,children:(0,r.jsx)(d,{...n})}):d(n)}},603905:(n,t,e)=>{e.d(t,{ah:()=>l});var r=e(667294);function o(n,t,e){return t in n?Object.defineProperty(n,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):n[t]=e,n}function i(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable}))),e.push.apply(e,r)}return e}function s(n){for(var t=1;t<arguments.length;t++){var e=null!=arguments[t]?arguments[t]:{};t%2?i(Object(e),!0).forEach((function(t){o(n,t,e[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):i(Object(e)).forEach((function(t){Object.defineProperty(n,t,Object.getOwnPropertyDescriptor(e,t))}))}return n}function a(n,t){if(null==n)return{};var e,r,o=function(n,t){if(null==n)return{};var e,r,o={},i=Object.keys(n);for(r=0;r<i.length;r++)e=i[r],t.indexOf(e)>=0||(o[e]=n[e]);return o}(n,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);for(r=0;r<i.length;r++)e=i[r],t.indexOf(e)>=0||Object.prototype.propertyIsEnumerable.call(n,e)&&(o[e]=n[e])}return o}var c=r.createContext({}),l=function(n){var t=r.useContext(c),e=t;return n&&(e="function"==typeof n?n(t):s(s({},t),n)),e},d={inlineCode:"code",wrapper:function(n){var t=n.children;return r.createElement(r.Fragment,{},t)}},p=r.forwardRef((function(n,t){var e=n.components,o=n.mdxType,i=n.originalType,c=n.parentName,p=a(n,["components","mdxType","originalType","parentName"]),m=l(e),u=o,h=m["".concat(c,".").concat(u)]||m[u]||d[u]||i;return e?r.createElement(h,s(s({ref:t},p),{},{components:e})):r.createElement(h,s({ref:t},p))}));p.displayName="MDXCreateElement"},590166:(n,t,e)=>{e.d(t,{Z:()=>r});const r=e.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-d59d1fe8aa35f1cb9f663bce683552c2.jpg"}}]);