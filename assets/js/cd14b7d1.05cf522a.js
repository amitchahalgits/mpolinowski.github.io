"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[84797],{949232:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>o,default:()=>h,frontMatter:()=>c,metadata:()=>i,toc:()=>l});var s=t(474848),r=t(28453);const c={sidebar_position:3910,slug:"2022-12-05",title:"Hashicorp Consul - Vault Cert Management Part 2",authors:"mpolinowski",tags:["Consul","Vault","LINUX"],description:"Set-up Vault to be the Certificate Authority"},o=void 0,i={id:"DevOps/Hashicorp/2022-12-05-hashicorp-consul-vault-certificates-part2/index",title:"Hashicorp Consul - Vault Cert Management Part 2",description:"Set-up Vault to be the Certificate Authority",source:"@site/docs/DevOps/Hashicorp/2022-12-05-hashicorp-consul-vault-certificates-part2/index.md",sourceDirName:"DevOps/Hashicorp/2022-12-05-hashicorp-consul-vault-certificates-part2",slug:"/DevOps/Hashicorp/2022-12-05-hashicorp-consul-vault-certificates-part2/2022-12-05",permalink:"/docs/DevOps/Hashicorp/2022-12-05-hashicorp-consul-vault-certificates-part2/2022-12-05",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Hashicorp/2022-12-05-hashicorp-consul-vault-certificates-part2/index.md",tags:[{label:"Consul",permalink:"/docs/tags/consul"},{label:"Vault",permalink:"/docs/tags/vault"},{label:"LINUX",permalink:"/docs/tags/linux"}],version:"current",sidebarPosition:3910,frontMatter:{sidebar_position:3910,slug:"2022-12-05",title:"Hashicorp Consul - Vault Cert Management Part 2",authors:"mpolinowski",tags:["Consul","Vault","LINUX"],description:"Set-up Vault to be the Certificate Authority"},sidebar:"tutorialSidebar",previous:{title:"Hashicorp Consul - Vault Cert Management Part 3",permalink:"/docs/DevOps/Hashicorp/2022-12-05-hashicorp-consul-vault-certificates-part3/2022-12-05"},next:{title:"Hashicorp Consul - Vault Cert Management Part 1",permalink:"/docs/DevOps/Hashicorp/2022-12-04-hashicorp-consul-vault-certificates-part1/2022-12-04"}},a={},l=[{value:"Configure Consul",id:"configure-consul",level:2},{value:"Consul Server",id:"consul-server",level:3},{value:"Consul Minions",id:"consul-minions",level:3},{value:"Cert Rotation",id:"cert-rotation",level:2}];function u(e){const n={a:"a",blockquote:"blockquote",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Shen Zhen, China",src:t(941422).A+"",width:"2230",height:"839"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"#configure-consul",children:"Configure Consul"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#consul-server",children:"Consul Server"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#consul-minions",children:"Consul Minions"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#cert-rotation",children:"Cert Rotation"})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"configure-consul",children:"Configure Consul"}),"\n",(0,s.jsx)(n.h3,{id:"consul-server",children:"Consul Server"}),"\n",(0,s.jsx)(n.p,{children:"Create a directory for the certificates and configure Consul TLS using the following configuration:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"mkdir -p /opt/consul/agent-certs\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.em,{children:"/etc/consul.d/client.hcl"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'tls {\n  defaults {\n    ca_file = "/opt/consul/agent-certs/ca.crt"\n    cert_file = "/opt/consul/agent-certs/agent.crt"\n    key_file = "/opt/consul/agent-certs/agent.key"\n    verify_incoming = true\n    verify_outgoing = true\n  }\n  internal_rpc {\n    verify_server_hostname = true\n  }\n  https {\n    verify_incoming = true\n  }\n}\n\nauto_encrypt {\n  allow_tls = true\n}\n\n'})}),"\n",(0,s.jsx)(n.p,{children:"I already created my certificates with the following command:"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Careful"}),": The official documentation uses the ",(0,s.jsx)(n.code,{children:"common_name"})," for the default datacenter ",(0,s.jsx)(n.code,{children:"consul.dc1"}),". I use the name ",(0,s.jsx)(n.code,{children:"consul"})," here and have to change the variable ",(0,s.jsx)(n.code,{children:"consul.consul"})," accordingly. Otherwise the cert verification will fail. This name will be used a couple of times in the following commands - you need to change all of them according to your setup."]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'vault write pki_int/issue/consul-consul common_name="server.consul.consul" ttl="24h" | tee consul_certs.txt\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Use the following commands to extract the two certificates and private key from the ",(0,s.jsx)(n.code,{children:"consul_certs.txt"})," and place them into the right file and location:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"grep -Pzo \"(?s)(?<=certificate)[^\\-]*.*?END CERTIFICATE[^\\n]*\\n\" consul_certs.txt | sed 's/^\\s*-/-/g' > /opt/consul/agent-certs/agent.crt\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"grep -Pzo \"(?s)(?<=issuing_ca)[^\\-]*.*?END CERTIFICATE[^\\n]*\\n\" consul_certs.txt | sed 's/^\\s*-/-/g' > /opt/consul/agent-certs/ca.crt\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"grep -Pzo \"(?s)(?<=private_key)[^\\-]*.*?END RSA PRIVATE KEY[^\\n]*\\n\" consul_certs.txt | sed 's/^\\s*-/-/g' > /opt/consul/agent-certs/agent.key\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"chown -R consul:consul /opt/consul/agent-certs\n"})}),"\n",(0,s.jsx)(n.h3,{id:"consul-minions",children:"Consul Minions"}),"\n",(0,s.jsx)(n.p,{children:"With auto-encryption, you can configure the Consul servers to automatically distribute certificates to the clients. To use this feature, you will need to configure clients to automatically get the certificates from the server."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"mkdir -p /opt/consul/agent-certs\n"})}),"\n",(0,s.jsx)(n.p,{children:"Configure Consul client TLS using the following configuration:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.em,{children:"/etc/consul.d/consul.hcl"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'tls {\n  defaults {\n    verify_incoming = true\n    verify_outgoing = true\n    ca_file = "/opt/consul/agent-certs/ca.crt"\n  }\n  internal_rpc {\n    verify_server_hostname = true\n  }\n}\n\nauto_encrypt {\n    tls = true\n }\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Now we need to copy the extracted ",(0,s.jsx)(n.code,{children:"agent.crt"})," to each node into the specified directory:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"grep -Pzo \"(?s)(?<=issuing_ca)[^\\-]*.*?END CERTIFICATE[^\\n]*\\n\" consul_certs.txt | sed 's/^\\s*-/-/g' > /opt/consul/agent-certs/ca.crt\n"})}),"\n",(0,s.jsx)(n.h2,{id:"cert-rotation",children:"Cert Rotation"}),"\n",(0,s.jsx)(n.p,{children:"Now that we have our Cert Authority (CA) and configured our master and minion server to use our short-lived, self-signed CA certs we now need to implement the automatic rotation whenever the cert expires."}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/docs/DevOps/Hashicorp/2022-12-05-hashicorp-consul-vault-certificates-part3/2022-12-05",children:"Hashicorp Consul - Vault Cert Management Part 3"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(u,{...e})}):u(e)}},941422:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-6c1edb088dfea3a7d39f8eebb8e9dc23.jpg"},28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>i});var s=t(296540);const r={},c=s.createContext(r);function o(e){const n=s.useContext(c);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(c.Provider,{value:n},e.children)}}}]);