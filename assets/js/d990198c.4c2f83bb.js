"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[59552],{712437:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>t,metadata:()=>c,toc:()=>l});var r=s(474848),i=s(28453);const t={sidebar_position:4040,slug:"2022-10-23",title:"Hashicorp Nomad - Working with Consul Connect",authors:"mpolinowski",tags:["Nomad","Consul","LINUX"],description:"CNI Error message with Consul Connect"},o=void 0,c={id:"DevOps/Hashicorp/2022-10-23-hashicorp-consul-connect/index",title:"Hashicorp Nomad - Working with Consul Connect",description:"CNI Error message with Consul Connect",source:"@site/docs/DevOps/Hashicorp/2022-10-23-hashicorp-consul-connect/index.md",sourceDirName:"DevOps/Hashicorp/2022-10-23-hashicorp-consul-connect",slug:"/DevOps/Hashicorp/2022-10-23-hashicorp-consul-connect/2022-10-23",permalink:"/docs/DevOps/Hashicorp/2022-10-23-hashicorp-consul-connect/2022-10-23",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Hashicorp/2022-10-23-hashicorp-consul-connect/index.md",tags:[{label:"Nomad",permalink:"/docs/tags/nomad"},{label:"Consul",permalink:"/docs/tags/consul"},{label:"LINUX",permalink:"/docs/tags/linux"}],version:"current",sidebarPosition:4040,frontMatter:{sidebar_position:4040,slug:"2022-10-23",title:"Hashicorp Nomad - Working with Consul Connect",authors:"mpolinowski",tags:["Nomad","Consul","LINUX"],description:"CNI Error message with Consul Connect"},sidebar:"tutorialSidebar",previous:{title:"Hashicorp Nomad - Working with Ports",permalink:"/docs/DevOps/Hashicorp/2022-10-23-hashicorp-nomad-ports/2022-10-23"},next:{title:"Hashicorp Nomad Sidecar Pattern",permalink:"/docs/DevOps/Hashicorp/2022-10-22-hashicorp-nomad-sidecar-pattern/2022-10-22"}},d={},l=[{value:"Setup Failure",id:"setup-failure",level:2},{value:"CNI Plugins",id:"cni-plugins",level:3},{value:"Sidecar Required Ports",id:"sidecar-required-ports",level:3}];function a(e){const n={a:"a",blockquote:"blockquote",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Shen Zhen, China",src:s(38787).A+"",width:"2230",height:"839"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"#setup-failure",children:"Setup Failure"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#cni-plugins",children:"CNI Plugins"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#sidecar-required-ports",children:"Sidecar Required Ports"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"setup-failure",children:"Setup Failure"}),"\n",(0,r.jsxs)(n.p,{children:["Trying to use ",(0,r.jsx)(n.strong,{children:"Consul Connect"})," in a Nomad job file:"]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:'failed to setup alloc: pre-run hook "network" failed: failed to configure networking for alloc: failed to configure network: plugin type="loopback" failed (add): failed to find plugin "loopback" in path [/opt/cni/bin]'})}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"cni-plugins",children:"CNI Plugins"}),"\n",(0,r.jsx)(n.p,{children:"Nomad uses CNI plugins to configure the network namespace used to secure the Consul service mesh sidecar proxy. All Nomad client nodes using network namespaces must have CNI plugins installed:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'curl -L -o cni-plugins.tgz "https://github.com/containernetworking/plugins/releases/download/v1.0.0/cni-plugins-linux-$( [ $(uname -m) = aarch64 ] && echo arm64 || echo amd64)"-v1.0.0.tgz\nsudo mkdir -p /opt/cni/bin\nsudo tar -C /opt/cni/bin -xzf cni-plugins.tgz\n'})}),"\n",(0,r.jsx)(n.p,{children:"Ensure the your Linux operating system distribution has been configured to allow container traffic through the bridge network to be routed via iptables. These tunables can be set as follows:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"echo 1 | tee /proc/sys/net/bridge/bridge-nf-call-arptables\necho 1 | tee /proc/sys/net/bridge/bridge-nf-call-ip6tables\necho 1 | tee /proc/sys/net/bridge/bridge-nf-call-iptables\n"})}),"\n",(0,r.jsx)(n.p,{children:"To preserve these settings on startup of a client node, add a file including the following to /etc/sysctl.d/ or remove the file your Linux distribution puts in that directory."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"net.bridge.bridge-nf-call-arptables = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sidecar-required-ports",children:"Sidecar Required Ports"}),"\n",(0,r.jsx)(n.p,{children:"Before running Consul, you should ensure the following bind ports are accessible. Below is a complete list of ports that need to be opened inside your Consul cluster:"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Use"}),(0,r.jsx)(n.th,{children:"Default Ports"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.strong,{children:"DNS"}),": The DNS server (",(0,r.jsx)(n.em,{children:"TCP and UDP"}),")"]}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"8600"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.strong,{children:"HTTP"}),": The HTTP API (",(0,r.jsx)(n.em,{children:"TCP Only"}),")"]}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"8500"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.strong,{children:"HTTPS"}),": The HTTPs API\t",(0,r.jsx)(n.em,{children:"disabled"})]}),(0,r.jsxs)(n.td,{children:["(",(0,r.jsx)(n.code,{children:"8501"}),")*"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.strong,{children:"gRPC"}),": The gRPC API ",(0,r.jsx)(n.em,{children:"disabled"})]}),(0,r.jsxs)(n.td,{children:["(",(0,r.jsx)(n.code,{children:"8502"}),")*"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.strong,{children:"LAN Serf"}),": The Serf LAN port (",(0,r.jsx)(n.em,{children:"TCP and UDP"}),")"]}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"8301"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.strong,{children:"Wan Serf"}),": The Serf WAN port (",(0,r.jsx)(n.em,{children:"TCP and UDP"}),")"]}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"8302"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.strong,{children:"server"}),": Server RPC address (",(0,r.jsx)(n.em,{children:"TCP Only"}),")"]}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"8300"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.strong,{children:"Sidecar"})," Proxy Min: Inclusive min port number to use for automatically assigned sidecar service registrations."]}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"21000"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.strong,{children:"Sidecar"})," Proxy Max: Inclusive max port number to use for automatically assigned sidecar service registrations."]}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"21255"})})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:["* ",(0,r.jsx)(n.em,{children:"For HTTPS and gRPC the ports specified in the table are recommendations."})]}),"\n",(0,r.jsxs)(n.p,{children:["E.g. ",(0,r.jsx)(n.em,{children:"Uncomplicated Firewall"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"ufw allow 8300,8301,8302,8500,8502,8600/tcp\nufw allow 8301,8302,8502,8600/udp\nufw allow 21000:21255/tcp\n"})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:["Continues here  ",(0,r.jsx)(n.a,{href:"/docs/DevOps/Hashicorp/2022-11-24-hashicorp-consul-connect/2022-11-24",children:"Hashicorp Nomad - Working with Consul Connect Part II"})]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},38787:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-6c1edb088dfea3a7d39f8eebb8e9dc23.jpg"},28453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>c});var r=s(296540);const i={},t=r.createContext(i);function o(e){const n=r.useContext(t);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);