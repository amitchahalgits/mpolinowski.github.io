"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[63518],{3905:(e,t,r)=>{r.d(t,{Zo:()=>d,kt:()=>m});var a=r(67294);function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){n(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function p(e,t){if(null==e)return{};var r,a,n=function(e,t){if(null==e)return{};var r,a,n={},o=Object.keys(e);for(a=0;a<o.length;a++)r=o[a],t.indexOf(r)>=0||(n[r]=e[r]);return n}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)r=o[a],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}var l=a.createContext({}),s=function(e){var t=a.useContext(l),r=t;return e&&(r="function"==typeof e?e(t):i(i({},t),e)),r},d=function(e){var t=s(e.components);return a.createElement(l.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var r=e.components,n=e.mdxType,o=e.originalType,l=e.parentName,d=p(e,["components","mdxType","originalType","parentName"]),u=s(r),m=n,c=u["".concat(l,".").concat(m)]||u[m]||h[m]||o;return r?a.createElement(c,i(i({ref:t},d),{},{components:r})):a.createElement(c,i({ref:t},d))}));function m(e,t){var r=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=r.length,i=new Array(o);i[0]=u;var p={};for(var l in t)hasOwnProperty.call(t,l)&&(p[l]=t[l]);p.originalType=e,p.mdxType="string"==typeof e?e:n,i[1]=p;for(var s=2;s<o;s++)i[s]=r[s];return a.createElement.apply(null,i)}return a.createElement.apply(null,r)}u.displayName="MDXCreateElement"},25257:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>p,toc:()=>s});var a=r(87462),n=(r(67294),r(3905));const o={sidebar_position:6980,slug:"2023-01-23",title:"OpenThread Border Router",authors:"mpolinowski",tags:["IoT"],image:"https://mpolinowski.github.io/img/search/mqtt.png",description:"Build an OpenThread Border Router with Raspberry Pi 3B+ and Pitaya Go."},i=void 0,p={unversionedId:"IoT-and-Machine-Learning/Home_Automation/2023-01-23-thread-edge-router/index",id:"IoT-and-Machine-Learning/Home_Automation/2023-01-23-thread-edge-router/index",title:"OpenThread Border Router",description:"Build an OpenThread Border Router with Raspberry Pi 3B+ and Pitaya Go.",source:"@site/docs/IoT-and-Machine-Learning/Home_Automation/2023-01-23-thread-edge-router/index.md",sourceDirName:"IoT-and-Machine-Learning/Home_Automation/2023-01-23-thread-edge-router",slug:"/IoT-and-Machine-Learning/Home_Automation/2023-01-23-thread-edge-router/2023-01-23",permalink:"/docs/IoT-and-Machine-Learning/Home_Automation/2023-01-23-thread-edge-router/2023-01-23",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/IoT-and-Machine-Learning/Home_Automation/2023-01-23-thread-edge-router/index.md",tags:[{label:"IoT",permalink:"/docs/tags/io-t"}],version:"current",sidebarPosition:6980,frontMatter:{sidebar_position:6980,slug:"2023-01-23",title:"OpenThread Border Router",authors:"mpolinowski",tags:["IoT"],image:"https://mpolinowski.github.io/img/search/mqtt.png",description:"Build an OpenThread Border Router with Raspberry Pi 3B+ and Pitaya Go."},sidebar:"tutorialSidebar",previous:{title:"OpenThread Border Router with Docker with Docker",permalink:"/docs/IoT-and-Machine-Learning/Home_Automation/2023-01-23-thread-edge-router-docker/2023-01-23"},next:{title:"MQTT Auto-Discovery - Use Node-RED to register Smarthome Devices",permalink:"/docs/IoT-and-Machine-Learning/Home_Automation/2022-07-17-node-red-for-mqtt-autodiscovery/2022-07-17"}},l={},s=[{value:"Hardware Requirements\xb6",id:"hardware-requirements",level:2},{value:"Preparing the RaspberryPI",id:"preparing-the-raspberrypi",level:2},{value:"Preparing the Pitaya Go",id:"preparing-the-pitaya-go",level:2},{value:"Flash the NCP firmware",id:"flash-the-ncp-firmware",level:3},{value:"Set up the Border Router",id:"set-up-the-border-router",level:2},{value:"Configure the Pitaya Go",id:"configure-the-pitaya-go",level:2}],d={toc:s};function h(e){let{components:t,...o}=e;return(0,n.kt)("wrapper",(0,a.Z)({},d,o,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"Guangzhou, China",src:r(42117).Z,width:"1500",height:"526"})),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#hardware-requirements"},"Hardware Requirements\xb6")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#preparing-the-raspberrypi"},"Preparing the RaspberryPI")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#preparing-the-pitaya-go"},"Preparing the Pitaya Go"),(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#flash-the-ncp-firmware"},"Flash the NCP firmware")))),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#set-up-the-border-router"},"Set up the Border Router")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#configure-the-pitaya-go"},"Configure the Pitaya Go"))),(0,n.kt)("p",null,"A ",(0,n.kt)("a",{parentName:"p",href:"https://openthread.io/guides/border-router/build"},"Thread Border Router")," serves as a gateway between the Internet and the Thread network. OpenThread's implementation of a Border Router is called OpenThread Border Router (OTBR). OTBR is a Thread Certified Component on the Raspberry Pi 3B with a Nordic nRF52840 NCP."),(0,n.kt)("p",null,"A Thread Border Router minimally supports the following functions:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},"End-to-end IP connectivity via routing between Thread devices and other external IP networks")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},"External Thread Commissioning (for example, a mobile phone) to authenticate and join a Thread device to a Thread network"))),(0,n.kt)("p",null,"For more technical details, ",(0,n.kt)("a",{parentName:"p",href:"https://openthread.io/guides/border_router"},"openthread.io")," is the best place for you."),(0,n.kt)("h2",{id:"hardware-requirements"},"Hardware Requirements\xb6"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"1x Raspberry Pi 3B"),(0,n.kt)("li",{parentName:"ul"},"1x Pitaya Go"),(0,n.kt)("li",{parentName:"ul"},"1x 4 GB (or larger) microSD card"),(0,n.kt)("li",{parentName:"ul"},"1x microSD card reader"),(0,n.kt)("li",{parentName:"ul"},"1x microUSB power supply for Raspberry Pi 3B")),(0,n.kt)("h2",{id:"preparing-the-raspberrypi"},"Preparing the RaspberryPI"),(0,n.kt)("p",null,"I am downloading a ",(0,n.kt)("strong",{parentName:"p"},"Raspberry Pi 3B+")," compatible ",(0,n.kt)("a",{parentName:"p",href:"https://raspi.debian.net/tested-images/"},"Debian Bullseye Image")," and bring it ",(0,n.kt)("a",{parentName:"p",href:"https://etcher.io"},"onto an SD card"),". To activate the SSH service you are have to add an empty file ",(0,n.kt)("inlineCode",{parentName:"p"},"ssh")," to the ",(0,n.kt)("inlineCode",{parentName:"p"},"boot")," directory - though remote logins are deactivated by default and need to be configured by attaching a keyboard and monitor. There should be a way to do this by a post-install script, but I could not find it on a quick skim:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"cd /run/media/myuser/RASPIROOT/boot/\ntouch ssh\n")),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"OpenThread Border Router",src:r(67523).Z,width:"1021",height:"521"})),(0,n.kt)("p",null,"To activate the login first generate a password for the root account by running:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"passwd\n")),(0,n.kt)("p",null,"And edit the following line in ",(0,n.kt)("inlineCode",{parentName:"p"},"/etc/ssh/sshd_config"),":"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"# FROM:\n# PermitRootLogin without-password\n# TO:\nPermitRootLogin yes\n")),(0,n.kt)("p",null,"Now restart the SSH daemon with:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl sshd restart\nsystemctl sshd status\n")),(0,n.kt)("h2",{id:"preparing-the-pitaya-go"},"Preparing the Pitaya Go"),(0,n.kt)("p",null,"The pre-built firmware is located in the following folder: pitaya-go/firmware/openthread/ncp with the name ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/makerdiary/pitaya-go/tree/master/firmware/openthread/ncp"},"thread_ncp_ftd_usb_pitaya_go_vx.x.x"),":"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"wget https://github.com/makerdiary/pitaya-go/archive/refs/heads/master.zip\nunzip master.zip && rm master.zip\n")),(0,n.kt)("p",null,"Download the ",(0,n.kt)("a",{parentName:"p",href:"https://www.nordicsemi.com/Products/Development-tools/nRF-Connect-for-desktop/Download#infotabs"},"nRF Connect Tool")," to Flash the NCP firmware:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"wget https://www.nordicsemi.com/-/media/Software-and-other-downloads/Desktop-software/nRF-Connect-for-Desktop/3-12-0/nrfconnect-3.12.0-x86_64.AppImage\nchmod +x ./nrfconnect-3.12.0-x86_64.AppImage\n./nrfconnect-3.12.0-x86_64.AppImage\n")),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"OpenThread Border Router",src:r(6715).Z,width:"755",height:"622"})),(0,n.kt)("p",null,"While pushing the ",(0,n.kt)("strong",{parentName:"p"},"USER")," button, press the ",(0,n.kt)("strong",{parentName:"p"},"RESET")," button to enter the DFU mode. Then program the NCP firmware using the nRF Connect for Desktop tool."),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"OpenThread Border Router",src:r(71992).Z,width:"743",height:"500"})),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Plug in your Pitaya Go to an USB Port on your computer."),(0,n.kt)("li",{parentName:"ol"},"While holding the ",(0,n.kt)("strong",{parentName:"li"},"USER")," button, press the ",(0,n.kt)("strong",{parentName:"li"},"RESET")," button. Observe that the ",(0,n.kt)("strong",{parentName:"li"},"RGB LED pulses RED")," (",(0,n.kt)("inlineCode",{parentName:"li"},"DFU mode"),")."),(0,n.kt)("li",{parentName:"ol"},"In ",(0,n.kt)("inlineCode",{parentName:"li"},"nRF Connect for Desktop")," launch the ",(0,n.kt)("inlineCode",{parentName:"li"},"Programmer")," app."),(0,n.kt)("li",{parentName:"ol"},"Select the device in the dropdown in the upper left corner if it is shown. Observe that the memory layout of the device will be displayed.")),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},(0,n.kt)("strong",{parentName:"p"},"ERROR"),": ",(0,n.kt)("inlineCode",{parentName:"p"},"Unable to detect version of nrfjprog DLL. Unable to detect version of JLink. Installed JLink version does not match the provided version (V7.66a)"),":")),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"OpenThread Border Router",src:r(11362).Z,width:"1021",height:"704"})),(0,n.kt)("p",null,"The needed version of J-Link can be ",(0,n.kt)("a",{parentName:"p",href:"https://www.segger.com/downloads/jlink/"},"downloaded here"),":"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"OpenThread Border Router",src:r(34388).Z,width:"1377",height:"593"})),(0,n.kt)("p",null,"Now the software starts up correctly:"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"OpenThread Border Router",src:r(84422).Z,width:"936",height:"202"})),(0,n.kt)("h3",{id:"flash-the-ncp-firmware"},"Flash the NCP firmware"),(0,n.kt)("p",null,"The pre-built firmware is located in the following folder: ",(0,n.kt)("inlineCode",{parentName:"p"},"pitaya-go/firmware/openthread/ncp")," with the name e.g. ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/makerdiary/pitaya-go/blob/master/firmware/openthread/ncp/"},"thread_ncp_ftd_usb_pitaya_go_v1.3.1.zip"),"."),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},(0,n.kt)("strong",{parentName:"p"},"Be careful")," to use the ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/makerdiary/pitaya-go/tree/master/firmware/openthread/ncp"},"ncp")," and not ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/makerdiary/pitaya-go/tree/master/firmware/openthread/cli"},"cli")," version - otherwise you will end up with the error message: ",(0,n.kt)("a",{parentName:"p",href:"https://devzone.nordicsemi.com/f/nordic-q-a/91307/openthread-daemon-is-not-running-with-docker-conainer-on-my-rpi4-with-nrf52840-dongle-as-an-rcp-device"},"OpenThread daemon is not running. Wpan service error: 13"))),(0,n.kt)("p",null,"While pushing the USER button, press the RESET button to enter the DFU mode. Then program the NCP firmware using the nRF Connect for Desktop tool."),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},(0,n.kt)("strong",{parentName:"p"},"ERROR Message"),": ",(0,n.kt)("inlineCode",{parentName:"p"},"Error when running nrfdl_fw_read_info")," when trying to access the dongle.")),(0,n.kt)("p",null,"I followed the advice on the ",(0,n.kt)("a",{parentName:"p",href:"https://devzone.nordicsemi.com/f/nordic-q-a/81989/error-when-fetching-device-versions-readfwinfo-error?ReplyFilter=Answers&ReplySortBy=Answers&ReplySortOrder=Descending"},"Nordic Forum")," and downgraded the Desktop and Programmer app from ",(0,n.kt)("inlineCode",{parentName:"p"},"v3.12")," to ",(0,n.kt)("inlineCode",{parentName:"p"},"v3.7"),". Now the Pitaya is recognized:"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"OpenThread Border Router",src:r(24564).Z,width:"931",height:"1032"})),(0,n.kt)("p",null,"And I am able to flash the ",(0,n.kt)("inlineCode",{parentName:"p"},".hex")," file:"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"OpenThread Border Router",src:r(51760).Z,width:"931",height:"176"})),(0,n.kt)("h2",{id:"set-up-the-border-router"},"Set up the Border Router"),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},"Before you continue, make sure your Raspberry Pi 3B is connected to the internet using Ethernet. The bootstrap script disables the platform's Wi-Fi interface and the setup script requires internet connectivity to download and install ",(0,n.kt)("inlineCode",{parentName:"p"},"wpantund"),".")),(0,n.kt)("p",null,"OTBR communicates with the Pitaya Go(serves as NCP) via ",(0,n.kt)("inlineCode",{parentName:"p"},"wpantund"),". On Raspberry Pi 3B+:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Clone the OTBR repository:")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"apt install git\ngit clone https://github.com/openthread/ot-br-posix\n")),(0,n.kt)("ol",{start:2},(0,n.kt)("li",{parentName:"ol"},"Install dependencies:")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"cd ot-br-posix\n./script/bootstrap\n")),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},(0,n.kt)("strong",{parentName:"p"},"ERROR"),": ",(0,n.kt)("inlineCode",{parentName:"p"},"./script/bootstrap: line 40: sudo: command not found")," I am currently running everything as root. So I need to remove ",(0,n.kt)("inlineCode",{parentName:"p"},"sudo")," from all shell commands. The script will work when you create another user in Debian that is able to use the ",(0,n.kt)("inlineCode",{parentName:"p"},"sudo")," command (And don't tell me the world is going to end when you use ",(0,n.kt)("inlineCode",{parentName:"p"},"root")," in a test system... it is not =.=)")),(0,n.kt)("ol",{start:3},(0,n.kt)("li",{parentName:"ol"},"Compile and install OTBR and ",(0,n.kt)("inlineCode",{parentName:"li"},"wpantund"),". Note that this setup script uses Network Manager to automatically set up the Wi-Fi access point (",(0,n.kt)("strong",{parentName:"li"},"AP"),"):")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"./script/setup\n")),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},(0,n.kt)("strong",{parentName:"p"},"ERROR"),": ",(0,n.kt)("inlineCode",{parentName:"p"},"-- Checking for module 'libsystemd' --   No package 'libsystemd' found -- Configuring incomplete, errors occurred!")," ")),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},(0,n.kt)("strong",{parentName:"p"},"ERROR"),": ",(0,n.kt)("inlineCode",{parentName:"p"},"fatal error: systemd/sd-daemon.h: No such file or directory"))),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"apt install libsystemd-dev\n")),(0,n.kt)("h2",{id:"configure-the-pitaya-go"},"Configure the Pitaya Go"),(0,n.kt)("p",null,"Attach the Pitaya Go to the Raspberry Pi 3B via USB. Configure the NCP device's serial port in ",(0,n.kt)("inlineCode",{parentName:"p"},"wpantund"),". Determine the serial port name for the NCP device by checking ",(0,n.kt)("inlineCode",{parentName:"p"},"/dev"),":"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"ls /dev/tty*\n")),(0,n.kt)("p",null,"Add the serial port name to ",(0,n.kt)("inlineCode",{parentName:"p"},"/etc/wpantund.conf"),". For example, for a serial port name of ",(0,n.kt)("inlineCode",{parentName:"p"},"ttyACM0"),":"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},'Config:NCP:SocketPath "/dev/ttyACM0"\n')),(0,n.kt)("ol",{start:6},(0,n.kt)("li",{parentName:"ol"},"Restart the Border Router. The OTBR service should start on boot.")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"sudo reboot\n")))}h.isMDXComponent=!0},67523:(e,t,r)=>{r.d(t,{Z:()=>a});const a=r.p+"assets/images/Thread-Edge-Router_01-5cc3edce08b900995648902b20771e2e.png"},71992:(e,t,r)=>{r.d(t,{Z:()=>a});const a=r.p+"assets/images/Thread-Edge-Router_02-021675cfbddb1bfd6ee015bf694ef252.png"},6715:(e,t,r)=>{r.d(t,{Z:()=>a});const a=r.p+"assets/images/Thread-Edge-Router_03-d486ac245e0971c48f61381b88d60d36.png"},11362:(e,t,r)=>{r.d(t,{Z:()=>a});const a=r.p+"assets/images/Thread-Edge-Router_04-5cfee3a4dcc73e3b0903b8794adbc404.png"},34388:(e,t,r)=>{r.d(t,{Z:()=>a});const a=r.p+"assets/images/Thread-Edge-Router_05a-4e43de527c5a31dbf8aa177516b8d73d.png"},84422:(e,t,r)=>{r.d(t,{Z:()=>a});const a=r.p+"assets/images/Thread-Edge-Router_05b-2205cd4b2311b59a6672cb1a096a4c24.png"},24564:(e,t,r)=>{r.d(t,{Z:()=>a});const a=r.p+"assets/images/Thread-Edge-Router_05d-52f5d9fe3ed11a1f6c63229e72956a51.png"},51760:(e,t,r)=>{r.d(t,{Z:()=>a});const a=r.p+"assets/images/Thread-Edge-Router_05e-25af6f7fce87a88284c7217ab1536839.png"},42117:(e,t,r)=>{r.d(t,{Z:()=>a});const a=r.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-98d71e33f881256303c68773a2ed92ba.jpg"}}]);