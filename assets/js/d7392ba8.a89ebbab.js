"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[7053],{141827:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>h,frontMatter:()=>o,metadata:()=>t,toc:()=>c});var i=r(785893),a=r(603905);const o={sidebar_position:4680,slug:"2023-02-06",title:"Apache Airflow Dynamic DAGs",authors:"mpolinowski",tags:["Python","Machine Learning","Airflow"],description:"Airflow is a platform to author, schedule and monitor workflows."},s=void 0,t={id:"IoT-and-Machine-Learning/AIOps/2023-02-06-apache-airflow-dynamic-dags/index",title:"Apache Airflow Dynamic DAGs",description:"Airflow is a platform to author, schedule and monitor workflows.",source:"@site/docs/IoT-and-Machine-Learning/AIOps/2023-02-06-apache-airflow-dynamic-dags/index.md",sourceDirName:"IoT-and-Machine-Learning/AIOps/2023-02-06-apache-airflow-dynamic-dags",slug:"/IoT-and-Machine-Learning/AIOps/2023-02-06-apache-airflow-dynamic-dags/2023-02-06",permalink:"/docs/IoT-and-Machine-Learning/AIOps/2023-02-06-apache-airflow-dynamic-dags/2023-02-06",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/IoT-and-Machine-Learning/AIOps/2023-02-06-apache-airflow-dynamic-dags/index.md",tags:[{label:"Python",permalink:"/docs/tags/python"},{label:"Machine Learning",permalink:"/docs/tags/machine-learning"},{label:"Airflow",permalink:"/docs/tags/airflow"}],version:"current",sidebarPosition:4680,frontMatter:{sidebar_position:4680,slug:"2023-02-06",title:"Apache Airflow Dynamic DAGs",authors:"mpolinowski",tags:["Python","Machine Learning","Airflow"],description:"Airflow is a platform to author, schedule and monitor workflows."},sidebar:"tutorialSidebar",previous:{title:"MLflow 2.1 Introduction",permalink:"/docs/IoT-and-Machine-Learning/AIOps/2023-02-09-mlflow-introduction/2023-02-09"},next:{title:"Apache Airflow DAG Scheduling",permalink:"/docs/IoT-and-Machine-Learning/AIOps/2023-02-05-apache-airflow-scheduler/2023-02-05"}},l={},c=[{value:"Docker Compose",id:"docker-compose",level:2},{value:"Preparation",id:"preparation",level:3},{value:"Initialization",id:"initialization",level:3},{value:"Running Airflow",id:"running-airflow",level:3},{value:"DAG Templating",id:"dag-templating",level:2}];function d(e){const n={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.ah)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Guangzhou, China",src:r(469756).Z+"",width:"1061",height:"405"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"#docker-compose",children:"Docker Compose"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#preparation",children:"Preparation"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#initialization",children:"Initialization"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#running-airflow",children:"Running Airflow"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#dag-templating",children:"DAG Templating"})}),"\n"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://github.com/mpolinowski/apache-airflow-intro",children:"Github Repository"})}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"docker-compose",children:"Docker Compose"}),"\n",(0,i.jsx)(n.h3,{id:"preparation",children:"Preparation"}),"\n",(0,i.jsxs)(n.p,{children:["To deploy ",(0,i.jsx)(n.a,{href:"https://airflow.apache.org/docs/apache-airflow/stable/howto/docker-compose/index.html",children:"Airflow with Docker Compose"}),", you should fetch ",(0,i.jsx)(n.code,{children:"docker-compose.yaml"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"curl -LfO 'https://airflow.apache.org/docs/apache-airflow/2.5.1/docker-compose.yaml'\n"})}),"\n",(0,i.jsx)(n.p,{children:"This file contains several service definitions:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"airflow-scheduler"}),": The scheduler monitors all tasks and DAGs, then triggers the task instances once their dependencies are complete."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"airflow-webserver"}),": The webserver is available at ",(0,i.jsx)(n.code,{children:"http://localhost:8080"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"airflow-worker"}),": The worker that executes the tasks given by the scheduler."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"airflow-init"}),": The initialization service."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"postgres"}),": The database."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"redis"}),": The redis - broker that forwards messages from scheduler to worker."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Some directories in the container are mounted, which means that their contents are synchronized between your computer and the container:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"dags"}),": you can put your DAG files here."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"logs"}),": contains logs from task execution and scheduler."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"plugins"}),": you can put your custom plugins here."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'mkdir -p ./dags ./logs ./plugins\necho -e "AIRFLOW_UID=$(id -u)" > .env\n'})}),"\n",(0,i.jsx)(n.h3,{id:"initialization",children:"Initialization"}),"\n",(0,i.jsx)(n.p,{children:"We first need to bring up the Postgres container, run database migrations and create the first user account. The following command also downloads all the other needed container images for us to be ready to go:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker-compose up airflow-init\n"})}),"\n",(0,i.jsx)(n.p,{children:"After initialization is complete, you should see a message like this:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'airflow-init_1       | INFO - Added user airflow\nairflow-init_1       | User "airflow" created with role "Admin"\nairflow-init_1       | 2.5.1\ndocker-compose_airflow-init_1 exited with code 0\n'})}),"\n",(0,i.jsx)(n.p,{children:"The account created has the login airflow and the password airflow."}),"\n",(0,i.jsx)(n.h3,{id:"running-airflow",children:"Running Airflow"}),"\n",(0,i.jsx)(n.p,{children:"Now we can start all services with:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker-compose up\n\n|   ____________       _____________\n|  ____    |__( )_________  __/__  /________      __\n| ____  /| |_  /__  ___/_  /_ __  /_  __ \\_ | /| / /\n| ___  ___ |  / _  /   _  __/ _  / / /_/ /_ |/ |/ /\n|  _/_/  |_/_/  /_/    /_/    /_/  \\____/____/|__/\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker ps\n\nIMAGE                  PORTS                    NAMES\napache/airflow:2.5.1   8080/tcp                 docker-compose_airflow-triggerer_1\napache/airflow:2.5.1   0.0.0.0:8080->8080/tcp   docker-compose_airflow-webserver_1\napache/airflow:2.5.1   8080/tcp                 docker-compose_airflow-worker_1\napache/airflow:2.5.1   8080/tcp                 docker-compose_airflow-scheduler_1\npostgres:13            5432/tcp                 docker-compose_postgres_1\nredis:latest           6379/tcp                 docker-compose_redis_1\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The webserver is available at: ",(0,i.jsx)(n.code,{children:"http://localhost:8080"}),". The default account has the login ",(0,i.jsx)(n.code,{children:"airflow"})," and the password ",(0,i.jsx)(n.code,{children:"airflow"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"To bring everything down again afterwards run:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker-compose down --volumes --remove-orphans\n"})}),"\n",(0,i.jsx)(n.p,{children:"To get rid of all downloaded images:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker compose down --volumes --rmi all\n"})}),"\n",(0,i.jsx)(n.h2,{id:"dag-templating",children:"DAG Templating"}),"\n",(0,i.jsxs)(n.p,{children:["Generating DAGs On-Demand using ",(0,i.jsx)(n.strong,{children:"Jinja templating"})," and ",(0,i.jsx)(n.strong,{children:"YAML"})," (",(0,i.jsx)(n.code,{children:"pip install jinja2 pyyaml"}),"). We can start by writing a DAG template that can be used to generate DAGs for us that only differ in small configuration changes:"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.em,{children:"dags/dynamic_dags/template_dag.jinja2"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-py",children:"from airflow import DAG \nfrom airflow.decorators import task\n\nfrom datetime import datetime\n\nstart_date = datetime(2023,2,6)\ntags=['generated']\n\nwith DAG(\n    dag_id = 'get_price_{{ dag_id }}',\n    start_date = start_date,\n    shedule_interval = '{{ shedule_interval }}',\n    catchup = {{ catchup or False }},\n    tags = tags\n    ):\n\n    @task\n    def extract(symbol):\n        return symbol\n\n    @task\n    def process(symbol):\n        return symbol\n\n    @task\n    def store(symbol):\n        return symbol\n\n    store(process(extract({{ input }})))\n"})}),"\n",(0,i.jsx)(n.p,{children:"And example configuration YAML file for this template looks like:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.em,{children:"dags/dynamic_dags/config_fb.yml"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yml",children:"dag_id: 'FB'\nschedule_interval: '@weekly'\ncatchup: False\ninput: 123\n"})}),"\n",(0,i.jsx)(n.p,{children:"Create all your configuration files and write a generator script that will build your DAGs for you:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.em,{children:"dags/dynamic_dags/generator.py"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-py",children:"from jinja2 import Environment, FileSystemLoader\nimport yaml\nimport os\n\nfile_dir = os.path.dirname(os.path.abspath(__file__))\nenv = Environment(loader=FileSystemLoader(file_dir))\ntemplate = env.get_template('template_dag.jinja2')\n\nfor filename in os.listdir(file_dir):\n    # loop over configuration yaml\n    if filename.endswith('.yml'):\n        # read configuration\n        with open(f'{file_dir}/{filename}', 'r') as configfile:\n            config = yaml.safe_load(configfile)\n            # generate dags based on config and template\n            with open(f'dags/get_price_{config[\"dag_id\"]}.py', 'w') as file:\n                file.write(template.render(config))\n"})}),"\n",(0,i.jsx)(n.p,{children:"You can now run the generator to output DAGs for every YAML configuration file you created:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"python dags/dynamic_dags/generator.py\n"})}),"\n",(0,i.jsx)(n.p,{children:"And the following DAGs will be created for you:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Apache Airflow Dynamic DAGs",src:r(333333).Z+"",width:"1248",height:"409"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Apache Airflow Dynamic DAGs",src:r(354466).Z+"",width:"1235",height:"781"})})]})}function h(e={}){const{wrapper:n}={...(0,a.ah)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},603905:(e,n,r)=>{r.d(n,{ah:()=>c});var i=r(667294);function a(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function o(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,i)}return r}function s(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?o(Object(r),!0).forEach((function(n){a(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function t(e,n){if(null==e)return{};var r,i,a=function(e,n){if(null==e)return{};var r,i,a={},o=Object.keys(e);for(i=0;i<o.length;i++)r=o[i],n.indexOf(r)>=0||(a[r]=e[r]);return a}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(i=0;i<o.length;i++)r=o[i],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var l=i.createContext({}),c=function(e){var n=i.useContext(l),r=n;return e&&(r="function"==typeof e?e(n):s(s({},n),e)),r},d={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},h=i.forwardRef((function(e,n){var r=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,h=t(e,["components","mdxType","originalType","parentName"]),p=c(r),f=a,m=p["".concat(l,".").concat(f)]||p[f]||d[f]||o;return r?i.createElement(m,s(s({ref:n},h),{},{components:r})):i.createElement(m,s({ref:n},h))}));h.displayName="MDXCreateElement"},333333:(e,n,r)=>{r.d(n,{Z:()=>i});const i=r.p+"assets/images/Apache_Airflow_DynDAGs_01-123fc6f3b30f7f924de82e8b2657ffb2.png"},354466:(e,n,r)=>{r.d(n,{Z:()=>i});const i=r.p+"assets/images/Apache_Airflow_DynDAGs_02-85158fd0de54924374366d1ebdcd5005.png"},469756:(e,n,r)=>{r.d(n,{Z:()=>i});const i=r.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-fe9bbb57ea8da08fea2f3fef2bf2515b.jpg"}}]);