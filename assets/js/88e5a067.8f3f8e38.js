"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[57503],{911268:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>o,contentTitle:()=>r,default:()=>h,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var a=n(474848),t=n(28453);const i={sidebar_position:8e3,slug:"2021-04-01",title:"Elastic Filebeat and NGINX Access Logs",authors:"mpolinowski",tags:["LINUX","Elasticsearch","Docker"]},r=void 0,l={id:"DevOps/Elasticsearch/2021-04-01-elastic-filebeats-for-nginx-logs/index",title:"Elastic Filebeat and NGINX Access Logs",description:"Mongkok, Hongkong",source:"@site/docs/DevOps/Elasticsearch/2021-04-01-elastic-filebeats-for-nginx-logs/index.md",sourceDirName:"DevOps/Elasticsearch/2021-04-01-elastic-filebeats-for-nginx-logs",slug:"/DevOps/Elasticsearch/2021-04-01-elastic-filebeats-for-nginx-logs/2021-04-01",permalink:"/docs/DevOps/Elasticsearch/2021-04-01-elastic-filebeats-for-nginx-logs/2021-04-01",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Elasticsearch/2021-04-01-elastic-filebeats-for-nginx-logs/index.md",tags:[{label:"LINUX",permalink:"/docs/tags/linux"},{label:"Elasticsearch",permalink:"/docs/tags/elasticsearch"},{label:"Docker",permalink:"/docs/tags/docker"}],version:"current",sidebarPosition:8e3,frontMatter:{sidebar_position:8e3,slug:"2021-04-01",title:"Elastic Filebeat and NGINX Access Logs",authors:"mpolinowski",tags:["LINUX","Elasticsearch","Docker"]},sidebar:"tutorialSidebar",previous:{title:"Performing an Elasticsearch v8 Upgrade",permalink:"/docs/DevOps/Elasticsearch/2022-02-02--elasticsearch-v8-upgrade/2022-02-02"},next:{title:"Elastic Filebeat and Apache Access Logs",permalink:"/docs/DevOps/Elasticsearch/2021-03-31-elastic-filebeats-for-apache-logs/2021-03-31"}},o={},c=[{value:"Installing Filebeat Kibana Dashboards",id:"installing-filebeat-kibana-dashboards",level:2},{value:"Filebeats Modules",id:"filebeats-modules",level:2},{value:"Edit your Filebeat Config",id:"edit-your-filebeat-config",level:4},{value:"Add your Module Config",id:"add-your-module-config",level:4},{value:"Running Filebeat",id:"running-filebeat",level:2},{value:"Using the Filebeat Dashboards",id:"using-the-filebeat-dashboards",level:2}];function d(e){const s={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h4:"h4",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(s.p,{children:(0,a.jsx)(s.img,{alt:"Mongkok, Hongkong",src:n(523244).A+"",width:"1500",height:"610"})}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsx)(s.li,{children:(0,a.jsx)(s.a,{href:"#installing-filebeat-kibana-dashboards",children:"Installing Filebeat Kibana Dashboards"})}),"\n",(0,a.jsxs)(s.li,{children:[(0,a.jsx)(s.a,{href:"#filebeats-modules",children:"Filebeats Modules"}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsx)(s.li,{children:(0,a.jsx)(s.a,{href:"#edit-your-filebeat-config",children:"Edit your Filebeat Config"})}),"\n",(0,a.jsx)(s.li,{children:(0,a.jsx)(s.a,{href:"#add-your-module-config",children:"Add your Module Config"})}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(s.li,{children:(0,a.jsx)(s.a,{href:"#running-filebeat",children:"Running Filebeat"})}),"\n",(0,a.jsx)(s.li,{children:(0,a.jsx)(s.a,{href:"#using-the-filebeat-dashboards",children:"Using the Filebeat Dashboards"})}),"\n"]}),"\n",(0,a.jsx)(s.h2,{id:"installing-filebeat-kibana-dashboards",children:"Installing Filebeat Kibana Dashboards"}),"\n",(0,a.jsx)(s.p,{children:"Filebeat comes with a couple of modules (NGINX, Apache, etc.) and fitting Kibana dashboards to help you visualize ingested logs. To install those dashboards in Kibana, you need to run the docker container with the setup command:"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-bash",children:'docker run --net="host" docker.elastic.co/beats/filebeat-oss:7.14.0-amd64 setup --dashboards\r\n\r\nLoading dashboards (Kibana must be running and reachable)\r\nLoaded dashboards\n'})}),"\n",(0,a.jsxs)(s.p,{children:["Make sure that ",(0,a.jsx)(s.a,{href:"/docs/DevOps/Elasticsearch/2021-03-30-elasticsearch7-and-filebeats/2021-03-30",children:"Elasticsearch and Kibana are running"})," and this command will just run through and exit after it successfully installed the dashboards."]}),"\n",(0,a.jsx)(s.h2,{id:"filebeats-modules",children:"Filebeats Modules"}),"\n",(0,a.jsxs)(s.p,{children:["I now want to ingest a Apache access log into Elasticsearch using the appropriated ",(0,a.jsx)(s.a,{href:"https://www.elastic.co/guide/en/beats/filebeat/7.14/filebeat-module-nginx.html",children:"Apache module in Filebeats"}),"."]}),"\n",(0,a.jsx)(s.h4,{id:"edit-your-filebeat-config",children:"Edit your Filebeat Config"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-bash",children:"nano /opt/beats/config/filebeat.yml\n"})}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-yml",children:"filebeat.config:\r\n  modules:\r\n    path: ${path.config}/modules.d/*.yml # enable all modules (nginx, kafka, redis, etc)\r\n    reload.enabled: false\r\n\r\noutput.elasticsearch:\r\n  hosts: 'localhost:9200'\r\n  username: 'elastic'\r\n  password: 'changeme'\n"})}),"\n",(0,a.jsx)(s.h4,{id:"add-your-module-config",children:"Add your Module Config"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-bash",children:"nano /opt/beats/config/nginx.yml\n"})}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-yml",children:"# Module: nginx\r\n# Docs: https://www.elastic.co/guide/en/beats/filebeat/7.x/filebeat-module-nginx.html\r\n\r\n- module: nginx\r\n  # Access logs\r\n  access:\r\n    enabled: true\r\n\r\n    # Set custom paths for the log files. If left empty,\r\n    # Filebeat will choose the paths depending on your OS.\r\n    var.paths: \r\n      - '/opt/nginx_access.log'\r\n\r\n  # Error logs\r\n  error:\r\n    enabled: false\r\n\r\n    # Set custom paths for the log files. If left empty,\r\n    # Filebeat will choose the paths depending on your OS.\r\n    # var.paths:\r\n\r\n  # Ingress-nginx controller logs. This is disabled by default. It could be used in Kubernetes environments to parse ingress-nginx logs\r\n  ingress_controller:\r\n    enabled: false\r\n\r\n    # Set custom paths for the log files. If left empty,\r\n    # Filebeat will choose the paths depending on your OS.\r\n    #var.paths:\n"})}),"\n",(0,a.jsxs)(s.blockquote,{children:["\n",(0,a.jsxs)(s.p,{children:[(0,a.jsx)(s.strong,{children:"Remember"})," to write the path variable here as an array! If you try to just copy&paste in the path string you will get the following error message: ",(0,a.jsx)(s.code,{children:'ERROR instance/beat.go:989 Exiting: Failed to start crawler: creating module reloader failed: could not create module registry for filesets: error getting config for fileset nginx/access: Error interpreting the template of the input: template: text:3:22: executing "text" at <.paths>: range can\'t iterate over /opt/nginx_access.log'})]}),"\n"]}),"\n",(0,a.jsx)(s.h2,{id:"running-filebeat",children:"Running Filebeat"}),"\n",(0,a.jsxs)(s.p,{children:[(0,a.jsx)(s.a,{href:"/docs/DevOps/Elasticsearch/2021-03-30-elasticsearch7-and-filebeats/2021-03-30",children:"As before"})," we can now run the Filebeat container using our updated configuration file:"]}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-bash",children:"docker run -d \\\r\n  --name filebeat \\\r\n  --user root \\\r\n  --net=host \\\r\n  --rm \\\r\n  -v /opt/beats/config/filebeat.yml:/usr/share/filebeat/filebeat.yml \\\r\n  -v /opt/beats/logs/nginx_access.log:/opt/nginx_access.log \\\r\n  -v /opt/beats/config/nginx.yml:/usr/share/filebeat/modules.d/nginx.yml \\\r\n  -v /var/lib/docker/containers:/var/lib/docker/containers:ro \\\r\n  -v /var/run/docker.sock:/var/run/docker.sock:ro \\\r\n  docker.elastic.co/beats/filebeat-oss:7.14.0-amd64\n"})}),"\n",(0,a.jsx)(s.p,{children:"Check if the index was created:"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-bash",children:"curl -XGET 'localhost:9200/_cat/indices?v'\r\n\r\nhealth status index                             uuid                   pri rep docs.count docs.deleted store.size pri.store.size\r\nyellow open   filebeat-7.14.0-2021.08.11-000001 7rJzWZOeRtePEbXv4keMuA   1   1       1411            0      1.4mb          1.4mb\n"})}),"\n",(0,a.jsxs)(s.p,{children:["You can now create an index pattern for ",(0,a.jsx)(s.code,{children:"filebeat-*"}),":"]}),"\n",(0,a.jsx)(s.p,{children:(0,a.jsx)(s.img,{alt:"Filebeats Server Logs",src:n(90375).A+"",width:"1279",height:"509"})}),"\n",(0,a.jsx)(s.h2,{id:"using-the-filebeat-dashboards",children:"Using the Filebeat Dashboards"}),"\n",(0,a.jsxs)(s.p,{children:["And now back to the new dashboards we installed in the beginning. Go to the dashboard menu and select the ",(0,a.jsx)(s.strong,{children:"[Filebeat Apache] Access and error logs ECS"})," dashboard."]}),"\n",(0,a.jsxs)(s.blockquote,{children:["\n",(0,a.jsxs)(s.p,{children:["ERROR Message: ",(0,a.jsx)(s.code,{children:"Could not locate that index-pattern (id: filebeat-*), click here to re-create it"})," - I go this message when I tried to open the Filebeat Apache Dashboard. I had to re-do the installation after the index was created - then it worked."]}),"\n"]}),"\n",(0,a.jsx)(s.p,{children:"The visualisation below shows the same search for server errors on our new dashboard:"}),"\n",(0,a.jsx)(s.p,{children:(0,a.jsx)(s.img,{alt:"Filebeats Server Logs",src:n(839692).A+"",width:"1525",height:"839"})}),"\n",(0,a.jsx)(s.p,{children:"You can use the dashboard to filter your data and search for the source of issues. E.g. What Provider were those GET requests coming from that resulted in an 404 error:"}),"\n",(0,a.jsx)(s.p,{children:(0,a.jsx)(s.img,{alt:"Filebeats Server Logs",src:n(751317).A+"",width:"1507",height:"465"})})]})}function h(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,a.jsx)(s,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},90375:(e,s,n)=>{n.d(s,{A:()=>a});const a=n.p+"assets/images/Filebeats_Server_Logs_01-addafb910b74d23d9307b86f06dbed8d.png"},839692:(e,s,n)=>{n.d(s,{A:()=>a});const a=n.p+"assets/images/Filebeats_Server_Logs_02-aa60143bbc88ab30cdab9fabcf9d6379.png"},751317:(e,s,n)=>{n.d(s,{A:()=>a});const a=n.p+"assets/images/Filebeats_Server_Logs_03-170da53fbf49d026c2d201d48d847597.png"},523244:(e,s,n)=>{n.d(s,{A:()=>a});const a=n.p+"assets/images/photo-456tdsfggd_67gfh6dgdf4_d-6328e7e35791f24402a0356fe74449ef.jpg"},28453:(e,s,n)=>{n.d(s,{R:()=>r,x:()=>l});var a=n(296540);const t={},i=a.createContext(t);function r(e){const s=a.useContext(i);return a.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function l(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),a.createElement(i.Provider,{value:s},e.children)}}}]);