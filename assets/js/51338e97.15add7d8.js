"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[37542],{579189:(e,s,a)=>{a.r(s),a.d(s,{assets:()=>l,contentTitle:()=>c,default:()=>d,frontMatter:()=>i,metadata:()=>t,toc:()=>o});var n=a(474848),r=a(28453);const i={sidebar_position:9060,slug:"2018-01-01",title:"Securing Elasticsearch with ReadOnlyREST",authors:"mpolinowski",tags:["LINUX","Databases","Elasticsearch"]},c=void 0,t={id:"DevOps/Elasticsearch/2018-01-01--securing-elasticsearch-readonlyrest/index",title:"Securing Elasticsearch with ReadOnlyREST",description:"Jomsom, Nepal",source:"@site/docs/DevOps/Elasticsearch/2018-01-01--securing-elasticsearch-readonlyrest/index.mdx",sourceDirName:"DevOps/Elasticsearch/2018-01-01--securing-elasticsearch-readonlyrest",slug:"/DevOps/Elasticsearch/2018-01-01--securing-elasticsearch-readonlyrest/2018-01-01",permalink:"/docs/DevOps/Elasticsearch/2018-01-01--securing-elasticsearch-readonlyrest/2018-01-01",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Elasticsearch/2018-01-01--securing-elasticsearch-readonlyrest/index.mdx",tags:[{label:"LINUX",permalink:"/docs/tags/linux"},{label:"Databases",permalink:"/docs/tags/databases"},{label:"Elasticsearch",permalink:"/docs/tags/elasticsearch"}],version:"current",sidebarPosition:9060,frontMatter:{sidebar_position:9060,slug:"2018-01-01",title:"Securing Elasticsearch with ReadOnlyREST",authors:"mpolinowski",tags:["LINUX","Databases","Elasticsearch"]},sidebar:"tutorialSidebar",previous:{title:"Elasticsearch 7 with Docker Compose",permalink:"/docs/DevOps/Elasticsearch/2019-09-08--elasticsearch_7-5_docker/2019-09-08"},next:{title:"Securing Elasticsearch with X-Pack",permalink:"/docs/DevOps/Elasticsearch/2017-12-31--securing-elasticsearch-xpack/2017-12-31"}},l={},o=[{value:"Securing Elasticsearch with ReadonlyREST",id:"securing-elasticsearch-with-readonlyrest",level:2},{value:"Install Elasticsearch",id:"install-elasticsearch",level:3},{value:"Install Kibana",id:"install-kibana",level:3},{value:"Secure Elasticsearch",id:"secure-elasticsearch",level:3},{value:"Disable X-Pack security module",id:"disable-x-pack-security-module",level:3},{value:"Upgrading the plugin",id:"upgrading-the-plugin",level:3},{value:"Securing Kibana",id:"securing-kibana",level:3}];function h(e){const s={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(s.p,{children:(0,n.jsx)(s.img,{alt:"Jomsom, Nepal",src:a(871482).A+"",width:"1500",height:"585"})}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsxs)(s.li,{children:[(0,n.jsx)(s.a,{href:"#securing-elasticsearch-with-readonlyrest",children:"Securing Elasticsearch with ReadonlyREST"}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.a,{href:"#install-elasticsearch",children:"Install Elasticsearch"})}),"\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.a,{href:"#install-kibana",children:"Install Kibana"})}),"\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.a,{href:"#secure-elasticsearch",children:"Secure Elasticsearch"})}),"\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.a,{href:"#disable-x-pack-security-module",children:"Disable X-Pack security module"})}),"\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.a,{href:"#upgrading-the-plugin",children:"Upgrading the plugin"})}),"\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.a,{href:"#securing-kibana",children:"Securing Kibana"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(s.h2,{id:"securing-elasticsearch-with-readonlyrest",children:"Securing Elasticsearch with ReadonlyREST"}),"\n",(0,n.jsxs)(s.p,{children:["Neither ",(0,n.jsx)(s.a,{href:"https://www.elastic.co/downloads/elasticsearch",children:"Elasticsearch"})," nor ",(0,n.jsx)(s.a,{href:"https://www.elastic.co/downloads/kibana",children:"Kibana"})," offer a user authentication. In earlier ",(0,n.jsx)(s.a,{href:"https://github.com/mpolinowski/express-static",children:"Projects"})," we circumvented this issue by blocking all access - only allowing our Website and Kibana to access the database via localhost."]}),"\n",(0,n.jsx)(s.p,{children:"But now we need an anonymous user account that is only allowed to Request and Read search results - while Writing to the database is forbidden."}),"\n",(0,n.jsxs)(s.p,{children:["Elastic offer their own solution for it called ",(0,n.jsx)(s.a,{href:"https://www.elastic.co/downloads/x-pack",children:"X-Pack"})," (On how to set it up - ",(0,n.jsx)(s.a,{href:"https://mpolinowski.github.io/nginx-node-elasticsearch/",children:"read more"}),") - which is a premium extension to the ELK stack and nobody seems to know how much it would cost to buy it. But as the wise man from the vintage sport car dealership knows - if you have to ask for the prize, you cannot afford it anyway. So are there free solutions out there?"]}),"\n",(0,n.jsx)(s.p,{children:"Yes! Searching for alternatives lead me to 2 solutions that are mentioned often - there are more if you keep searching:"}),"\n",(0,n.jsxs)(s.ol,{children:["\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.a,{href:"https://github.com/sscarduzio/elasticsearch-readonlyrest-plugin",children:"ReadOnlyREST"})}),"\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.a,{href:"https://github.com/floragunncom/search-guard",children:"SearchGuard"})}),"\n"]}),"\n",(0,n.jsx)(s.p,{children:"Today we are going to set up the first of them. The first thing I noticed is, that those plugins are written for the exact Version number of Elasticsearch. The newest version of RestOnlyREST supports Elasticsearch Version 6.2.3 - I am using 6.2.4, which unfortunately means that I have to downgrade my ES version.... and since there is no downgrade option with ES, I have to shut off the service and go in manually to delete every folder that ES has generated on my CentOS server (really ? That is the only option that I could find online.. but it is really a mess...)."}),"\n",(0,n.jsx)(s.h3,{id:"install-elasticsearch",children:"Install Elasticsearch"}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.strong,{children:"I. Download and install the public signing key"})}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:" rpm --import https://packages.elastic.co/GPG-KEY-elasticsearch\n"})}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.strong,{children:"II. Add the following in your /etc/yum.repos.d/ directory in a file with a .repo suffix, for example elasticsearch.repo"})}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-yaml",children:"[elasticsearch-6.x]\r\nname=Elasticsearch repository for 6.x packages\r\nbaseurl=https://artifacts.elastic.co/packages/6.x/yum\r\ngpgcheck=1\r\ngpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch\r\nenabled=1\r\nautorefresh=1\r\ntype=rpm-md\n"})}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.strong,{children:"III. Install a specific version of Elasticsearch"})}),"\n",(0,n.jsx)(s.p,{children:"ReadOnlyREST requires us to install a specific version (6.2.3) of Elasticsearch. Let's check what versions are available to install (CentOS/yum):"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"yum --showduplicates list elasticsearch | expand\r\nInstalled Packages\r\nelasticsearch.noarch                 6.2.4-1                  @elasticsearch-6.x\r\nAvailable Packages\r\nelasticsearch.noarch                 6.0.0-1                  elasticsearch-6.x\r\nelasticsearch.noarch                 6.0.0-1                  kibana-6.x\r\nelasticsearch.noarch                 6.0.1-1                  elasticsearch-6.x\r\nelasticsearch.noarch                 6.0.1-1                  kibana-6.x\r\nelasticsearch.noarch                 6.1.0-1                  elasticsearch-6.x\r\nelasticsearch.noarch                 6.1.0-1                  kibana-6.x\r\nelasticsearch.noarch                 6.1.1-1                  elasticsearch-6.x\r\nelasticsearch.noarch                 6.1.1-1                  kibana-6.x\r\nelasticsearch.noarch                 6.1.2-1                  elasticsearch-6.x\r\nelasticsearch.noarch                 6.1.2-1                  kibana-6.x\r\nelasticsearch.noarch                 6.1.3-1                  elasticsearch-6.x\r\nelasticsearch.noarch                 6.1.3-1                  kibana-6.x\r\nelasticsearch.noarch                 6.1.4-1                  elasticsearch-6.x\r\nelasticsearch.noarch                 6.1.4-1                  kibana-6.x\r\nelasticsearch.noarch                 6.2.0-1                  elasticsearch-6.x\r\nelasticsearch.noarch                 6.2.0-1                  kibana-6.x\r\nelasticsearch.noarch                 6.2.1-1                  elasticsearch-6.x\r\nelasticsearch.noarch                 6.2.1-1                  kibana-6.x\r\nelasticsearch.noarch                 6.2.2-1                  elasticsearch-6.x\r\nelasticsearch.noarch                 6.2.2-1                  kibana-6.x\r\nelasticsearch.noarch                 6.2.3-1                  elasticsearch-6.x\r\nelasticsearch.noarch                 6.2.3-1                  kibana-6.x\r\nelasticsearch.noarch                 6.2.4-1                  elasticsearch-6.x\r\nelasticsearch.noarch                 6.2.4-1                  kibana-6.x\n"})}),"\n",(0,n.jsx)(s.p,{children:"To install the version 6.2.3 of elasticsearch type:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"yum install elasticsearch-6.2.3-1\n"})}),"\n",(0,n.jsxs)(s.p,{children:["Here I ran into issues due to the messy uninstall of the earlier (newer) version of Elasticsearch - ",(0,n.jsx)(s.strong,{children:"if someone knows a cleaner way to do this, please tell :)"})]}),"\n",(0,n.jsx)(s.p,{children:"Yum still had the older version in its DB leading to an 'package already installed. Checking for update. Nothing to do' error. This can be fixed by:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{children:"rpm -e --justdb --nodeps elasticsearch\r\nrpm -e --justdb --nodeps kibana\n"})}),"\n",(0,n.jsx)(s.p,{children:"Now re-run the install command above:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"yum install elasticsearch-6.2.3-1\r\nDependencies Resolved\r\n\r\n====================================================================================================\r\n Package                  Arch              Version              Repository                    Size\r\n====================================================================================================\r\nInstalling:\r\n elasticsearch            noarch            6.2.3-1              elasticsearch-6.x             28 M\r\n\r\nTransaction Summary\r\n====================================================================================================\r\nInstall  1 Package\r\n\r\nTotal download size: 28 M\r\nInstalled size: 31 M\r\nIs this ok [y/d/N]:y\n"})}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.strong,{children:"IV. Restrict access to your Elasticsearch instance"})}),"\n",(0,n.jsxs)(s.p,{children:["To configure Elasticsearch open the following file inside your text editor: ",(0,n.jsx)(s.em,{children:"/etc/elasticsearch/elasticsearch.yml"}),". We want to limit access to localhost and a public domain that we are going to configure in NGINX. This can be done with the variable ",(0,n.jsx)(s.strong,{children:"network.host"}),":"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-yaml",children:"# ---------------------------------- Network -----------------------------------\r\n#\r\n# Set the bind address to a specific IP (IPv4 or IPv6):\r\n#\r\nnetwork.host: 127.0.0.1, my.domain.com\r\n#\r\n# Set a custom port for HTTP:\r\n#\r\nhttp.port: 9200\n"})}),"\n",(0,n.jsxs)(s.p,{children:["The HTTP port 9200 is the default port and should be changed - but we are only going to use it on localhost. NGINX will take care of it on the outside - so we will just leave it at it's default value. The webserver will also add a security layer to our app - which means, we will need to enable ",(0,n.jsx)(s.a,{href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS",children:"CORS header"})," for the transaction. Add the following lines below the Network Block:"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-yaml",children:"# --------------------------------- CORS ----------------------------------\r\n#\r\n#\r\n#http.cors:\r\n#  enabled: true\r\n#  allow-origin: /https?:\\/\\/my.domain.com(:[0-9]+)?/\r\nhttp.cors:\r\n enabled: true\r\n allow-origin: /https?:\\/\\/my.domain.com(:[0-9][0-9][0-9][0-9])?/\n"})}),"\n",(0,n.jsx)(s.p,{children:"Both examples above allow Cross-Origin Resource Sharing for your domain on every available port - but for some reasons the first regular expression stopped to work in Elasticsearch 6.2.x. You just need one of them."}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.strong,{children:"V. Set up the Elasticsearch Service"})}),"\n",(0,n.jsx)(s.p,{children:"To configure Elasticsearch to start automatically when the system boots up, run the following commands:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{children:"sudo /bin/systemctl daemon-reload\r\nsudo /bin/systemctl enable elasticsearch.service\n"})}),"\n",(0,n.jsx)(s.p,{children:"Elasticsearch can be started and stopped as follows:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{children:"sudo systemctl start elasticsearch.service\r\nsudo systemctl stop elasticsearch.service\n"})}),"\n",(0,n.jsx)(s.h3,{id:"install-kibana",children:"Install Kibana"}),"\n",(0,n.jsxs)(s.p,{children:["Since we installed a specific version (6.2.3) of Elasticsearch we now need to install the same version of the admin panel Kibana. First Create and edit a new yum repository file for Kibana in ",(0,n.jsx)(s.em,{children:"/etc/yum.repos.d/kibana.repo"}),":"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-yaml",children:"[kibana-6.x]\r\nname=Kibana repository for 6.x packages\r\nbaseurl=https://artifacts.elastic.co/packages/6.x/yum\r\ngpgcheck=1\r\ngpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch\r\nenabled=1\r\nautorefresh=1\r\ntype=rpm-md\n"})}),"\n",(0,n.jsx)(s.p,{children:"Then install the correct version as listed earlier:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"yum install kibana-6.2.3-1\n"})}),"\n",(0,n.jsxs)(s.p,{children:["Now set the Elasticsearch Connection URL for Kibana in ",(0,n.jsx)(s.em,{children:"/etc/kibana/kibana.yml"}),":"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-yaml",children:"elasticsearch.url: 'http://localhost:9200'\n"})}),"\n",(0,n.jsx)(s.p,{children:"To configure Kibana to start automatically when the system boots up, run the following commands:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"sudo /bin/systemctl daemon-reload\r\nsudo /bin/systemctl enable kibana.service\n"})}),"\n",(0,n.jsx)(s.p,{children:"Kibana can be started and stopped as follows:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{children:"sudo systemctl start kibana.service\r\nsudo systemctl stop kibana.service\n"})}),"\n",(0,n.jsx)(s.h3,{id:"secure-elasticsearch",children:"Secure Elasticsearch"}),"\n",(0,n.jsxs)(s.p,{children:["Now we can install RestOnlyREST to secure the database. First ",(0,n.jsx)(s.a,{href:"https://readonlyrest.com/download.html",children:"download"})," the correct package for the installed version of Elasticsearch and place it inside the ",(0,n.jsx)(s.em,{children:"./tmp"})," directory."]}),"\n",(0,n.jsxs)(s.p,{children:["First set up the configuration file in ",(0,n.jsx)(s.em,{children:"/etc/elasticsearch/readonlyrest.yml"})," to allow all access from localhost (required by Kibana) and restrict outside access to specific indices to read only:"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-yaml",children:"readonlyrest:\r\n    #optional\r\n    response_if_req_forbidden: Sorry, your request is forbidden.\r\n    \r\n    access_control_rules:\r\n\r\n    - name: Accept all requests from localhost\r\n      hosts: [127.0.0.1]\r\n\r\n    - name: Just certain indices, and read only\r\n      actions: ['indices:data/read/*']\r\n      indices: ['all_my_public_indices_start_with*'] # index aliases are taken in account!\n"})}),"\n",(0,n.jsx)(s.p,{children:"Then install the plugin to the elasticsearch plugin directory:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"cd /usr/share/elasticsearch/bin\r\n./elasticsearch-plugin install file:///tmp/readonlyrest-1.16.18_es6.2.3.zip\r\n\r\n-> Downloading file:///tmp/readonlyrest-1.16.18_es6.2.3.zip\r\n[=================================================] 100%\xa0\xa0\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@     WARNING: plugin requires additional permissions     @\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n* java.io.FilePermission << ALL FILES >> read\r\n* java.lang.RuntimePermission accessDeclaredMembers\r\n* java.lang.RuntimePermission getClassLoader\r\n* java.lang.reflect.ReflectPermission suppressAccessChecks\r\n* java.net.SocketPermission * connect,accept,resolve\r\n* java.security.SecurityPermission getProperty.ssl.KeyManagerFactory.algorithm\r\n* java.util.PropertyPermission * read,write\r\nSee http://docs.oracle.com/javase/8/docs/technotes/guides/security/permissions.html\r\nfor descriptions of what these permissions allow and the associated risks.\r\n\r\nContinue with installation? [y/N]y\r\n-> Installed readonlyrest\n"})}),"\n",(0,n.jsx)(s.h3,{id:"disable-x-pack-security-module",children:"Disable X-Pack security module"}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.strong,{children:"(applies to ES 6.4.0 or greater)"})}),"\n",(0,n.jsx)(s.p,{children:"ReadonlyREST and X-Pack security module can't run together, so the latter needs to be disabled."}),"\n",(0,n.jsxs)(s.p,{children:["Edit ",(0,n.jsx)(s.em,{children:"elasticsearch.yml"})," and append ",(0,n.jsx)(s.code,{children:"xpack.security.enabled: false"}),":"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"$ES_HOME/conf/elasticsearch.yml\n"})}),"\n",(0,n.jsx)(s.h3,{id:"upgrading-the-plugin",children:"Upgrading the plugin"}),"\n",(0,n.jsx)(s.p,{children:"To upgrade ReadonlyREST for Elasticsearch:"}),"\n",(0,n.jsxs)(s.ol,{children:["\n",(0,n.jsx)(s.li,{children:"Stop Elasticsearch.\r\nEither kill the process manually, or use:"}),"\n"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{children:"service stop elasticsearch\n"})}),"\n",(0,n.jsx)(s.p,{children:"depending on your environment."}),"\n",(0,n.jsxs)(s.ol,{start:"2",children:["\n",(0,n.jsx)(s.li,{children:"Uninstall ReadonlyREST"}),"\n"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{children:"bin/elasticsearch-plugin remove readonlyrest\n"})}),"\n",(0,n.jsxs)(s.ol,{start:"3",children:["\n",(0,n.jsx)(s.li,{children:"Install the new version of ReadonlyREST into Elasticsearch."}),"\n"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{children:"bin/elasticsearch-plugin install file://<download_dir>/readonlyrest-<ROR_VERSION>_es<ES_VERSION>.zip\n"})}),"\n",(0,n.jsx)(s.p,{children:"e.g. bin/elasticsearch-plugin install file:///tmp/readonlyrest-1.16.15_es6.1.1.zip"}),"\n",(0,n.jsxs)(s.ol,{start:"4",children:["\n",(0,n.jsx)(s.li,{children:"Restart Elasticsearch."}),"\n"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{children:"service start elasticsearch\n"})}),"\n",(0,n.jsx)(s.h3,{id:"securing-kibana",children:"Securing Kibana"}),"\n",(0,n.jsx)(s.p,{children:"Remember to secure Kibana with NGINX, since it is not protected by the free version of ReadOnlyREST!"})]})}function d(e={}){const{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,n.jsx)(s,{...e,children:(0,n.jsx)(h,{...e})}):h(e)}},871482:(e,s,a)=>{a.d(s,{A:()=>n});const n=a.p+"assets/images/photo-15514459555_50b13064fa_o-1fad066839f1a3d5a790953d8c7399b8.png"},28453:(e,s,a)=>{a.d(s,{R:()=>c,x:()=>t});var n=a(296540);const r={},i=n.createContext(r);function c(e){const s=n.useContext(i);return n.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function t(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),n.createElement(i.Provider,{value:s},e.children)}}}]);