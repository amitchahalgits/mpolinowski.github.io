<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Development/Magento/2019-09-13--magento-and-varnish/index" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">Magento 2 and Varnish 6 | Mike Polinowski</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://mpolinowski.github.io/docs/Development/Magento/2019-09-13--magento-and-varnish/2019-09-13"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Magento 2 and Varnish 6 | Mike Polinowski"><meta data-rh="true" name="description" content="Victoria Harbour, Hongkong"><meta data-rh="true" property="og:description" content="Victoria Harbour, Hongkong"><link data-rh="true" rel="icon" href="/img/icons/favicon-32x32.png"><link data-rh="true" rel="canonical" href="https://mpolinowski.github.io/docs/Development/Magento/2019-09-13--magento-and-varnish/2019-09-13"><link data-rh="true" rel="alternate" href="https://mpolinowski.github.io/docs/Development/Magento/2019-09-13--magento-and-varnish/2019-09-13" hreflang="en"><link data-rh="true" rel="alternate" href="https://mpolinowski.github.io/docs/Development/Magento/2019-09-13--magento-and-varnish/2019-09-13" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Mike Polinowski RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Mike Polinowski Atom Feed">




<link rel="icon" href="/img/angular_momentum.png">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37,194,160)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/angular_momentum.png">
<link rel="mask-icon" href="/img/angular_momentum.png" color="rgb(33,33,33)">
<meta name="msapplication-TileImage" content="/img/angular_momentum.png">
<meta name="msapplication-TileColor" content="#000">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-P74BDWF0C6"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-P74BDWF0C6",{})</script><link rel="stylesheet" href="/assets/css/styles.08c8c484.css">
<script src="/assets/js/runtime~main.a54fca34.js" defer="defer"></script>
<script src="/assets/js/main.93a0244f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/angular_momentum.png" alt="Mike Polinowski :: Dev Notebook" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/angular_momentum.png" alt="Mike Polinowski :: Dev Notebook" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Mike Polinowski</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/docs/tags">Tags</a><a class="navbar__item navbar__link" href="/Search">Search</a><a href="https://mpolinowski.github.io/Personal" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">About<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/mpolinowski" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/development">Development</a><button aria-label="Collapse sidebar category &#x27;Development&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/javascript">Javascript</a><button aria-label="Expand sidebar category &#x27;Javascript&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/python">Python</a><button aria-label="Expand sidebar category &#x27;Python&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/go">Go</a><button aria-label="Expand sidebar category &#x27;Go&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/graphs">Graphs</a><button aria-label="Expand sidebar category &#x27;Graphs&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/react-native">React Native</a><button aria-label="Expand sidebar category &#x27;React Native&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/category/magento">Magento</a><button aria-label="Collapse sidebar category &#x27;Magento&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Magento/2021-07-28--magento2-google-analytics-universal/2021-07-28">Adding Google Analytics to Magento 2</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Magento/2020-12-07-google-analytics-g4-tag/2020-12-07">Installing Google Analytics g4 Tag in your Gatsby and Discourse Webservice</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Magento/2019-09-21--magento2-google-analytics/2019-09-21">Adding Google Analytics to Magento 2</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Magento/2019-09-21--magento2-docker-install/2019-09-21">Docker Compose install Magento 2</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Magento/2019-09-20--magento2-ui-components/2019-09-20">Magento 2 UI Components</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Magento/2019-09-19--magento2-console-commands/2019-09-19">Creating Magento 2 Console Commands</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Magento/2019-09-18--magento2-cronjobs/2019-09-18">Creating Magento 2 Cron Jobs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Magento/2019-09-17--magento2-modules/2019-09-17">Creating Magento 2 Modules</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Magento/2019-09-16--working-with-sql-dumps/2019-09-16">Working with SQL Dumps</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Magento/2019-09-15--updating-from-php70-to-php72/2019-09-15">Updating a Magento Project from PHP v7.0 to v7.3</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Magento/2019-09-14--magento-and-themes/2019-09-14">Magento 2 Manual Theme Installation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Development/Magento/2019-09-13--magento-and-varnish/2019-09-13">Magento 2 and Varnish 6</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Magento/2019-09-12--magento-and-elasticsearch/2019-09-12">Magento 2 and Elasticsearch</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Magento/2019-09-11--magento-on-debian-with-nginx/2019-09-11">Magento 2 Installation with NGINX on Debian Buster</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Magento/2019-09-10--magento2-docker-on-ubuntu/2019-09-10">Magento 2 Dev Environment with Docker Compose</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Magento/2019-09-07--magento-development-in-docker/2019-09-07">Magento 2 Docker Development</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/misc">Misc</a><button aria-label="Expand sidebar category &#x27;Misc&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/devops">DevOps</a><button aria-label="Expand sidebar category &#x27;DevOps&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/machine-learning-ai-and-computer-vision">Machine Learning, AI and Computer Vision</a><button aria-label="Expand sidebar category &#x27;Machine Learning, AI and Computer Vision&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/automation-deep-vision-and-robotics">Automation, Deep Vision and Robotics</a><button aria-label="Expand sidebar category &#x27;Automation, Deep Vision and Robotics&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/development"><span itemprop="name">Development</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/magento"><span itemprop="name">Magento</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Magento 2 and Varnish 6</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Magento 2 and Varnish 6</h1></header><p><img alt="Victoria Harbour, Hongkong" src="/assets/images/photo-kt456d_645dhfh6dgjkhg4_d-145ed6eb6aa8262c20e6ec230401d047.jpg" width="1500" height="645"></p>
<ul>
<li><a href="#install-varnish-6-on-debian-10">Install Varnish 6 on Debian 10</a></li>
<li><a href="#configure-nginx">Configure NGINX</a></li>
<li><a href="#modify-the-varnish-system-configuration">Modify the Varnish system configuration</a></li>
<li><a href="#modify-defaultvcl">Modify default.vcl</a></li>
<li><a href="#configure-magento-to-use-varnish">Configure Magento to use Varnish</a></li>
<li><a href="#export-a-varnish-configuration-file">Export a Varnish Configuration File</a></li>
<li><a href="#the-varnishing-of-the-topmenu">The Varnishing of the TopMenu</a></li>
</ul>
<h2 id="install-varnish-6-on-debian-10">Install Varnish 6 on Debian 10</h2>
<p>In order to get <a href="https://varnish-cache.org/docs/6.0/installation/install.html">Varnish</a> up and running type sudo apt-get install varnish. Enter the following command to display the version of Varnish you are running:</p>
<pre><code class="language-bash">varnishd -V
varnishd (varnish-6.1.1 revision efc2f6c1536cf2272e471f5cff5f145239b19460)
Copyright (c) 2006 Verdens Gang AS
Copyright (c) 2006-2015 Varnish Software AS
</code></pre>
<h2 id="configure-nginx">Configure NGINX</h2>
<p>Configure your web server to listen on a port other than the default port <code>80</code> because Varnish responds directly to incoming HTTP requests, not the web server. In the sections that follow, we use port <code>8080</code> as an example:</p>
<pre><code class="language-bash">nano /etc/nginx/sites-available/magento.conf
</code></pre>
<p>Change the server to listen to port <code>8080</code>:</p>
<pre><code class="language-js">upstream fastcgi_backend {
  server  unix:/run/php/php7.2-fpm.sock;
}

server {

  listen 8080 default_server;
  server_name your-server.de;
  set $MAGE_ROOT /var/www/html/magento;
  include /var/www/html/magento/nginx.conf.sample;
}
</code></pre>
<p>Test and reload NGINX:</p>
<pre><code class="language-bash">nginx -t
service nginx reload
</code></pre>
<h2 id="modify-the-varnish-system-configuration">Modify the Varnish system configuration</h2>
<p>As a user with root privileges, open your Vanish configuration file in a text editor:</p>
<pre><code class="language-bash">nano /etc/default/varnish
</code></pre>
<p>Set the Varnish listen port to 80:</p>
<pre><code class="language-js">VARNISH_LISTEN_PORT = 80
</code></pre>
<p>Make sure that DAEMON_OPTS contains the correct listening port for the <code>-a</code> parameter:</p>
<pre><code class="language-js">DAEMON_OPTS =
  &#x27;-a :80 \
             -T localhost:6082 \
             -f /etc/varnish/default.vcl \
             -S /etc/varnish/secret \
             -s malloc,256m&#x27;
</code></pre>
<p>Save your changes to the Varnish configuration file and exit the text editor.</p>
<h2 id="modify-defaultvcl">Modify default.vcl</h2>
<p>This section discusses how to provide minimal configuration so Varnish returns HTTP response headers. This enables you to verify Varnish works before you configure Magento to use Varnish.</p>
<ol>
<li>Back up default.vcl:</li>
</ol>
<pre><code class="language-bash">cp /etc/varnish/default.vcl /etc/varnish/default.vcl.bak
</code></pre>
<p>Open <code>/etc/varnish/default.vcl</code> in a text editor and locate the <code>backend default</code> and replace the value of .host with the fully qualified hostname or IP address and listen port of the Varnish backend or origin server; that is, the server providing the content Varnish will accelerate. Replace the value of .port with the web server’s listen port:</p>
<pre><code class="language-js">backend default {
    .host = &quot;my.domain.com&quot;;
    .port = &quot;8080&quot;;
}
</code></pre>
<p>Save your changes to default.vcl and exit the text editor and restart Varnish:</p>
<pre><code class="language-bash">service varnish restart
</code></pre>
<p><strong>Unfortunatly</strong> this did not change the Port Varnish was running on:</p>
<pre><code class="language-bash">netstat -tulpn | grep varnish
tcp        0      0 0.0.0.0:6081            0.0.0.0:*               LISTEN      1634/varnishd
tcp        0      0 127.0.0.1:6082          0.0.0.0:*               LISTEN      1634/varnishd
tcp6       0      0 :::6081                 :::*                    LISTEN      1634/varnishd
</code></pre>
<p><a href="https://serverfault.com/questions/824389/varnish-daemon-not-listening-on-configured-port/824399">Following this guide</a>, applying changes to the default service is best done by creating a new file <code>/etc/systemd/system/varnish.service.d/customexec.conf</code>:</p>
<pre><code class="language-bash"># create the drop in directory
mkdir /etc/systemd/system/varnish.service.d
# create the drop in file. The name is irrelevant, as long as it ends in .conf
nano /etc/systemd/system/varnish.service.d/customexec.conf
</code></pre>
<p>Here you only need to add the settings you want do change, everything else will be loaded from the default definition file.</p>
<pre><code class="language-bash">[Service]
ExecStart=/usr/sbin/varnishd -j unix,user=vcache -F -a :80 -T localhost:6082 -f /etc/varnish/default.vcl -S /etc/varnish/secret -s malloc,256m
</code></pre>
<p>Afterwards, tell systemctl to reload it&#x27;s config files and to restart the service</p>
<pre><code class="language-bash">systemctl daemon-reload
service varnish restart
</code></pre>
<p>Now I received an error message:</p>
<pre><code class="language-bash">service varnish restart
Failed to restart varnish.service: Unit varnish.service has a bad unit file setting.
See system logs and &#x27;systemctl status varnish.service&#x27; for details.

systemctl status varnish.service
Warning: The unit file, source configuration file or drop-ins of varnish.service changed on disk● varnish.service - Varnish HTTP accelerator
   Loaded: bad-setting (Reason: Unit varnish.service has a bad unit file setting.)
  Drop-In: /etc/systemd/system/varnish.service.d
           └─customexec.conf
   Active: active (running) since Fri 2020-02-07 11:10:15 CET; 33min ago
     Docs: https://www.varnish-cache.org/docs/6.1/
           man:varnishd
 Main PID: 1634 (varnishd)
    Tasks: 217 (limit: 4915)
   Memory: 71.4M
   CGroup: /system.slice/varnish.service
           ├─1634 /usr/sbin/varnishd -j unix,user=vcache -F -a :6081 -T localhost:6082 -f /etc/v           └─1646 /usr/sbin/varnishd -j unix,user=vcache -F -a :6081 -T localhost:6082 -f /etc/v
Feb 07 11:10:15 Magento2 systemd[1]: Started Varnish HTTP accelerator.
Feb 07 11:10:16 Magento2 varnishd[1634]: Debug: Version: varnish-6.1.1 revision efc2f6c1536cf227Feb 07 11:10:16 Magento2 varnishd[1634]: Debug: Platform: Linux,4.19.0-6-amd64,x86_64,-junix,-smFeb 07 11:10:16 Magento2 varnishd[1634]: Version: varnish-6.1.1 revision efc2f6c1536cf2272e471f5Feb 07 11:10:16 Magento2 varnishd[1634]: Platform: Linux,4.19.0-6-amd64,x86_64,-junix,-smalloc,-Feb 07 11:10:16 Magento2 varnishd[1634]: Debug: Child (1646) Started
Feb 07 11:10:16 Magento2 varnishd[1634]: Child (1646) Started
Feb 07 11:10:16 Magento2 varnishd[1634]: Info: Child (1646) said Child starts
Feb 07 11:10:16 Magento2 varnishd[1634]: Child (1646) said Child starts
Feb 07 11:43:32 Magento2 systemd[1]: varnish.service: Service has more than one ExecStart= setti
</code></pre>
<p>The duplicated <code>ExecStart</code> line is in <code>/lib/systemd/system/varnish.service</code>:</p>
<pre><code>cat /lib/systemd/system/varnish.service
[Unit]
Description=Varnish HTTP accelerator
Documentation=https://www.varnish-cache.org/docs/6.1/ man:varnishd

[Service]
Type=simple
LimitNOFILE=131072
LimitMEMLOCK=82000
ExecStart=/usr/sbin/varnishd -j unix,user=vcache -F -a :6081 -T localhost:6082 -f /etc/varnish/default.vcl -S /etc/varnish/secret -s malloc,256m
ExecReload=/usr/share/varnish/varnishreload
ProtectSystem=full
ProtectHome=true
PrivateTmp=true
PrivateDevices=true

[Install]
WantedBy=multi-user.target
</code></pre>
<p>Note that the drop-in should have an empty <code>ExecStart=</code> to prevent this problem:</p>
<pre><code class="language-bash">[Service]
ExecStart=
ExecStart=/usr/sbin/varnishd -j unix,user=vcache -F -a :80 -T localhost:6082 -f /etc/varnish/default.vcl -S /etc/varnish/secret -s malloc,256m
</code></pre>
<p>Varnish is now running on port 80:</p>
<pre><code class="language-bash">netstat -tulpn | grep varnish
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      2972/varnishd
tcp        0      0 127.0.0.1:6082          0.0.0.0:*               LISTEN      2972/varnishd
tcp6       0      0 :::80                   :::*                    LISTEN      2972/varnishd
</code></pre>
<p>And I am able to access the Magento store again on port 80. You can check that your shop is served by Varnish by querying the HTTP header of your page:</p>
<pre><code class="language-bash">curl -I http://my.domain.com/
HTTP/1.1 200 OK
Server: nginx/1.14.2
Date: Fri, 07 Feb 2020 12:46:23 GMT
Content-Type: text/html; charset=UTF-8
Set-Cookie: X-Magento-Vary=6b1086e51dc44ada73095007287c835c2e8a8cb2; expires=Fri, 07-Feb-2020 13:46:23 GMT; Max-Age=3600; path=/; HttpOnly
X-Magento-Cache-Control: max-age=86400, public, s-maxage=86400
X-Magento-Cache-Debug: MISS
X-Magento-Tags: store,cms_b,FPC
Pragma: no-cache
Cache-Control: max-age=0, must-revalidate, no-cache, no-store
Expires: Thu, 07 Feb 2019 12:46:23 GMT
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
X-Frame-Options: SAMEORIGIN
Content-Encoding: gzip
Vary: Accept-Encoding
X-Varnish: 98400
Age: 0
Via: 1.1 varnish (Varnish/6.1)
Connection: keep-alive
</code></pre>
<blockquote>
<p>Before you can look at headers, you must set Magento for developer mode. You can also use the <a href="https://devdocs.magento.com/guides/v2.3/config-guide/cli/config-cli-subcommands-mode.html#change-to-developer-mode">magento deploy:mode<!-- -->:set</a> command.</p>
</blockquote>
<p>Make sure Varnish is running then enter the following command on the Varnish server and click on a link on your website:</p>
<pre><code class="language-bash">varnishlog
</code></pre>
<h2 id="configure-magento-to-use-varnish">Configure Magento to use Varnish</h2>
<ol>
<li>Log in to the Magento Admin as an administrator.</li>
<li>Click <strong>Stores</strong> &gt; <strong>Configuration</strong> &gt; <strong>Advanced</strong> &gt; <strong>System</strong> &gt; <strong>Full Page Cache</strong>.</li>
<li>From the Caching Application list, click Varnish Caching.</li>
<li>Enter a value in the TTL for public content field.</li>
<li>Expand Varnish Configuration and enter the following information:</li>
</ol>
<table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>Access list</td><td>Enter the fully qualified hostname, IP address, or Classless Inter-Domain Routing (CIDR) notation IP address range for which to invalidate content. <a href="https://www.varnish-cache.org/docs/3.0/tutorial/purging.html">More information</a></td></tr><tr><td>Backend host</td><td>Enter the fully qualified hostname or IP address and listen port of the Varnish backend or origin server; that is, the server providing the content Varnish will accelerate. Typically, this is your web server. <a href="https://www.varnish-cache.org/docs/trunk/users-guide/vcl-backends.html">More information</a></td></tr><tr><td>Backend port</td><td>Origin server&#x27;s listen port.</td></tr><tr><td>Grace period</td><td>The grace period determines how long Varnish serves stale content if the backend is not responsive. The default value is 300 seconds.</td></tr></tbody></table>
<p><img alt="Magento 2 with Varnish 6" src="/assets/images/Magento_Varnish_01-b18a2fcee34a61cc368a83a8582621a6.png" width="972" height="849"></p>
<ol start="6">
<li>Click Save Config.</li>
</ol>
<h2 id="export-a-varnish-configuration-file">Export a Varnish Configuration File</h2>
<ol>
<li>Click one of the export button to create a <code>varnish.vcl</code> you can use with Varnish.</li>
</ol>
<p><img alt="Magento 2 with Varnish 6" src="/assets/images/Magento_Varnish_02-c067fa7020d27385f4423aa701be06e0.png" width="1028" height="167"></p>
<ol start="2">
<li>
<p>Upload the file to <code>/etc/varnish/varnish.vcl</code></p>
</li>
<li>
<p>It is recommended to change the value of <code>acl purge</code> to the IP address of the Varnish host.</p>
</li>
</ol>
<pre><code class="language-bash"> acl purge {
    &quot;localhost&quot;;
 }
</code></pre>
<ol start="4">
<li>Edit <code>nano /etc/default/varnish</code> to add the new configuration file:</li>
</ol>
<pre><code class="language-js">DAEMON_OPTS =
  &#x27;-a :80 \
             -T localhost:6082 \
             -f /etc/varnish/varnish.vcl \
             -S /etc/varnish/secret \
             -s malloc,256m&#x27;
</code></pre>
<ol start="5">
<li>Static files should not be cached by default, but if you want to cache them, you can edit the section <code>Static files caching</code> in the VCL to have the following content:</li>
</ol>
<pre><code class="language-bash"># Static files should not be cached by default
  return (pass);

# But if you use a few locales and don&#x27;t use CDN you can enable caching static files by commenting previous line (#return (pass);) and uncommenting next 3 lines
  #unset req.http.Https;
  #unset req.http./*  */;
  #unset req.http.Cookie;
</code></pre>
<ol start="6">
<li>And reload Varnish and NGINX:</li>
</ol>
<pre><code class="language-bash">systemctl daemon-reload
service varnish restart
service nginx restart
</code></pre>
<ol start="7">
<li>Now that you’re using the <code>default.vcl</code> generated for you by Magento, you can perform some final verifications to make sure Varnish is working.</li>
</ol>
<pre><code class="language-bash">curl -I -v --location-trusted &#x27;http://my.domain.com&#x27;
</code></pre>
<h2 id="the-varnishing-of-the-topmenu">The Varnishing of the TopMenu</h2>
<p>After switching to Varnish I noticed that my <em>topmenu</em> module was no longer loading. Checking the page source showed me that the <a href="https://varnish-cache.org/docs/6.0/users-guide/esi.html">Edge Side Include</a> was failing:</p>
<p><img alt="Varnish 6 on Magento 2" src="/assets/images/Varnish_ESI_Problems_01-e03a7730bf6a29fcdb31a10dc881080b.png" width="1158" height="718"></p>
<p>The <a href="https://github.com/magento/magento2/issues/3421">problem in my case</a> was a <code>ttl=&quot;3600&quot;</code> parameter given in the menu component that has to be deleted:</p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;page xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:noNamespaceSchemaLocation=&quot;urn:magento:framework:View/Layout/etc/page_configuration.xsd&quot;&gt;
    &lt;body&gt;
        &lt;referenceContainer name=&quot;div.sidebar.main&quot;&gt;
            &lt;block class=&quot;TemplateMonster\Megamenu\Block\Html\Topmenu&quot;
                   name=&quot;catalog.sidebarnav&quot;
                   template=&quot;TemplateMonster_Megamenu::html/topmenu.phtml&quot;
                   ifconfig=&quot;megamenu/config/megamenu_general_show_left&quot;
                   before=&quot;-&quot;
                   ttl=&quot;3600&quot; /&gt;
        &lt;/referenceContainer&gt;
        &lt;referenceBlock name=&quot;catalog.topnav&quot; template=&quot;TemplateMonster_Megamenu::html/topmenu.phtml&quot; /&gt;
    &lt;/body&gt;
</code></pre>
<p>I found this block in <code>themeXXX\app\code\TemplateMonster\Megamenu\view\frontend\layout\default.xml</code> in the template source. And on the server inside the magento installation dir <code>/vendor/magento/module-theme/view/frontend/layout/default.xml</code>.</p>
<p>There might also be issues with <a href="https://support.magento.com/hc/en-us/articles/360028757791-Top-navigation-panel-does-not-load-on-storefront">HTTPS on the backend side</a>:</p>
<pre><code class="language-bash">nano /etc/default/varnish
</code></pre>
<p>In the DAEMON_OPTS variable, add -p feature=+esi_ignore_https, -p feature=+esi_ignore_other_elements, -p feature=+esi_disable_xml_check. This would look like:</p>
<pre><code class="language-js">DAEMON_OPTS =
  &#x27;-a :80 \
             -p feature=+esi_ignore_other_elements \
             -p feature=+esi_disable_xml_check \
             -p feature=+esi_ignore_https \
             -T localhost:6082 \
             -f /etc/varnish/varnish.vcl \
             -S /etc/varnish/secret \
             -s malloc,256m&#x27;
</code></pre>
<p>When you change this, you need to run <code>service varnish restart</code> for the changes to take effect.</p>
<h1 id="going-to-production-https">Going to Production (HTTPS)</h1>
<p>I am now going to use NGINX to add SSL encryption to my cached content - since <strong>Varnish does not natively supports encryption</strong>.</p>
<h2 id="etcvarnishdefaultvcl">/etc/varnish/default.vcl</h2>
<p>Magento will still be served on port <code>8080</code> by NGINX - so we have to set the Varnish default backend accordingly (this is the default - nothing to change here):</p>
<pre><code class="language-cfg">backend default {
    .host = &quot;localhost&quot;;
    .port = &quot;8080&quot;;
    .first_byte_timeout = 6000s;
}
</code></pre>
<h2 id="etcdefaultvarnish">/etc/default/varnish</h2>
<p>For testing I set the Varnish listening port to port <code>80</code> - I am now reversing it back to port <code>6081</code> - the reasoning is that I will tell NGINX to automatically upgrade all incoming traffic on port <code>80</code> (HTTP) to port <code>443</code> (HTTPS). Port <code>6081</code> will only be used on <code>localhost</code> and can be blocked to outside traffic:</p>
<pre><code class="language-cfg">DAEMON_OPTS=&quot;-a :6081 \
             -T localhost:6082 \
             -f /etc/varnish/default.vcl \
             -S /etc/varnish/secret \
             -s malloc,256m&quot;
</code></pre>
<h2 id="etcsystemdsystemvarnishservice">/etc/systemd/system/varnish.service</h2>
<p>The SystemD service file also specifies the ports being used by Varnish. This seems redundant (they are also defined in the varnish configuration). So either remove them (i did not try) or revert them back to use the default ports <code>6081</code> and <code>6082</code>:</p>
<pre><code class="language-cfg">[Unit]
Description=Varnish HTTP accelerator
Documentation=https://www.varnish-cache.org/docs/6.1/ man:varnishd

[Service]
Type=simple
LimitNOFILE=131072
LimitMEMLOCK=82000
ExecStart=
ExecStart=/usr/sbin/varnishd -j unix,user=vcache -F -a :6081 -T localhost:6082 -f /etc/varnish/default.vcl -S /etc/varnish/secret -s malloc,256m
ExecReload=/usr/share/varnish/varnishreload
ProtectSystem=full
ProtectHome=true
PrivateTmp=true
PrivateDevices=true

[Install]
WantedBy=multi-user.target
</code></pre>
<h2 id="etcnginxconfddefaultconf">/etc/nginx/conf.d/default.conf</h2>
<p>The NGINX server needs 3 blocks:</p>
<ul>
<li><strong>server block port 80</strong>: forced upgrade to HTTPS <code>443</code></li>
<li><strong>server block port 8080</strong>: execute the Magento backend and make your shop available to Varnish</li>
<li><strong>server block port 443</strong>: <code>proxy_pass</code> the Varnish cash from port <code>6081</code> to the web and add encryption</li>
</ul>
<pre><code class="language-cfg">upstream fastcgi_backend {
    server unix:/run/php/php7.3-fpm.sock;
  }

server {
    listen 80;
    listen [::]:80;

    server_name my.server-domain.com;

    return 301 https://$server_name$request_uri;
  }

server {
   listen 8080;
    server_name my.server-domain.com;
    set $MAGE_ROOT /var/www/magento2;
    set $MAGE_MODE developer; # or production
    include /var/www/magento2/nginx.conf.sample;
    fastcgi_read_timeout 600;
    proxy_read_timeout 600;



    set $MAGE_DEBUG_SHOW_ARGS 1;
    set $MAGE_ROOT /var/www/magento2;

    location ~ (index|get|static|report|404|503)\.php$ {
            fastcgi_pass   unix:/run/php/php7.0-fpm.sock;
            fastcgi_buffers 1024 4k;
            fastcgi_read_timeout 600s;
            fastcgi_connect_timeout 600s;
            fastcgi_index  index.php;
            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
            include        fastcgi_params;
        }

      location / {
          try_files $uri $uri/ /index.php$is_args$args;

          proxy_read_timeout 600s;
          proxy_connect_timeout 75s;
          proxy_headers_hash_max_size 5120000;
          proxy_headers_hash_bucket_size 640000;
        }
        #proxy the php scripts to php-fpm
        location ~ \.php$ {
            include /etc/nginx/fastcgi.conf;
            fastcgi_intercept_errors on;
            fastcgi_pass unix:/var/run/php7.3-fpm.sock;
        }
}



server {

    listen 443 ssl http2 default_server;
    listen [::]:443 ssl;
    server_name my.server-domain.com; # managed by Certbot

    ssl on;

    # ssl_certificate /etc/nginx/pems/public_cert.pem;
    # ssl_certificate_key /etc/nginx/pems/privat_key.pem;
    ssl_certificate /etc/letsencrypt/live/my.server-domain.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/my.server-domain.com/privkey.pem; # managed by Certbot
    include /etc/nginx/ssl/ssl-params.conf; # add additional SSL parameter
    include /etc/nginx/conf.d/header.conf; ## add additional HEADER



    location / {
       proxy_pass http://127.0.0.1:6081;
       proxy_set_header Host               $http_host;
       proxy_set_header X-Forwarded-Host   $http_host;
       proxy_set_header X-Real-IP          $remote_addr;
       proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
       proxy_set_header X-Forwarded-Proto  https;
       proxy_set_header X-Forwarded-Port   443;
       proxy_buffer_size                   128k;
       proxy_buffers                       4 256k;
       proxy_busy_buffers_size             256k;
       fastcgi_buffer_size                 32k;
       fastcgi_buffers                     4 32k;
   }


}
</code></pre>
<h3 id="check-if-varnish-is-running">Check if Varnish is Running</h3>
<pre><code class="language-bash">curl -I https://my.domain.com

HTTP/2 200
server: nginx
date: Thu, 29 Apr 2021 09:19:57 GMT
content-type: text/html; charset=UTF-8
vary: Accept-Encoding
vary: Accept-Encoding
strict-transport-security: max-age=31536000
content-security-policy: upgrade-insecure-requests;
x-content-type-options: nosniff
x-xss-protection: 1; mode=block
x-magento-cache-control: max-age=86400, public, s-maxage=86400
age: 35212
x-magento-cache-debug: HIT
grace: none
pragma: no-cache
expires: -1
cache-control: no-store, no-cache, must-revalidate, max-age=0
accept-ranges: bytes
x-frame-options: DENY
x-content-type-options: nosniff
x-xss-protection: 1; mode=block
cache-control: public, must-revalidate, proxy-revalidate, max-age=0
</code></pre>
<p>You should see either a <code>x-magento-cache-debug: HIT</code> or <code>x-magento-cache-debug: MISS</code>. If you are not seeing it:</p>
<ol>
<li>
<p>Make sure that you activated the DEVELOPER mode in the Magento Server Block in NGINX: <code>set $MAGE_MODE developer;</code></p>
</li>
<li>
<p>Activate <strong>Full Page Cache</strong> under <strong>System</strong>/<strong>Cache Management</strong>:</p>
</li>
</ol>
<pre><code class="language-bash">bin/magento cache:status

Current status:
                        config: 1
                        layout: 1
                    block_html: 1
                   collections: 1
                    reflection: 1
                        db_ddl: 1
               compiled_config: 1
                           eav: 1
         customer_notification: 1
            config_integration: 1
        config_integration_api: 1
                google_product: 1
                     full_page: 0
             config_webservice: 1
                     translate: 1
                        vertex: 1
</code></pre>
<p><img alt="Magento 2 with Varnish 6" src="/assets/images/Full-Page-Cache-3e9c388e5e9c994c0ad6fe4b1c823829.png" width="800" height="525"></p>
<h2 id="excluding-backend-urls">Excluding Backend URLs</h2>
<h3 id="defaultvcl">default.vcl</h3>
<p>Add exclude statements to <code>/etc/varnish/default.vcl</code>:</p>
<pre><code class="language-vcl">sub vcl_recv {

    if (req.url == &quot;/example.html&quot;) {
          return(pass);
    }

    # Static files caching
    if (req.url ~ &quot;/downloads/&quot;) {
        # Static files should not be cached by default
        return (pass);

        # But if you use a few locales and don&#x27;t use CDN you can enable caching static files by commenting previous line (#return (pass);) and uncommenting next 3 lines
        #unset req.http.Https;
        #unset req.http.SSL-OFFLOADED;
        #unset req.http.Cookie;
    }

    if (req.url ~ &quot;^/(pub/)?(media|static)/&quot;) {
        # Static files should not be cached by default
        return (pass);
    }

    return (hash);
}
</code></pre>
<pre><code class="language-vcl">sub vcl_backend_response {

    if (bereq.url == &quot;/example.html&quot;) {
        set beresp.uncacheable = true;
        set beresp.ttl = 120s;
        return(deliver);
    }

    if (bereq.url ~ &quot;/downloads/&quot;) {
        set beresp.uncacheable = true;
        set beresp.ttl = 120s;
        return(deliver);
    }

    if (bereq.url ~ &quot;^/(pub/)?(media|static)/&quot;) {
        set beresp.uncacheable = true;
        set beresp.ttl = 120s;
        return(deliver);
    }

    return (deliver);
}
</code></pre>
<h3 id="testing">Testing</h3>
<p>Now check your pages for the <code>x-magento-cache-debug: HIT</code> result:</p>
<pre><code class="language-bash">curl -I https://www.instar.com/

HTTP/2 200
server: nginx
date: Tue, 27 Jul 2021 07:30:13 GMT
content-type: text/html; charset=UTF-8
vary: Accept-Encoding
vary: Accept-Encoding
strict-transport-security: max-age=31536000
content-security-policy: upgrade-insecure-requests;
x-content-type-options: nosniff
x-xss-protection: 1; mode=block
x-magento-cache-control: max-age=86400, public, s-maxage=86400
age: 83
x-magento-cache-debug: HIT
grace: none
pragma: no-cache
expires: -1
cache-control: no-store, no-cache, must-revalidate, max-age=0
accept-ranges: bytes
x-frame-options: DENY
x-content-type-options: nosniff
x-xss-protection: 1; mode=block
cache-control: public, must-revalidate, proxy-revalidate, max-age=0
access-control-allow-origin: *
</code></pre>
<pre><code class="language-bash">curl -I https://www.instar.com/static/test.txt

HTTP/2 200
server: nginx
date: Tue, 27 Jul 2021 07:31:10 GMT
content-type: text/plain; charset=utf-8
content-length: 10
last-modified: Tue, 06 Jul 2021 06:55:08 GMT
etag: &quot;60e3fe4c-a&quot;
accept-ranges: bytes
x-frame-options: DENY
x-content-type-options: nosniff
x-xss-protection: 1; mode=block
cache-control: public, must-revalidate, proxy-revalidate, max-age=0
access-control-allow-origin: *
</code></pre>
<pre><code class="language-bash">curl -I https://www.instar.com/instar/downloads/IN-9008-PoE_FW_4.1.2.48_WebUI_3.0.\(328\)_update.zip

HTTP/2 200
server: nginx
date: Tue, 27 Jul 2021 07:32:19 GMT
content-type: application/zip
content-length: 7962962
last-modified: Mon, 14 Dec 2020 09:45:54 GMT
etag: &quot;5fd73452-798152&quot;
accept-ranges: bytes
pragma: no-cache
expires: -1
cache-control: no-store, no-cache, must-revalidate, max-age=0
x-frame-options: DENY
x-content-type-options: nosniff
x-xss-protection: 1; mode=block
cache-control: public, must-revalidate, proxy-revalidate, max-age=0
access-control-allow-origin: *
</code></pre></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/linux">LINUX</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/magento">Magento</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Development/Magento/2019-09-13--magento-and-varnish/index.mdx" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Development/Magento/2019-09-14--magento-and-themes/2019-09-14"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Magento 2 Manual Theme Installation</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Development/Magento/2019-09-12--magento-and-elasticsearch/2019-09-12"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Magento 2 and Elasticsearch</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#install-varnish-6-on-debian-10" class="table-of-contents__link toc-highlight">Install Varnish 6 on Debian 10</a></li><li><a href="#configure-nginx" class="table-of-contents__link toc-highlight">Configure NGINX</a></li><li><a href="#modify-the-varnish-system-configuration" class="table-of-contents__link toc-highlight">Modify the Varnish system configuration</a></li><li><a href="#modify-defaultvcl" class="table-of-contents__link toc-highlight">Modify default.vcl</a></li><li><a href="#configure-magento-to-use-varnish" class="table-of-contents__link toc-highlight">Configure Magento to use Varnish</a></li><li><a href="#export-a-varnish-configuration-file" class="table-of-contents__link toc-highlight">Export a Varnish Configuration File</a></li><li><a href="#the-varnishing-of-the-topmenu" class="table-of-contents__link toc-highlight">The Varnishing of the TopMenu</a></li><li><a href="#etcvarnishdefaultvcl" class="table-of-contents__link toc-highlight">/etc/varnish/default.vcl</a></li><li><a href="#etcdefaultvarnish" class="table-of-contents__link toc-highlight">/etc/default/varnish</a></li><li><a href="#etcsystemdsystemvarnishservice" class="table-of-contents__link toc-highlight">/etc/systemd/system/varnish.service</a></li><li><a href="#etcnginxconfddefaultconf" class="table-of-contents__link toc-highlight">/etc/nginx/conf.d/default.conf</a><ul><li><a href="#check-if-varnish-is-running" class="table-of-contents__link toc-highlight">Check if Varnish is Running</a></li></ul></li><li><a href="#excluding-backend-urls" class="table-of-contents__link toc-highlight">Excluding Backend URLs</a><ul><li><a href="#defaultvcl" class="table-of-contents__link toc-highlight">default.vcl</a></li><li><a href="#testing" class="table-of-contents__link toc-highlight">Testing</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Research</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Notebook</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/tags">Tags</a></li><li class="footer__item"><a class="footer__link-item" href="/Curriculum-Vitae">CV</a></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.linkedin.com/in/mike-polinowski-6396ba121/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/MikePolinowski" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.flickr.com/people/149680084@N06/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Flickr<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/mpolinowski" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Mike Polinowski, INSTAR Deutschland GmbH, Shenzhen - China.</div></div></div></footer></div>
</body>
</html>