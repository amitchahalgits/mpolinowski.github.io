<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-DevOps/Hashicorp/2022-05-25-hashicorp-nomad-with-gitlab/index" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">App Deployment with Hashicorp Nomad from Gitlab | Mike Polinowski</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://mpolinowski.github.io/docs/DevOps/Hashicorp/2022-05-25-hashicorp-nomad-with-gitlab/2022-05-25"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="App Deployment with Hashicorp Nomad from Gitlab | Mike Polinowski"><meta data-rh="true" name="description" content="Shen Zhen, China"><meta data-rh="true" property="og:description" content="Shen Zhen, China"><link data-rh="true" rel="icon" href="/img/icons/favicon-32x32.png"><link data-rh="true" rel="canonical" href="https://mpolinowski.github.io/docs/DevOps/Hashicorp/2022-05-25-hashicorp-nomad-with-gitlab/2022-05-25"><link data-rh="true" rel="alternate" href="https://mpolinowski.github.io/docs/DevOps/Hashicorp/2022-05-25-hashicorp-nomad-with-gitlab/2022-05-25" hreflang="en"><link data-rh="true" rel="alternate" href="https://mpolinowski.github.io/docs/DevOps/Hashicorp/2022-05-25-hashicorp-nomad-with-gitlab/2022-05-25" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Mike Polinowski RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Mike Polinowski Atom Feed">




<link rel="icon" href="/img/angular_momentum.png">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37,194,160)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/angular_momentum.png">
<link rel="mask-icon" href="/img/angular_momentum.png" color="rgb(33,33,33)">
<meta name="msapplication-TileImage" content="/img/angular_momentum.png">
<meta name="msapplication-TileColor" content="#000">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-P74BDWF0C6"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-P74BDWF0C6",{})</script><link rel="stylesheet" href="/assets/css/styles.08c8c484.css">
<script src="/assets/js/runtime~main.003ec094.js" defer="defer"></script>
<script src="/assets/js/main.0363f805.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/angular_momentum.png" alt="Mike Polinowski :: Dev Notebook" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/angular_momentum.png" alt="Mike Polinowski :: Dev Notebook" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Mike Polinowski</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/docs/tags">Tags</a><a class="navbar__item navbar__link" href="/Search">Search</a><a href="https://mpolinowski.github.io/Personal" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">About<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/mpolinowski" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/development">Development</a><button aria-label="Expand sidebar category &#x27;Development&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/devops">DevOps</a><button aria-label="Collapse sidebar category &#x27;DevOps&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/category/hashicorp">Hashicorp</a><button aria-label="Collapse sidebar category &#x27;Hashicorp&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2023-12-23-opentofu-vs-terraform/2023-12-22">Opentofu vs Hashicorp Terraform</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2023-12-22-hashicorp-terraform-docker-2024/2023-12-22">Hashicorp Terraform - Docker Provider 2024</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2023-10-22-hashicorp-terraform-docker-2023/2023-10-22">Hashicorp Terraform - Docker Provider 2023</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-12-07-hashicorp-vault-ca-certificates/2022-12-07">Hashicorp Vault - Certificate Authority</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-12-05-hashicorp-consul-vault-certificates-part3/2022-12-05">Hashicorp Consul - Vault Cert Management Part 3</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-12-05-hashicorp-consul-vault-certificates-part2/2022-12-05">Hashicorp Consul - Vault Cert Management Part 2</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-12-04-hashicorp-consul-vault-certificates-part1/2022-12-04">Hashicorp Consul - Vault Cert Management Part 1</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-12-03-hashicorp-vault-installation/2022-12-03">Hashicorp Vault - Installation 2023</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-11-24-hashicorp-consul-connect/2022-11-24">Hashicorp Nomad - Working with Consul Connect</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-11-18-hashicorp-nomad-grav/2022-11-18">Deploy Grav CMS with Hashicorp Nomad</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-11-16-hashicorp-nomad-mautic/2022-11-16">Deploy Mautic with Hashicorp Nomad</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-11-15-hashicorp-nomad-nginx-load-balancing/2022-11-15">Hashicorp Nomad for NGINX Load-balancing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-11-15-hashicorp-nomad-balanced-nts/2022-11-15">Hashicorp Nomad Secure &amp; Balanced NTS Time Service</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-11-12-hashicorp-nomad-certbot-renewal/2022-11-12">Hashicorp Nomad to Renew your TLS Certificates</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-11-11-hashicorp-nomad-for-borg-backups/2022-11-11">Hashicorp Nomad to run periodic backups</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-10-25-hashicorp-nomad-for-osticket-part-ii/2022-10-25">Hashicorp Nomad to set up an OSTicket Helpdesk - Part II</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-10-23-hashicorp-nomad-ports/2022-10-23">Hashicorp Nomad - Working with Ports</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-10-23-hashicorp-consul-connect/2022-10-23">Hashicorp Nomad - Working with Consul Connect</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-10-22-hashicorp-nomad-sidecar-pattern/2022-10-22">Hashicorp Nomad Sidecar Pattern</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-10-21-hashicorp-nomad-for-osticket-part-i/2022-10-21">Hashicorp Nomad to set up an OSTicket Helpdesk - Part I</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-09-24--nomad-nginx-ingress/2022-09-24">NGINX Ingress with Nomad</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-09-22--nomad-nts-timeserver/2022-09-22">Secure Timeserver - Deploying a NTS Server using Hashicorp Nomad</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-06-08-hashicorp-waypoint-nomad/2022-06-09">Hashicorp Waypoint with Nomad</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-06-07-hashicorp-waypoint-docker/2022-06-07">Hashicorp Waypoint with Docker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-05-29-hashicorp-nomad-with-nginx-loadbalancer/2022-05-29">Hashicorp Nomad with NGINX Loadbalancer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-05-28-hashicorp-nomad-for-elastic-part-2/2022-05-28">Hashicorp Nomad to set up an Elasticsearch Cluster Part II</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-05-27-hashicorp-nomad-for-elastic/2022-05-27">Hashicorp Nomad to set up an Elasticsearch Cluster</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-05-26-hashicorp-nomad-with-gitlab-part-2/2022-05-26">App Deployment with Hashicorp Nomad from Gitlab Part Deux</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/DevOps/Hashicorp/2022-05-25-hashicorp-nomad-with-gitlab/2022-05-25">App Deployment with Hashicorp Nomad from Gitlab</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-05-24-hashicorp-nomad-with-nginx/2022-05-24">Hashicorp Nomad for NGINX Web Proxies</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-05-22-hashicorp-dojo-nomad-consul-part-2/2022-05-22">Hashicorp Nomad with Consul II - The Reckoning</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-05-21-hashicorp-dojo-consul-refresher/2022-05-21">Hashicorp Dojo Consul Refresher</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-05-20-hashicorp-dojo-nomad-consul/2022-05-20">Hashicorp Nomad with Consul Service Discovery</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-05-19-hashicorp-dojo-nomad-access-control/2022-05-19">Hashicorp Nomad Access Control</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-05-18-hashicorp-dojo-nomad-adding-encryption/2022-05-18">Hashicorp Nomad Adding Encryption to your Cluster</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-05-17-hashicorp-dojo-nomad-deployment/2022-05-17">Hashicorp Nomad Deployment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-05-16-hashicorp-dojo-nomad-starter/2022-05-16">Hashicorp Nomad Dojo</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2022-05-15-hashicorp-nomad-refresher/2022-05-15">Hashicorp Nomad Refresher</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2021-10-11--hashicorp-consul-in-production/2021-10-11">Hashicorp Consul in Production</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2021-10-10--hashicorp-nomad-in-production/2021-10-10">Hashicorp Nomad in Production</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2021-09-06--hashicorp-terraform-providers-variables-attributes/2021-09-07">Hashicorp Terraform - Providers, Variables &amp; Attributes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2021-09-05--hashicorp-terraform-setup/2021-09-05">Hashicorp Terraform - Setup</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2021-08-25--hashicorp-vault-logging/2021-08-25">Hashicorp Vault - Logging</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2021-08-23--hashicorp-vault-rest-api/2021-08-23">Hashicorp Vault - Rest API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2021-08-22--hashicorp-vault-policies/2021-08-22">Hashicorp Vault - ACL Policies</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2021-08-21--hashicorp-vault-secrets-tokens/2021-08-21">Hashicorp Vault - Secrets &amp; Tokens</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2021-08-20--hashicorp-vault-setup/2021-08-20">Hashicorp Vault - Setup</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2021-08-14--hashicorp-consul-tls-encryption/2021-08-14">Hashicorp Consul Refresher - Gossip TLS Encryption</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2021-08-13--hashicorp-consul-access-control-lists/2021-08-13">Hashicorp Consul Refresher - Access Control Lists</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2021-08-12--hashicorp-consul-service-mesh/2021-08-12">Hashicorp Consul Refresher - Service Mesh</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2021-08-11--hashicorp-consul-backups/2021-08-11">Hashicorp Consul Refresher - Backups</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2021-08-10--hashicorp-consul-key-value-store/2021-08-10">Hashicorp Consul Refresher - Key Value Store</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2021-08-09--hashicorp-consul-services/2021-08-09">Hashicorp Consul Refresher - Services</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2021-08-08--hashicorp-nomad-access-control-lists/2021-08-08">Nomad Access Control Lists</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2021-08-07--hashicorp-nomad-job-configuration/2021-08-07">Nomad Job Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2021-08-06--hashicorp-consul-traefik-loadbalancing/2021-08-06">Hashicorp Consul Refresher - Loadbalancing with Traefik</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2021-08-06--hashicorp-consul-fabio-loadbalancing/2021-08-06">Hashicorp Consul Refresher - Loadbalancing with Fabio</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2021-08-05--hashicorp-consul-service-discovery/2021-08-05">Hashicorp Consul Refresher - Service Discovery</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2021-08-04--hashicorp-nomad-job-specifications/2021-08-04">Hashicorp Nomad Refresher - Job Specifications</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2021-08-03--hashicorp-nomad-jobs/2021-08-03">Hashicorp Nomad Refresher - Jobs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2021-08-02--hashicorp-nomad-security/2021-08-02">Hashicorp Nomad Refresher - Security</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2021-08-01--hashicorp-nomad-refresher/2021-08-01">Hashicorp Nomad Refresher - Installation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2020-10-26--hashicorp-packer-provisioner/2020-10-26">HashiCorp Packer Provisioning</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2020-10-25--hashicorp-packer-and-virtualbox-autoinstall/2020-10-25">HashiCorp Packer with Virtualbox (Autoinstall)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2020-10-24--hashicorp-packer-and-virtualbox-preseed/2020-10-24">HashiCorp Packer with Virtualbox (Preseed)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2020-10-23--hashicorp-packer-machine-image/2020-10-23">HashiCorp Packer Machine Images Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2020-08-19--consul-deployment-guide/2020-08-19">Consul Deployment Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2020-08-18--consul-service-mesh/2020-08-18">Consul Service Mesh</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2020-08-18--consul-mock-datacenter/2020-08-19">Joining Consul Clients</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2020-08-17--installing-consul-ubuntu/2020-08-17">Installing HashiCorp Consul on Ubuntu Server 20.04</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2020-08-16--nomad-cluster/2020-08-16">Nomad Server Cluster</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOps/Hashicorp/2020-08-15--installing-nomad-ubuntu/2020-08-15">Installing HashiCorp Nomad on Ubuntu Server 20.04</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/zabbix">Zabbix</a><button aria-label="Expand sidebar category &#x27;Zabbix&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/server-provisioning">Server Provisioning</a><button aria-label="Expand sidebar category &#x27;Server Provisioning&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/gitops">GitOps</a><button aria-label="Expand sidebar category &#x27;GitOps&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/kubernetes">Kubernetes</a><button aria-label="Expand sidebar category &#x27;Kubernetes&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/nginx">NGINX</a><button aria-label="Expand sidebar category &#x27;NGINX&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/elasticsearch">Elasticsearch</a><button aria-label="Expand sidebar category &#x27;Elasticsearch&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/ansible">Ansible</a><button aria-label="Expand sidebar category &#x27;Ansible&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/server-security">Server Security</a><button aria-label="Expand sidebar category &#x27;Server Security&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/linux">Linux</a><button aria-label="Expand sidebar category &#x27;Linux&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/windows">Windows</a><button aria-label="Expand sidebar category &#x27;Windows&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/tomcat">Tomcat</a><button aria-label="Expand sidebar category &#x27;Tomcat&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/salt">Salt</a><button aria-label="Expand sidebar category &#x27;Salt&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/machine-learning-ai-and-computer-vision">Machine Learning, AI and Computer Vision</a><button aria-label="Expand sidebar category &#x27;Machine Learning, AI and Computer Vision&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/automation-deep-vision-and-robotics">Automation, Deep Vision and Robotics</a><button aria-label="Expand sidebar category &#x27;Automation, Deep Vision and Robotics&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/devops"><span itemprop="name">DevOps</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/hashicorp"><span itemprop="name">Hashicorp</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">App Deployment with Hashicorp Nomad from Gitlab</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>App Deployment with Hashicorp Nomad from Gitlab</h1></header><p><img alt="Shen Zhen, China" src="/assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-6c1edb088dfea3a7d39f8eebb8e9dc23.jpg" width="2230" height="839"></p>
<ul>
<li><a href="#deploy-applications-from-the-gitlab-docker-registry">Deploy Applications from the Gitlab Docker Registry</a>
<ul>
<li><a href="#add-a-healthcheck">Add a Healthcheck</a></li>
<li><a href="#updating-applications">Updating Applications</a></li>
<li><a href="#adding-a-loadbalancer--app-ingress">Adding a Loadbalancer / App Ingress</a></li>
</ul>
</li>
<li><a href="#use-git-to-download-artifacts">Use Git to Download Artifacts</a>
<ul>
<li><a href="#preparation">Preparation</a>
<ul>
<li><a href="#create-your-ssh-key">Create your SSH Key</a></li>
<li><a href="#configuring-gitlab">Configuring Gitlab</a></li>
<li><a href="#test-the-connection">Test the Connection</a></li>
</ul>
</li>
<li><a href="#create-a-nomad-job">Create a Nomad Job</a></li>
</ul>
</li>
</ul>
<h2 id="deploy-applications-from-the-gitlab-docker-registry">Deploy Applications from the Gitlab Docker Registry</h2>
<p>I want to download a Docker image from a private <a href="/docs/DevOps/GitOps/2020-08-03--gitlab-as-docker-registry/2020-08-03">Gitlab Docker Registry</a> and run the container on a dynamic port forwarded to a static port on the inside of the container providing a web frontend:</p>
<pre><code class="language-js">job &quot;wiki_de&quot; {
	datacenters = [&quot;instaryun&quot;]

	group &quot;wiki_de&quot; {
    count = 1
        
		network {
			mode = &quot;host&quot;
			port &quot;http&quot; {
				to = &quot;1234&quot;
			}
		}

		task &quot;container&quot; {
			driver = &quot;docker&quot;

			config {
				image = &quot;mygitlab.mydomain.com:12345/wiki/wiki_de_mdx&quot;
				ports = [&quot;http&quot;]

        auth {
          username = &quot;mynomaduserongitlab&quot;
          password = &quot;acomplicatedpassword&quot;
        }
			}
		}
	}
}
</code></pre>
<p>This time I want to use the Nomad web frontend to plan and execute the job:</p>
<p><img alt="Nomad &amp;amp; Gitlab" src="/assets/images/Gitlab_CI_with_Nomad_01-c7c13dba915ead792f9618238d8b17f2.png" width="1264" height="777"></p>
<p><img alt="Nomad &amp;amp; Gitlab" src="/assets/images/Gitlab_CI_with_Nomad_02-09854662304c0ba9eb7ccb0230187f79.png" width="1008" height="436"></p>
<p>After clicking on execute I find the UI a bit lacking - you get feedback if something went wrong. But there is no progress or error log. So let&#x27;s check the CLI:</p>
<pre><code class="language-bash">nomad job status wiki_de

Deployed
Task Group  Desired  Placed  Healthy  Unhealthy  Progress Deadline
wiki_de     1        1       0        0          2022-06-12T11:23:40+02:00

Allocations
ID        Node ID   Task Group  Version  Desired  Status   Created   Modified
a98b7e7d  005f708b  wiki_de     0        run      running  1m5s ago  1s ago
</code></pre>
<pre><code class="language-bash">nomad alloc-status a98b7e7d

Recent Events:
Time                       Type        Description
2022-06-12T11:14:45+02:00  Started     Task started by client
2022-06-12T11:13:41+02:00  Driver      Downloading image
2022-06-12T11:13:41+02:00  Task Setup  Building Task Directory
2022-06-12T11:13:40+02:00  Received    Task received by client
</code></pre>
<p>Everything seemed to have worked. Checking the UI confirms that the allocation was successful:</p>
<p><img alt="Nomad &amp;amp; Gitlab" src="/assets/images/Gitlab_CI_with_Nomad_03-86a495d684bd0f12f7de3b1ca88ce382.png" width="1005" height="615"></p>
<p>Checking the docker process tells me that the port allocation is in place as well:</p>
<pre><code class="language-bash">docker ps
CONTAINER ID        PORTS
ca5e75497442        my.minion.ip:24372-&gt;1234/tcp, my.minion.ip:24372-&gt;1234/udp
</code></pre>
<p>I am able to access my web frontend by running <code>curl http://my.minion.ip:24372</code>.</p>
<h3 id="add-a-healthcheck">Add a Healthcheck</h3>
<p><a href="https://www.nomadproject.io/docs/job-specification/service">Job Specification / Service</a></p>
<p>The health check initially failed since - even though I am running the container on my host network - I am still assigning a random port to it and forward it to my HTTP port inside the container:</p>
<pre><code class="language-js">network {
  mode = &quot;host&quot;
  port &quot;http&quot; {
    to = &quot;1234&quot;
  }
}
</code></pre>
<p>This means that Consul is trying to connect on to the HTTP frontend on this random port instead - that, unfortunately, leads to nothing and makes the health check fail:</p>
<p><img alt="Gitlab CI with Nomad" src="/assets/images/Gitlab_CI_with_Nomad_06-22d1ded82c984ab4eb8643798cff8bb0.png" width="917" height="515"></p>
<p>I initially left this part in because I plan to use the Consul service discovery to handle routing automatically. But it seems for now I have to add a static port to continue. This is going to cause an issue later on when trying to update the application:</p>
<pre><code class="language-bash">Scheduler dry-run:
- WARNING: Failed to place all allocations.
  Task Group &quot;docker&quot; (failed to place 1 allocation):
    * Resources exhausted on 1 nodes
    * Dimension &quot;network: reserved port collision http=1234&quot; exhausted on 1 nodes
</code></pre>
<p>So I first have to manually stop the running allocation and then plan/run the job to update the application...</p>
<pre><code class="language-js">network {
    mode = &quot;host&quot;
    port &quot;http&quot; {
        static = &quot;1234&quot;
    }
}
</code></pre>
<pre><code class="language-js">job &quot;wiki_en&quot; {
	  datacenters = [&quot;wiki_search&quot;]
    type = &quot;service&quot;

	group &quot;docker&quot; {
    count = 1
        
    network {
        mode = &quot;host&quot;
        port &quot;http&quot; {
            static = &quot;1234&quot;
        }
	  }

    service {
        name = &quot;wikiEN&quot;
        port = &quot;http&quot;
        tags = [
            &quot;frontend&quot;,
            &quot;urlprefix-/en/&quot;
        ]

        check {
            name     = &quot;HTTP Health&quot;
            path     = &quot;/&quot;
            type     = &quot;http&quot;
            protocol = &quot;http&quot;
            interval = &quot;10s&quot;
            timeout  = &quot;2s&quot;
        }
    }

    task &quot;wiki_en_container&quot; {
        driver = &quot;docker&quot;

        config {
            image = &quot;mygitlab.mydomain.com:12345/wiki/wiki_de_mdx&quot;
            ports = [&quot;http&quot;]
            network_mode = &quot;host&quot;

            auth {
              username = &quot;mynomaduserongitlab&quot;
              password = &quot;acomplicatedpassword&quot;
            }
          }
        }
    }
}
</code></pre>
<p>This application provides a web frontend on port <code>1234</code>. The health check now registers a service with Consul that will check every 10s if the web frontend is available. Once the health check fails Nomad will be triggered to fullfill the requirement of having at least one healthy instance of this app running. We now have a self-healing app! Nice!</p>
<p>But before I run it - let&#x27;s define some update parameter for the application.</p>
<h3 id="updating-applications">Updating Applications</h3>
<p><a href="https://www.nomadproject.io/docs/job-specification/service">Job Specification / Update</a></p>
<p>The Update block below will make sure that only 1 instance of the app is running at a time. It would be better to have count higher than one and a load-balancing service in place - but there are space restraints. So I accept some potential downtime.</p>
<p>The update service makes sure that the application passes the health-check for at least <code>10s</code> and rolls the application back to the old version if the health-check fails for <code>2min</code>. Once the application is deemed healthy the canary deployment will be promoted to stable.</p>
<p>To make sure that Nomad always pulls the latest Docker image - this job only going to be used after a new image was committed - you can add the <a href="https://www.nomadproject.io/docs/drivers/docker#force_pull">force-pull</a> option:</p>
<pre><code class="language-bash">job &quot;wiki_en&quot; {
	  datacenters = [&quot;wiki_search&quot;]
    type = &quot;service&quot;

	group &quot;docker&quot; {
    count = 1
        
    network {
        mode = &quot;host&quot;
        port &quot;http&quot; {
            static = &quot;1234&quot;
        }
	  }

    update {
      max_parallel = 1
      min_healthy_time  = &quot;10s&quot;
      healthy_deadline  = &quot;2m&quot;
      progress_deadline = &quot;5m&quot;
      auto_revert = true
      auto_promote = true
      canary = 1
    }

    service {
        name = &quot;wikiEN&quot;
        port = &quot;http&quot;
        tags = [
            &quot;frontend&quot;,
            &quot;urlprefix-/en/&quot;
        ]

        check {
            name     = &quot;HTTP Health&quot;
            path     = &quot;/&quot;
            type     = &quot;http&quot;
            protocol = &quot;http&quot;
            interval = &quot;10s&quot;
            timeout  = &quot;2s&quot;
        }
    }

    task &quot;wiki_en_container&quot; {
        driver = &quot;docker&quot;

        config {
            image = &quot;mygitlab.mydomain.com:12345/wiki/wiki_de_mdx&quot;
            ports = [&quot;http&quot;]
            network_mode = &quot;host&quot;
            force_pull = true

            auth {
              username = &quot;mynomaduserongitlab&quot;
              password = &quot;acomplicatedpassword&quot;
            }
          }
        }
    }
}
</code></pre>
<p>Starting the job I can now see the canary deployment and job promotion once the Consul health check is successful:</p>
<p><img alt="Gitlab CI with Nomad" src="/assets/images/Gitlab_CI_with_Nomad_07-828676621659533b7460794c186049c1.png" width="944" height="244"></p>
<p><img alt="Gitlab CI with Nomad" src="/assets/images/Gitlab_CI_with_Nomad_08-c942127691667ad6d3ef0b9e4da5dc1c.png" width="917" height="653"></p>
<h3 id="adding-a-loadbalancer--app-ingress">Adding a Loadbalancer / App Ingress</h3>
<p><a href="/docs/DevOps/Hashicorp/2022-05-26-hashicorp-nomad-with-gitlab-part-2/2022-05-26">see Part II</a></p>
<h2 id="use-git-to-download-artifacts">Use Git to Download Artifacts</h2>
<h3 id="preparation">Preparation</h3>
<h4 id="create-your-ssh-key">Create your SSH Key</h4>
<p>First we need to create the private and public SSH key on the <strong>Nomad Minion</strong> node:</p>
<pre><code class="language-bash">ssh-keygen -t rsa -b 4096 -f /etc/nomad.d/.ssh/id_rsa
</code></pre>
<blockquote>
<p>I realized afterwards that the Nomad process is executed by the <code>root</code> user on each minion. Only the master node uses the <code>nomad</code> user. This means this key could be placed in the root home dir. But I am going to add a default SSH config parameter that will make sure that this key is used - no matter where it is placed. And having everything neatly placed inside the <code>nomad.d</code> dir is maybe not a bad idea. This might even be source controlled and used in provisioning new instances of each Nomad Minion.</p>
</blockquote>
<p>This will create the RSA and RSA public key - place them inside your Nomad users home directory. If you used the following command before to create the user <code>useradd --system --home /etc/nomad.d --shell /bin/false nomad</code> this directory will be <code>/etc/nomad.d</code>:</p>
<p><strong>id_rsa</strong></p>
<pre><code class="language-bash">-----BEGIN OPENSSH PRIVATE KEY-----
bYWQ=fDSAFe4 ... 5sdgfdDFSfszgf
-----END OPENSSH PRIVATE KEY-----
</code></pre>
<p><strong>id_rsa.pub</strong></p>
<pre><code class="language-bash">ssh-rsa AA ... 7+lU= myuser@Nomad
</code></pre>
<p>Make sure those files can be used by the Nomad user <code>chown nomad:nomad /etc/nomad.d/*</code>:</p>
<pre><code class="language-bash">chmod 400 /etc/nomad.d/.ssh/id_rsa

ls -la /etc/nomad.d/.ssh

total 16
drwxr-xr-x 2 root  root  4096 Jun  8 12:18 .
drwxr-xr-x 4 nomad nomad 4096 Jun  8 12:18 ..
-r-------- 7 nomad nomad 3.2K Jun 13 07:23 id_rsa
-rw-r--r-- 7 nomad nomad  744 Jun 13 07:23 id_rsa.pub
</code></pre>
<p>Make sure that the Nomad user&#x27;s known hosts file is populated:</p>
<pre><code class="language-bash">ssh-keyscan my.gitlab.address.com | sudo tee -a /etc/nomad.d/.ssh/known_hosts
</code></pre>
<p>Make sure that SSH uses the correct public key when connecting to your Gitlab server by adding the following configuration:</p>
<pre><code class="language-bash">nano /etc/ssh/ssh_config
</code></pre>
<pre><code class="language-bash">Host my.gitlab.address.com
   Preferredauthentications publickey
   IdentityFile /etc/nomad.d/.ssh/id_rsa
</code></pre>
<pre><code class="language-bash">ssh -T git@my.gitlab.address.com
Welcome to GitLab, @nomaduser!
</code></pre>
<h4 id="configuring-gitlab">Configuring Gitlab</h4>
<p>Create a Nomad User in Gitlab and add the Public key:</p>
<p><img alt="Gitlab CI with Nomad" src="/assets/images/Gitlab_CI_with_Nomad_04-6c73c147e43a6e9d386b0b11a04da5fb.png" width="1221" height="646"></p>
<h4 id="test-the-connection">Test the Connection</h4>
<pre><code class="language-bash">runuser -u nomad -- mkdir /etc/nomad.d/test
cd /etc/nomad.d/test
runuser -u nomad -- git clone git@my.gitlab.address.com/group/repo.git
</code></pre>
<p>The repository should be downloaded into your <code>test</code> directory without having to type in a password - then you are good to go!</p>
<h3 id="create-a-nomad-job">Create a Nomad Job</h3>
<p>For testing I am going to download some HTML code from a private Gitlab repository and execute a small terminal Node.js web server called <a href="https://www.npmjs.com/package/httpster">httpster</a> to serve those files:</p>
<pre><code class="language-bash">httpster -p 8080 -d /home/somedir/public_html
</code></pre>
<p>So now we can plan and run our Nomad job from the Nomad UI:</p>
<pre><code class="language-js">job &quot;web_front&quot; {
  datacenters = [&quot;kundensysteme&quot;]

  group &quot;web&quot; {

    task &quot;httpster&quot; {
      driver = &quot;exec&quot;

      config {
        command = &quot;httpster&quot;
        args = [&quot;-p&quot;, &quot;8080&quot;, &quot;-d&quot;, &quot;${NOMAD_TASK_DIR}/html&quot;]
      }

      artifact {
        source      = &quot;git::git@my.gitlab.address.com/group/repo.git&quot;
        destination = &quot;${NOMAD_TASK_DIR}/html&quot;
        options {
          sshkey = &quot;${base64encode(file(pathexpand(&quot;~/.ssh/id_rsa&quot;)))}&quot;
          depth = 1
        }
      }

      resources {
        cpu    = 128
        memory = 128
      }
    }
  }
}
</code></pre>
<p>But it seems that you cannot access the <a href="https://discuss.hashicorp.com/t/call-to-function-pathexpand-failed-filesystem-function-disabled/30995">servers filesystem</a> when using the Nomad webUI:</p>
<blockquote>
<p><strong>Parse Error</strong>:
input.hcl:18,41-52: Error in function call; Call to function &quot;pathexpand&quot; failed: filesystem function disabled. input.hcl:18,20-72: Unsuitable value type; Unsuitable value: value must be known</p>
</blockquote>
<p><img alt="Gitlab CI with Nomad" src="/assets/images/Gitlab_CI_with_Nomad_05-1fd0f49135a65752b1bfa7e652879961.png" width="1009" height="772"></p>
<p>So let&#x27;s create this job file on our Nomad master and execute it using the Nomad CLI:</p>
<pre><code class="language-bash">nomad plan test_artifacts.nomad                                                                                      
+/- Job: &quot;web_front&quot;
+/- Stop: &quot;true&quot; =&gt; &quot;false&quot;
+/- Task Group: &quot;web&quot; (1 create)
  +/- Task: &quot;httpster&quot; (forces create/destroy update)
    +/- Artifact {
          GetterMode:            &quot;any&quot;
          GetterOptions[sshkey]: &quot;ADgfdt...tf325sd&quot;
          GetterSource:          &quot;git::ssh://git@my.gitlab.address.com/group/repo.git&quot;
          RelativeDest:          &quot;local/html&quot;
        }

Scheduler dry-run:
- All tasks successfully allocated.

To submit the job with version verification run:

nomad job run -check-index 8150 test_artifacts.nomad
</code></pre>
<pre><code class="language-bash">nomad job run -check-index 8150 test_artifacts.nomad

==&gt; 2022-06-13T08:24:57+02:00: Monitoring evaluation &quot;19cbcc30&quot;
    2022-06-13T08:24:57+02:00: Evaluation triggered by job &quot;web_front&quot;
==&gt; 2022-06-13T08:24:58+02:00: Monitoring evaluation &quot;19cbcc30&quot;
    2022-06-13T08:24:58+02:00: Evaluation within deployment: &quot;cb210d05&quot;
    2022-06-13T08:24:58+02:00: Allocation &quot;ab8494c7&quot; created: node &quot;005f708b&quot;, group &quot;web&quot;
    2022-06-13T08:24:58+02:00: Evaluation status changed: &quot;pending&quot; -&gt; &quot;complete&quot;
==&gt; 2022-06-13T08:24:58+02:00: Evaluation &quot;19cbcc30&quot; finished with status &quot;complete&quot;
==&gt; 2022-06-13T08:24:58+02:00: Monitoring deployment &quot;cb210d05&quot;
  ✓ Deployment &quot;cb210d05&quot; successful
    
    2022-06-13T08:25:14+02:00
    ID          = cb210d05
    Job ID      = web_front
    Job Version = 9
    Status      = successful
    Description = Deployment completed successfully
    
    Deployed
    Task Group  Desired  Placed  Healthy  Unhealthy  Progress Deadline
    web         1        1       1        0          2022-06-13T08:35:12+02:00
</code></pre>
<pre><code class="language-bash">nomad job status web_front

Deployed
Task Group  Desired  Placed  Healthy  Unhealthy  Progress Deadline
web         1        1       0        0          2022-06-13T07:15:19+02:00

Allocations
ID        Node ID   Task Group  Version  Desired  Status    Created     Modified
11526379  005f708b  web         1        run      pending   7s ago      4s ago
</code></pre>
<pre><code class="language-bash">nomad alloc-status a6323ccc

Task &quot;httpster&quot; is &quot;running&quot;
Task Resources
CPU        Memory          Disk     Addresses
0/128 MHz  13 MiB/128 MiB  300 MiB  

Recent Events:
Time                       Type                   Description
2022-06-13T08:25:02+02:00  Started                Task started by client
2022-06-13T08:25:01+02:00  Downloading Artifacts  Client is downloading artifacts
2022-06-13T08:24:58+02:00  Task Setup             Building Task Directory
2022-06-13T08:24:58+02:00  Received               Task received by client
</code></pre>
<p>I can verify that the web server is running:</p>
<pre><code class="language-bash">netstat -tlnp
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp6       0      0 :::8080                 :::*                    LISTEN      7002/node
</code></pre>
<pre><code class="language-bash">curl localhost:8080
&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta charset=&#x27;utf-8&#x27;&gt;

    ...

</code></pre>
<p>It works!</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/nomad">Nomad</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/consul">Consul</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/linux">LINUX</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Hashicorp/2022-05-25-hashicorp-nomad-with-gitlab/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/DevOps/Hashicorp/2022-05-26-hashicorp-nomad-with-gitlab-part-2/2022-05-26"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">App Deployment with Hashicorp Nomad from Gitlab Part Deux</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/DevOps/Hashicorp/2022-05-24-hashicorp-nomad-with-nginx/2022-05-24"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Hashicorp Nomad for NGINX Web Proxies</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#deploy-applications-from-the-gitlab-docker-registry" class="table-of-contents__link toc-highlight">Deploy Applications from the Gitlab Docker Registry</a><ul><li><a href="#add-a-healthcheck" class="table-of-contents__link toc-highlight">Add a Healthcheck</a></li><li><a href="#updating-applications" class="table-of-contents__link toc-highlight">Updating Applications</a></li><li><a href="#adding-a-loadbalancer--app-ingress" class="table-of-contents__link toc-highlight">Adding a Loadbalancer / App Ingress</a></li></ul></li><li><a href="#use-git-to-download-artifacts" class="table-of-contents__link toc-highlight">Use Git to Download Artifacts</a><ul><li><a href="#preparation" class="table-of-contents__link toc-highlight">Preparation</a></li><li><a href="#create-a-nomad-job" class="table-of-contents__link toc-highlight">Create a Nomad Job</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Research</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Notebook</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/tags">Tags</a></li><li class="footer__item"><a class="footer__link-item" href="/Curriculum-Vitae">CV</a></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.linkedin.com/in/mike-polinowski-6396ba121/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/MikePolinowski" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.flickr.com/people/149680084@N06/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Flickr<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/mpolinowski" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Mike Polinowski, INSTAR Deutschland GmbH, Shenzhen - China.</div></div></div></footer></div>
</body>
</html>